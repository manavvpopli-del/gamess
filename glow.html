<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soccer Pro Ultimate</title>
    <style>
        * { touch-action: none; -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        body { margin: 0; background: #000; color: white; font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        
        #ui-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .box { background: #111; padding: 30px; border-radius: 20px; text-align: center; border: 2px solid #4CAF50; width: 320px; box-shadow: 0 0 30px rgba(76, 175, 80, 0.2); }
        input { padding: 14px; border-radius: 10px; border: 1px solid #333; margin: 10px 0; width: 100%; background: #000; color: #fff; font-size: 16px; outline: none; }
        button { padding: 14px; background: #4CAF50; color: white; border: none; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:active { transform: scale(0.95); }
        
        #header-info { position: absolute; top: 15px; width: 100%; text-align: center; font-size: 14px; color: #4CAF50; letter-spacing: 1px; }
        canvas { background: #1b5e20; border: 6px solid #fff; border-radius: 10px; max-width: 98vw; max-height: 85vh; }
        #goal-anim { position: absolute; display: none; font-size: 80px; font-weight: 900; color: #fff; text-shadow: 0 0 20px #4CAF50, 0 0 40px #000; z-index: 60; pointer-events: none; }
    </style>
</head>
<body>

<div id="header-info">KOD: <span id="code-val">-</span> | <span id="role-val">G√ñZL∆èNƒ∞Lƒ∞R</span></div>

<div id="ui-layer">
    <div class="box">
        <h2 style="color:#4CAF50; margin-top:0;">‚öΩ SOCCER ARENA</h2>
        <input type="text" id="pName" placeholder="Adƒ±nƒ±zƒ± yazƒ±n..." maxlength="10">
        <button onclick="initGame(true)">YENƒ∞ OYUN YARAT</button>
        <div style="margin: 15px; font-size: 12px; color: #555;">V∆è YA</div>
        <input type="text" id="jCode" placeholder="OTAQ KODUNU YAZIN...">
        <button onclick="initGame(false)" style="background:#2e7d32">QO≈ûUL</button>
    </div>
</div>

<div id="goal-anim">GOAL!</div>
<canvas id="gameCanvas"></canvas>

<audio id="bgMusic" loop>
    <source src="lp.mp3" type="audio/mpeg">
</audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
        authDomain: "sevgili-testi.firebaseapp.com",
        databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
        projectId: "sevgili-testi"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 400; canvas.height = 600;

    let myRole = null, roomId = null, myName = "";
    let isGoal = false;
    const bgMusic = document.getElementById('bgMusic');

    let state = {
        p1: { x: 200, y: 100, name: "" },
        p2: { x: 200, y: 500, name: "" },
        ball: { x: 200, y: 300, vx: 0, vy: 0 },
        score: { p1: 0, p2: 0 }
    };

    window.initGame = (isHost) => {
        // Musiqini ba≈ülat
        bgMusic.play().catch(e => console.log("Musiqi √º√ß√ºn klik lazƒ±mdƒ±r"));
        
        myName = document.getElementById('pName').value || "Oyuncu";
        roomId = isHost ? Math.random().toString(36).substring(2, 7).toUpperCase() : document.getElementById('jCode').value.toUpperCase();
        if(!roomId) return;

        const roomRef = ref(db, 'games/' + roomId);

        onValue(roomRef, (snap) => {
            const data = snap.val();
            if(!myRole) {
                if(!data) {
                    myRole = 'p1';
                    set(roomRef, state);
                } else {
                    myRole = 'p2';
                }
                document.getElementById('ui-layer').style.display = 'none';
                document.getElementById('code-val').innerText = roomId;
                document.getElementById('role-val').innerText = myRole === 'p1' ? "MEYDAN SAHƒ∞Bƒ∞" : "QONAQ";
                bindControls();
            }
            if(data) {
                state.score = data.score;
                state.p1 = data.p1;
                state.p2 = data.p2;
                if(myRole === 'p2') state.ball = data.ball;
            }
        });
        requestAnimationFrame(loop);
    };

    function bindControls() {
        const move = (e) => {
            if(isGoal) return;
            const rect = canvas.getBoundingClientRect();
            const t = e.touches ? e.touches[0] : e;
            const mx = (t.clientX - rect.left) * (canvas.width / rect.width);
            const my = (t.clientY - rect.top) * (canvas.height / rect.height);
            
            update(ref(db, `games/${roomId}/${myRole}`), { 
                x: Math.max(25, Math.min(375, mx)), 
                y: Math.max(25, Math.min(575, my)),
                name: myName 
            });
        };
        window.addEventListener('mousemove', move);
        window.addEventListener('touchmove', (e) => { e.preventDefault(); move(e); }, {passive:false});
    }

    function physics() {
        if(myRole !== 'p1' || isGoal) return;

        let b = state.ball;
        b.x += b.vx; b.y += b.vy;
        b.vx *= 0.985; b.vy *= 0.985; // S√ºrt√ºnm…ô

        // üõ°Ô∏è TOP ƒ∞TM∆èSƒ∞N - S∆èRH∆èD MEXANƒ∞ZMƒ∞
        if(b.x < 15) { b.x = 15; b.vx *= -0.8; }
        if(b.x > 385) { b.x = 385; b.vx *= -0.8; }

        // Qapƒ± sah…ôsi yoxlanƒ±≈üƒ±
        const inGoal = b.x > 125 && b.x < 275;
        if(!inGoal) {
            if(b.y < 15) { b.y = 15; b.vy *= -0.8; }
            if(b.y > 585) { b.y = 585; b.vy *= -0.8; }
        } else {
            if(b.y < -20) scoreTrigger(2);
            if(b.y > 620) scoreTrigger(1);
        }

        // Toqqu≈üma
        [state.p1, state.p2].forEach(p => {
            const dx = b.x - p.x;
            const dy = b.y - p.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist < 40) {
                const angle = Math.atan2(dy, dx);
                const force = 8;
                b.vx = Math.cos(angle) * force;
                b.vy = Math.sin(angle) * force;
                // Topun oyun√ßunun i√ßind…ô ili≈üm…ôm…ôsi √º√ß√ºn:
                b.x = p.x + Math.cos(angle) * 41;
                b.y = p.y + Math.sin(angle) * 41;
            }
        });

        update(ref(db, `games/${roomId}/ball`), b);
    }

    function scoreTrigger(p) {
        isGoal = true;
        document.getElementById('goal-anim').style.display = 'block';
        let newScore = {...state.score};
        if(p===1) newScore.p1++; else newScore.p2++;
        
        setTimeout(() => {
            update(ref(db, `games/${roomId}`), {
                score: newScore,
                ball: { x: 200, y: 300, vx: 0, vy: 0 }
            });
            document.getElementById('goal-anim').style.display = 'none';
            isGoal = false;
        }, 2000);
    }

    function draw() {
        ctx.fillStyle = "#1b5e20"; ctx.fillRect(0,0,400,600);
        
        // Meydan√ßa cizgil…ôri
        ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 3;
        ctx.strokeRect(10,10,380,580);
        ctx.beginPath(); ctx.moveTo(10,300); ctx.lineTo(390,300); ctx.stroke();
        ctx.beginPath(); ctx.arc(200,300,60,0,Math.PI*2); ctx.stroke();
        
        // Qapƒ±lar
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 12;
        ctx.beginPath(); ctx.moveTo(125, 5); ctx.lineTo(275, 5); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(125, 595); ctx.lineTo(275, 595); ctx.stroke();

        // Hesab (Arxa fon)
        ctx.fillStyle = "rgba(255,255,255,0.1)"; ctx.font = "bold 100px Arial"; ctx.textAlign = "center";
        ctx.fillText(state.score.p1, 200, 260); ctx.fillText(state.score.p2, 200, 420);

        // Top
        ctx.shadowBlur = 15; ctx.shadowColor = "white";
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(state.ball.x, state.ball.y, 12, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
        
        // Oyun√ßular
        drawPlayer(state.p1.x, state.p1.y, "#ff3333", state.p1.name);
        drawPlayer(state.p2.x, state.p2.y, "#3388ff", state.p2.name);
    }

    function drawPlayer(x, y, c, n) {
        ctx.fillStyle = c; ctx.beginPath(); ctx.arc(x, y, 25, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 3; ctx.stroke();
        ctx.fillStyle = "#fff"; ctx.font = "bold 13px Arial"; ctx.fillText(n, x, y + 45);
    }

    function loop() {
        physics();
        draw();
        requestAnimationFrame(loop);
    }
</script>
</body>
</html>