<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Soccer Multiplayer</title>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        
        #ui-layer { position: absolute; background: rgba(0, 0, 0, 0.9); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        .box { background: #222; padding: 30px; border-radius: 15px; border: 2px solid #4CAF50; box-shadow: 0 0 20px rgba(76, 175, 80, 0.3); }
        input { padding: 12px; font-size: 1rem; border-radius: 5px; border: none; margin: 10px; width: 200px; text-align: center; }
        button { padding: 12px 25px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; }
        
        canvas { border: 10px solid #fff; border-radius: 5px; background: #2e7d32; cursor: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #game-stats { position: absolute; top: 10px; left: 10px; pointer-events: none; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="box">
        <h2>⚽ Super Soccer</h2>
        <input type="text" id="playerName" placeholder="Adınızı yazın..." maxlength="12"><br>
        <button onclick="createNewGame()">Yeni Oyun Yarat</button>
        <div style="margin: 10px; color: #888;">və ya</div>
        <input type="text" id="joinCode" placeholder="Otaq kodu daxil edin..."><br>
        <button onclick="joinExistingGame()">Qoşul</button>
    </div>
</div>

<div id="game-stats">
    Otaq: <span id="displayRoom">-</span> | <span id="p1NameDisplay">P1</span> vs <span id="p2NameDisplay">P2</span>
</div>
<canvas id="gameCanvas"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
        authDomain: "sevgili-testi.firebaseapp.com",
        databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
        projectId: "sevgili-testi",
        storageBucket: "sevgili-testi.firebasestorage.app",
        messagingSenderId: "399260477557",
        appId: "1:399260477557:web:584204a698d7bf145bb03c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = 450;
    canvas.height = 700;

    let myRole = null;
    let roomId = null;
    let myName = "";
    const goalWidth = 160;

    let state = {
        p1: { x: 225, y: 80, name: "Gözlənilir..." },
        p2: { x: 225, y: 620, name: "Gözlənilir..." },
        ball: { x: 225, y: 350, vx: 0, vy: 0 },
        score: { p1: 0, p2: 0 }
    };

    // Otaq yaratma
    window.createNewGame = function() {
        const code = Math.random().toString(36).substring(2, 7).toUpperCase();
        setupGame(code, 'player1');
    };

    // Qoşulma
    window.joinExistingGame = function() {
        const code = document.getElementById('joinCode').value.trim().toUpperCase();
        if(code) setupGame(code, 'player2');
    };

    function setupGame(code, preferredRole) {
        myName = document.getElementById('playerName').value || "Adsız";
        roomId = code;
        const roomRef = ref(db, 'matches/' + roomId);

        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (!myRole) {
                if (!data) {
                    myRole = 'player1';
                    set(roomRef, { ...state, p1: { ...state.p1, name: myName }, p1_online: true });
                } else {
                    myRole = 'player2';
                    update(roomRef, { "p2/name": myName, p2_online: true });
                }
                document.getElementById('ui-layer').style.display = 'none';
                document.getElementById('displayRoom').innerText = roomId;
                
                // Oyundan çıxanda təmizlə
                onDisconnect(ref(db, `matches/${roomId}/${myRole}_online`)).remove();
            }
            if (data) {
                state = data;
                document.getElementById('p1NameDisplay').innerText = data.p1.name;
                document.getElementById('p2NameDisplay').innerText = data.p2.name;
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;

            if (myRole === 'player1' && my < canvas.height / 2 - 30) {
                update(ref(db, `matches/${roomId}/p1`), { x: mx, y: my, name: myName });
            } else if (myRole === 'player2' && my > canvas.height / 2 + 30) {
                update(ref(db, `matches/${roomId}/p2`), { x: mx, y: my, name: myName });
            }
        });

        requestAnimationFrame(gameLoop);
    }

    function updatePhysics() {
        if (myRole !== 'player1') return;

        let { ball, p1, p2, score } = state;

        // Topun hərəkəti
        ball.x += ball.vx;
        ball.y += ball.vy;

        // Sürtünmə (Real top effekti)
        ball.vx *= 0.985;
        ball.vy *= 0.985;

        // Yan divarlar
        if (ball.x < 20 || ball.x > canvas.width - 20) {
            ball.vx *= -0.8; 
            ball.x = ball.x < 20 ? 20 : canvas.width - 20;
        }

        // Qapı və Üst/Alt divar
        const inGoalRange = (ball.x > (canvas.width - goalWidth) / 2 && ball.x < (canvas.width + goalWidth) / 2);
        if (!inGoalRange) {
            if (ball.y < 20 || ball.y > canvas.height - 20) {
                ball.vy *= -0.8;
                ball.y = ball.y < 20 ? 20 : canvas.height - 20;
            }
        } else {
            if (ball.y < -15) { score.p2++; resetBall(); }
            else if (ball.y > canvas.height + 15) { score.p1++; resetBall(); }
        }

        // Toqquşma fizikası
        [p1, p2].forEach(p => {
            const dx = ball.x - p.x;
            const dy = ball.y - p.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 45) { // Radiuslar cəmi
                const angle = Math.atan2(dy, dx);
                const speed = Math.sqrt(ball.vx**2 + ball.vy**2) + 5; // Vuruş gücü
                ball.vx = Math.cos(angle) * speed;
                ball.vy = Math.sin(angle) * speed;
            }
        });

        function resetBall() {
            ball = { x: 225, y: 350, vx: 0, vy: 0 };
        }

        update(ref(db, 'matches/' + roomId), { ball, score });
    }

    function drawField() {
        // Ot örtüyü
        ctx.fillStyle = "#2e7d32";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Meydança cizgiləri
        ctx.strokeStyle = "rgba(255,255,255,0.5)";
        ctx.lineWidth = 3;
        
        // Mərkəz dairə və xətt
        ctx.beginPath();
        ctx.moveTo(0, canvas.height/2);
        ctx.lineTo(canvas.width, canvas.height/2);
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(canvas.width/2, canvas.height/2, 60, 0, Math.PI*2);
        ctx.stroke();

        // Cərimə meydançaları
        ctx.strokeRect((canvas.width-250)/2, 0, 250, 100);
        ctx.strokeRect((canvas.width-250)/2, canvas.height-100, 250, 100);

        // Qapılar
        ctx.strokeStyle = "white";
        ctx.lineWidth = 8;
        ctx.strokeRect((canvas.width - goalWidth)/2, -2, goalWidth, 5);
        ctx.strokeRect((canvas.width - goalWidth)/2, canvas.height - 3, goalWidth, 5);
    }

    function draw() {
        drawField();

        // Hesab
        ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.font = "bold 80px sans-serif";
        ctx.fillText(state.score.p1, canvas.width/2 - 25, canvas.height/2 - 50);
        ctx.fillText(state.score.p2, canvas.width/2 - 25, canvas.height/2 + 110);

        // Oyunçular (Rəngli formalar)
        drawObject(state.p1.x, state.p1.y, 25, "#e74c3c", state.p1.name);
        drawObject(state.p2.x, state.p2.y, 25, "#3498db", state.p2.name);
        
        // Top (Futbol topu dizaynı)
        drawBall(state.ball.x, state.ball.y);
    }

    function drawObject(x, y, r, color, name) {
        ctx.fillStyle = color;
        ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "white"; ctx.lineWidth = 3; ctx.stroke();
        
        ctx.fillStyle = "white";
        ctx.font = "12px Arial";
        ctx.textAlign = "center";
        ctx.fillText(name, x, y + r + 15);
    }

    function drawBall(x, y) {
        ctx.fillStyle = "white";
        ctx.beginPath(); ctx.arc(x, y, 15, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "black"; ctx.lineWidth = 1; ctx.stroke();
        // Topun üzərindəki qara naxışlar (simvolik)
        ctx.fillStyle = "black";
        for(let i=0; i<5; i++) {
            ctx.beginPath();
            ctx.arc(x + Math.cos(i)*8, y + Math.sin(i)*8, 3, 0, Math.PI*2);
            ctx.fill();
        }
    }

    function gameLoop() {
        updatePhysics();
        draw();
        requestAnimationFrame(gameLoop);
    }
</script>
</body>
</html>