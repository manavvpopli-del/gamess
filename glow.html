<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Glow Air Hockey • Multiplayer</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <style>
    body {
      margin:0; padding:0; height:100vh; background:#0a0015; 
      font-family: system-ui, sans-serif; color:#e0f7ff; 
      overflow:hidden; touch-action: none; user-select:none;
    }
    #lobby, #game {
      position: absolute; inset:0; display:flex; flex-direction:column;
      align-items:center; justify-content:center; padding:20px; box-sizing:border-box;
    }
    #game { display:none; }
    h1 { margin:0 0 30px; font-size: clamp(2rem, 8vw, 3.5rem); text-shadow:0 0 20px #00d4ff; }
    input, button {
      font-size: clamp(1.1rem, 5vw, 1.4rem);
      padding: 14px 24px; margin:12px; border:none; border-radius:12px;
      width: clamp(220px, 70vw, 380px); max-width:90%;
    }
    button {
      background: linear-gradient(45deg, #00d4ff, #00ffff);
      color:#000; font-weight:bold; cursor:pointer;
    }
    button:active { transform:scale(0.97); }
    #status { font-size:1.3rem; margin:20px 0; text-align:center; }
    #scores {
      position:absolute; top:10px; left:0; right:0; text-align:center;
      font-size:1.4rem; z-index:10; pointer-events:none;
    }
    canvas { display:block; width:100%; height:100%; }
  </style>
</head>
<body>

<div id="lobby">
  <h1>Glow Air Hockey</h1>
  <input id="roomCode" placeholder="Otaq kodu (4 rəqəm)" maxlength="4" inputmode="numeric"/>
  <button onclick="createRoom()">Yeni Otaq Yarat</button>
  <button onclick="joinRoom()">Otağa Qoşul</button>
  <div id="status">Otaq kodu daxil edin və ya yeni otaq yaradın</div>
</div>

<div id="game">
  <div id="scores">Sən: <span id="myScore">0</span> – Rəqib: <span id="oppScore">0</span></div>
  <canvas id="c"></canvas>
</div>

<script>
// =================== FIREBASE ===================
const firebaseConfig = {
  apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
  authDomain: "sevgili-testi.firebaseapp.com",
  databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
  projectId: "sevgili-testi",
  storageBucket: "sevgili-testi.firebasestorage.app",
  messagingSenderId: "399260477557",
  appId: "1:399260477557:web:584204a698d7bf145bb03c",
  measurementId: "G-44P21XCZ7G"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// =================== DƏYİŞƏNLƏR ===================
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
let roomRef = null;
let myId = null; // "p1" və ya "p2"
let myPaddle, oppPaddle, puck;
let scoreMe = 0, scoreOpp = 0;

let WIDTH, HEIGHT, CENTER_X, CENTER_Y, PADDLE_R, PUCK_R, GOAL_W;

function resize() {
  WIDTH = canvas.width = window.innerWidth;
  HEIGHT = canvas.height = window.innerHeight;
  CENTER_X = WIDTH >> 1;
  CENTER_Y = HEIGHT >> 1;

  // Mobil üçün daha böyük ölçülər
  const scale = Math.min(WIDTH, HEIGHT) / 800;
  PADDLE_R = Math.round(38 * scale);
  PUCK_R   = Math.round(24 * scale);
  GOAL_W   = Math.round(WIDTH * 0.22);
}
window.addEventListener("resize", resize);
resize();

// Obyekt sinfi
class Circle {
  constructor(x, y, r, color) {
    this.x = x; this.y = y; this.r = r; this.color = color;
    this.vx = 0; this.vy = 0;
  }
  draw() {
    ctx.save();
    ctx.shadowColor = this.color;
    ctx.shadowBlur = 30;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
    ctx.fillStyle = this.color;
    ctx.fill();
    // içəridə glow
    ctx.shadowBlur = 12;
    ctx.fillStyle = this.color + "88";
    ctx.fill();
    ctx.restore();
  }
}

// Input (mouse + touch)
const pointer = { x: CENTER_X, y: CENTER_Y, active: false };

function updatePointer(e) {
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const touch = e.touches ? e.touches[0] : e;
  pointer.x = touch.clientX - rect.left;
  pointer.y = touch.clientY - rect.top;
  pointer.active = true;
}

canvas.addEventListener("mousemove", updatePointer);
canvas.addEventListener("touchmove", updatePointer, {passive:false});
canvas.addEventListener("touchstart", updatePointer, {passive:false});
canvas.addEventListener("mousedown", updatePointer);

// =================== LOBBY FUNKSİYALARI ===================
function showGame() {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("game").style.display = "block";
}

function createRoom() {
  const code = Math.floor(1000 + Math.random()*9000).toString();
  document.getElementById("roomCode").value = code;
  connectToRoom(code, "p1");
}

function joinRoom() {
  const code = document.getElementById("roomCode").value.trim();
  if (code.length !== 4 || !/^\d{4}$/.test(code)) {
    document.getElementById("status").innerText = "Düzgün 4 rəqəmli kod daxil edin!";
    return;
  }
  connectToRoom(code, "p2");
}

function connectToRoom(code, side) {
  roomRef = db.ref("rooms/" + code);
  document.getElementById("status").innerText = "Qoşulur...";

  roomRef.child("connected").transaction(current => {
    if (current === null) current = {};
    if (side === "p1" && !current.p1) {
      current.p1 = true;
      return current;
    }
    if (side === "p2" && !current.p2) {
      current.p2 = true;
      return current;
    }
    return; // artıq dolu
  }, (error, committed) => {
    if (error) {
      document.getElementById("status").innerText = "Xəta: " + error.message;
      return;
    }
    if (!committed) {
      document.getElementById("status").innerText = "Bu otaq artıq doludur!";
      roomRef = null;
      return;
    }

    myId = side;
    showGame();
    initGame();
  });
}

// =================== OYUN ===================
function initGame() {
  const myColor   = myId === "p1" ? "#ff3366" : "#33aaff";
  const oppColor  = myId === "p1" ? "#33aaff" : "#ff3366";
  const myStartY  = myId === "p1" ? HEIGHT * 0.18 : HEIGHT * 0.82;

  myPaddle  = new Circle(CENTER_X, myStartY,  PADDLE_R, myColor);
  oppPaddle = new Circle(CENTER_X, HEIGHT - myStartY, PADDLE_R, oppColor);
  puck      = new Circle(CENTER_X, CENTER_Y, PUCK_R, "#ffffff");

  // Başlanğıc vəziyyəti yazırıq (yalnız p1)
  if (myId === "p1") {
    roomRef.set({
      puck: {x: CENTER_X, y: CENTER_Y, vx:0, vy:0},
      p1: {x: CENTER_X, y: myPaddle.y, score:0},
      p2: {x: CENTER_X, y: oppPaddle.y, score:0}
    });
  }

  // Dəyişiklikləri dinlə
  roomRef.on("value", snap => {
    const d = snap.val();
    if (!d) return;

    puck.x  = d.puck?.x ?? CENTER_X;
    puck.y  = d.puck?.y ?? CENTER_Y;
    puck.vx = d.puck?.vx ?? 0;
    puck.vy = d.puck?.vy ?? 0;

    const me   = d[myId];
    const opp  = d[myId === "p1" ? "p2" : "p1"];

    if (me)   scoreMe  = me.score  || 0;
    if (opp)  scoreOpp = opp.score || 0;

    document.getElementById("myScore").innerText  = scoreMe;
    document.getElementById("oppScore").innerText = scoreOpp;

    if (opp) {
      oppPaddle.x = opp.x ?? CENTER_X;
      oppPaddle.y = opp.y ?? (HEIGHT - myStartY);
    }
  });

  requestAnimationFrame(loop);
}

function loop() {
  ctx.fillStyle = "#0a0015";
  ctx.fillRect(0,0,WIDTH,HEIGHT);

  // Orta xətt + qapı xətləri
  ctx.strokeStyle = "#4050ff";
  ctx.lineWidth = 5;
  ctx.shadowColor = "#4050ff";
  ctx.shadowBlur = 20;
  ctx.beginPath();
  ctx.moveTo(0, CENTER_Y); ctx.lineTo(WIDTH, CENTER_Y);
  ctx.moveTo(CENTER_X - GOAL_W/2, 0);      ctx.lineTo(CENTER_X - GOAL_W/2, HEIGHT);
  ctx.moveTo(CENTER_X + GOAL_W/2, 0);      ctx.lineTo(CENTER_X + GOAL_W/2, HEIGHT);
  ctx.stroke();

  // Qapı arxası glow
  ctx.fillStyle = "rgba(180,40,40,0.15)";
  ctx.fillRect(0,0,WIDTH, 40);
  ctx.fillStyle = "rgba(40,80,220,0.15)";
  ctx.fillRect(0, HEIGHT-40, WIDTH, 40);

  puck.draw();
  myPaddle.draw();
  oppPaddle.draw();

  // Öz paddle-ın hərəkəti
  if (pointer.active) {
    const targetX = pointer.x;
    const targetY = pointer.y;

    const minY = myId === "p1" ? PADDLE_R : CENTER_Y;
    const maxY = myId === "p1" ? CENTER_Y : HEIGHT - PADDLE_R;

    myPaddle.x += (targetX - myPaddle.x) * 0.35;
    myPaddle.y += (targetY - myPaddle.y) * 0.35;

    myPaddle.x = Math.max(PADDLE_R, Math.min(WIDTH - PADDLE_R, myPaddle.x));
    myPaddle.y = Math.max(minY, Math.min(maxY, myPaddle.y));

    roomRef.child(myId).update({
      x: Math.round(myPaddle.x * 10) / 10,
      y: Math.round(myPaddle.y * 10) / 10
    });
  }

  // Puck fizikası (yalnız p1 idarə edir)
  if (myId === "p1") {
    puck.x += puck.vx;
    puck.y += puck.vy;

    // Yan divarlar
    if (puck.x < PUCK_R || puck.x > WIDTH - PUCK_R) {
      puck.vx *= -0.97;
      puck.x = Math.max(PUCK_R, Math.min(WIDTH - PUCK_R, puck.x));
    }

    // Qol
    if (puck.y < 0 || puck.y > HEIGHT) {
      const inGoal = Math.abs(puck.x - CENTER_X) < GOAL_W / 2;

      if (inGoal) {
        if ((puck.y < 0 && myId === "p2") || (puck.y > HEIGHT && myId === "p1")) {
          scoreMe++;
          roomRef.child(myId + "/score").set(scoreMe);
        } else {
          scoreOpp++;
          roomRef.child((myId === "p1" ? "p2" : "p1") + "/score").set(scoreOpp);
        }
        resetPuck();
      } else {
        puck.vy *= -0.97;
        puck.y = puck.y < 0 ? 0 : HEIGHT;
      }
    }

    // Toqquşma
    collide(myPaddle);
    collide(oppPaddle);

    // Puck-ı firebase-ə yaz
    roomRef.child("puck").update({
      x: Math.round(puck.x * 10) / 10,
      y: Math.round(puck.y * 10) / 10,
      vx: Math.round(puck.vx * 100) / 100,
      vy: Math.round(puck.vy * 100) / 100
    });
  }

  requestAnimationFrame(loop);
}

function collide(p) {
  const dx = puck.x - p.x;
  const dy = puck.y - p.y;
  const dist = Math.hypot(dx, dy);

  if (dist < PADDLE_R + PUCK_R) {
    const angle = Math.atan2(dy, dx);
    let speed = Math.hypot(puck.vx, puck.vy) * 1.08;

    puck.vx = Math.cos(angle) * speed;
    puck.vy = Math.sin(angle) * speed;

    // paddle sürət effekti
    puck.vx += (p.x - (p.lastX || p.x)) * 0.6;
    puck.vy += (p.y - (p.lastY || p.y)) * 0.6;

    p.lastX = p.x;
    p.lastY = p.y;
  }
}

function resetPuck() {
  puck.x = CENTER_X;
  puck.y = CENTER_Y;
  puck.vx = (Math.random() - 0.5) * 10;
  puck.vy = (Math.random() - 0.5) * 10;
}

</script>
</body>
</html>