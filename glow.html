<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soccer Pro Fixed</title>
    <style>
        * { touch-action: none; -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        body { margin: 0; background: #111; color: white; font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        
        #ui-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .box { background: #222; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #4CAF50; width: 300px; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #444; margin: 10px 0; width: 100%; background: #000; color: #fff; font-size: 16px; }
        button { padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 5px; }
        
        #header-info { position: absolute; top: 10px; width: 100%; text-align: center; font-weight: bold; font-size: 14px; color: #4CAF50; z-index: 10; }
        canvas { background: #1b5e20; border: 4px solid #fff; border-radius: 8px; max-width: 98vw; max-height: 80vh; }
        
        #goal-anim { position: absolute; display: none; font-size: 70px; color: #fff; text-shadow: 0 0 20px #4CAF50; z-index: 60; pointer-events: none; }
    </style>
</head>
<body>

<div id="header-info">KOD: <span id="code-val">-</span> | ROL: <span id="role-val">-</span></div>

<div id="ui-layer">
    <div class="box">
        <h3>⚽ SOCCER ONLINE</h3>
        <input type="text" id="pName" placeholder="Adınız..." maxlength="10">
        <button onclick="initGame(true)">Yeni Oyun</button>
        <div style="margin: 10px; font-size: 12px; color: #666;">və ya</div>
        <input type="text" id="jCode" placeholder="Otaq Kodu...">
        <button onclick="initGame(false)">Qoşul</button>
    </div>
</div>

<div id="goal-anim">GOAL!</div>
<canvas id="gameCanvas"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
        authDomain: "sevgili-testi.firebaseapp.com",
        databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
        projectId: "sevgili-testi"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 400; canvas.height = 600;

    let myRole = null, roomId = null, myName = "";
    let isGoal = false;

    let state = {
        p1: { x: 200, y: 100, name: "" },
        p2: { x: 200, y: 500, name: "" },
        ball: { x: 200, y: 300, vx: 0, vy: 0 },
        score: { p1: 0, p2: 0 }
    };

    window.initGame = (isHost) => {
        myName = document.getElementById('pName').value || "Player";
        roomId = isHost ? Math.random().toString(36).substring(2, 7).toUpperCase() : document.getElementById('jCode').value.toUpperCase();
        if(!roomId) return;

        const roomRef = ref(db, 'games/' + roomId);

        onValue(roomRef, (snap) => {
            const data = snap.val();
            if(!myRole) {
                if(!data) {
                    myRole = 'p1';
                    set(roomRef, state);
                } else {
                    myRole = 'p2';
                }
                document.getElementById('ui-layer').style.display = 'none';
                document.getElementById('code-val').innerText = roomId;
                document.getElementById('role-val').innerText = myRole.toUpperCase();
                bindControls();
            }
            if(data) {
                // Sinxronizasiya
                state.score = data.score;
                state.p1 = data.p1;
                state.p2 = data.p2;
                // Topun kəskin atılmaması üçün hamar ötürmə
                if(myRole === 'p2') {
                    state.ball = data.ball;
                }
            }
        });
        requestAnimationFrame(loop);
    };

    function bindControls() {
        const move = (e) => {
            if(isGoal) return;
            const rect = canvas.getBoundingClientRect();
            const t = e.touches ? e.touches[0] : e;
            const mx = (t.clientX - rect.left) * (canvas.width / rect.width);
            const my = (t.clientY - rect.top) * (canvas.height / rect.height);
            
            update(ref(db, `games/${roomId}/${myRole}`), { 
                x: Math.max(25, Math.min(375, mx)), 
                y: Math.max(25, Math.min(575, my)),
                name: myName 
            });
        };
        window.addEventListener('mousemove', move);
        window.addEventListener('touchmove', (e) => { e.preventDefault(); move(e); }, {passive:false});
    }

    function physics() {
        if(myRole !== 'p1' || isGoal) return;

        let b = state.ball;
        b.x += b.vx; b.y += b.vy;
        b.vx *= 0.98; b.vy *= 0.98; // Sürtünmə

        // Sərhədlər
        if(b.x < 15 || b.x > 385) b.vx *= -1;
        
        // Qapı sahəsi (120-280 arası)
        const inGoal = b.x > 120 && b.x < 280;
        if(!inGoal) {
            if(b.y < 15 || b.y > 585) b.vy *= -1;
        } else {
            if(b.y < -10) { score(2); }
            if(b.y > 610) { score(1); }
        }

        // Toqquşma
        [state.p1, state.p2].forEach(p => {
            const dx = b.x - p.x;
            const dy = b.y - p.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist < 40) {
                const angle = Math.atan2(dy, dx);
                const speed = 7;
                b.vx = Math.cos(angle) * speed;
                b.vy = Math.sin(angle) * speed;
                // Topun içəri girməməsi üçün itələmə
                b.x = p.x + Math.cos(angle) * 41;
                b.y = p.y + Math.sin(angle) * 41;
            }
        });

        update(ref(db, `games/${roomId}/ball`), b);
    }

    function score(p) {
        isGoal = true;
        document.getElementById('goal-anim').style.display = 'block';
        let newScore = {...state.score};
        if(p===1) newScore.p1++; else newScore.p2++;
        
        setTimeout(() => {
            update(ref(db, `games/${roomId}`), {
                score: newScore,
                ball: { x: 200, y: 300, vx: 0, vy: 0 }
            });
            document.getElementById('goal-anim').style.display = 'none';
            isGoal = false;
        }, 2000);
    }

    function draw() {
        ctx.clearRect(0,0,400,600);
        
        // Meydança
        ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = 2;
        ctx.strokeRect(10,10,380,580);
        ctx.beginPath(); ctx.moveTo(10,300); ctx.lineTo(390,300); ctx.stroke();
        ctx.beginPath(); ctx.arc(200,300,50,0,Math.PI*2); ctx.stroke();
        
        // Qapılar
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 8;
        ctx.strokeRect(120, 0, 160, 10); ctx.strokeRect(120, 590, 160, 10);

        // Hesab
        ctx.fillStyle = "rgba(255,255,255,0.1)"; ctx.font = "100px Arial"; ctx.textAlign = "center";
        ctx.fillText(state.score.p1, 200, 250); ctx.fillText(state.score.p2, 200, 420);

        // Top
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(state.ball.x, state.ball.y, 12, 0, Math.PI*2); ctx.fill();
        
        // Oyunçular
        drawP(state.p1.x, state.p1.y, "#ff4444", state.p1.name);
        drawP(state.p2.x, state.p2.y, "#4444ff", state.p2.name);
    }

    function drawP(x, y, c, n) {
        ctx.fillStyle = c; ctx.beginPath(); ctx.arc(x, y, 25, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.stroke();
        ctx.fillStyle = "#fff"; ctx.font = "12px Arial"; ctx.fillText(n, x, y + 40);
    }

    function loop() {
        physics();
        draw();
        requestAnimationFrame(loop);
    }
</script>
</body>
</html>