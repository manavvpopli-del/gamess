<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Glow Air Hockey • Multiplayer</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <style>
    body {
      margin:0; padding:0; height:100vh; background:#0a0015; 
      font-family: Arial, Helvetica, sans-serif; color:#e0f7ff; 
      overflow:hidden; touch-action: none;
    }
    #ui {
      position: absolute; top:0; left:0; right:0; z-index:10;
      padding:10px; display:flex; justify-content:space-between; pointer-events:none;
    }
    #ui > div { pointer-events:auto; background:rgba(0,0,0,0.4); padding:8px 14px; border-radius:8px; }
    canvas { display:block; }
    input, button {
      padding:8px 14px; margin:4px; border:none; border-radius:6px; font-size:16px;
    }
    button { background:#00d4ff; color:black; font-weight:bold; cursor:pointer; }
    button:hover { background:#00ffff; }
    #status { font-size:1.1em; }
  </style>
</head>
<body>

<div id="ui">
  <div>
    <input id="roomInput" placeholder="Otaq kodu (4 rəqəm)" maxlength="4"/>
    <button onclick="joinRoom()">Otağa Qoşul</button>
    <button onclick="createRoom()">Yeni Otaq Yarat</button>
  </div>
  <div id="status">Otaq gözlənilir...</div>
  <div>Sən: <span id="myScore">0</span> – Rəqib: <span id="oppScore">0</span></div>
</div>

<canvas id="c"></canvas>

<script>
// =================== FIREBASE KONFIGURASIYA ===================
const firebaseConfig = {
  apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
  authDomain: "sevgili-testi.firebaseapp.com",
  databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
  projectId: "sevgili-testi",
  storageBucket: "sevgili-testi.firebasestorage.app",
  messagingSenderId: "399260477557",
  appId: "1:399260477557:web:584204a698d7bf145bb03c",
  measurementId: "G-44P21XCZ7G"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// =================== OYUN DƏYİŞƏNLƏRİ ===================
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
let myId = null;           // "p1" və ya "p2"
let roomRef = null;
let myPaddle, oppPaddle, puck;
let scoreMe = 0, scoreOpp = 0;

// Ölçülər ( responsive olacaq )
let WIDTH, HEIGHT, CENTER_X, CENTER_Y, PADDLE_R, PUCK_R, GOAL_W;

function resize() {
  WIDTH = canvas.width = window.innerWidth;
  HEIGHT = canvas.height = window.innerHeight;
  CENTER_X = WIDTH/2;
  CENTER_Y = HEIGHT/2;
  PADDLE_R = Math.max(35, WIDTH*0.04);
  PUCK_R   = Math.max(22, WIDTH*0.025);
  GOAL_W   = WIDTH * 0.18;
}
window.addEventListener("resize", resize);
resize();

// Obyektlər
class Circle {
  constructor(x,y,r,color) {
    this.x = x; this.y = y; this.r = r; this.color = color;
    this.vx = 0; this.vy = 0;
  }
  draw(glow=true) {
    ctx.save();
    ctx.shadowColor = this.color;
    ctx.shadowBlur = glow ? 25 : 0;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
    ctx.fillStyle = this.color;
    ctx.fill();
    ctx.restore();
  }
}

// Mouse / Touch
let touchActive = false;
let mouse = {x:0, y:0};

function updateInput(e) {
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  mouse.x = clientX - rect.left;
  mouse.y = clientY - rect.top;
  touchActive = true;
}

canvas.addEventListener("mousemove", updateInput);
canvas.addEventListener("touchmove", updateInput);
canvas.addEventListener("touchstart", updateInput);
canvas.addEventListener("mousedown", updateInput);
window.addEventListener("touchend", ()=>{touchActive=false;});

// =================== OYUN LİNKİ / LOBBY ===================
function generateRoomCode() {
  return Math.floor(1000 + Math.random()*9000).toString();
}

function createRoom() {
  const code = generateRoomCode();
  roomRef = db.ref("rooms/" + code);
  document.getElementById("roomInput").value = code;
  status("Otaq yaradıldı: " + code + " — Rəqib gözlənilir...");
  initGame("p1");
}

function joinRoom() {
  const code = document.getElementById("roomInput").value.trim();
  if(code.length !== 4) return alert("4 rəqəmli kod daxil edin!");
  
  roomRef = db.ref("rooms/" + code);
  status("Otağa qoşulur...");
  
  roomRef.child("p2").once("value", snap => {
    if(snap.exists()) {
      alert("Bu otaq doludur!");
      status("Otaq dolu.");
      roomRef = null;
    } else {
      initGame("p2");
    }
  });
}

function status(text) {
  document.getElementById("status").innerText = text;
}

// =================== OYUN BAŞLAYIR ===================
function initGame(side) {
  myId = side;
  status(myId === "p1" ? "Sən yuxarı tərəfdəsən (qırmızı)" : "Sən aşağı tərəfdəsən (mavi)");

  // Başlanğıc vəziyyət
  roomRef.set({
    puck: {x: CENTER_X, y: CENTER_Y, vx:0, vy:0},
    p1: {x: CENTER_X, y: HEIGHT*0.15, score:0},
    p2: {x: CENTER_X, y: HEIGHT*0.85, score:0},
    started: true
  });

  // Listener-lər
  roomRef.on("value", snapshot => {
    const data = snapshot.val();
    if(!data) return;

    // Puck
    puck.x = data.puck.x;
    puck.y = data.puck.y;
    puck.vx = data.puck.vx || 0;
    puck.vy = data.puck.vy || 0;

    // Skorlar
    scoreMe = (myId === "p1" ? data.p1.score : data.p2.score) || 0;
    scoreOpp = (myId === "p1" ? data.p2.score : data.p1.score) || 0;
    document.getElementById("myScore").innerText = scoreMe;
    document.getElementById("oppScore").innerText = scoreOpp;

    // Rəqib paddle
    const oppData = myId === "p1" ? data.p2 : data.p1;
    oppPaddle.x = oppData.x;
    oppPaddle.y = oppData.y;
  });

  // Öz paddle-ımızı yaradırıq
  myPaddle = new Circle(CENTER_X, myId==="p1"?HEIGHT*0.15:HEIGHT*0.85, PADDLE_R, myId==="p1"?"#ff3366":"#33ccff");
  oppPaddle = new Circle(CENTER_X, myId==="p1"?HEIGHT*0.85:HEIGHT*0.15, PADDLE_R, myId==="p1"?"#33ccff":"#ff3366");
  puck = new Circle(CENTER_X, CENTER_Y, PUCK_R, "#ffffff");

  requestAnimationFrame(gameLoop);
}

// =================== GAME LOOP ===================
function gameLoop() {
  ctx.fillStyle = "#0a0015";
  ctx.fillRect(0,0,WIDTH,HEIGHT);

  // Masa xətləri (glow)
  ctx.strokeStyle = "#4444ff";
  ctx.lineWidth = 4;
  ctx.shadowColor = "#4444ff";
  ctx.shadowBlur = 15;
  ctx.beginPath();
  ctx.moveTo(0, CENTER_Y); ctx.lineTo(WIDTH, CENTER_Y);
  ctx.moveTo(CENTER_X-GOAL_W/2, 0); ctx.lineTo(CENTER_X-GOAL_W/2, HEIGHT);
  ctx.moveTo(CENTER_X+GOAL_W/2, 0); ctx.lineTo(CENTER_X+GOAL_W/2, HEIGHT);
  ctx.stroke();
  ctx.shadowBlur = 0;

  // Qollar (glow)
  ctx.fillStyle = "rgba(255,50,50,0.3)";
  ctx.fillRect(0,0,WIDTH,10);
  ctx.fillStyle = "rgba(50,100,255,0.3)";
  ctx.fillRect(0,HEIGHT-10,WIDTH,10);

  // Puck + paddles
  puck.draw(true);
  myPaddle.draw(true);
  oppPaddle.draw(true);

  // Input → paddle hərəkəti (özümüzün)
  if(touchActive || mouse.x>0) {
    const targetX = mouse.x;
    const targetY = mouse.y;

    // Öz tərəfimizi məhdudlaşdırırıq
    const minY = myId==="p1" ? 0 : CENTER_Y;
    const maxY = myId==="p1" ? CENTER_Y : HEIGHT;

    myPaddle.x += (targetX - myPaddle.x) * 0.25;
    myPaddle.y += (targetY - myPaddle.y) * 0.25;
    myPaddle.x = Math.max(PADDLE_R, Math.min(WIDTH-PADDLE_R, myPaddle.x));
    myPaddle.y = Math.max(minY + PADDLE_R, Math.min(maxY - PADDLE_R, myPaddle.y));

    // Firebase-ə göndər
    if(roomRef) {
      roomRef.child(myId).update({
        x: Math.round(myPaddle.x*10)/10,
        y: Math.round(myPaddle.y*10)/10
      });
    }
  }

  // Sadə fizika (puck)
  puck.x += puck.vx;
  puck.y += puck.vy;

  // Divar çarpma
  if(puck.x < PUCK_R || puck.x > WIDTH-PUCK_R) {
    puck.vx *= -0.98;
    puck.x = Math.max(PUCK_R, Math.min(WIDTH-PUCK_R, puck.x));
  }

  // Qol yoxlaması
  if(puck.y < 0 || puck.y > HEIGHT) {
    if(Math.abs(puck.x - CENTER_X) < GOAL_W/2) {
      // Qol!
      if((puck.y < 0 && myId==="p2") || (puck.y > HEIGHT && myId==="p1")) {
        scoreMe++;
        roomRef.child(myId + "/score").set(scoreMe);
      } else {
        scoreOpp++;
        roomRef.child((myId==="p1"?"p2":"p1") + "/score").set(scoreOpp);
      }
      resetPuck();
    } else {
      puck.vy *= -0.98;
      puck.y = Math.max(0, Math.min(HEIGHT, puck.y));
    }
  }

  // Paddle ilə toqquşma (sadə radius yoxlaması)
  collide(myPaddle);
  collide(oppPaddle);

  // Firebase-ə puck göndərmək yalnız bir nəfər etməlidir (məsələn p1)
  if(myId === "p1" && roomRef) {
    roomRef.child("puck").update({
      x: Math.round(puck.x*10)/10,
      y: Math.round(puck.y*10)/10,
      vx: Math.round(puck.vx*100)/100,
      vy: Math.round(puck.vy*100)/100
    });
  }

  requestAnimationFrame(gameLoop);
}

function collide(paddle) {
  const dx = puck.x - paddle.x;
  const dy = puck.y - paddle.y;
  const dist = Math.sqrt(dx*dx + dy*dy);

  if(dist < PUCK_R + PADDLE_R) {
    // Toqquşma
    const angle = Math.atan2(dy, dx);
    const speed = Math.sqrt(puck.vx**2 + puck.vy**2) * 1.1;
    puck.vx = Math.cos(angle) * speed;
    puck.vy = Math.sin(angle) * speed;

    // Bir az paddle sürətini də əlavə edək
    puck.vx += (paddle.x - (paddle.x-paddle.vx||0)) * 0.4;
    puck.vy += (paddle.y - (paddle.y-paddle.vy||0)) * 0.4;
  }
}

function resetPuck() {
  puck.x = CENTER_X;
  puck.y = CENTER_Y;
  puck.vx = (Math.random()-0.5)*8;
  puck.vy = (Math.random()-0.5)*8;
}

// Başlanğıc mesajı
status("Yeni otaq yarat və ya mövcud otaq kodunu daxil et →");

</script>
</body>
</html>