<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Soccer Multiplayer</title>
    <style>
        * { touch-action: none; -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        
        #ui-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .box { background: #222; padding: 25px; border-radius: 15px; text-align: center; border: 2px solid #4CAF50; width: 90%; max-width: 320px; }
        input { padding: 12px; border-radius: 8px; border: none; margin: 10px 0; width: 100%; text-align: center; font-size: 16px; }
        button { padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }
        
        canvas { background: #2e7d32; border: 5px solid #fff; box-shadow: 0 0 20px #000; max-width: 100vw; max-height: 85vh; }
        
        #goal-overlay { 
            position: absolute; display: none; font-size: 80px; font-weight: bold; 
            color: #ffeb3b; text-shadow: 0 0 20px #000; z-index: 50;
            animation: bounce 0.5s infinite alternate;
        }
        @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.2); } }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="box">
        <h3>⚽ PRO SOCCER</h3>
        <input type="text" id="playerName" placeholder="Adınız...">
        <button onclick="start(true)">Yeni Oyun Yarat</button>
        <hr style="margin:15px; opacity:0.2">
        <input type="text" id="joinCode" placeholder="Otaq kodu...">
        <button onclick="start(false)">Qoşul</button>
    </div>
</div>

<div id="goal-overlay">GOAL!</div>
<canvas id="gameCanvas"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
        authDomain: "sevgili-testi.firebaseapp.com",
        databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
        projectId: "sevgili-testi"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 400; canvas.height = 650;

    // Səslər (Base64 və ya Web Audio API istifadə etmək olar, bura sadə Audio obyektləri qoyuruq)
    const hitSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3');
    const goalSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2020/2020-preview.mp3');

    let myRole = null, roomId = null, myName = "";
    let isGoalAnimating = false;

    let state = {
        p1: { x: 200, y: 100, name: "" },
        p2: { x: 200, y: 550, name: "" },
        ball: { x: 200, y: 325, vx: 0, vy: 0 },
        score: { p1: 0, p2: 0 },
        lastHit: ""
    };

    window.start = (isHost) => {
        myName = document.getElementById('playerName').value || "Oyuncu";
        roomId = isHost ? Math.random().toString(36).substring(2, 7).toUpperCase() : document.getElementById('joinCode').value.toUpperCase();
        if(!roomId) return;

        const roomRef = ref(db, 'pro_matches/' + roomId);

        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (!myRole) {
                if (!data) {
                    myRole = 'p1';
                    set(roomRef, state);
                } else {
                    myRole = 'p2';
                }
                document.getElementById('ui-layer').style.display = 'none';
                initControls();
            }
            if (data) {
                // Sinxronizasiya: Topun hərəkətini yalnız Host (p1) hesablayır
                // Digər oyunçu (p2) yalnız datanı vizuallaşdırır
                state = data;
                checkGoalAnimation(data.score);
            }
        });

        requestAnimationFrame(gameLoop);
    };

    function initControls() {
        const move = (e) => {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            const mx = (touch.clientX - rect.left) * (canvas.width / rect.width);
            const my = (touch.clientY - rect.top) * (canvas.height / rect.height);
            
            // Meydança sərhədləri daxilində hərəkət
            const limitedX = Math.max(25, Math.min(canvas.width - 25, mx));
            const limitedY = Math.max(25, Math.min(canvas.height - 25, my));

            update(ref(db, `pro_matches/${roomId}/${myRole}`), { x: limitedX, y: limitedY, name: myName });
        };
        canvas.addEventListener('mousemove', move);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); move(e); }, { passive: false });
    }

    function updatePhysics() {
        if (myRole !== 'p1' || isGoalAnimating) return; // Yalnız Host fizikanı idarə edir

        let { ball, p1, p2, score } = state;

        ball.x += ball.vx;
        ball.y += ball.vy;
        ball.vx *= 0.985;
        ball.vy *= 0.985;

        // Divarlar
        if (ball.x < 15 || ball.x > canvas.width - 15) { ball.vx *= -1; hitSound.play(); }

        // Qapı və Qol
        const inGoal = (ball.x > 120 && ball.x < 280);
        if (!inGoal) {
            if (ball.y < 15 || ball.y > canvas.height - 15) { ball.vy *= -1; hitSound.play(); }
        } else {
            if (ball.y < -10) { score.p2++; resetBall(); goalSound.play(); }
            if (ball.y > canvas.height + 10) { score.p1++; resetBall(); goalSound.play(); }
        }

        // Toqquşma
        [p1, p2].forEach(p => {
            const dx = ball.x - p.x;
            const dy = ball.y - p.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 40) {
                hitSound.play();
                const angle = Math.atan2(dy, dx);
                const power = 8;
                ball.vx = Math.cos(angle) * power;
                ball.vy = Math.sin(angle) * power;
            }
        });

        function resetBall() {
            ball = { x: 200, y: 325, vx: 0, vy: 0 };
        }

        update(ref(db, 'pro_matches/' + roomId), { ball, score });
    }

    let prevScore = { p1: 0, p2: 0 };
    function checkGoalAnimation(newScore) {
        if (newScore.p1 !== prevScore.p1 || newScore.p2 !== prevScore.p2) {
            isGoalAnimating = true;
            const overlay = document.getElementById('goal-overlay');
            overlay.style.display = 'block';
            setTimeout(() => {
                overlay.style.display = 'none';
                isGoalAnimating = false;
            }, 2000);
            prevScore = { ...newScore };
        }
    }

    function draw() {
        // Ot Meydança
        ctx.fillStyle = "#2e7d32"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Cizgilər
        ctx.strokeStyle = "rgba(255,255,255,0.6)"; ctx.lineWidth = 3;
        ctx.strokeRect(5, 5, canvas.width-10, canvas.height-10);
        ctx.beginPath(); ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); ctx.stroke();
        ctx.beginPath(); ctx.arc(200, 325, 60, 0, Math.PI*2); ctx.stroke();
        
        // Qapılar
        ctx.strokeStyle = "white"; ctx.lineWidth = 10;
        ctx.strokeRect(120, -5, 160, 10); ctx.strokeRect(120, canvas.height-5, 160, 10);

        // Hesab
        ctx.fillStyle = "rgba(255,255,255,0.2)"; ctx.font = "80px Arial";
        ctx.textAlign = "center";
        ctx.fillText(state.score.p1, 200, 280);
        ctx.fillText(state.score.p2, 200, 420);

        // Oyunçular
        drawPlayer(state.p1.x, state.p1.y, "#e74c3c", state.p1.name);
        drawPlayer(state.p2.x, state.p2.y, "#3498db", state.p2.name);
        
        // Top
        ctx.shadowBlur = 10; ctx.shadowColor = "white";
        ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(state.ball.x, state.ball.y, 12, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
    }

    function drawPlayer(x, y, color, name) {
        ctx.fillStyle = color; ctx.beginPath(); ctx.arc(x, y, 25, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "white"; ctx.lineWidth = 3; ctx.stroke();
        ctx.fillStyle = "white"; ctx.font = "14px Arial"; ctx.fillText(name, x, y + 40);
    }

    function gameLoop() {
        updatePhysics();
        draw();
        requestAnimationFrame(gameLoop);
    }
</script>
</body>
</html>