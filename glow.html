<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fixed Soccer Multiplayer</title>
    <style>
        /* Ekranın hərəkətini tamamilə bloklayırıq */
        * {
            touch-action: none; /* Brauzerin default touch hərəkətlərini söndürür */
            -webkit-user-select: none;
            user-select: none;
        }

        body { 
            margin: 0; 
            padding: 0;
            background: #1a1a1a; 
            color: white; 
            font-family: sans-serif; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; /* Scroll-u tam bağlayır */
            position: fixed; /* Bütün səhifəni sabitləyir */
        }
        
        #ui-layer { 
            position: absolute; 
            inset: 0;
            background: rgba(0, 0, 0, 0.9); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 100; 
        }

        .box { background: #222; padding: 25px; border-radius: 15px; text-align: center; border: 2px solid #4CAF50; width: 80%; max-width: 300px; }
        input { padding: 12px; border-radius: 5px; border: none; margin: 8px 0; width: 90%; text-align: center; font-size: 16px; }
        button { padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 5px; width: 95%; font-weight: bold; margin: 5px 0; }
        
        /* Canvas mobil ölçülərinə uyğunlaşdırıldı */
        canvas { 
            background: #2e7d32; 
            border: 5px solid #fff; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 95vw;
            max-height: 80vh;
            touch-action: none;
        }

        #game-stats { 
            position: absolute; 
            top: 5px; 
            width: 100%; 
            text-align: center; 
            font-size: 12px;
            color: #ccc;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="box">
        <h3>⚽ MOBİL FUTBOL</h3>
        <input type="text" id="playerName" placeholder="Adınız...">
        <button onclick="createNewGame()">Yeni Oyun</button>
        <input type="text" id="joinCode" placeholder="Otaq kodu...">
        <button onclick="joinExistingGame()">Qoşul</button>
    </div>
</div>

<div id="game-stats">
    Otaq: <span id="displayRoom">-</span> | <span id="p1NameDisplay">P1</span> vs <span id="p2NameDisplay">P2</span>
</div>
<canvas id="gameCanvas"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
        authDomain: "sevgili-testi.firebaseapp.com",
        databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
        projectId: "sevgili-testi",
        storageBucket: "sevgili-testi.firebasestorage.app",
        messagingSenderId: "399260477557",
        appId: "1:399260477557:web:584204a698d7bf145bb03c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = 400;
    canvas.height = 600;

    let myRole = null, roomId = null, myName = "";
    let state = {
        p1: { x: 200, y: 80, name: "..." },
        p2: { x: 200, y: 520, name: "..." },
        ball: { x: 200, y: 300, vx: 0, vy: 0 },
        score: { p1: 0, p2: 0 }
    };

    window.createNewGame = () => setupGame(Math.random().toString(36).substring(2, 7).toUpperCase(), 'player1');
    window.joinExistingGame = () => {
        const code = document.getElementById('joinCode').value.trim().toUpperCase();
        if(code) setupGame(code, 'player2');
    };

    function setupGame(code, rolePref) {
        myName = document.getElementById('playerName').value || "Oyuncu";
        roomId = code;
        const roomRef = ref(db, 'matches/' + roomId);

        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (!myRole) {
                if (!data) {
                    myRole = 'player1';
                    set(roomRef, { ...state, p1: { ...state.p1, name: myName }, p1_online: true });
                } else {
                    myRole = 'player2';
                    update(roomRef, { "p2/name": myName, p2_online: true });
                }
                document.getElementById('ui-layer').style.display = 'none';
                document.getElementById('displayRoom').innerText = roomId;
            }
            if (data) state = data;
        });

        // Touch və Mouse üçün vahid idarəetmə funksiyası
        const handleInput = (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const mx = (clientX - rect.left) * (canvas.width / rect.width);
            const my = (clientY - rect.top) * (canvas.height / rect.height);

            if (myRole === 'player1' && my < canvas.height / 2 - 20) {
                update(ref(db, `matches/${roomId}/p1`), { x: mx, y: my, name: myName });
            } else if (myRole === 'player2' && my > canvas.height / 2 + 20) {
                update(ref(db, `matches/${roomId}/p2`), { x: mx, y: my, name: myName });
            }
        };

        canvas.addEventListener('mousemove', handleInput);
        canvas.addEventListener('touchmove', handleInput, { passive: false });
        requestAnimationFrame(gameLoop);
    }

    function updatePhysics() {
        if (myRole !== 'player1') return;
        let { ball, p1, p2, score } = state;

        ball.x += ball.vx; ball.y += ball.vy;
        ball.vx *= 0.98; ball.vy *= 0.98; // Sürtünmə

        // Divarlar
        if (ball.x < 15 || ball.x > canvas.width - 15) ball.vx *= -0.8;
        
        const inGoal = (ball.x > 120 && ball.x < 280);
        if (!inGoal) {
            if (ball.y < 15 || ball.y > canvas.height - 15) ball.vy *= -0.8;
        } else {
            if (ball.y < 0) { score.p2++; ball = {x:200, y:300, vx:0, vy:0}; }
            if (ball.y > canvas.height) { score.p1++; ball = {x:200, y:300, vx:0, vy:0}; }
        }

        // Topla toqquşma
        [p1, p2].forEach(p => {
            const dx = ball.x - p.x, dy = ball.y - p.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 40) {
                const angle = Math.atan2(dy, dx);
                ball.vx = Math.cos(angle) * 7;
                ball.vy = Math.sin(angle) * 7;
            }
        });

        update(ref(db, 'matches/' + roomId), { ball, score });
    }

    function draw() {
        ctx.fillStyle = "#2e7d32"; ctx.fillRect(0,0,400,600);
        
        // Xətlər
        ctx.strokeStyle = "white"; ctx.lineWidth = 2;
        ctx.strokeRect(0,0,400,600);
        ctx.beginPath(); ctx.moveTo(0,300); ctx.lineTo(400,300); ctx.stroke();
        ctx.beginPath(); ctx.arc(200,300,50,0,Math.PI*2); ctx.stroke();

        // Hesab
        ctx.globalAlpha = 0.3; ctx.font = "60px Arial"; ctx.fillStyle = "white";
        ctx.fillText(state.score.p1, 180, 250); ctx.fillText(state.score.p2, 180, 370);
        ctx.globalAlpha = 1.0;

        // Qapılar
        ctx.lineWidth = 6;
        ctx.strokeRect(120, -2, 160, 5); ctx.strokeRect(120, 597, 160, 5);

        // Obyektlər
        drawCircle(state.p1.x, state.p1.y, 22, "#e74c3c");
        drawCircle(state.p2.x, state.p2.y, 22, "#3498db");
        drawCircle(state.ball.x, state.ball.y, 12, "#fff");
    }

    function drawCircle(x, y, r, c) {
        ctx.fillStyle = c; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.stroke();
    }

    function gameLoop() {
        updatePhysics(); draw(); requestAnimationFrame(gameLoop);
    }
</script>
</body>
</html>