<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psixoloji Spektr - Multiplayer</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Poppins', sans-serif;
        }
        
        body { 
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px;
            overflow-x: hidden;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .container { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px; 
            padding: 40px; 
            max-width: 600px; 
            width: 100%; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }
        
        h1 { 
            text-align: center; 
            color: #2d3748; 
            margin-bottom: 10px; 
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: fadeInDown 0.8s ease;
        }
        
        .subtitle {
            text-align: center;
            color: #718096;
            font-size: 14px;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease 0.2s both;
        }
        
        input { 
            width: 100%; 
            padding: 18px 20px; 
            border: 2px solid #e2e8f0; 
            border-radius: 16px; 
            font-size: 16px; 
            margin: 10px 0; 
            text-align: center;
            transition: all 0.3s ease;
            background: #f7fafc;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        button { 
            width: 100%; 
            padding: 18px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            border-radius: 16px; 
            font-size: 16px; 
            font-weight: 600;
            cursor: pointer; 
            margin: 8px 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover:not(:disabled) { 
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(102, 126, 234, 0.4);
        }
        
        button:active:not(:disabled) {
            transform: translateY(-1px) scale(0.98);
        }
        
        button:disabled { 
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .code-box { 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 30px; 
            text-align: center; 
            font-size: 42px; 
            font-weight: 700; 
            letter-spacing: 8px;
            color: #4a5568;
            border-radius: 20px; 
            margin: 20px 0;
            border: 3px dashed #667eea;
            animation: pulse 2s infinite;
            position: relative;
            overflow: hidden;
        }
        
        .code-box::after {
            content: 'üîê';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            opacity: 0.3;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(102, 126, 234, 0); }
        }
        
        .progress-container {
            background: #edf2f7;
            border-radius: 50px;
            padding: 4px;
            margin: 20px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }
        
        .progress-bar { 
            height: 12px; 
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 50px; 
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .question-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.5s ease;
            border-left: 5px solid #667eea;
        }
        
        .question { 
            font-size: 18px; 
            font-weight: 600; 
            color: #2d3748; 
            line-height: 1.6; 
            margin-bottom: 20px;
        }
        
        .question-number {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .answers { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        
        .answer-btn { 
            background: #f7fafc; 
            border: 2px solid #e2e8f0; 
            color: #4a5568; 
            text-align: left; 
            padding: 16px 20px;
            border-radius: 12px; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .answer-btn::before {
            content: '‚óã';
            font-size: 20px;
            color: #cbd5e0;
            transition: all 0.3s ease;
        }
        
        .answer-btn:hover:not(:disabled) { 
            background: #edf2f7; 
            border-color: #667eea;
            transform: translateX(8px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .answer-btn:hover:not(:disabled)::before {
            content: '‚óè';
            color: #667eea;
        }
        
        .answer-btn.selected { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border-color: transparent;
            transform: scale(1.02);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .answer-btn.selected::before {
            content: '‚úì';
            color: white;
        }
        
        .answer-btn:disabled { 
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .status { 
            text-align: center; 
            padding: 16px; 
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #4c51bf;
            border-radius: 12px; 
            margin-top: 20px;
            font-weight: 600;
            display: none;
            animation: fadeIn 0.5s ease;
            border: 2px solid #a5b4fc;
        }
        
        .status.show { display: block; animation: pulse 2s infinite; }
        
        .hidden { display: none !important; }
        
        .result-card {
            background: white;
            border-radius: 24px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.8s ease;
            text-align: center;
        }
        
        .result-icon {
            font-size: 64px;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .result-title {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .result-desc {
            color: #4a5568;
            line-height: 1.8;
            font-size: 15px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 11px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .waiting-anim {
            display: inline-block;
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .player-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #c6f6d5;
            color: #22543d;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 15px;
            animation: fadeIn 0.5s ease;
        }
        
        .player-badge::before {
            content: '‚óè';
            color: #48bb78;
            animation: pulse 2s infinite;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .error-shake {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        @media (max-width: 640px) {
            .container { padding: 25px; }
            h1 { font-size: 24px; }
            .code-box { font-size: 32px; letter-spacing: 5px; }
        }
        
        /* Yeni Dair…ôvi Davam Et D√ºym…ôsi */
        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
        }
        
        .welcome-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .welcome-text {
            color: #4a5568;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 40px;
        }
        
        .circle-btn {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
            transition: all 0.3s ease;
            animation: pulse-scale 2s infinite;
        }
        
        .circle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }
        
        .circle-btn:active {
            transform: scale(0.95);
        }
        
        @keyframes pulse-scale {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            50% { box-shadow: 0 0 0 20px rgba(102, 126, 234, 0); }
        }
        
        .circle-btn span {
            font-size: 24px;
        }
    </style>
</head>
<body>
    <!-- Audio Element -->
    <audio id="bgMusic" loop>
        <source src="mahni.mp3" type="audio/mpeg">
        Sizin brauzeriniz audio elementini d…ôst…ôkl…ômir.
    </audio>

    <div class="container">
        <!-- Yeni Ba≈ülangƒ±√ß Ekranƒ± -->
        <div id="welcome" class="welcome-screen">
            <div class="welcome-icon">üß†</div>
            <h1>Psixoloji Spektr</h1>
            <p class="welcome-text">
                Onlayn birlikd…ô 30 suallƒ±q Professional<br>
                ≈û…ôxsiyy…ôt Analizi
            </p>
            <button class="circle-btn" onclick="startGameAndMusic()">
                <span>‚ñ∂</span>
                <div>Davam Et</div>
            </button>
            <p style="margin-top: 20px; font-size: 12px; color: #a0aec0;">
                Davam et d√ºym…ôsin…ô toxunduqda musiqi ba≈ülayacaq
            </p>
        </div>

        <!-- Menyu (∆èvv…ôlc…ô gizli) -->
        <div id="menu" class="hidden">
            <h1>üß† Psixoloji Spektr</h1>
            <p class="subtitle">Professional multi-dimensional ≈ü…ôxsiyy…ôt analizi</p>
            <button onclick="createRoom()" style="margin-bottom: 15px;">
                <span style="font-size: 20px; margin-right: 8px;">+</span> Yeni Sessiya Yarat
            </button>
            <input type="text" id="roomInput" placeholder="4 r…ôq…ômli kod daxil edin">
            <button onclick="joinRoom()" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                <span style="font-size: 20px; margin-right: 8px;">‚Üí</span> Sessiyaya Qo≈üul
            </button>
            <div id="error" style="color: #e53e3e; text-align: center; margin-top: 15px; font-weight: 600;"></div>
        </div>

        <!-- G√∂zl…ôm…ô -->
        <div id="waiting" class="hidden">
            <h1>üß† Psixoloji Spektr</h1>
            <p style="text-align: center; color: #4a5568; font-weight: 500; margin-top: 20px;">Sessiya kodu:</p>
            <div class="code-box" id="roomCodeDisplay">----</div>
            <p style="text-align: center; color: #718096; font-size: 14px;">
                Bu kodu dostunuzla payla≈üƒ±n<br>
                <span style="font-size: 12px; opacity: 0.7;">(Kod avtomatik kopyalandƒ±)</span>
            </p>
            <div style="text-align: center; margin-top: 25px;">
                <div class="player-badge" id="playerBadge">
                    1/2 Psixoanalitik Hazƒ±r
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px; color: #4a5568; font-size: 14px;">
                R…ôqib g√∂zl…ônilir<span class="waiting-anim">...</span>
            </div>
        </div>

        <!-- Oyun -->
        <div id="game" class="hidden">
            <div class="progress-container">
                <div class="progress-bar" id="progress" style="width: 0%"></div>
            </div>
            
            <div class="question-card">
                <span class="question-number" id="qNum">Sual 1/30</span>
                <div class="question" id="questionText"></div>
            </div>
            
            <div class="answers" id="answers"></div>
            
            <div class="status" id="status">
                üïê R…ôqibin cavabƒ± g√∂zl…ônilir<span class="waiting-anim">...</span>
            </div>
        </div>

        <!-- N…ôtic…ô -->
        <div id="result" class="hidden">
            <div class="result-card">
                <div class="result-icon" id="resultIcon">üéØ</div>
                <div class="result-title" id="resultTitle">Analiz Hazƒ±rlanƒ±r</div>
                <div class="result-desc" id="resultDesc"></div>
                
                <div class="stats-grid" id="statsGrid"></div>
                
                <div style="background: #ebf8ff; border-left: 4px solid #4299e1; padding: 15px; border-radius: 8px; text-align: left; margin: 20px 0; font-size: 14px; color: #2c5282; line-height: 1.6;" id="adviceBox">
                </div>
                
                <button onclick="location.reload()" style="margin-top: 10px;">
                    Yeni Analiz
                </button>
            </div>
        </div>
    </div>

    <script>
        // S∆èNƒ∞N FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
            authDomain: "sevgili-testi.firebaseapp.com",
            databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
            projectId: "sevgili-testi",
            storageBucket: "sevgili-testi.firebasestorage.app",
            messagingSenderId: "399260477557",
            appId: "1:399260477557:web:584204a698d7bf145bb03c",
            measurementId: "G-44P21XCZ7G"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomId = null;
        let playerId = 'player_' + Math.random().toString(36).substr(2, 9);
        let currentQ = 0;
        let isHost = false;

        const bgMusic = document.getElementById('bgMusic');
        
        function startGameAndMusic() {
            // Musiqini 100% s…ôsl…ô ba≈ülat
            bgMusic.volume = 1.0;
            bgMusic.play().catch(e => {
                console.log("Musiqi oxutmaq m√ºmk√ºn olmadƒ±:", e);
            });
            
            // Welcome gizl…ôt, Menyu g√∂st…ôr
            document.getElementById('welcome').classList.add('hidden');
            document.getElementById('menu').classList.remove('hidden');
        }

        // PROFESSIONAL PSIXOLOJI TEST SUALLARI (Big Five Modeli …ôsaslƒ±)
        const questions = [
            // A√áIQLIQ (Openness)
            { category: "openness", q: "Yeni v…ô tanƒ±≈ü olmadƒ±ƒüƒ±m situasiyalara rahatlƒ±qla uyƒüunla≈üƒ±ram.", a: ["Tamamil…ô razƒ±yam", "Razƒ±yam", "Qism…ôn razƒ±yam", "Razƒ± deyil…ôm"] },
            { category: "openness", q: "ƒ∞magine edilmi≈ü v…ô ya fantastik hekay…ôl…ôr m…ôn…ô cazib…ôdar g…ôlir.", a: ["H…ômi≈ü…ô", "Ad…ôt…ôn", "B…ôz…ôn", "Nadir hallarda"] },
            { category: "openness", q: "ƒ∞nc…ôs…ôn…ôt galeriyasƒ± v…ô ya muzey ziyar…ôti m…ôni h…ôyacanlandƒ±rƒ±r.", a: ["√áox h…ôyacanlandƒ±rƒ±r", "Maraqlƒ±dƒ±r", "T…ôsirsiz", "Sƒ±xƒ±cƒ±dƒ±r"] },
            { category: "openness", q: "Q…ôlibl…ôr…ô sƒ±ƒümayan, orijinal ideyalar √ºretm…ôyi sevir…ôm.", a: ["H…ômi≈ü…ô", "Tez-tez", "B…ôz…ôn", "Nadir…ôn"] },
            { category: "openness", q: "M√º…ôyy…ôn bir m√∂vzuda d…ôrin bilik …ôld…ô etm…ôk √º√ß√ºn saatlarla ara≈üdƒ±rma ed…ô bil…ôr…ôm.", a: ["Tez-tez edir…ôm", "B…ôz…ôn edir…ôm", "Nadir…ôn", "He√ß etmir…ôm"] },
            { category: "openness", q: "M√ºxt…ôlif m…ôd…ôniyy…ôtl…ôrin qaydalarƒ± m…ôn…ô q…ôrib…ô g√∂r√ºns…ô d…ô, h√∂rm…ôtl…ô yana≈üƒ±ram.", a: ["Tam h√∂rm…ôt", "Ad…ôt…ôn h√∂rm…ôt", "Asan deyil", "√á…ôtinl…ô≈üir"] },
            
            // Vƒ∞CdanLILIQ (Conscientiousness)
            { category: "conscientiousness", q: "Tap≈üƒ±rƒ±qlarƒ± son d…ôqiq…ôy…ô saxlamaqdansa, planlƒ± ≈ü…ôkild…ô vaxtƒ±nda bitirm…ôyi √ºst√ºn tuturam.", a: ["H…ômi≈ü…ô bel…ôdir", "Ad…ôt…ôn bel…ôdir", "B…ôz…ôn", "√á…ôtindir"] },
            { category: "conscientiousness", q: "Detallara diqq…ôt yetirm…ôk m…ônim √º√ß√ºn t…ôbii bacarƒ±qdƒ±r.", a: ["√áox t…ôbii", "T…ôbii", "Orta s…ôviyy…ôd…ô", "√á…ôtindir"] },
            { category: "conscientiousness", q: "√ñhd…ôlikl…ôrimi yerin…ô yetirm…ôk ≈ü…ôxsi ≈ü…ôr…ôf m…ôs…ôl…ômdir.", a: ["Tamamil…ô", "B…ôli", "Qism…ôn", "F…ôrq etmir"] },
            { category: "conscientiousness", q: "ƒ∞≈üimi bitirm…ôd…ôn …ôyl…ônc…ôy…ô vaxt ayƒ±rmam.", a: ["He√ß vaxt", "Nadir…ôn", "B…ôz…ôn", "Tez-tez"] },
            { category: "conscientiousness", q: "E≈üyalarƒ±mƒ± v…ô fikirl…ôrimi sistemli ≈ü…ôkild…ô t…ô≈ükil etm…ôyi sevir…ôm.", a: ["H…ômi≈ü…ô", "Ad…ôt…ôn", "B…ôz…ôn", "Sevmir…ôm"] },
            { category: "conscientiousness", q: "H…ôd…ôf…ô √ßatmaq √º√ß√ºn lazƒ±mi q…ôd…ôr √ßalƒ±≈ümaq, istedaddan vacibdir.", a: ["Tam razƒ±", "Razƒ±", "Qism…ôn", "Razƒ± deyil…ôm"] },
            
            // EKSTRAVERSIJA (Extraversion)
            { category: "extraversion", q: "B√∂y√ºk qruplarƒ±n i√ß…ôrisind…ô √∂z√ºm√º enerjili hiss edir…ôm.", a: ["H…ômi≈ü…ô", "Ad…ôt…ôn", "Nadir…ôn", "He√ß vaxt"] },
            { category: "extraversion", q: "Tanƒ±≈ü olmadƒ±ƒüƒ±m insanlarla s√∂hb…ôt…ô ba≈ülamaq m…ôn…ô √ß…ôtinlik yaratmƒ±r.", a: ["Asandƒ±r", "Ad…ôt…ôn asan", "√á…ôtindir", "√áox √ß…ôtindir"] },
            { category: "extraversion", q: "Hadis…ôl…ôrin m…ôrk…ôzind…ô olmaq m…ôni h…ôyacanlandƒ±rƒ±r.", a: ["√áox", "B…ôli", "Orta", "Yox"] },
            { category: "extraversion", q: "Yalnƒ±z qaldƒ±qda tez-tez sƒ±xƒ±lƒ±r v…ô sosial …ôlaq…ô axtarƒ±rƒ±m.", a: ["H…ômi≈ü…ô", "Tez-tez", "Nadir…ôn", "He√ß vaxt"] },
            { category: "extraversion", q: "Stranger (tanƒ±madƒ±ƒüƒ±m) insanlarla s√∂hb…ôt zamanƒ± √∂z√ºm√º ifad…ô etm…ôkd…ôn √ß…ôkinm…ôm.", a: ["He√ß √ß…ôkinmir…ôm", "Az √ß…ôkinir…ôm", "√á…ôkinir…ôm", "√áox √ß…ôkinir…ôm"] },
            { category: "extraversion", q: "H…ôyat dolu v…ô enerjiy…ô tama≈üa√ßƒ±lƒ±qdan z√∂vq almaqdan √ßox, aktiv i≈ütirak etm…ôk ist…ôyir…ôm.", a: ["Tamamil…ô", "B…ôli", "F…ôrq etm…ôz", "Tama≈üa√ßƒ±lƒ±q kifay…ôtdir"] },
            
            // XO≈ûG√ñR√úL√úL√úK (Agreeableness)
            { category: "agreeableness", q: "Ba≈üqalarƒ±nƒ±n hissl…ôrini anlamaƒüa √ßalƒ±≈ümaq m…ônim √º√ß√ºn √∂n…ômlidir.", a: ["H…ômi≈ü…ô", "Ad…ôt…ôn", "B…ôz…ôn", "Nadir…ôn"] },
            { category: "agreeableness", q: "M√ºbahis…ôl…ôrd…ô qalib g…ôlm…ôkd…ôn vacib olan, m√ºnasib…ôtl…ôri qorumaqdƒ±r.", a: ["Tamamil…ô", "B…ôli", "B…ôzi hallarda", "Yox"] },
            { category: "agreeableness", q: "Ba≈üqalarƒ±nƒ±n probleml…ôrini dinl…ôm…ôk v…ô d…ôst…ôk olmaq m…ôn…ô m…ôn…ôvi rahatlƒ±q verir.", a: ["√áox verir", "Verir", "Neytral", "Yorucudur"] },
            { category: "agreeableness", q: "ƒ∞nsanlara g√ºv…ônm…ôk m…ôni …ôsla pis v…ôziyy…ôt…ô salmayƒ±b.", a: ["He√ß vaxt", "Nadir…ôn", "B…ôz…ôn", "Tez-tez"] },
            { category: "agreeableness", q: "Komanda i≈üind…ô ba≈üqalarƒ±nƒ±n fikirl…ôrini √∂z fikirl…ôrimd…ôn √ºst√ºn tuta bil…ôr…ôm.", a: ["H…ômi≈ü…ô", "Ad…ôt…ôn", "B…ôz…ôn", "√á…ôtindir"] },
            { category: "agreeableness", q: "Kims…ô incidils…ô, onun yerin…ô √∂z√ºm√º qoyur v…ô hiss edir…ôm.", a: ["D…ôrhal", "Tez", "Sonra", "√á…ôtin"] },
            
            // NEVROTIZM (Neuroticism)
            { category: "neuroticism", q: "Ki√ßik probleml…ôr bel…ô m…ôni asanlƒ±qla v…ôr…ôq √ßƒ±xara bilir.", a: ["H…ômi≈ü…ô", "Tez-tez", "Nadir…ôn", "He√ß vaxt"] },
            { category: "neuroticism", q: "T…ônqid edildiyimd…ô √∂z√ºm√º m√ºdafi…ô etm…ôkd…ôns…ô, d…ôrhal √ºz√ºl√ºr…ôm.", a: ["H…ômi≈ü…ô", "Ad…ôt…ôn", "B…ôz…ôn", "Nadir…ôn"] },
            { category: "neuroticism", q: "G…ôl…ôc…ôkd…ô n…ô olacaƒüƒ± bar…ôd…ô narahatlƒ±q hissi tez-tez m…ôni …ôl…ô alƒ±r.", a: ["H…ôr g√ºn", "Tez-tez", "Nadir…ôn", "He√ß vaxt"] },
            { category: "neuroticism", q: "Stresli situasiyada sakin qalmaq …ôv…ôzin…ô, emosional reaksiya verir…ôm.", a: ["H…ômi≈ü…ô", "Ad…ôt…ôn", "B…ôz…ôn", "Nadir…ôn"] },
            { category: "neuroticism", q: "Ke√ßmi≈üd…ôki pis xatir…ôl…ôr tez-tez yadƒ±ma d√º≈ü√ºr v…ô m…ôni narahat edir.", a: ["H…ômi≈ü…ô", "Tez-tez", "Nadir…ôn", "He√ß vaxt"] },
            { category: "neuroticism", q: "G√∂zl…ônilm…ôz hadis…ôl…ôr m…ôn √ßox stres edir v…ô √ß…ôtinlikl…ô adaptasiya oluram.", a: ["Tamamil…ô", "B…ôli", "Qism…ôn", "Asanlƒ±qla uyƒüunla≈üƒ±ram"] }
        ];

        function createRoom() {
            roomId = Math.floor(1000 + Math.random() * 9000).toString();
            isHost = true;
            
            db.ref('rooms/' + roomId).set({
                createdAt: Date.now(),
                currentQuestion: 0,
                started: false,
                finished: false,
                players: {
                    [playerId]: { 
                        joined: Date.now(), 
                        answers: {},
                        ready: false,
                        lastActive: Date.now()
                    }
                }
            }).then(() => {
                navigator.clipboard.writeText(roomId);
                
                document.getElementById('menu').classList.add('hidden');
                document.getElementById('waiting').classList.remove('hidden');
                document.getElementById('roomCodeDisplay').textContent = roomId;
                
                listenRoom();
            });
        }

        function joinRoom() {
            roomId = document.getElementById('roomInput').value.trim();
            
            if (!roomId || roomId.length !== 4 || !/^\d{4}$/.test(roomId)) {
                showError("4 r…ôq…ômli d√ºzg√ºn kod daxil edin!");
                return;
            }

            db.ref('rooms/' + roomId).once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    showError("Bel…ô bir sessiya tapƒ±lmadƒ±!");
                    return;
                }
                
                const data = snapshot.val();
                const playerCount = Object.keys(data.players || {}).length;
                
                if (playerCount >= 2) {
                    showError("Bu sessiya artƒ±q doludur!");
                    return;
                }
                
                if (data.finished) {
                    showError("Bu sessiya artƒ±q bitib!");
                    return;
                }

                db.ref('rooms/' + roomId + '/players/' + playerId).set({
                    joined: Date.now(),
                    answers: {},
                    ready: false,
                    lastActive: Date.now()
                });
                
                document.getElementById('menu').classList.add('hidden');
                document.getElementById('waiting').classList.remove('hidden');
                document.getElementById('roomCodeDisplay').textContent = roomId;
                document.querySelector('#waiting p').innerHTML = "Sessiyaya uƒüurla qo≈üuldunuz!<br><small>G√∂zl…ôyin...</small>";
                
                listenRoom();
            });
        }

        function showError(msg) {
            const errDiv = document.getElementById('error');
            errDiv.textContent = msg;
            errDiv.parentElement.classList.add('error-shake');
            setTimeout(() => {
                errDiv.parentElement.classList.remove('error-shake');
            }, 500);
        }

        function listenRoom() {
            db.ref('rooms/' + roomId).on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                
                const players = data.players || {};
                const playerCount = Object.keys(players).length;
                
                const badge = document.getElementById('playerBadge');
                if (playerCount === 2) {
                    badge.innerHTML = `‚óè 2/2 Psixoanalitik Hazƒ±r`;
                    badge.style.background = '#c6f6d5';
                    badge.style.color = '#22543d';
                }
                
                if (playerCount === 2 && !data.started && data.currentQuestion === 0) {
                    setTimeout(() => {
                        db.ref('rooms/' + roomId).update({ started: true });
                    }, 1500);
                }
                
                if (data.started && !document.getElementById('game').classList.contains('hidden') === false && !data.finished) {
                    if (document.getElementById('waiting').classList.contains('hidden') === false) {
                        setTimeout(startGame, 800);
                    }
                }
                
                if (data.started && data.currentQuestion !== currentQ && data.currentQuestion < questions.length) {
                    if (data.currentQuestion > currentQ) {
                        currentQ = data.currentQuestion;
                        showQuestion(currentQ);
                    }
                }
                
                if (data.finished) {
                    showResult();
                }
                
                if (data.started && currentQ < questions.length && !data.finished) {
                    checkAnswers(players);
                }
            });
        }

        function startGame() {
            document.getElementById('waiting').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            showQuestion(0);
        }

        function showQuestion(index) {
            currentQ = index;
            const q = questions[index];
            
            const percent = ((index + 1) / questions.length) * 100;
            document.getElementById('progress').style.width = percent + '%';
            
            const card = document.querySelector('.question-card');
            if (card) {
                card.style.animation = 'none';
                setTimeout(() => card.style.animation = 'slideUp 0.5s ease', 10);
            }
            
            document.getElementById('qNum').textContent = `Sual ${index + 1}/${questions.length}`;
            document.getElementById('questionText').textContent = q.q;
            document.getElementById('status').classList.remove('show');
            
            const container = document.getElementById('answers');
            container.innerHTML = '';
            
            q.a.forEach((ans, idx) => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.innerHTML = `<span>${ans}</span>`;
                btn.onclick = () => submitAnswer(idx, btn);
                container.appendChild(btn);
            });
        }

        function submitAnswer(answerIndex, btn) {
            if (btn.disabled) return;
            
            document.querySelectorAll('.answer-btn').forEach(b => {
                b.classList.remove('selected');
                b.disabled = true;
            });
            btn.classList.add('selected');
            btn.disabled = false;
            
            db.ref(`rooms/${roomId}/players/${playerId}/answers/${currentQ}`).set({
                answer: answerIndex,
                category: questions[currentQ].category,
                timestamp: Date.now()
            });
            
            db.ref(`rooms/${roomId}/players/${playerId}/ready`).set(true);
            
            document.getElementById('status').classList.add('show');
        }

        function checkAnswers(players) {
            const playerList = Object.values(players);
            if (playerList.length < 2) return;
            
            const allReady = playerList.every(p => p.ready === true);
            
            if (allReady) {
                playerList.forEach((p, idx) => {
                    const pid = Object.keys(players)[idx];
                    db.ref(`rooms/${roomId}/players/${pid}/ready`).set(false);
                });
                
                if (isHost) {
                    setTimeout(() => {
                        const nextQ = currentQ + 1;
                        if (nextQ < questions.length) {
                            db.ref(`rooms/${roomId}/currentQuestion`).set(nextQ);
                        } else {
                            db.ref(`rooms/${roomId}/finished`).set(true);
                        }
                    }, 1000);
                }
            }
        }

        function showResult() {
            document.getElementById('game').classList.add('hidden');
            document.getElementById('result').classList.remove('hidden');
            
            db.ref(`rooms/${roomId}/players/${playerId}/answers`).once('value').then((snapshot) => {
                const answers = snapshot.val() || {};
                analyzeResult(Object.values(answers));
            });
        }

        function analyzeResult(answerData) {
            let scores = {
                openness: 0,
                conscientiousness: 0,
                extraversion: 0,
                agreeableness: 0,
                neuroticism: 0
            };
            
            answerData.forEach((data) => {
                if (!data || !data.category) return;
                const value = 3 - data.answer;
                scores[data.category] += value;
            });
            
            const maxScore = 18;
            const percentages = {
                openness: Math.round((scores.openness / maxScore) * 100),
                conscientiousness: Math.round((scores.conscientiousness / maxScore) * 100),
                extraversion: Math.round((scores.extraversion / maxScore) * 100),
                agreeableness: Math.round((scores.agreeableness / maxScore) * 100),
                neuroticism: Math.round((scores.neuroticism / maxScore) * 100)
            };
            
            let dominant = 'openness';
            let maxVal = -1;
            
            const adjustedScores = {...percentages};
            adjustedScores.neuroticism = 100 - adjustedScores.neuroticism;
            
            Object.keys(adjustedScores).forEach(key => {
                if (adjustedScores[key] > maxVal && key !== 'neuroticism') {
                    maxVal = adjustedScores[key];
                    dominant = key;
                }
            });
            
            if (percentages.neuroticism > 70 && adjustedScores.neuroticism < maxVal) {
                dominant = 'neuroticism';
            }
            
            const profiles = {
                openness: {
                    icon: "üé®",
                    title: "Yaradƒ±cƒ± Visioner",
                    desc: "Siz t…ôcr√ºb…ôy…ô son d…ôr…ôc…ô a√ßƒ±qsƒ±nƒ±z. ƒ∞magination g√ºc√ºn√ºz y√ºks…ôk, m√ºxt…ôlif m…ôd…ôniyy…ôtl…ôr…ô v…ô inc…ôs…ôn…ôt…ô d…ôrin maraƒüƒ±nƒ±z var. Adi h…ôll…ôr sizi qane etmir, orijinal yollar axtarƒ±rsƒ±nƒ±z.",
                    advice: "Yaradƒ±cƒ±lƒ±ƒüƒ±nƒ±zƒ± praktik i≈ül…ôr…ô y√∂n…ôltm…ôk √º√ß√ºn realistl…ôr il…ô …ôm…ôkda≈ülƒ±q edin.",
                    color: "#9f7aea"
                },
                conscientiousness: {
                    icon: "üìã",
                    title: "Perfeksionist Strateq",
                    desc: "Nizam-intizam sizin √º√ß√ºn t…ôbii haldƒ±r. Detallara diqq…ôtiniz v…ô planlƒ± i≈ül…ôm…ô qabiliyy…ôtiniz y√ºks…ôk s…ôviyy…ôd…ôdir. √ñhd…ôlikl…ôrinizi d…ôqiq yerin…ô yetirirsiniz.",
                    advice: "B…ôz…ôn 'kifay…ôt q…ôd…ôr yax≈üƒ±' kriteriyasƒ±nƒ± q…ôbul edin, perfeksionizm sizi yora bil…ôr.",
                    color: "#4299e1"
                },
                extraversion: {
                    icon: "‚òÄÔ∏è",
                    title: "Enerjik Lider",
                    desc: "Sosial situasiyalar siz…ô enerji verir. Ba≈üqalarƒ± il…ô √ºnsiyy…ôt sizin g√ºc m…ônb…ôyinizdir. Pozitivliyiniz v…ô aktivliyiniz il…ô …ôtrafƒ±nƒ±zdakƒ±larƒ± motivasiya edirsiniz.",
                    advice: "Yalnƒ±z qaldƒ±ƒüƒ±nƒ±z vaxtlarƒ± da d…ôy…ôrl…ôndirin, daxili d√ºnyanƒ±zƒ± k…ô≈üf edin.",
                    color: "#ed8936"
                },
                agreeableness: {
                    icon: "üïäÔ∏è",
                    title: "Empatik Harmonist",
                    desc: "Ba≈üqalarƒ±nƒ±n hissl…ôrini d…ôrind…ôn anayƒ±rsƒ±nƒ±z. ∆èm…ôkda≈ülƒ±q v…ô harmoniya sizin √º√ß√ºn √∂n…ômlidir. M√ºnaqi≈ü…ôl…ôrd…ô vasit…ô√ßi rolunu √∂z √ºz…ôriniz…ô g√∂t√ºr√ºrs√ºn√ºz.",
                    advice: "Ba≈üqalarƒ±na k√∂m…ôk ed…ôrk…ôn √∂z ehtiyaclarƒ±nƒ±zƒ± da unutmayƒ±n, 'hayƒ±r' dem…ôyi √∂yr…ônin.",
                    color: "#48bb78"
                },
                neuroticism: {
                    icon: "üåä",
                    title: "D…ôrin Hiss Ed…ôn",
                    desc: "Emosiyalarƒ±nƒ±zƒ± d…ôrin v…ô intense ya≈üayƒ±rsƒ±nƒ±z. Detallara h…ôssas yana≈ümanƒ±z b…ôz…ôn narahatlƒ±q yaratsa da, bu sizi inc…ôs…ôn…ôtd…ô v…ô empatiyada g√ºcl√º edir.",
                    advice: "N…ôf…ôs m…ô≈üql…ôri v…ô mindfulness texnikalarƒ± il…ô emosional balans saxlamaƒüa √ßalƒ±≈üƒ±n.",
                    color: "#e53e3e"
                }
            };
            
            const p = profiles[dominant];
            
            document.getElementById('resultIcon').textContent = p.icon;
            document.getElementById('resultTitle').textContent = p.title;
            document.getElementById('resultTitle').style.color = p.color;
            document.getElementById('resultDesc').textContent = p.desc;
            document.getElementById('adviceBox').innerHTML = `<strong>üí° Psixoloji M…ôsl…ôh…ôt:</strong> ${p.advice}`;
            
            const statsHtml = `
                <div class="stat-item">
                    <div class="stat-value">${percentages.openness}%</div>
                    <div class="stat-label">A√ßƒ±qlƒ±q</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${percentages.conscientiousness}%</div>
                    <div class="stat-label">Vicdanlƒ±lƒ±q</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${percentages.extraversion}%</div>
                    <div class="stat-label">Ekstraversiya</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${percentages.agreeableness}%</div>
                    <div class="stat-label">Xo≈üg√∂r√ºl√ºl√ºk</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${100 - percentages.neuroticism}%</div>
                    <div class="stat-label">Stabilite</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${percentages.neuroticism}%</div>
                    <div class="stat-label">H…ôssaslƒ±q</div>
                </div>
            `;
            document.getElementById('statsGrid').innerHTML = statsHtml;
        }
        
        window.onbeforeunload = function() {
            if (roomId) {
                db.ref(`rooms/${roomId}/players/${playerId}`).remove();
            }
        };
    </script>
</body>
</html>
