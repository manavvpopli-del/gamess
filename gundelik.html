<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <title>Online Pong - 2 Player (PeerJS)</title>
  <style>
    body { margin:0; background:#111; font-family:Arial, sans-serif; color:#0f0; text-align:center; }
    canvas { border:2px solid #0f0; background:#000; display:block; margin:20px auto; }
    #controls { margin:20px; }
    input, button { padding:8px 16px; font-size:16px; margin:5px; }
    #status { font-size:18px; margin:10px; color:#ff0; }
  </style>
</head>
<body>

  <h2>Online Pong - İki nəfər</h2>
  <p id="status">Status: Hazırlanır...</p>

  <div id="controls">
    <button onclick="createHost()">Host ol (ID yarat)</button>
    <br><br>
    <input id="peerIdInput" placeholder="Dostunun ID-sini buraya yapışdır" />
    <button onclick="joinGame()">Qoşul</button>
  </div>

  <canvas id="game" width="800" height="500"></canvas>

  <!-- PeerJS CDN -->
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const status = document.getElementById('status');

    // Oyun dəyişənləri
    let ball = { x: 400, y: 250, dx: 5, dy: 4, radius: 12 };
    let paddle1 = { x: 20, y: 200, w: 15, h: 100, speed: 8 };  // Sol (Host)
    let paddle2 = { x: 765, y: 200, w: 15, h: 100, speed: 8 }; // Sağ
    let score1 = 0;
    let score2 = 0;

    let myRole = null;          // 'host' və ya 'guest'
    let conn = null;            // PeerJS bağlantısı
    let peer = null;
    let myId = '';

    // Klaviatura
    const keys = {};
    window.addEventListener('keydown', e => keys[e.key] = true);
    window.addEventListener('keyup',   e => keys[e.key] = false);

    // Host yarat
    function createHost() {
      peer = new Peer();  // avtomatik ID yaradır

      peer.on('open', id => {
        myId = id;
        myRole = 'host';
        status.innerHTML = `Host ID: <strong>${id}</strong><br>Dostuna bu ID-ni göndər!`;
        document.getElementById('controls').style.display = 'none';
      });

      peer.on('connection', connection => {
        conn = connection;
        conn.on('open', () => {
          status.innerHTML = 'Əlaqə quruldu! Oyun başlayır...';
          gameLoop();
        });

        conn.on('data', data => {
          if (data.type === 'paddle') {
            paddle2.y = data.y;
          }
        });
      });
    }

    // Qoşul
    function joinGame() {
      const hostId = document.getElementById('peerIdInput').value.trim();
      if (!hostId) return alert('ID yaz!');

      peer = new Peer();  // guest də öz ID-si olur, amma istifadə etmirik

      peer.on('open', myPeerId => {
        conn = peer.connect(hostId);

        conn.on('open', () => {
          myRole = 'guest';
          status.innerHTML = 'Qoşuldun! Oyun başlayır...';
          document.getElementById('controls').style.display = 'none';
          gameLoop();
        });

        conn.on('data', data => {
          if (data.type === 'paddle') {
            paddle1.y = data.y;
          } else if (data.type === 'ball') {
            ball.x = data.x;
            ball.y = data.y;
            ball.dx = data.dx;
            ball.dy = data.dy;
          } else if (data.type === 'score') {
            score1 = data.s1;
            score2 = data.s2;
          }
        });
      });
    }

    function sendMyPaddle() {
      if (!conn || !conn.open) return;
      const paddle = myRole === 'host' ? paddle1 : paddle2;
      conn.send({ type: 'paddle', y: paddle.y });
    }

    function gameLoop() {
      // Klaviatura ilə hərəkət (hər iki tərəf öz raketini idarə edir)
      if (myRole === 'host') {
        if (keys['w'] || keys['W']) paddle1.y -= paddle1.speed;
        if (keys['s'] || keys['S']) paddle1.y += paddle1.speed;
      } else {
        if (keys['ArrowUp'])    paddle2.y -= paddle2.speed;
        if (keys['ArrowDown'])  paddle2.y += paddle2.speed;
      }

      // Sərhədlər
      paddle1.y = Math.max(0, Math.min(canvas.height - paddle1.h, paddle1.y));
      paddle2.y = Math.max(0, Math.min(canvas.height - paddle2.h, paddle2.y));

      // Top hərəkəti (yalnız Host hesablayır, sonra guest-ə göndərir)
      if (myRole === 'host') {
        ball.x += ball.dx;
        ball.y += ball.dy;

        // Divarlara dəyəndə
        if (ball.y <= 0 || ball.y >= canvas.height) ball.dy *= -1;

        // Raketka collision
        if (ball.x <= paddle1.x + paddle1.w && ball.y > paddle1.y && ball.y < paddle1.y + paddle1.h) {
          ball.dx *= -1.05;  // sürət artır
        }
        if (ball.x >= paddle2.x - paddle2.w && ball.y > paddle2.y && ball.y < paddle2.y + paddle2.h) {
          ball.dx *= -1.05;
        }

        // Qol
        if (ball.x < 0) {
          score2++;
          resetBall();
        }
        if (ball.x > canvas.width) {
          score1++;
          resetBall();
        }

        // Göndər
        conn.send({ type: 'ball', x: ball.x, y: ball.y, dx: ball.dx, dy: ball.dy });
        conn.send({ type: 'score', s1: score1, s2: score2 });
      }

      sendMyPaddle();

      // Çək
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Orta xətt
      ctx.strokeStyle = '#333';
      ctx.setLineDash([10, 10]);
      ctx.beginPath();
      ctx.moveTo(canvas.width/2, 0);
      ctx.lineTo(canvas.width/2, canvas.height);
      ctx.stroke();

      // Raketkalar
      ctx.fillStyle = '#0f0';
      ctx.fillRect(paddle1.x, paddle1.y, paddle1.w, paddle1.h);
      ctx.fillRect(paddle2.x, paddle2.y, paddle2.w, paddle2.h);

      // Top
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
      ctx.fillStyle = '#ff0';
      ctx.fill();

      // Skor
      ctx.font = 'bold 60px Arial';
      ctx.fillStyle = '#0f0';
      ctx.fillText(score1, canvas.width/2 - 80, 80);
      ctx.fillText(score2, canvas.width/2 + 40, 80);

      requestAnimationFrame(gameLoop);
    }

    function resetBall() {
      ball.x = canvas.width / 2;
      ball.y = canvas.height / 2;
      ball.dx = (Math.random() > 0.5 ? 5 : -5);
      ball.dy = (Math.random() * 6 - 3);
    }

    status.innerHTML = 'Host ol və ya dostunun ID-sini yazaraq qoşul!';
  </script>
</body>
</html>