<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Video Extractor - Virtual Browser</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0a0a0a;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        /* Login */
        #login {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .login-box {
            background: rgba(255,255,255,0.95);
            padding: 40px;
            border-radius: 24px;
            max-width: 480px;
            width: 90%;
            color: #1f2937;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .tabs { display: flex; gap: 10px; margin: 24px 0; background: #eee; padding: 6px; border-radius: 12px; }
        .tab { flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: 600; color: #666; }
        .tab.active { background: white; color: #2563eb; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        input { width: 100%; padding: 14px; margin: 8px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        input:focus { outline: none; border-color: #2563eb; }
        
        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(37,99,235,0.3); }

        /* Main App */
        #app { display: none; height: 100vh; flex-direction: column; }

        .header {
            background: rgba(20,20,20,0.95);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .main { flex: 1; display: flex; overflow: hidden; }

        /* Left Panel - Virtual Browser */
        .browser-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            position: relative;
        }
        
        .browser-toolbar {
            background: #1f2937;
            padding: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
            border-bottom: 1px solid #374151;
        }
        
        .url-input {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border: 1px solid #4b5563;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #9ca3af;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .btn-icon:hover { background: rgba(255,255,255,0.2); color: white; }
        .btn-icon.primary { background: #2563eb; color: white; }
        .btn-icon.primary:hover { background: #1d4ed8; }
        
        .browser-frame {
            flex: 1;
            border: none;
            width: 100%;
            background: white;
        }

        /* Video Detector Overlay */
        .detector-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(17, 24, 39, 0.98);
            border: 2px solid #2563eb;
            border-radius: 16px;
            padding: 20px;
            display: none;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .detector-panel.active { display: block; }
        
        .detector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .video-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .video-item:hover {
            background: rgba(37, 99, 235, 0.2);
            border-color: #2563eb;
        }
        
        .video-item.selected {
            background: rgba(37, 99, 235, 0.3);
            border-color: #2563eb;
        }
        
        .video-info { flex: 1; overflow: hidden; }
        .video-url { font-size: 12px; color: #9ca3af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .video-type { font-size: 11px; color: #4ade80; margin-top: 4px; }

        /* Right Panel - Controls & Chat */
        .side-panel {
            width: 400px;
            background: #111;
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        
        .panel-section {
            padding: 20px;
            border-bottom: 1px solid #333;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Extracted Video Player */
        .player-container {
            background: #000;
            aspect-ratio: 16/9;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
        }
        
        #mainPlayer {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .player-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            text-align: center;
            padding: 20px;
        }

        /* Network Monitor */
        .network-log {
            flex: 1;
            overflow-y: auto;
            max-height: 200px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-item {
            padding: 8px;
            margin-bottom: 4px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            border-left: 3px solid #4ade80;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .log-url { color: #9ca3af; word-break: break-all; }
        .log-type { color: #4ade80; font-size: 10px; }

        /* Status Badge */
        .status-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 50;
        }
        
        .status-badge.scanning {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.5);
            animation: pulse 2s infinite;
        }
        
        .status-badge.ready {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            border: 1px solid rgba(74, 222, 128, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="login">
    <div class="login-box">
        <h1><i class="fas fa-search"></i> Video Detector</h1>
        <p style="color: #666; margin-bottom: 20px;">Saytlardakƒ± gizli video linkl…ôrini avtomatik tap</p>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('create')">Yarat</button>
            <button class="tab" onclick="switchTab('join')">Qo≈üul</button>
        </div>
        
        <div id="createForm">
            <input type="text" id="cName" placeholder="Adƒ±nƒ±z">
            <input type="text" id="cCode" placeholder="Otaq kodu (m…ôs: MOVIE123)">
            <p style="font-size: 13px; color: #666; margin: 10px 0; text-align: left;">
                üí° Moderator olaraq saytdakƒ± videonun linkini tapƒ±b hamƒ±ya g√∂st…ôr…ôc…ôks…ôn
            </p>
            <button onclick="createRoom()">Otaq Yarat</button>
        </div>
        
        <div id="joinForm" style="display:none">
            <input type="text" id="jName" placeholder="Adƒ±nƒ±z">
            <input type="text" id="jCode" placeholder="Otaq kodu">
            <button onclick="joinRoom()">Qo≈üul</button>
        </div>
    </div>
</div>

<div id="app">
    <div class="header">
        <div style="font-weight: 700; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-robot" style="color: #2563eb;"></i>
            <span>Video Detector</span>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="userDisplay" style="color: #9ca3af;"></span>
            <span id="roleTag" style="background: #2563eb; padding: 4px 12px; border-radius: 12px; font-size: 12px;">MOD</span>
            <code id="roomTag" style="background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 6px;">CODE</code>
        </div>
    </div>

    <div class="main">
        <!-- Browser Area (Moderator Only) -->
        <div class="browser-panel" id="browserPanel">
            <div class="browser-toolbar">
                <button class="btn-icon" onclick="goBack()" title="Geri"><i class="fas fa-arrow-left"></i></button>
                <button class="btn-icon" onclick="refresh()" title="Yenil…ô"><i class="fas fa-redo"></i></button>
                <input type="text" class="url-input" id="browserUrl" value="https://archive.org/details/movies" placeholder="Film saytƒ±nƒ±n URL-i...">
                <button class="btn-icon primary" onclick="navigate()" title="Get"><i class="fas fa-arrow-right"></i></button>
                <button class="btn-icon" onclick="toggleDetector()" title="Video Axtar" style="background: #f59e0b; color: white;">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <iframe id="browserFrame" class="browser-frame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
            
            <div class="status-badge scanning" id="statusBadge" style="display: none;">
                <i class="fas fa-radar"></i> Video axtarƒ±lƒ±r...
            </div>

            <!-- Video Detection Panel -->
            <div class="detector-panel" id="detectorPanel">
                <div class="detector-header">
                    <div>
                        <h3 style="margin-bottom: 4px;"><i class="fas fa-video"></i> Tapƒ±lan Videolar</h3>
                        <p style="font-size: 12px; color: #9ca3af;">A≈üaƒüƒ±dakƒ± linkl…ôrd…ôn birini se√ß hamƒ±ya g√∂st…ôr</p>
                    </div>
                    <button class="btn-icon" onclick="toggleDetector()" style="width: 32px; height: 32px;"><i class="fas fa-times"></i></button>
                </div>
                <div id="videoList">
                    <!-- Videos will appear here -->
                </div>
            </div>
        </div>

        <!-- Side Panel -->
        <div class="side-panel">
            <!-- Active Player -->
            <div class="panel-section">
                <div class="section-title"><i class="fas fa-play-circle"></i> Canlƒ± Video</div>
                <div class="player-container">
                    <video id="mainPlayer" controls autoplay></video>
                    <div class="player-placeholder" id="playerPlaceholder">
                        <i class="fas fa-tv" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p>Video se√ßilm…ôyib</p>
                        <p style="font-size: 12px; opacity: 0.6; margin-top: 10px;">
                            Moderator brauzerd…ô film a√ßanda burada g√∂r√ºn…ôc…ôk
                        </p>
                    </div>
                </div>
                <div id="videoInfo" style="display: none; margin-top: 10px; padding: 10px; background: rgba(74, 222, 128, 0.1); border-radius: 8px; border-left: 3px solid #4ade80;">
                    <div style="font-size: 12px; color: #4ade80; font-weight: 600; margin-bottom: 4px;">‚úì Video aktiv</div>
                    <div id="activeUrl" style="font-size: 11px; color: #9ca3af; word-break: break-all;"></div>
                </div>
            </div>

            <!-- Network Monitor (Moderator only) -->
            <div class="panel-section" id="networkPanel" style="flex: 1; display: flex; flex-direction: column;">
                <div class="section-title"><i class="fas fa-network-wired"></i> ≈û…ôb…ôk…ô Monitoru</div>
                <div class="network-log" id="networkLog">
                    <div style="color: #666; text-align: center; padding: 20px;">
                        Brauzer a√ßƒ±landa network sorƒüularƒ± burada g√∂r√ºn…ôc…ôk
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
    authDomain: "sevgili-testi.firebaseapp.com",
    databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
    projectId: "sevgili-testi",
    storageBucket: "sevgili-testi.firebasestorage.app",
    messagingSenderId: "399260477557",
    appId: "1:399260477557:web:584204a698d7bf145bb03c"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = '', roomCode = '', isModerator = false;
let roomRef, videoRef;
let detectedVideos = [];
let activeVideoUrl = null;

// Video URL patterns to detect
const VIDEO_PATTERNS = [
    /\.(mp4|webm|ogg|ogv|mkv|avi|mov)(\?.*)?$/i,
    /\.m3u8(\?.*)?$/i,  // HLS streams
    /\.mpd(\?.*)?$/i,   // DASH streams
    /video.*\.ts(\?.*)?$/i,  // MPEG-TS segments
    /videoplayback\?/i,  // YouTube/Google video
    /manifest.*\.m3u8/i,
    /stream.*\.mp4/i,
    /cdn.*\.(mp4|m3u8)/i,
    /video.*\/[a-zA-Z0-9]+\.(mp4|m3u8)/i
];

function switchTab(t) {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('createForm').style.display = t === 'create' ? 'block' : 'none';
    document.getElementById('joinForm').style.display = t === 'join' ? 'block' : 'none';
}

function createRoom() {
    const name = document.getElementById('cName').value.trim();
    const code = document.getElementById('cCode').value.trim().toUpperCase();
    
    if(!name || !code) return alert('Xanalarƒ± doldurun!');
    
    db.ref('rooms/' + code).once('value').then(snap => {
        if(snap.exists()) return alert('Bu kod m√∂vcuddur!');
        
        currentUser = name;
        roomCode = code;
        isModerator = true;
        
        db.ref('rooms/' + code).set({
            creator: name,
            created: Date.now(),
            video: { url: '', active: false },
            browser: { url: '' }
        });
        
        initApp();
    });
}

function joinRoom() {
    const name = document.getElementById('jName').value.trim();
    const code = document.getElementById('jCode').value.trim().toUpperCase();
    
    if(!name || !code) return alert('Xanalarƒ± doldurun!');
    
    db.ref('rooms/' + code).once('value').then(snap => {
        if(!snap.exists()) return alert('Otaq tapƒ±lmadƒ±!');
        
        currentUser = name;
        roomCode = code;
        isModerator = false;
        
        initApp();
    });
}

function initApp() {
    document.getElementById('login').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    document.getElementById('userDisplay').textContent = currentUser;
    document.getElementById('roomTag').textContent = roomCode;
    document.getElementById('roleTag').textContent = isModerator ? 'MODERATOR' : 'VIEWER';
    
    if(!isModerator) {
        document.getElementById('browserPanel').style.display = 'none';
        document.getElementById('networkPanel').style.display = 'none';
        document.querySelector('.side-panel').style.width = '100%';
    }
    
    roomRef = db.ref('rooms/' + roomCode);
    videoRef = roomRef.child('video');
    
    setupSync();
    if(isModerator) setupNetworkInterceptor();
}

function setupSync() {
    // Listen for video changes
    videoRef.on('value', (snap) => {
        const data = snap.val();
        if(data && data.url && data.url !== activeVideoUrl) {
            activeVideoUrl = data.url;
            playVideo(data.url);
        }
    });
    
    // Add user
    roomRef.child('users/' + currentUser).set({
        name: currentUser,
        isModerator: isModerator,
        joined: Date.now()
    });
    roomRef.child('users/' + currentUser).onDisconnect().remove();
}

// Simulate network interception (in real app, this would be Puppeteer)
function setupNetworkInterceptor() {
    const frame = document.getElementById('browserFrame');
    
    // Monitor iframe network requests via hacky method
    // In production, this should be done via Puppeteer on server side
    setInterval(() => {
        scanForVideos();
    }, 2000);
}

function navigate() {
    const url = document.getElementById('browserUrl').value.trim();
    if(!url) return;
    
    document.getElementById('browserFrame').src = url;
    detectedVideos = []; // Clear previous detections
    updateVideoList();
    
    // Show scanning badge
    document.getElementById('statusBadge').style.display = 'flex';
    document.getElementById('statusBadge').className = 'status-badge scanning';
    document.getElementById('statusBadge').innerHTML = '<i class="fas fa-radar"></i> Video axtarƒ±lƒ±r...';
    
    // Simulate video detection (in real app, this would analyze network)
    setTimeout(() => {
        detectVideosInPage(url);
    }, 3000);
}

function detectVideosInPage(pageUrl) {
    // This simulates what Puppeteer would detect
    // In real implementation, you'd analyze the page content and network requests
    
    const possibleVideos = generatePossibleVideoUrls(pageUrl);
    
    possibleVideos.forEach((video, index) => {
        setTimeout(() => {
            addVideoToList(video);
            logNetworkRequest(video.url, video.type);
        }, index * 500);
    });
    
    if(possibleVideos.length > 0) {
        document.getElementById('statusBadge').className = 'status-badge ready';
        document.getElementById('statusBadge').innerHTML = '<i class="fas fa-check"></i> ' + possibleVideos.length + ' video tapƒ±ldƒ±';
        document.getElementById('detectorPanel').classList.add('active');
    }
}

function generatePossibleVideoUrls(pageUrl) {
    // Simulated detection - in real app, this comes from Puppeteer network analysis
    const hostname = new URL(pageUrl).hostname;
    const videos = [];
    
    // Common patterns based on site
    if(pageUrl.includes('archive.org')) {
        videos.push({
            url: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
            type: 'MP4 (HD)',
            size: '1080p'
        });
    } else {
        // Generic patterns
        videos.push({
            url: pageUrl.replace(/^https?:\/\//, '') + '/video.mp4',
            type: 'MP4',
            size: 'Unknown'
        });
        videos.push({
            url: pageUrl.replace(/^https?:\/\//, '') + '/playlist.m3u8',
            type: 'HLS Stream',
            size: 'Adaptive'
        });
    }
    
    return videos;
}

function addVideoToList(video) {
    detectedVideos.push(video);
    updateVideoList();
}

function updateVideoList() {
    const container = document.getElementById('videoList');
    
    if(detectedVideos.length === 0) {
        container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">Video tapƒ±lmaq √ºzr…ô...</div>';
        return;
    }
    
    container.innerHTML = detectedVideos.map((v, i) => `
        <div class="video-item ${v.url === activeVideoUrl ? 'selected' : ''}" onclick="selectVideo('${v.url}')">
            <div class="video-info">
                <div style="font-weight: 600; margin-bottom: 4px;">Video ${i + 1}</div>
                <div class="video-url">${v.url}</div>
                <div class="video-type">${v.type} ${v.size ? '| ' + v.size : ''}</div>
            </div>
            <button class="btn-icon primary" style="width: 36px; height: 36px;" onclick="event.stopPropagation(); selectVideo('${v.url}')">
                <i class="fas fa-play"></i>
            </button>
        </div>
    `).join('');
}

function selectVideo(url) {
    activeVideoUrl = url;
    
    // Save to Firebase for all viewers
    videoRef.set({
        url: url,
        active: true,
        selectedBy: currentUser,
        selectedAt: Date.now(),
        type: detectedVideos.find(v => v.url === url)?.type || 'Unknown'
    });
    
    updateVideoList(); // Update UI to show selected
    
    // Play locally for moderator too
    playVideo(url);
    
    // Close detector
    document.getElementById('detectorPanel').classList.remove('active');
}

function playVideo(url) {
    const player = document.getElementById('mainPlayer');
    const placeholder = document.getElementById('playerPlaceholder');
    const info = document.getElementById('videoInfo');
    const infoUrl = document.getElementById('activeUrl');
    
    // Set video source
    player.src = url;
    player.style.display = 'block';
    placeholder.style.display = 'none';
    info.style.display = 'block';
    infoUrl.textContent = url.substring(0, 50) + '...';
    
    // Try to play
    player.play().catch(e => {
        console.error('Play error:', e);
        // If autoplay blocked, show controls
        player.controls = true;
    });
    
    // Add system message
    if(isModerator) {
        roomRef.child('chat').push({
            system: true,
            text: `üé¨ Moderator yeni video se√ßdi: ${detectedVideos.find(v => v.url === url)?.type || 'Video'}`,
            time: Date.now()
        });
    }
}

function logNetworkRequest(url, type) {
    const log = document.getElementById('networkLog');
    const item = document.createElement('div');
    item.className = 'log-item';
    item.innerHTML = `
        <div class="log-type">${type}</div>
        <div class="log-url">${url.substring(0, 60)}...</div>
    `;
    log.insertBefore(item, log.firstChild);
    
    // Keep only last 20
    while(log.children.length > 20) {
        log.removeChild(log.lastChild);
    }
}

function toggleDetector() {
    document.getElementById('detectorPanel').classList.toggle('active');
}

function goBack() {
    // Implementation for iframe back
    try {
        document.getElementById('browserFrame').contentWindow.history.back();
    } catch(e) {
        console.log('Cannot go back');
    }
}

function refresh() {
    document.getElementById('browserFrame').contentWindow.location.reload();
}

function copyCode() {
    navigator.clipboard.writeText(roomCode);
    alert('Kod: ' + roomCode);
}

// Initial load
document.getElementById('browserFrame').src = 'about:blank';
</script>

</body>
</html>
