<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Screen Share - Film Party</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0a0a0a;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        /* Login */
        #login {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            color: #333;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 10px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            color: #666;
        }
        
        .tab.active { background: white; color: #764ba2; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        input {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: 0.3s;
        }
        
        input:focus { outline: none; border-color: #764ba2; }
        
        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        button:hover { transform: translateY(-2px); }

        /* App */
        #app { display: none; height: 100vh; flex-direction: column; }
        
        .header {
            background: rgba(255,255,255,0.05);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .main { flex: 1; display: flex; overflow: hidden; }
        
        /* Video/Screen Area */
        .screen-area {
            flex: 1;
            background: #000;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #mainVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }
        
        .screen-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .control-btn {
            width: auto;
            padding: 12px 24px;
            margin: 0;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .control-btn.stop { background: #ef4444; }
        .control-btn.share { background: #10b981; }
        
        .status-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 8px;
            animation: pulse 2s infinite;
            z-index: 10;
        }
        
        .status-badge.active { display: flex; }
        .status-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

        /* Chat */
        .chat-panel {
            width: 350px;
            background: rgba(255,255,255,0.02);
            border-left: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .msg {
            background: rgba(255,255,255,0.1);
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 85%;
            font-size: 14px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .msg.own {
            background: linear-gradient(135deg, #667eea, #764ba2);
            align-self: flex-end;
        }
        
        .msg b { display: block; font-size: 12px; margin-bottom: 4px; opacity: 0.8; }
        
        .msg.system {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            text-align: center;
            align-self: center;
            font-size: 13px;
        }
        
        .chat-input {
            padding: 15px;
            display: flex;
            gap: 10px;
            background: rgba(255,255,255,0.05);
        }
        
        .chat-input input {
            flex: 1;
            margin: 0;
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
        }
        
        .chat-input button {
            width: 50px;
            margin: 0;
            border-radius: 50%;
            padding: 0;
        }

        .waiting-message {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            text-align: center;
            padding: 40px;
        }
        
        .waiting-message i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #333;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .conn-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
        }
        
        .conn-dot.connecting { background: #f59e0b; animation: blink 1s infinite; }
        .conn-dot.error { background: #ef4444; }

        @media (max-width: 900px) {
            .chat-panel { position: absolute; right: 0; top: 60px; bottom: 0; transform: translateX(100%); transition: 0.3s; }
            .chat-panel.open { transform: translateX(0); width: 100%; }
        }
    </style>
</head>
<body>

<div id="login">
    <div class="login-box">
        <h2 style="text-align: center; margin-bottom: 5px; color: #764ba2;">ðŸŽ¥ Real Screen Share</h2>
        <p style="text-align: center; color: #666; margin-bottom: 25px; font-size: 14px;">CanlÄ± ekran yayÄ±mÄ± ilÉ™ film izlÉ™</p>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('create')">Yarat</button>
            <button class="tab" onclick="switchTab('join')">QoÅŸul</button>
        </div>
        
        <div id="createTab">
            <input type="text" id="createName" placeholder="AdÄ±nÄ±z" maxlength="20">
            <input type="text" id="createCode" placeholder="Otaq kodu (mÉ™sÉ™lÉ™n: FAMILY)" maxlength="15">
            <button onclick="createRoom()">Otaq Yarat vÉ™ YayÄ±m BaÅŸlat</button>
            <p style="font-size: 12px; color: #666; margin-top: 10px; text-align: center;">
                ðŸ’¡ Kod yaradÄ±rsansa avtomatik moderator olursan
            </p>
        </div>
        
        <div id="joinTab" style="display:none">
            <input type="text" id="joinName" placeholder="AdÄ±nÄ±z" maxlength="20">
            <input type="text" id="joinCode" placeholder="Moderatorun kodu" maxlength="15">
            <button onclick="joinRoom()">YayÄ±na QoÅŸul</button>
            <p style="font-size: 12px; color: #666; margin-top: 10px; text-align: center;">
                ðŸ’¡ Moderatorun ekranÄ±nÄ± canlÄ± izlÉ™yÉ™cÉ™ksÉ™n
            </p>
        </div>
    </div>
</div>

<div id="app">
    <div class="header">
        <div style="display:flex; align-items:center; gap:10px;">
            <b style="font-size:20px;">ðŸŽ¬ CanlÄ± YayÄ±m</b>
            <span id="roleBadge" style="background:#f59e0b; padding:4px 12px; border-radius:20px; font-size:12px;">Moderator</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <span id="roomCode" style="font-family:monospace; background:rgba(255,255,255,0.1); padding:6px 12px; border-radius:8px; font-weight:bold;"></span>
            <button onclick="copyCode()" style="width:auto; padding:8px 15px; font-size:13px;"><i class="fas fa-copy"></i></button>
        </div>
    </div>

    <div class="main">
        <div class="screen-area">
            <!-- Local Video (Moderator) / Remote Video (Viewer) -->
            <video id="mainVideo" autoplay playsinline></video>
            
            <!-- Live Indicator -->
            <div class="status-badge" id="liveBadge">
                <i class="fas fa-circle"></i> CANLI YAYIM
            </div>
            
            <!-- Connection Status -->
            <div class="connection-status" id="connStatus">
                <div class="conn-dot" id="connDot"></div>
                <span id="connText">BaÄŸlanÄ±r...</span>
            </div>
            
            <!-- Waiting Message for Viewers -->
            <div class="waiting-message" id="waitingMsg" style="display:none;">
                <i class="fas fa-tv"></i>
                <h3>GÃ¶zlÉ™yir...</h3>
                <p>Moderator ekran paylaÅŸmaÄŸa baÅŸlayana qÉ™dÉ™r gÃ¶zlÉ™yin.<br>Bu pÉ™ncÉ™rÉ™ avtomatik olaraq moderatorun ekranÄ±nÄ± gÃ¶stÉ™rÉ™cÉ™k.</p>
            </div>
            
            <!-- Moderator Controls -->
            <div class="screen-controls" id="modControls" style="display:none;">
                <button class="control-btn share" onclick="startScreenShare()">
                    <i class="fas fa-desktop"></i> Ekran PaylaÅŸ
                </button>
                <button class="control-btn share" onclick="startCamera()">
                    <i class="fas fa-video"></i> Kamera
                </button>
                <button class="control-btn stop" onclick="stopShare()" style="display:none;" id="stopBtn">
                    <i class="fas fa-stop"></i> DayandÄ±r
                </button>
            </div>
        </div>

        <div class="chat-panel">
            <div class="chat-header">
                <b>ðŸ’¬ SÃ¶hbÉ™t</b>
                <div style="font-size:13px; color:#4ecca3; margin-top:5px;">
                    <span id="onlineCount">1</span> onlayn
                </div>
            </div>
            <div class="messages" id="chatBox"></div>
            <div class="chat-input">
                <input type="text" id="msgInput" placeholder="Mesaj yaz..." onkeypress="if(event.key==='Enter')sendMsg()">
                <button onclick="sendMsg()">âž¤</button>
            </div>
        </div>
    </div>
</div>

<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
    authDomain: "sevgili-testi.firebaseapp.com",
    databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
    projectId: "sevgili-testi",
    storageBucket: "sevgili-testi.firebasestorage.app",
    messagingSenderId: "399260477557",
    appId: "1:399260477557:web:584204a698d7bf145bb03c",
    measurementId: "G-44P21XCZ7G"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Global Variables
let currentUser = '';
let roomCode = '';
let isModerator = false;
let localStream = null;
let peerConnection = null;
let roomRef = null;

// WebRTC Configuration (STUN servers for NAT traversal)
const rtcConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' }
    ]
};

function switchTab(t) {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('createTab').style.display = t === 'create' ? 'block' : 'none';
    document.getElementById('joinTab').style.display = t === 'join' ? 'block' : 'none';
}

// Create Room (Moderator)
function createRoom() {
    const name = document.getElementById('createName').value.trim();
    const code = document.getElementById('createCode').value.trim().toUpperCase();
    
    if(!name || !code) return alert('BÃ¼tÃ¼n xanalarÄ± doldurun!');
    
    // Check if room exists
    db.ref('rooms/' + code).once('value').then(snap => {
        if(snap.exists()) return alert('Bu kod artÄ±q istifadÉ™ olunur. BaÅŸqa kod yoxlayÄ±n.');
        
        currentUser = name;
        roomCode = code;
        isModerator = true;
        
        // Initialize room
        roomRef = db.ref('rooms/' + roomCode);
        roomRef.set({
            creator: currentUser,
            created: firebase.database.ServerValue.TIMESTAMP,
            streamActive: false,
            viewers: 0
        });
        
        enterRoom();
    });
}

// Join Room (Viewer)
function joinRoom() {
    const name = document.getElementById('joinName').value.trim();
    const code = document.getElementById('joinCode').value.trim().toUpperCase();
    
    if(!name || !code) return alert('BÃ¼tÃ¼n xanalarÄ± doldurun!');
    
    db.ref('rooms/' + code).once('value').then(snap => {
        if(!snap.exists()) return alert('Otaq tapÄ±lmadÄ±! Kodu yoxlayÄ±n.');
        
        currentUser = name;
        roomCode = code;
        isModerator = false;
        roomRef = db.ref('rooms/' + code);
        
        enterRoom();
    });
}

function enterRoom() {
    document.getElementById('login').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    document.getElementById('roomCode').textContent = roomCode;
    document.getElementById('roleBadge').textContent = isModerator ? 'Moderator' : 'TamaÅŸaÃ§Ä±';
    document.getElementById('roleBadge').style.background = isModerator ? '#f59e0b' : '#64748b';
    
    if(isModerator) {
        document.getElementById('modControls').style.display = 'flex';
        document.getElementById('mainVideo').poster = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="100"><text x="50%" y="50%" font-family="Arial" font-size="16" fill="gray" text-anchor="middle" dominant-baseline="middle">Ekran paylaÅŸmaÄŸa hazÄ±r</text></svg>';
    } else {
        document.getElementById('waitingMsg').style.display = 'flex';
        setupViewerConnection();
    }
    
    setupChat();
    updateConnectionStatus('connected', 'QoÅŸuldu');
}

// SCREEN SHARING (Moderator)
async function startScreenShare() {
    try {
        // Get screen stream
        localStream = await navigator.mediaDevices.getDisplayMedia({
            video: {
                cursor: "always",
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            },
            audio: true
        });
        
        const videoElement = document.getElementById('mainVideo');
        videoElement.srcObject = localStream;
        videoElement.muted = true; // Mute local to avoid echo
        
        document.getElementById('liveBadge').classList.add('active');
        document.getElementById('stopBtn').style.display = 'flex';
        document.getElementById('connText').textContent = 'CanlÄ± yayÄ±m aktiv';
        
        // Update room status
        roomRef.update({ streamActive: true, streamStarted: firebase.database.ServerValue.TIMESTAMP });
        
        // Listen for viewers joining
        setupModeratorConnection();
        
        // Detect when user stops sharing via browser UI
        localStream.getVideoTracks()[0].onended = () => {
            stopShare();
        };
        
    } catch(err) {
        console.error('Error:', err);
        alert('Ekran paylaÅŸÄ±mÄ± baÅŸlamadÄ±. Ä°cazÉ™ verdiyinÉ™ É™min ol.');
    }
}

// Camera Share (Alternative)
async function startCamera() {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ 
            video: true, 
            audio: true 
        });
        
        const videoElement = document.getElementById('mainVideo');
        videoElement.srcObject = localStream;
        videoElement.muted = true;
        
        document.getElementById('liveBadge').classList.add('active');
        document.getElementById('stopBtn').style.display = 'flex';
        
        roomRef.update({ streamActive: true });
        setupModeratorConnection();
        
    } catch(err) {
        alert('Kamera aÃ§Ä±lmadÄ±: ' + err.message);
    }
}

function stopShare() {
    if(localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    if(peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }
    
    document.getElementById('mainVideo').srcObject = null;
    document.getElementById('liveBadge').classList.remove('active');
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('connText').textContent = 'YayÄ±m dayandÄ±rÄ±ldÄ±';
    
    roomRef.update({ streamActive: false });
    
    // Clear signaling data
    roomRef.child('signal').remove();
}

// WEBRTC SIGNALING THROUGH FIREBASE
function setupModeratorConnection() {
    // Listen for viewer offers
    roomRef.child('signal/viewers').on('child_added', async (snap) => {
        const viewerData = snap.val();
        if(!viewerData || viewerData.type !== 'offer') return;
        
        console.log('Viewer offer received:', snap.key);
        
        // Create peer connection
        const pc = new RTCPeerConnection(rtcConfig);
        
        // Add local stream
        localStream.getTracks().forEach(track => {
            pc.addTrack(track, localStream);
        });
        
        // Handle ICE candidates
        pc.onicecandidate = (event) => {
            if(event.candidate) {
                roomRef.child(`signal/viewers/${snap.key}/candidates`).push({
                    candidate: event.candidate.toJSON(),
                    type: 'moderator'
                });
            }
        };
        
        // Set remote description (viewer's offer)
        await pc.setRemoteDescription(new RTCSessionDescription(viewerData.offer));
        
        // Create answer
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        
        // Send answer back
        roomRef.child(`signal/viewers/${snap.key}`).update({
            type: 'answer',
            answer: answer
        });
        
        peerConnection = pc;
        
        // Listen for viewer's ICE candidates
        roomRef.child(`signal/viewers/${snap.key}/candidates`).on('child_added', (candSnap) => {
            const data = candSnap.val();
            if(data && data.type === 'viewer') {
                pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        });
        
        updateConnectionStatus('connected', `Viewer connected: ${snap.key}`);
    });
}

// VIEWER CONNECTION
function setupViewerConnection() {
    const viewerId = 'viewer_' + Math.random().toString(36).substr(2, 9);
    
    // Listen for stream start
    roomRef.child('streamActive').on('value', async (snap) => {
        if(snap.val() === true && !peerConnection) {
            document.getElementById('waitingMsg').style.display = 'none';
            updateConnectionStatus('connecting', 'YayÄ±na qoÅŸulur...');
            
            try {
                // Create peer connection
                const pc = new RTCPeerConnection(rtcConfig);
                
                // Handle incoming stream
                pc.ontrack = (event) => {
                    console.log('Stream received!');
                    const videoElement = document.getElementById('mainVideo');
                    videoElement.srcObject = event.streams[0];
                    document.getElementById('liveBadge').classList.add('active');
                    updateConnectionStatus('connected', 'CanlÄ± yayÄ±m izlÉ™nilir');
                };
                
                // Create offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                // Send offer to moderator
                const signalRef = roomRef.child('signal/viewers').push();
                signalRef.set({
                    type: 'offer',
                    offer: offer,
                    viewerName: currentUser,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Handle ICE candidates
                pc.onicecandidate = (event) => {
                    if(event.candidate) {
                        signalRef.child('candidates').push({
                            candidate: event.candidate.toJSON(),
                            type: 'viewer'
                        });
                    }
                };
                
                // Listen for answer
                signalRef.on('value', async (sigSnap) => {
                    const data = sigSnap.val();
                    if(data && data.type === 'answer' && pc.signalingState !== 'stable') {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                });
                
                // Listen for moderator's ICE candidates
                signalRef.child('candidates').on('child_added', (candSnap) => {
                    const data = candSnap.val();
                    if(data && data.type === 'moderator') {
                        pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                    }
                });
                
                peerConnection = pc;
                
            } catch(err) {
                console.error('Connection error:', err);
                updateConnectionStatus('error', 'BaÄŸlantÄ± xÉ™tasÄ±');
            }
        } else if(snap.val() === false) {
            // Stream stopped
            document.getElementById('waitingMsg').style.display = 'flex';
            document.getElementById('liveBadge').classList.remove('active');
            document.getElementById('mainVideo').srcObject = null;
            if(peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            updateConnectionStatus('connected', 'YayÄ±m gÃ¶zlÉ™nilir');
        }
    });
}

// CHAT SYSTEM
function setupChat() {
    // Add user
    const userRef = roomRef.child('users/' + currentUser);
    userRef.set({ 
        online: true, 
        isModerator: isModerator,
        joined: firebase.database.ServerValue.TIMESTAMP 
    });
    userRef.onDisconnect().remove();
    
    // Count users
    roomRef.child('users').on('value', s => {
        document.getElementById('onlineCount').textContent = s.numChildren();
    });
    
    // Messages
    roomRef.child('chat').limitToLast(30).on('child_added', (snap) => {
        const m = snap.val();
        const div = document.createElement('div');
        div.className = 'msg ' + (m.user === currentUser ? 'own' : '');
        if(m.system) div.className = 'msg system';
        
        div.innerHTML = m.system ? m.text : `<b>${m.user}</b>${m.text}`;
        document.getElementById('chatBox').appendChild(div);
        document.getElementById('chatBox').scrollTop = 9999;
    });
}

function sendMsg() {
    const inp = document.getElementById('msgInput');
    const text = inp.value.trim();
    if(!text) return;
    
    roomRef.child('chat').push({
        user: currentUser,
        text: text,
        time: firebase.database.ServerValue.TIMESTAMP
    });
    inp.value = '';
}

function copyCode() {
    navigator.clipboard.writeText(roomCode);
    alert('Kod kopyalandÄ±: ' + roomCode);
}

function updateConnectionStatus(type, text) {
    const dot = document.getElementById('connDot');
    const txt = document.getElementById('connText');
    
    dot.className = 'conn-dot ' + (type === 'connecting' ? 'connecting' : type === 'error' ? 'error' : '');
    txt.textContent = text;
}

// Browser compatibility check
if(!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
    alert('Brauzeriniz ekran paylaÅŸÄ±mÄ±nÄ± dÉ™stÉ™klÉ™mÃ¼r. Chrome, Edge vÉ™ ya Firefox istifadÉ™ edin.');
}
</script>

</body>
</html>
