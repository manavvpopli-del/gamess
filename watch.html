<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SyncRoom - Multi Theme</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Inter', sans-serif; }
        
        :root {
            --primary-color: #dc2626;
            --primary-dark: #991b1b;
            --primary-light: #fca5a5;
            --bg-color: #0a0000;
            --glass-bg: rgba(20, 0, 0, 0.95);
            --border-color: rgba(220, 38, 38, 0.3);
            --shadow-color: rgba(220, 38, 38, 0.15);
        }
        
        body { 
            background: var(--bg-color); 
            color: white; 
            overflow: hidden; 
            touch-action: manipulation;
            transition: background 0.5s ease;
        }
        
        /* THEME COLORS */
        body.theme-red {
            --primary-color: #dc2626;
            --primary-dark: #991b1b;
            --primary-light: #fca5a5;
            --bg-color: #0a0000;
            --glass-bg: rgba(20, 0, 0, 0.95);
            --border-color: rgba(220, 38, 38, 0.3);
            --shadow-color: rgba(220, 38, 38, 0.15);
        }
        
        body.theme-pink {
            --primary-color: #ec4899;
            --primary-dark: #be185d;
            --primary-light: #fbcfe8;
            --bg-color: #0f0006;
            --glass-bg: rgba(30, 0, 15, 0.95);
            --border-color: rgba(236, 72, 153, 0.3);
            --shadow-color: rgba(236, 72, 153, 0.15);
        }
        
        body.theme-green {
            --primary-color: #22c55e;
            --primary-dark: #15803d;
            --primary-light: #86efac;
            --bg-color: #000a03;
            --glass-bg: rgba(0, 20, 5, 0.95);
            --border-color: rgba(34, 197, 94, 0.3);
            --shadow-color: rgba(34, 197, 94, 0.15);
        }
        
        body.theme-blue {
            --primary-color: #3b82f6;
            --primary-dark: #1d4ed8;
            --primary-light: #93c5fd;
            --bg-color: #000510;
            --glass-bg: rgba(0, 10, 30, 0.95);
            --border-color: rgba(59, 130, 246, 0.3);
            --shadow-color: rgba(59, 130, 246, 0.15);
        }
        
        body.theme-black {
            --primary-color: #525252;
            --primary-dark: #171717;
            --primary-light: #a3a3a3;
            --bg-color: #000000;
            --glass-bg: rgba(10, 10, 10, 0.95);
            --border-color: rgba(82, 82, 82, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.3);
        }
        
        body.theme-gray {
            --primary-color: #6b7280;
            --primary-dark: #374151;
            --primary-light: #d1d5db;
            --bg-color: #0a0a0a;
            --glass-bg: rgba(20, 20, 20, 0.95);
            --border-color: rgba(107, 114, 128, 0.3);
            --shadow-color: rgba(107, 114, 128, 0.15);
        }
        
        body.theme-darkgreen {
            --primary-color: #059669;
            --primary-dark: #065f46;
            --primary-light: #6ee7b7;
            --bg-color: #000a06;
            --glass-bg: rgba(0, 20, 10, 0.95);
            --border-color: rgba(5, 150, 105, 0.3);
            --shadow-color: rgba(5, 150, 105, 0.15);
        }
        
        body.theme-lightblue {
            --primary-color: #06b6d4;
            --primary-dark: #0891b2;
            --primary-light: #a5f3fc;
            --bg-color: #000f12;
            --glass-bg: rgba(0, 20, 25, 0.95);
            --border-color: rgba(6, 182, 212, 0.3);
            --shadow-color: rgba(6, 182, 212, 0.15);
        }
        
        body.theme-orange {
            --primary-color: #f97316;
            --primary-dark: #c2410c;
            --primary-light: #fdba74;
            --bg-color: #0f0500;
            --glass-bg: rgba(25, 10, 0, 0.95);
            --border-color: rgba(249, 115, 22, 0.3);
            --shadow-color: rgba(249, 115, 22, 0.15);
        }
        
        /* CINEMA MODE - D√úZ∆èLƒ∞LMƒ∞≈û */
        body.cinema-mode {
            background: #000 !important;
        }
        
        body.cinema-mode #room > header,
        body.cinema-mode .chat-container,
        body.cinema-mode #hostControls {
            opacity: 0;
            pointer-events: none;
            transform: translateX(100%);
        }
        
        body.cinema-mode #videoSection {
            position: fixed;
            inset: 0;
            z-index: 50;
            height: 100vh !important;
            width: 100vw !important;
        }
        
        body.cinema-mode .cinema-exit {
            opacity: 0;
            transform: translateY(-20px);
        }
        
        .cinema-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: var(--glass-bg);
            border: 2px solid var(--border-color);
            backdrop-filter: blur(10px);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 20px var(--shadow-color);
            color: var(--primary-color);
        }
        
        .cinema-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px var(--shadow-color);
        }
        
        .cinema-exit {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            border: 2px solid var(--primary-color);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
        }
        
        body.cinema-mode .cinema-exit {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }
        
        .cinema-exit:hover {
            background: var(--primary-color);
            transform: scale(1.05);
        }
        
        /* THEME PICKER */
        .theme-picker {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 24px;
            z-index: 200;
            display: none;
            box-shadow: 0 25px 50px -12px var(--shadow-color);
            min-width: 300px;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .theme-picker.active {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 16px;
        }
        
        .theme-option {
            aspect-ratio: 1;
            border-radius: 16px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .theme-option:hover {
            transform: scale(1.05);
        }
        
        .theme-option.active {
            border-color: white;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }
        
        .theme-option::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
        }
        
        .theme-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .glass-red { 
            background: var(--glass-bg); 
            backdrop-filter: blur(20px); 
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px var(--shadow-color);
            transition: all 0.5s ease;
        }
        
        .chat-container {
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, transparent 100%);
            background-color: var(--bg-color);
            border-left: 1px solid var(--border-color);
            transition: all 0.5s ease;
        }
        
        .messages-scroll {
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
        }
        
        .msg-wrapper {
            display: flex;
            width: 100%;
            margin-bottom: 4px;
            animation: msgAppear 0.2s ease-out;
            position: relative;
        }
        
        .msg-wrapper:hover .reaction-btn {
            opacity: 1;
        }
        
        @keyframes msgAppear {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .msg-bubble {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 13.5px;
            line-height: 1.35;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: normal;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .msg-own {
            margin-left: auto;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        .msg-other {
            margin-right: auto;
            background: rgba(255,255,255,0.05);
            color: var(--primary-light);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        
        .msg-reply {
            background: rgba(0,0,0,0.2);
            border-left: 2px solid var(--primary-light);
            padding: 4px 8px;
            margin-bottom: 4px;
            border-radius: 6px;
            font-size: 11px;
        }
        
        .msg-meta {
            font-size: 10px;
            margin-top: 2px;
            opacity: 0.85;
            display: flex;
            align-items: center;
            gap: 4px;
            justify-content: flex-end;
        }
        
        .msg-sender {
            font-size: 11px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 2px;
            margin-left: 44px;
            transition: color 0.3s ease;
        }
        
        .msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
            margin-right: 8px;
            align-self: flex-end;
            margin-bottom: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        .reaction-bar {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            flex-wrap: wrap;
        }
        
        .reaction-item {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .reaction-item:hover {
            background: var(--primary-color);
            transform: scale(1.1);
        }
        
        .reaction-item.user-reacted {
            background: var(--primary-color);
            border-color: var(--primary-light);
            color: white;
        }
        
        .reaction-btn {
            position: absolute;
            bottom: -10px;
            right: 0;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            z-index: 10;
            font-size: 12px;
            color: var(--primary-color);
        }
        
        .msg-own .reaction-btn {
            right: auto;
            left: -30px;
        }
        
        .emoji-picker {
            position: absolute;
            bottom: 36px;
            right: 0;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            display: none;
            grid-template-columns: repeat(6, 1fr);
            gap: 4px;
            z-index: 20;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        
        .emoji-picker.show {
            display: grid;
        }
        
        .emoji-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .emoji-btn:hover {
            background: var(--primary-color);
            transform: scale(1.2);
        }
        
        .chat-input-area {
            background: var(--glass-bg);
            border-top: 1px solid var(--border-color);
            padding: 10px 16px 28px;
            flex-shrink: 0;
            margin-top: auto;
            transition: all 0.5s ease;
        }
        
        .input-container {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            display: flex;
            align-items: flex-end;
            padding: 4px;
            transition: all 0.3s;
        }
        
        .input-container:focus-within {
            border-color: var(--primary-color);
            background: rgba(255,255,255,0.08);
            box-shadow: 0 0 0 3px var(--shadow-color), 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .chat-textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-size: 14px;
            padding: 10px 16px;
            resize: none;
            max-height: 100px;
            min-height: 40px;
            line-height: 1.4;
        }
        
        .chat-textarea::placeholder {
            color: rgba(255,255,255,0.3);
        }
        
        .send-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 2px;
            transition: all 0.2s;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px var(--shadow-color);
        }
        
        .reply-bar {
            background: var(--glass-bg);
            border-left: 3px solid var(--primary-color);
            padding: 8px 16px;
            margin: 0 16px 8px 16px;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideUp 0.2s ease;
            border-top: 1px solid var(--border-color);
            transition: all 0.5s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .users-bar {
            background: var(--glass-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 16px;
            flex-shrink: 0;
            transition: all 0.5s ease;
        }
        
        .user-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            position: relative;
        }
        
        .user-chip:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow-color);
            border-color: var(--primary-color);
        }
        
        .user-chip.host {
            background: rgba(234, 179, 8, 0.1);
            border-color: rgba(234, 179, 8, 0.3);
        }
        
        .user-chip.host:hover {
            background: rgba(234, 179, 8, 0.2);
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.2);
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            font-size: 11px;
            color: var(--primary-color);
            margin-bottom: 8px;
            animation: fadeIn 0.3s ease;
            border: 1px solid var(--border-color);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .typing-dots {
            display: flex;
            gap: 2px;
        }
        
        .typing-dots span {
            width: 4px;
            height: 4px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .messages-scroll::-webkit-scrollbar {
            width: 4px;
        }
        
        .messages-scroll::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            height: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        .avatar-upload {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px dashed var(--primary-color);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: rgba(255,255,255,0.02);
            transition: all 0.3s;
            box-shadow: 0 4px 20px var(--shadow-color);
        }
        
        .avatar-upload:hover {
            border-color: var(--primary-light);
            background: rgba(255,255,255,0.05);
            transform: scale(1.05);
        }
        
        .avatar-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .avatar-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
        }
        
        .modal-content-red {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9), 0 0 40px var(--shadow-color);
            transition: all 0.5s ease;
        }
        
        .notification-red {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px var(--shadow-color);
            transition: all 0.5s ease;
        }
        
        .spinner { 
            border: 3px solid rgba(255,255,255,0.1); 
            border-left-color: var(--primary-color); 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            animation: spin 1s linear infinite; 
            transition: border-left-color 0.3s;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .toggle-switch {
            width: 50px;
            height: 26px;
            background: #374151;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active { 
            background: var(--primary-color);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        .toggle-switch.active::after { transform: translateX(24px); }
        
        .danger-btn {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
            padding: 12px;
            border-radius: 12px;
            width: 100%;
            font-weight: 600;
            transition: all 0.2s;
            margin-top: 8px;
        }
        .danger-btn:hover { background: rgba(239, 68, 68, 0.25); }
        
        .viewer-overlay {
            position: absolute;
            inset: 0;
            background: transparent;
            z-index: 5;
        }
        
        /* Theme Button in Header */
        .theme-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .theme-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--primary-color);
        }
        
        .theme-btn i {
            color: var(--primary-color);
        }
        
        .color-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-color);
            display: inline-block;
        }
    </style>
</head>
<body class="h-screen flex flex-col theme-red">

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
            authDomain: "sevgili-testi.firebaseapp.com",
            databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
            projectId: "sevgili-testi",
            storageBucket: "sevgili-testi.firebasestorage.app",
            messagingSenderId: "399260477557",
            appId: "1:399260477557:web:584204a698d7bf145bb03c",
            measurementId: "G-44P21XCZ7G"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const YOUTUBE_API_KEY = "AIzaSyBterRsxZoTvVbxlsOzESKWBDAY2B8BWc4";
        
        let userId = localStorage.getItem('syncUserId') || 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('syncUserId', userId);
        
        let currentRoom = null, isHost = false, player = null, serverOffset = 0;
        let ignoreUpdates = false, currentVideoId = null;
        let replyingTo = null, userName = '', userAvatar = '';
        let selectedUserId = null;
        let userPermissions = { chat: true, video: true, changeVideo: false };
        let typingTimeout = null;
        let currentReactionMessageId = null;
        
        const themes = [
            { id: 'red', name: 'Qƒ±rmƒ±zƒ±', color: '#dc2626' },
            { id: 'pink', name: '√á…ôhrayƒ±', color: '#ec4899' },
            { id: 'green', name: 'Ya≈üƒ±l', color: '#22c55e' },
            { id: 'blue', name: 'Mavi', color: '#3b82f6' },
            { id: 'black', name: 'Qara', color: '#525252' },
            { id: 'gray', name: 'Boz', color: '#6b7280' },
            { id: 'darkgreen', name: 'T√ºnd Ya≈üƒ±l', color: '#059669' },
            { id: 'lightblue', name: 'A√ßƒ±q Mavi', color: '#06b6d4' },
            { id: 'orange', name: 'Narƒ±ncƒ±', color: '#f97316' }
        ];
        
        db.ref(".info/serverTimeOffset").on("value", (snap) => { serverOffset = snap.val() || 0; });
        const getServerTime = () => Date.now() + serverOffset;
    </script>

    <!-- LANDING PAGE -->
    <div id="landing" class="flex-1 flex items-center justify-center p-4 bg-gradient-to-br from-neutral-950 via-red-950/20 to-neutral-950 overflow-auto">
        <div class="max-w-md w-full space-y-6 pb-8">
            <div class="text-center space-y-2">
                <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-rose-600 mb-2">üìΩÔ∏è KinoZal</h1>
                <p class="text-red-200/60 text-sm">FOR BALAM üñ§</p>
            </div>

            <div class="glass-red rounded-3xl p-8 space-y-6 shadow-2xl">
                <div class="flex flex-col items-center space-y-3">
                    <label class="text-xs font-semibold uppercase tracking-wider" style="color: var(--primary-color)">Profil ≈û…ôkli</label>
                    <div class="avatar-upload" id="avatarUpload" onclick="document.getElementById('avatarInput').click()">
                        <div class="avatar-placeholder" id="avatarPlaceholder">
                            <i class="fas fa-camera text-2xl mb-1"></i>
                            <span class="text-xs">≈û…ôkil se√ß</span>
                        </div>
                        <img id="avatarPreview" class="avatar-preview hidden" alt="Avatar">
                    </div>
                    <p class="text-xs hidden" id="avatarError" style="color: var(--primary-color)"><i class="fas fa-exclamation-circle mr-1"></i>≈û…ôkil se√ßilm…ôlidir</p>
                </div>

                <div class="space-y-3">
                    <input type="text" id="hostName" placeholder="Adƒ±nƒ±zƒ± daxil edin" class="w-full px-4 py-3 rounded-xl bg-black/40 border text-white focus:outline-none transition text-center font-medium placeholder-white/30" style="border-color: var(--border-color)">
                    
                    <button onclick="createRoom()" class="w-full py-3.5 rounded-xl font-bold transition shadow-lg text-white" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); box-shadow: 0 10px 30px var(--shadow-color);">
                        <i class="fas fa-plus-circle mr-2"></i>Otaq Yarat
                    </button>
                </div>

                <div class="relative flex items-center py-2">
                    <div class="flex-grow border-t" style="border-color: var(--border-color)"></div>
                    <span class="px-3 text-xs" style="color: var(--primary-light)">VE YA</span>
                    <div class="flex-grow border-t" style="border-color: var(--border-color)"></div>
                </div>

                <div class="space-y-3">
                    <input type="text" id="joinRoomId" placeholder="Otaq Kodu" class="w-full px-4 py-3 rounded-xl bg-black/40 border text-white uppercase text-center font-bold tracking-widest focus:outline-none transition placeholder-white/30" style="border-color: var(--border-color)">
                    <button onclick="joinRoom()" class="w-full py-3.5 bg-neutral-900 hover:bg-neutral-800 rounded-xl font-bold transition border text-white/90" style="border-color: var(--border-color)">
                        <i class="fas fa-sign-in-alt mr-2"></i>Qo≈üul
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- THEME PICKER MODAL -->
    <div id="themePicker" class="theme-picker">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">üé® Tema Se√ß</h3>
            <button onclick="closeThemePicker()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="theme-grid" id="themeGrid"></div>
        <p class="text-xs text-center mt-4 opacity-60">Yalnƒ±z moderator d…ôyi≈ü…ô bil…ôr</p>
    </div>

    <!-- MODERATOR MODAL -->
    <div id="userModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4" onclick="if(event.target === this) closeUserModal()">
        <div class="modal-content-red rounded-3xl p-6 w-full max-w-sm">
            <div class="flex items-center gap-4 mb-6">
                <img id="modalUserAvatar" src="" class="w-16 h-16 rounded-full object-cover border-2 shadow-lg" style="border-color: var(--primary-color)">
                <div class="flex-1">
                    <h3 id="modalUserName" class="text-lg font-bold text-white"></h3>
                    <p class="text-xs" style="color: var(--primary-light)" id="modalUserStatus">ƒ∞zl…ôyici</p>
                </div>
                <button onclick="closeUserModal()" class="ml-auto p-2 text-neutral-400 hover:text-white hover:bg-neutral-800 rounded-full transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-3">
                <h4 class="text-xs font-bold uppercase tracking-wider mb-2" style="color: var(--primary-color)">ƒ∞caz…ôl…ôr</h4>
                
                <div class="permission-toggle flex items-center justify-between p-3 rounded-xl bg-neutral-900/80 border" style="border-color: var(--border-color)">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center" style="color: var(--primary-color)">
                            <i class="fas fa-comment text-sm"></i>
                        </div>
                        <span class="text-sm font-medium text-neutral-200">Yazƒ± Yazmaq</span>
                    </div>
                    <div class="toggle-switch active" id="permChat" onclick="togglePermission('chat')"></div>
                </div>
                
                <div class="permission-toggle flex items-center justify-between p-3 rounded-xl bg-neutral-900/80 border" style="border-color: var(--border-color)">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center" style="color: var(--primary-color)">
                            <i class="fas fa-eye text-sm"></i>
                        </div>
                        <span class="text-sm font-medium text-neutral-200">Video ƒ∞zl…ôm…ô</span>
                    </div>
                    <div class="toggle-switch active" id="permVideo" onclick="togglePermission('video')"></div>
                </div>
                
                <div class="permission-toggle flex items-center justify-between p-3 rounded-xl bg-neutral-900/80 border" style="border-color: var(--border-color)">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center" style="color: var(--primary-color)">
                            <i class="fas fa-film text-sm"></i>
                        </div>
                        <span class="text-sm font-medium text-neutral-200">Video Se√ßm…ô</span>
                    </div>
                    <div class="toggle-switch" id="permChangeVideo" onclick="togglePermission('changeVideo')"></div>
                </div>
            </div>
            
            <div class="mt-6">
                <button onclick="kickUser()" class="danger-btn w-full">
                    <i class="fas fa-sign-out-alt mr-2"></i>Otaqdan At
                </button>
            </div>
        </div>
    </div>

    <!-- REACTION PICKER TEMPLATE -->
    <div id="emojiPickerTemplate" class="emoji-picker">
        <button class="emoji-btn" onclick="addReaction('üëç')">üëç</button>
        <button class="emoji-btn" onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
        <button class="emoji-btn" onclick="addReaction('üòÇ')">üòÇ</button>
        <button class="emoji-btn" onclick="addReaction('üòÆ')">üòÆ</button>
        <button class="emoji-btn" onclick="addReaction('üò¢')">üò¢</button>
        <button class="emoji-btn" onclick="addReaction('üò°')">üò°</button>
        <button class="emoji-btn" onclick="addReaction('üéâ')">üéâ</button>
        <button class="emoji-btn" onclick="addReaction('üî•')">üî•</button>
        <button class="emoji-btn" onclick="addReaction('üëè')">üëè</button>
        <button class="emoji-btn" onclick="addReaction('üòç')">üòç</button>
        <button class="emoji-btn" onclick="addReaction('ü§î')">ü§î</button>
        <button class="emoji-btn" onclick="addReaction('üëé')">üëé</button>
    </div>

    <!-- ROOM INTERFACE -->
    <div id="room" class="hidden flex-1 flex flex-col h-screen relative">
        
        <!-- Cinema Toggle -->
        <button class="cinema-toggle" onclick="toggleCinemaMode()" title="Sinema Rejimi">
            <i class="fas fa-film text-xl"></i>
        </button>
        
        <!-- Cinema Exit Button -->
        <button class="cinema-exit" onclick="toggleCinemaMode()">
            <i class="fas fa-compress"></i>
            <span>Sinema rejimind…ôn √ßƒ±x</span>
        </button>

        <header class="glass-red border-b h-14 flex items-center justify-between px-4 shrink-0 z-20" style="border-color: var(--border-color)">
            <div class="flex items-center space-x-3">
                <h1 class="text-lg font-bold text-white">Sync<span style="color: var(--primary-color)">Room</span></h1>
                
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-xl bg-black/40 border" style="border-color: var(--border-color)">
                    <span class="text-[10px] uppercase font-bold" style="color: var(--primary-color)">Kod:</span>
                    <span id="roomCode" class="font-mono font-bold text-sm tracking-wider" style="color: var(--primary-color)">---</span>
                    <div class="flex items-center gap-1 ml-2 border-l pl-2" style="border-color: var(--border-color)">
                        <button onclick="copyCode()" class="p-1.5 text-neutral-400 hover:text-white transition" title="Kopyala">
                            <i class="fas fa-copy text-xs"></i>
                        </button>
                        <button onclick="shareCode()" class="p-1.5 text-neutral-400 hover:text-white transition" title="Payla≈ü">
                            <i class="fas fa-share-alt text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center space-x-2">
                <!-- THEME BUTTON -->
                <button onclick="openThemePicker()" class="theme-btn" title="Tema D…ôyi≈ü">
                    <div class="color-dot"></div>
                    <span class="hidden sm:inline">Tema</span>
                    <i class="fas fa-palette"></i>
                </button>

                <span id="activeUsersCount" class="hidden md:flex items-center px-3 py-1 rounded-full text-xs border" style="background: var(--glass-bg); border-color: var(--border-color); color: var(--primary-color)">
                    <i class="fas fa-users mr-1.5"></i>
                    <span id="usersCountText">1</span>
                </span>
                
                <span id="userType" class="px-3 py-1 rounded-full text-xs font-bold bg-neutral-900 border" style="border-color: var(--border-color)">ƒ∞zl…ôyici</span>
                <button onclick="leaveRoom()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 transition" style="color: var(--primary-color)">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">
            <!-- Video Section -->
            <div id="videoSection" class="flex-1 relative bg-black flex flex-col min-h-0">
                
                <button id="changeVideoBtn" onclick="toggleSearch()" class="hidden absolute top-4 right-4 z-40 glass-red px-4 py-2 rounded-xl border text-sm font-bold text-white shadow-lg transition hover:scale-105" style="border-color: var(--border-color)">
                    <i class="fas fa-film mr-2" style="color: var(--primary-color)"></i>Video D…ôyi≈ü
                </button>

                <div id="searchContainer" class="hidden absolute top-16 left-1/2 transform -translate-x-1/2 z-30 w-full max-w-lg px-4">
                    <div class="glass-red rounded-2xl overflow-hidden shadow-2xl border" style="border-color: var(--border-color)">
                        <div class="flex items-center px-4 py-3 border-b bg-neutral-950/50" style="border-color: var(--border-color)">
                            <i class="fas fa-search mr-3" style="color: var(--primary-color)"></i>
                            <input type="text" id="searchQuery" placeholder="YouTube-da axtar..." class="flex-1 bg-transparent border-none outline-none text-white placeholder-neutral-500 text-sm" onkeypress="if(event.key==='Enter') searchYouTube()">
                            <button onclick="searchYouTube()" class="px-4 py-1.5 rounded-lg text-sm font-bold transition shadow-lg text-white" style="background: var(--primary-color)">Axtar</button>
                            <button onclick="closeSearch()" class="ml-2 p-2 text-neutral-400 hover:text-white hover:bg-neutral-800 rounded-lg transition">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="searchResults" class="hidden max-h-[35vh] overflow-y-auto p-3 bg-neutral-950/98 space-y-2"></div>
                    </div>
                </div>

                <div class="flex-1 relative flex items-center justify-center bg-black min-h-0">
                    <div id="playerWrapper" class="w-full h-full relative">
                        <div id="player"></div>
                        <div id="viewerOverlay" class="hidden viewer-overlay"></div>
                    </div>
                    <div id="playerLoader" class="absolute inset-0 flex items-center justify-center bg-black z-10">
                        <div class="spinner"></div>
                    </div>
                </div>

                <div id="hostControls" class="hidden glass-red border-t p-3 shrink-0 z-30" style="border-color: var(--border-color)">
                    <div class="flex items-center justify-center space-x-6">
                        <button onclick="playerControl('seek', -10)" class="p-2 text-neutral-300 hover:text-white transition" style="--tw-text-opacity: 1; color: var(--primary-color)">
                            <i class="fas fa-backward"></i>
                        </button>
                        <button id="playPauseBtn" onclick="playerControl('toggle')" class="w-12 h-12 rounded-full flex items-center justify-center hover:scale-105 transition shadow-lg text-white" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); box-shadow: 0 0 20px var(--shadow-color)">
                            <i class="fas fa-play ml-0.5" id="playIcon"></i>
                            <i class="fas fa-pause hidden" id="pauseIcon"></i>
                        </button>
                        <button onclick="playerControl('seek', 10)" class="p-2 text-neutral-300 hover:text-white transition" style="color: var(--primary-color)">
                            <i class="fas fa-forward"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="chat-container w-full lg:w-[420px] flex flex-col shrink-0 z-20">
                
                <div class="users-bar shrink-0">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-bold uppercase tracking-wider flex items-center gap-1" style="color: var(--primary-color)">
                            <i class="fas fa-users text-[10px]"></i>
                            ƒ∞≈ütirak√ßƒ±lar
                        </h3>
                        <span class="text-[11px] text-neutral-500 bg-neutral-900/50 px-2 py-0.5 rounded-full" id="onlineCount">0 onlayn</span>
                    </div>
                    <div id="usersList" class="flex gap-2 overflow-x-auto custom-scrollbar pb-1"></div>
                </div>

                <div id="replyIndicator" class="hidden reply-bar shrink-0">
                    <div class="flex-1 min-w-0">
                        <div class="text-[10px] font-semibold mb-0.5 flex items-center gap-1" style="color: var(--primary-color)">
                            <i class="fas fa-reply text-[8px]"></i> Cavab
                        </div>
                        <div class="text-xs text-neutral-300 truncate" id="replyText"></div>
                    </div>
                    <button onclick="cancelReply()" class="p-1.5 hover:bg-neutral-800 rounded-full text-neutral-400 hover:text-white transition">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>

                <div id="chatMessages" class="messages-scroll min-h-0">
                    <div id="typingIndicator" class="hidden typing-indicator">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span id="typingText">kims…ô yazƒ±r...</span>
                    </div>
                </div>
                
                <div class="chat-input-area shrink-0">
                    <div class="input-container">
                        <textarea id="messageInput" placeholder="Mesaj yaz..." rows="1" 
                            class="chat-textarea"
                            oninput="autoResize(this); handleTyping()"
                            onkeypress="handleKeyPress(event)"></textarea>
                        <button onclick="sendMessage()" class="send-btn">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notificationToast" class="notification-red fixed top-20 right-4 p-4 rounded-2xl z-50 transform translate-x-[150%] transition-transform duration-300 max-w-xs">
        <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center shrink-0" style="color: var(--primary-color)">
                <i class="fas fa-info"></i>
            </div>
            <div>
                <div class="text-sm font-bold text-white mb-0.5" id="notifTitle">Bildiri≈ü</div>
                <div class="text-xs text-neutral-400 leading-relaxed" id="notifText">...</div>
            </div>
        </div>
    </div>

    <script>
        function handleAvatarSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) { alert('≈û…ôkil 2MB-dan ki√ßik olmalƒ±dƒ±r!'); return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                userAvatar = e.target.result;
                document.getElementById('avatarPreview').src = userAvatar;
                document.getElementById('avatarPreview').classList.remove('hidden');
                document.getElementById('avatarPlaceholder').classList.add('hidden');
                document.getElementById('avatarError').classList.add('hidden');
                localStorage.setItem('userAvatar', userAvatar);
            };
            reader.readAsDataURL(file);
        }
        
        function validateInputs() {
            const name = document.getElementById('hostName').value.trim();
            const hasAvatar = !document.getElementById('avatarPreview').classList.contains('hidden');
            if (!name) { alert('Adƒ±nƒ±zƒ± daxil edin!'); return false; }
            if (!hasAvatar) { document.getElementById('avatarError').classList.remove('hidden'); return false; }
            return true;
        }

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // THEME FUNCTIONS
        function initThemePicker() {
            const grid = document.getElementById('themeGrid');
            grid.innerHTML = '';
            
            themes.forEach(theme => {
                const btn = document.createElement('div');
                btn.className = 'theme-option';
                btn.style.background = `linear-gradient(135deg, ${theme.color}, ${theme.color}dd)`;
                btn.onclick = () => changeTheme(theme.id);
                btn.innerHTML = `
                    <span class="theme-label">${theme.name}</span>
                    <div style="width: 20px; height: 20px; border-radius: 50%; background: ${theme.color}; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>
                `;
                btn.dataset.theme = theme.id;
                grid.appendChild(btn);
            });
        }
        
        function openThemePicker() {
            if (!isHost && !userPermissions.changeVideo) {
                showNotification('ƒ∞caz…ô yoxdur', 'Temanƒ± yalnƒ±z moderator d…ôyi≈ü…ô bil…ôr');
                return;
            }
            document.getElementById('themePicker').classList.add('active');
        }
        
        function closeThemePicker() {
            document.getElementById('themePicker').classList.remove('active');
        }
        
        function changeTheme(themeId) {
            if (!currentRoom) return;
            if (!isHost && !userPermissions.changeVideo) {
                showNotification('ƒ∞caz…ô yoxdur', 'Temanƒ± yalnƒ±z moderator d…ôyi≈ü…ô bil…ôr');
                return;
            }
            
            // Update Firebase
            db.ref(`rooms/${currentRoom}/theme`).set({
                color: themeId,
                updatedBy: userId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            closeThemePicker();
        }
        
        function applyTheme(themeId) {
            // Remove all theme classes
            document.body.classList.remove('theme-red', 'theme-pink', 'theme-green', 'theme-blue', 'theme-black', 'theme-gray', 'theme-darkgreen', 'theme-lightblue', 'theme-orange');
            // Add new theme
            document.body.classList.add(`theme-${themeId}`);
            
            // Update active state in picker
            document.querySelectorAll('.theme-option').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.theme === themeId) el.classList.add('active');
            });
            
            // Notify
            const themeNames = {
                red: 'Qƒ±rmƒ±zƒ±', pink: '√á…ôhrayƒ±', green: 'Ya≈üƒ±l', blue: 'Mavi',
                black: 'Qara', gray: 'Boz', darkgreen: 'T√ºnd Ya≈üƒ±l',
                lightblue: 'A√ßƒ±q Mavi', orange: 'Narƒ±ncƒ±'
            };
            showNotification('Tema d…ôyi≈üdirildi', `${themeNames[themeId]} tema t…ôtbiq edildi`);
        }

        async function createRoom() {
            if (!validateInputs()) return;
            userName = document.getElementById('hostName').value.trim();
            const code = generateRoomCode();
            
            await db.ref(`rooms/${code}`).set({
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                hostId: userId,
                theme: { color: 'red', updatedBy: userId, timestamp: firebase.database.ServerValue.TIMESTAMP },
                currentVideo: { id: 'jfKfPfyJRdk', title: 'Lofi Girl', time: 0, isPlaying: false, timestamp: firebase.database.ServerValue.TIMESTAMP },
                users: { [userId]: { name: userName, avatar: userAvatar, isHost: true, joinedAt: firebase.database.ServerValue.TIMESTAMP, status: 'active' }},
                permissions: {}
            });
            enterRoom(code, true);
        }

        async function joinRoom() {
            const code = document.getElementById('joinRoomId').value.trim().toUpperCase();
            if (!validateInputs()) return;
            if (!code) return alert('Kodu daxil edin!');
            
            userName = document.getElementById('hostName').value.trim();
            const roomSnap = await db.ref(`rooms/${code}`).once('value');
            if (!roomSnap.exists()) return alert('Otaq tapƒ±lmadƒ±!');
            
            // Get current theme
            const themeData = roomSnap.val().theme;
            if (themeData) applyTheme(themeData.color);
            
            await db.ref(`rooms/${code}/users/${userId}`).set({
                name: userName, avatar: userAvatar, isHost: false, 
                joinedAt: firebase.database.ServerValue.TIMESTAMP, status: 'active'
            });
            enterRoom(code, false);
        }

        function enterRoom(code, host) {
            currentRoom = code;
            isHost = host;
            
            document.getElementById('landing').classList.add('hidden');
            document.getElementById('room').classList.remove('hidden');
            document.getElementById('roomCode').textContent = code;
            
            const userType = document.getElementById('userType');
            if (host) {
                userType.textContent = 'üëë Moderator';
                userType.style.background = 'rgba(234, 179, 8, 0.1)';
                userType.style.color = '#fbbf24';
                userType.style.borderColor = 'rgba(234, 179, 8, 0.3)';
                document.getElementById('hostControls').classList.remove('hidden');
                document.getElementById('changeVideoBtn').classList.remove('hidden');
                document.getElementById('searchContainer').classList.remove('hidden');
                document.getElementById('viewerOverlay').classList.add('hidden');
                userPermissions = { chat: true, video: true, changeVideo: true };
            } else {
                userType.textContent = 'üëÅÔ∏è ƒ∞zl…ôyici';
                userType.style.color = 'var(--primary-color)';
                document.getElementById('viewerOverlay').classList.remove('hidden');
                loadUserPermissions();
            }
            
            initThemePicker();
            initPlayer();
            setupListeners();
            setupVisibility();
        }

        async function loadUserPermissions() {
            const snap = await db.ref(`rooms/${currentRoom}/permissions/${userId}`).once('value');
            const perms = snap.val();
            if (perms) {
                userPermissions = { ...userPermissions, ...perms };
                if (perms.changeVideo) {
                    document.getElementById('changeVideoBtn').classList.remove('hidden');
                }
            }
        }
        
        function setupVisibility() {
            document.addEventListener('visibilitychange', () => {
                const status = document.hidden ? 'background' : 'active';
                if (currentRoom) db.ref(`rooms/${currentRoom}/users/${userId}/status`).set(status);
            });
            window.addEventListener('blur', () => { if(currentRoom) db.ref(`rooms/${currentRoom}/users/${userId}/focused`).set(false); });
            window.addEventListener('focus', () => { if(currentRoom) { db.ref(`rooms/${currentRoom}/users/${userId}/focused`).set(true); db.ref(`rooms/${currentRoom}/users/${userId}/status`).set('active'); }});
        }

        // CINEMA MODE - D√úZ∆èLƒ∞LMƒ∞≈û
        function toggleCinemaMode() {
            cinemaMode = !cinemaMode;
            document.body.classList.toggle('cinema-mode');
            
            // Toggle fullscreen
            if (cinemaMode) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                }
                showNotification('Sinema Rejimi', 'Tam ekran aktivl…ô≈üdirildi. √áƒ±xmaq √º√ß√ºn ESC v…ô ya yuxarƒ± saƒüdakƒ± d√ºym…ô...');
            } else {
                if (document.exitFullscreen && document.fullscreenElement) {
                    document.exitFullscreen();
                }
            }
        }

        // Handle fullscreen change from browser
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && cinemaMode) {
                cinemaMode = false;
                document.body.classList.remove('cinema-mode');
            }
        });

        function initPlayer() {
            if (typeof YT === 'undefined' || !YT.Player) { setTimeout(initPlayer, 100); return; }
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                videoId: 'jfKfPfyJRdk',
                playerVars: { autoplay: 0, controls: isHost ? 1 : 0, disablekb: isHost ? 0 : 1, rel: 0, playsinline: 1 },
                events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange }
            });
            document.getElementById('playerLoader').style.display = 'none';
        }

        function onPlayerReady() {
            if (isHost || userPermissions.changeVideo) {
                setInterval(() => {
                    if (!player?.getCurrentTime || ignoreUpdates) return;
                    if (isHost) {
                        db.ref(`rooms/${currentRoom}/currentVideo`).update({
                            time: player.getCurrentTime(),
                            isPlaying: player.getPlayerState() === YT.PlayerState.PLAYING,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                }, 2000);
            }
            
            syncVideo();
        }

        function syncVideo() {
            db.ref(`rooms/${currentRoom}/currentVideo`).on('value', (snap) => {
                if (!player?.loadVideoById || ignoreUpdates) return;
                const video = snap.val();
                if (!video) return;
                
                if (currentVideoId !== video.id) {
                    currentVideoId = video.id;
                    player.loadVideoById(video.id);
                    showNotification('Yeni video', video.title?.substring(0, 40) + '...');
                }
                
                if (!isHost && !userPermissions.changeVideo) {
                    const timeDiff = Math.abs(player.getCurrentTime() - video.time);
                    if (timeDiff > 2) player.seekTo(video.time, true);
                    
                    const isPlaying = player.getPlayerState() === YT.PlayerState.PLAYING;
                    if (video.isPlaying && !isPlaying) player.playVideo();
                    else if (!video.isPlaying && isPlaying) player.pauseVideo();
                }
            });
            
            // Theme sync listener
            db.ref(`rooms/${currentRoom}/theme`).on('value', (snap) => {
                const themeData = snap.val();
                if (themeData && themeData.color) {
                    applyTheme(themeData.color);
                }
            });
        }

        function onPlayerStateChange(e) {
            updatePlayIcon(e.data === YT.PlayerState.PLAYING);
            if ((!isHost && !userPermissions.changeVideo) || ignoreUpdates) return;
            
            db.ref(`rooms/${currentRoom}/currentVideo`).update({
                isPlaying: e.data === YT.PlayerState.PLAYING,
                time: player.getCurrentTime(),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function updatePlayIcon(playing) {
            document.getElementById('playIcon').classList.toggle('hidden', playing);
            document.getElementById('pauseIcon').classList.toggle('hidden', !playing);
        }

        function toggleSearch() { 
            const canChange = isHost || userPermissions.changeVideo;
            if (!canChange) {
                showNotification('ƒ∞caz…ô yoxdur', 'Video d…ôyi≈üm…ôk √º√ß√ºn moderatordan icaz…ô ist…ôyin');
                return;
            }
            document.getElementById('searchContainer').classList.toggle('hidden'); 
        }
        
        function closeSearch() { 
            document.getElementById('searchContainer').classList.add('hidden'); 
            document.getElementById('searchResults').classList.add('hidden'); 
        }

        async function searchYouTube() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) return;
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="flex justify-center p-4"><div class="spinner"></div></div>';
            resultsDiv.classList.remove('hidden');
            
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=8&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}`);
                const data = await res.json();
                resultsDiv.innerHTML = '';
                data.items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'flex space-x-3 p-2 rounded-lg bg-neutral-900/50 hover:bg-neutral-800 cursor-pointer transition border border-transparent';
                    card.style.setProperty('--tw-border-opacity', '1');
                    card.onmouseenter = () => card.style.borderColor = 'var(--primary-color)';
                    card.onmouseleave = () => card.style.borderColor = 'transparent';
                    card.onclick = () => selectVideo(item.id.videoId, item.snippet.title);
                    card.innerHTML = `
                        <div class="relative w-28 h-16 shrink-0 rounded-lg overflow-hidden bg-neutral-950">
                            <img src="${item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default.url}" class="w-full h-full object-cover" loading="lazy">
                            <div class="absolute inset-0 bg-black/40 opacity-0 hover:opacity-100 flex items-center justify-center transition">
                                <i class="fas fa-play text-white"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-xs font-bold text-white line-clamp-2 mb-1">${item.snippet.title}</h4>
                            <p class="text-[10px] text-neutral-500">${item.snippet.channelTitle}</p>
                        </div>
                    `;
                    resultsDiv.appendChild(card);
                });
            } catch (err) {
                resultsDiv.innerHTML = `<div class="text-xs text-center p-2" style="color: var(--primary-color)">X…ôta ba≈ü verdi</div>`;
            }
        }

        function selectVideo(id, title) {
            const canChange = isHost || userPermissions.changeVideo;
            if (!canChange) return;
            
            currentVideoId = id;
            player.loadVideoById(id);
            closeSearch();
            
            db.ref(`rooms/${currentRoom}/currentVideo`).set({
                id: id, title: title, time: 0, isPlaying: true,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            showNotification('Video d…ôyi≈üdirildi', title.substring(0, 30) + '...');
        }

        function playerControl(action, val) {
            if ((!isHost && !userPermissions.changeVideo) || !player) return;
            ignoreUpdates = true;
            setTimeout(() => ignoreUpdates = false, 500);
            if (action === 'toggle') {
                if (player.getPlayerState() === YT.PlayerState.PLAYING) player.pauseVideo();
                else player.playVideo();
            } else if (action === 'seek') {
                player.seekTo(player.getCurrentTime() + val, true);
            }
        }

        // MODERATOR FUNCTIONS
        function openUserModal(uid, userData) {
            if (!isHost || uid === userId) return;
            selectedUserId = uid;
            document.getElementById('modalUserName').textContent = userData.name;
            document.getElementById('modalUserAvatar').src = userData.avatar || 'https://via.placeholder.com/64';
            document.getElementById('modalUserStatus').textContent = userData.isHost ? 'Moderator' : 'ƒ∞zl…ôyici';
            
            db.ref(`rooms/${currentRoom}/permissions/${uid}`).once('value').then(snap => {
                const perms = snap.val() || { chat: true, video: true, changeVideo: false };
                updateToggleUI(document.getElementById('permChat'), perms.chat !== false);
                updateToggleUI(document.getElementById('permVideo'), perms.video !== false);
                updateToggleUI(document.getElementById('permChangeVideo'), perms.changeVideo === true);
            });
            
            document.getElementById('userModal').classList.remove('hidden');
        }
        
        function closeUserModal() { 
            document.getElementById('userModal').classList.add('hidden'); 
            selectedUserId = null;
        }
        
        function updateToggleUI(el, active) {
            if (active) el.classList.add('active');
            else el.classList.remove('active');
        }
        
        function togglePermission(type) {
            if (!selectedUserId) return;
            const el = document.getElementById('perm' + type.charAt(0).toUpperCase() + type.slice(1));
            const newState = !el.classList.contains('active');
            updateToggleUI(el, newState);
            
            db.ref(`rooms/${currentRoom}/permissions/${selectedUserId}/${type}`).set(newState);
        }
        
        function kickUser() {
            if (!selectedUserId) return;
            if (confirm('ƒ∞stifad…ô√ßini otaqdan atmaq ist…ôdiyiniz…ô …ôminsiniz?')) {
                db.ref(`rooms/${currentRoom}/users/${selectedUserId}`).remove();
                db.ref(`rooms/${currentRoom}/permissions/${selectedUserId}`).remove();
                closeUserModal();
                showNotification('ƒ∞stifad…ô√ßi atƒ±ldƒ±', 'ƒ∞stifad…ô√ßi otaqdan √ßƒ±xarƒ±ldƒ±');
            }
        }

        // CHAT FUNCTIONS
        function setupListeners() {
            // Users listener
            db.ref(`rooms/${currentRoom}/users`).on('value', (snap) => {
                const users = snap.val() || {};
                const list = document.getElementById('usersList');
                list.innerHTML = '';
                let count = 0;
                
                Object.entries(users).forEach(([uid, data]) => {
                    if (data.status !== 'active') return;
                    count++;
                    const chip = document.createElement('div');
                    chip.className = `user-chip ${data.isHost ? 'host' : ''}`;
                    chip.onclick = () => openUserModal(uid, data);
                    chip.innerHTML = `
                        <img src="${data.avatar}" class="w-6 h-6 rounded-full object-cover" style="border: 1px solid var(--border-color)">
                        <span class="text-xs font-medium text-neutral-200">${data.name}</span>
                        ${data.isHost ? '<i class="fas fa-crown text-amber-400 text-[10px]"></i>' : ''}
                    `;
                    list.appendChild(chip);
                });
                
                document.getElementById('onlineCount').textContent = count + ' onlayn';
                document.getElementById('usersCountText').textContent = count;
            });

            // Messages listener
            db.ref(`rooms/${currentRoom}/messages`).limitToLast(50).on('child_added', (snap) => {
                const msg = snap.val();
                displayMessage(snap.key, msg);
            });

            // Typing listener
            db.ref(`rooms/${currentRoom}/typing`).on('value', (snap) => {
                const typing = snap.val() || {};
                const typingUsers = Object.entries(typing)
                    .filter(([uid, data]) => uid !== userId && data.timestamp > Date.now() - 3000)
                    .map(([uid, data]) => data.name);
                
                const indicator = document.getElementById('typingIndicator');
                if (typingUsers.length > 0) {
                    indicator.classList.remove('hidden');
                    document.getElementById('typingText').textContent = typingUsers.join(', ') + ' yazƒ±r...';
                } else {
                    indicator.classList.add('hidden');
                }
            });
            
            // Permission updates for current user
            if (!isHost) {
                db.ref(`rooms/${currentRoom}/permissions/${userId}`).on('value', (snap) => {
                    const perms = snap.val();
                    if (perms) {
                        userPermissions = { ...userPermissions, ...perms };
                        if (perms.changeVideo) {
                            document.getElementById('changeVideoBtn').classList.remove('hidden');
                        } else {
                            document.getElementById('changeVideoBtn').classList.add('hidden');
                        }
                        
                        if (perms.chat === false) {
                            document.getElementById('messageInput').disabled = true;
                            document.getElementById('messageInput').placeholder = 'Yazƒ± yazmaq qadaƒüandƒ±r';
                        } else {
                            document.getElementById('messageInput').disabled = false;
                            document.getElementById('messageInput').placeholder = 'Mesaj yaz...';
                        }
                    }
                });
                
                db.ref(`rooms/${currentRoom}/users/${userId}`).on('value', (snap) => {
                    if (!snap.exists() && currentRoom) {
                        alert('Siz otaqdan atƒ±ldƒ±nƒ±z!');
                        location.reload();
                    }
                });
            }
        }

        function handleTyping() {
            if (!currentRoom) return;
            
            db.ref(`rooms/${currentRoom}/typing/${userId}`).set({
                name: userName,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                db.ref(`rooms/${currentRoom}/typing/${userId}`).remove();
            }, 3000);
        }

        function displayMessage(msgId, msg) {
            const container = document.getElementById('chatMessages');
            const isOwn = msg.userId === userId;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper';
            wrapper.id = 'msg-' + msgId;
            
            let replyHtml = '';
            if (msg.replyTo) {
                replyHtml = `<div class="msg-reply" style="border-color: var(--primary-light)"><i class="fas fa-reply text-[10px] mr-1"></i>${msg.replyTo.text}</div>`;
            }
            
            let reactionsHtml = '<div class="reaction-bar" id="reactions-' + msgId + '"></div>';
            
            const html = `
                ${!isOwn ? `<img src="${msg.avatar}" class="msg-avatar" onclick="setReply('${msgId}', '${msg.name}', '${msg.text}')">` : ''}
                <div class="flex flex-col ${isOwn ? 'items-end' : 'items-start'} flex-1">
                    ${!isOwn ? `<div class="msg-sender">${msg.name}</div>` : ''}
                    <div class="msg-bubble ${isOwn ? 'msg-own' : 'msg-other'}" ondblclick="showReactionPicker('${msgId}')">
                        ${replyHtml}
                        <div class="break-words">${escapeHtml(msg.text)}</div>
                        <div class="msg-meta">
                            <span>${formatTime(msg.timestamp)}</span>
                            ${isOwn ? '<i class="fas fa-check-double text-[10px]"></i>' : ''}
                        </div>
                    </div>
                    ${reactionsHtml}
                    <div class="reaction-btn" style="background: var(--glass-bg); border-color: var(--border-color); color: var(--primary-color)" onclick="showReactionPicker('${msgId}')">
                        <i class="far fa-smile"></i>
                    </div>
                </div>
                ${isOwn ? `<img src="${msg.avatar}" class="msg-avatar">` : ''}
            `;
            
            wrapper.innerHTML = html;
            container.insertBefore(wrapper, document.getElementById('typingIndicator'));
            container.scrollTop = container.scrollHeight;
            
            loadReactions(msgId);
        }

        function loadReactions(msgId) {
            db.ref(`rooms/${currentRoom}/messages/${msgId}/reactions`).on('value', (snap) => {
                const reactions = snap.val() || {};
                const bar = document.getElementById('reactions-' + msgId);
                if (!bar) return;
                
                bar.innerHTML = '';
                const counts = {};
                const userReacted = {};
                
                Object.entries(reactions).forEach(([uid, emoji]) => {
                    counts[emoji] = (counts[emoji] || 0) + 1;
                    if (uid === userId) userReacted[emoji] = true;
                });
                
                Object.entries(counts).forEach(([emoji, count]) => {
                    const btn = document.createElement('div');
                    btn.className = 'reaction-item ' + (userReacted[emoji] ? 'user-reacted' : '');
                    btn.style.setProperty('background', userReacted[emoji] ? 'var(--primary-color)' : 'rgba(255,255,255,0.1)');
                    btn.innerHTML = `<span>${emoji}</span><span class="font-bold">${count}</span>`;
                    btn.onclick = () => toggleReaction(msgId, emoji);
                    bar.appendChild(btn);
                });
            });
        }

        function showReactionPicker(msgId) {
            event.stopPropagation();
            currentReactionMessageId = msgId;
            
            document.querySelectorAll('.emoji-picker').forEach(el => el.remove());
            
            const picker = document.getElementById('emojiPickerTemplate').cloneNode(true);
            picker.id = 'activePicker';
            picker.classList.add('show');
            
            const msgEl = document.getElementById('msg-' + msgId);
            const bubble = msgEl.querySelector('.msg-bubble');
            bubble.appendChild(picker);
            
            setTimeout(() => {
                document.addEventListener('click', function closePicker(e) {
                    if (!e.target.closest('.emoji-picker')) {
                        picker.remove();
                        document.removeEventListener('click', closePicker);
                    }
                }, { once: true });
            }, 100);
        }

        function addReaction(emoji) {
            if (!currentReactionMessageId) return;
            toggleReaction(currentReactionMessageId, emoji);
            document.getElementById('activePicker')?.remove();
        }

        function toggleReaction(msgId, emoji) {
            const ref = db.ref(`rooms/${currentRoom}/messages/${msgId}/reactions/${userId}`);
            ref.once('value').then(snap => {
                if (snap.val() === emoji) {
                    ref.remove();
                } else {
                    ref.set(emoji);
                }
            });
        }

        function setReply(msgId, name, text) {
            const shortText = text.length > 30 ? text.substring(0, 30) + '...' : text;
            replyingTo = { id: msgId, name, text: shortText };
            document.getElementById('replyIndicator').classList.remove('hidden');
            document.getElementById('replyText').textContent = name + ': ' + shortText;
            document.getElementById('messageInput').focus();
        }

        function cancelReply() {
            replyingTo = null;
            document.getElementById('replyIndicator').classList.add('hidden');
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !currentRoom) return;
            
            if (!isHost && userPermissions.chat === false) {
                showNotification('X…ôta', 'Siz…ô yazƒ± yazmaq qadaƒüan edilib');
                return;
            }
            
            const msg = {
                type: 'text',
                text: text,
                userId: userId,
                name: userName,
                avatar: userAvatar,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            if (replyingTo) {
                msg.replyTo = replyingTo;
                cancelReply();
            }
            
            db.ref(`rooms/${currentRoom}/messages`).push(msg);
            input.value = '';
            input.style.height = 'auto';
            
            db.ref(`rooms/${currentRoom}/typing/${userId}`).remove();
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 100) + 'px';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' });
        }

        function showNotification(title, text) {
            const notif = document.getElementById('notificationToast');
            document.getElementById('notifTitle').textContent = title;
            document.getElementById('notifText').textContent = text;
            notif.style.transform = 'translateX(0)';
            setTimeout(() => {
                notif.style.transform = 'translateX(150%)';
            }, 3000);
        }

        function copyCode() {
            navigator.clipboard.writeText(currentRoom);
            showNotification('Kopyalandƒ±', 'Otaq kodu kopyalandƒ±');
        }

        function shareCode() {
            if (navigator.share) {
                navigator.share({
                    title: 'KinoZal',
                    text: 'KinoZal otaƒüƒ±na qo≈üul: ' + currentRoom
                });
            } else {
                copyCode();
            }
        }

        function leaveRoom() {
            if (confirm('Otaqdan √ßƒ±xmaq ist…ôdiyiniz…ô …ôminsiniz?')) {
                if (document.fullscreenElement) document.exitFullscreen();
                db.ref(`rooms/${currentRoom}/users/${userId}`).remove();
                db.ref(`rooms/${currentRoom}/typing/${userId}`).remove();
                location.reload();
            }
        }

        // Load saved avatar
        const savedAvatar = localStorage.getItem('userAvatar');
        if (savedAvatar) {
            userAvatar = savedAvatar;
            document.getElementById('avatarPreview').src = savedAvatar;
            document.getElementById('avatarPreview').classList.remove('hidden');
            document.getElementById('avatarPlaceholder').classList.add('hidden');
        }
    </script>
</body>
</html>
