<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KinoZal - Test</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
        
        :root {
            --primary-color: #dc2626;
            --primary-dark: #991b1b;
            --primary-light: #fca5a5;
            --bg-color: #0a0000;
            --glass-bg: rgba(20, 0, 0, 0.95);
            --border-color: rgba(220, 38, 38, 0.3);
        }
        
        body.theme-red { --primary-color: #dc2626; --primary-dark: #991b1b; --primary-light: #fca5a5; --bg-color: #0a0000; --glass-bg: rgba(20, 0, 0, 0.95); --border-color: rgba(220, 38, 38, 0.3); }
        body.theme-pink { --primary-color: #ec4899; --primary-dark: #be185d; --primary-light: #fbcfe8; --bg-color: #0f0006; --glass-bg: rgba(30, 0, 15, 0.95); --border-color: rgba(236, 72, 153, 0.3); }
        body.theme-green { --primary-color: #22c55e; --primary-dark: #15803d; --primary-light: #86efac; --bg-color: #000a03; --glass-bg: rgba(0, 20, 5, 0.95); --border-color: rgba(34, 197, 94, 0.3); }
        body.theme-blue { --primary-color: #3b82f6; --primary-dark: #1d4ed8; --primary-light: #93c5fd; --bg-color: #000510; --glass-bg: rgba(0, 10, 30, 0.95); --border-color: rgba(59, 130, 246, 0.3); }
        
        body { 
            background: var(--bg-color); 
            color: white; 
            overflow: hidden; 
            touch-action: manipulation;
        }
        
        .glass-red { background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--border-color); }
        
        .avatar-upload { 
            width: 100px; 
            height: 100px; 
            border-radius: 50%; 
            border: 3px dashed var(--primary-color); 
            cursor: pointer; 
            position: relative; 
            overflow: hidden; 
            background: rgba(255,255,255,0.02);
            margin: 0 auto;
        }
        
        .avatar-upload:hover { border-color: var(--primary-light); }
        
        .avatar-preview { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: none; 
        }
        
        .avatar-preview.show { display: block; }
        
        .avatar-placeholder { 
            position: absolute; 
            inset: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: var(--primary-color); 
            pointer-events: none;
        }
        
        .hidden { display: none !important; }
        
        .main-container { display: flex; height: calc(100vh - 70px); }
        
        .chat-container { 
            width: 400px; 
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
        }
        
        @media (max-width: 1024px) {
            .main-container { flex-direction: column; }
            .chat-container { width: 100%; height: 40%; }
        }
    </style>
</head>
<body class="h-screen flex flex-col theme-red">

    <!-- Gizli File Input -->
    <input type="file" id="avatarInput" class="hidden" accept="image/*" onchange="handleAvatarSelect(event)">

    <script>
        // S…ônin Firebase konfiqurasiyan (…ôslind…ô bura √∂z m…ôlumatlarƒ±nƒ± yaz)
        const firebaseConfig = {
            apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PfyJRdk",
            authDomain: "sevgili-testi.firebaseapp.com",
            databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
            projectId: "sevgili-testi",
            storageBucket: "sevgili-testi.firebasestorage.app",
            messagingSenderId: "399260477557",
            appId: "1:399260477557:web:584204a698d7bf145bb03c"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // ∆èsas d…ôyi≈ü…ônl…ôr (BUNLAR ∆èVV∆èLC∆è YAZILMALIDIR)
        let userId = localStorage.getItem('syncUserId');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('syncUserId', userId);
        }
        
        let userName = '';
        let userAvatar = localStorage.getItem('userAvatar') || '';
        let currentRoom = null;
        let isHost = false;
        let player = null;
        let cinemaMode = false; // BU ∆èVV∆èL √áATƒ∞≈ûMAYIRDI
        let ignoreUpdates = false;
        let typingTimeout = null;
        let listeners = [];
        
        // DOM y√ºkl…ôn…ônd…ô avatarƒ± g√∂st…ôr
        document.addEventListener('DOMContentLoaded', function() {
            if (userAvatar) {
                const preview = document.getElementById('avatarPreview');
                const placeholder = document.getElementById('avatarPlaceholder');
                if (preview && placeholder) {
                    preview.src = userAvatar;
                    preview.classList.add('show');
                    placeholder.style.display = 'none';
                }
            }
        });
        
        // Avatar funksiyalarƒ±
        function triggerAvatarUpload() {
            document.getElementById('avatarInput').click();
        }
        
        function handleAvatarSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                alert('≈û…ôkil 2MB-dan ki√ßik olmalƒ±dƒ±r!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                userAvatar = e.target.result;
                localStorage.setItem('userAvatar', userAvatar);
                
                const preview = document.getElementById('avatarPreview');
                const placeholder = document.getElementById('avatarPlaceholder');
                const error = document.getElementById('avatarError');
                
                if (preview) {
                    preview.src = userAvatar;
                    preview.classList.add('show');
                }
                if (placeholder) placeholder.style.display = 'none';
                if (error) error.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        // Yoxlama
        function validateInputs() {
            const name = document.getElementById('hostName')?.value.trim();
            
            if (!name) {
                alert('Adƒ±nƒ±zƒ± daxil edin!');
                return false;
            }
            
            if (!userAvatar) {
                document.getElementById('avatarError')?.classList.remove('hidden');
                alert('Profil ≈ü…ôkli se√ßilm…ôlidir!');
                return false;
            }
            
            userName = name;
            return true;
        }
        
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        // OTAQ YARAT - BU FUNKSIYA ƒ∞NDI D√úZG√úN ƒ∞≈ûL∆èYƒ∞R
        async function createRoom() {
            console.log("Otaq yaratma ba≈üladƒ±...");
            
            if (!validateInputs()) {
                console.log("Validasiya uƒüursuz oldu");
                return;
            }
            
            const code = generateRoomCode();
            console.log("Kod:", code);
            
            try {
                const roomData = {
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    hostId: userId,
                    theme: { color: 'red', updatedBy: userId, timestamp: firebase.database.ServerValue.TIMESTAMP },
                    currentVideo: { 
                        id: 'jfKfPfyJRdk', 
                        title: 'Lofi Girl', 
                        time: 0, 
                        isPlaying: false, 
                        timestamp: firebase.database.ServerValue.TIMESTAMP 
                    },
                    users: {
                        [userId]: {
                            name: userName,
                            avatar: userAvatar,
                            isHost: true,
                            joinedAt: firebase.database.ServerValue.TIMESTAMP,
                            status: 'active'
                        }
                    },
                    permissions: {}
                };
                
                await db.ref('rooms/' + code).set(roomData);
                console.log("Firebase-…ô yazƒ±ldƒ±");
                
                enterRoom(code, true);
                
            } catch (error) {
                console.error("X…ôta:", error);
                alert('X…ôta ba≈ü verdi: ' + error.message);
            }
        }
        
        async function joinRoom() {
            const code = document.getElementById('joinRoomId')?.value.trim().toUpperCase();
            
            if (!validateInputs()) return;
            if (!code) {
                alert('Kodu daxil edin!');
                return;
            }
            
            try {
                const snap = await db.ref('rooms/' + code).once('value');
                if (!snap.exists()) {
                    alert('Otaq tapƒ±lmadƒ±!');
                    return;
                }
                
                await db.ref(`rooms/${code}/users/${userId}`).set({
                    name: userName,
                    avatar: userAvatar,
                    isHost: false,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP,
                    status: 'active'
                });
                
                enterRoom(code, false);
            } catch (error) {
                alert('X…ôta: ' + error.message);
            }
        }
        
        function enterRoom(code, host) {
            currentRoom = code;
            isHost = host;
            
            document.getElementById('landing').classList.add('hidden');
            document.getElementById('room').classList.remove('hidden');
            document.getElementById('roomCode').textContent = code;
            
            if (host) {
                document.getElementById('hostControls')?.classList.remove('hidden');
                document.getElementById('changeVideoBtn')?.classList.remove('hidden');
                document.getElementById('userType').textContent = 'üëë Moderator';
            } else {
                document.getElementById('userType').textContent = 'üëÅÔ∏è ƒ∞zl…ôyici';
            }
            
            initThemePicker();
            setupListeners();
            
            // YouTube player
            if (typeof YT !== 'undefined' && YT.Player) {
                initPlayer();
            }
        }
        
        function initPlayer() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: 'jfKfPfyJRdk',
                events: {
                    onReady: onPlayerReady,
                    onStateChange: onPlayerStateChange
                }
            });
        }
        
        function onPlayerReady() {
            if (isHost) {
                setInterval(() => {
                    if (player?.getCurrentTime && currentRoom) {
                        db.ref(`rooms/${currentRoom}/currentVideo`).update({
                            time: player.getCurrentTime(),
                            isPlaying: player.getPlayerState() === YT.PlayerState.PLAYING,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                }, 2000);
            }
        }
        
        function onPlayerStateChange(e) {
            if (isHost && currentRoom) {
                db.ref(`rooms/${currentRoom}/currentVideo`).update({
                    isPlaying: e.data === YT.PlayerState.PLAYING,
                    time: player.getCurrentTime(),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }
        
        // Dig…ôr funksiyalar (tema, chat, vs) - eyni qalƒ±r
        function initThemePicker() {
            const grid = document.getElementById('themeGrid');
            if (!grid) return;
            
            const themes = [
                { id: 'red', name: 'Qƒ±rmƒ±zƒ±', color: '#dc2626' },
                { id: 'pink', name: '√á…ôhrayƒ±', color: '#ec4899' },
                { id: 'green', name: 'Ya≈üƒ±l', color: '#22c55e' },
                { id: 'blue', name: 'Mavi', color: '#3b82f6' }
            ];
            
            grid.innerHTML = '';
            themes.forEach(theme => {
                const btn = document.createElement('div');
                btn.className = 'theme-option';
                btn.style.background = theme.color;
                btn.onclick = () => changeTheme(theme.id);
                btn.innerHTML = `<span class="theme-label">${theme.name}</span>`;
                grid.appendChild(btn);
            });
        }
        
        function openThemePicker() {
            if (!isHost) return alert('Yalnƒ±z moderator d…ôyi≈ü…ô bil…ôr');
            document.getElementById('themePicker')?.classList.add('active');
        }
        
        function closeThemePicker() {
            document.getElementById('themePicker')?.classList.remove('active');
        }
        
        function changeTheme(themeId) {
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            document.body.classList.add(`theme-${themeId}`);
            closeThemePicker();
        }
        
        function setupListeners() {
            if (!currentRoom) return;
            
            // Users
            db.ref(`rooms/${currentRoom}/users`).on('value', (snap) => {
                const users = snap.val() || {};
                const list = document.getElementById('usersList');
                if (!list) return;
                
                list.innerHTML = '';
                Object.entries(users).forEach(([uid, data]) => {
                    if (data.status !== 'active') return;
                    const chip = document.createElement('div');
                    chip.className = `user-chip ${data.isHost ? 'host' : ''}`;
                    chip.innerHTML = `
                        <img src="${data.avatar}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
                        <span>${data.name}</span>
                        ${data.isHost ? '<i class="fas fa-crown text-amber-400"></i>' : ''}
                    `;
                    list.appendChild(chip);
                });
            });
            
            // Messages
            db.ref(`rooms/${currentRoom}/messages`).limitToLast(50).on('child_added', (snap) => {
                displayMessage(snap.key, snap.val());
            });
        }
        
        function displayMessage(msgId, msg) {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            const isOwn = msg.userId === userId;
            const div = document.createElement('div');
            div.className = 'msg-wrapper';
            div.innerHTML = `
                <div class="msg-bubble ${isOwn ? 'msg-own' : 'msg-other'}">
                    <div class="text-xs opacity-70 mb-1">${msg.name}</div>
                    <div>${msg.text}</div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            if (!input || !currentRoom) return;
            
            const text = input.value.trim();
            if (!text) return;
            
            db.ref(`rooms/${currentRoom}/messages`).push({
                text,
                userId,
                name: userName,
                avatar: userAvatar,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            input.value = '';
        }
        
        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        function leaveRoom() {
            if (confirm('√áƒ±xmaq ist…ôyirsiniz?')) {
                if (currentRoom) {
                    db.ref(`rooms/${currentRoom}/users/${userId}`).remove();
                }
                location.reload();
            }
        }
        
        function copyCode() {
            navigator.clipboard.writeText(currentRoom);
            alert('Kod kopyalandƒ±!');
        }
    </script>

    <!-- LANDING PAGE -->
    <div id="landing" class="flex-1 flex items-center justify-center p-4">
        <div class="glass-red rounded-3xl p-8 max-w-md w-full space-y-6">
            <div class="text-center">
                <h1 class="text-4xl font-bold mb-2">üìΩÔ∏è KinoZal</h1>
                <p class="text-white/60">Dostlarƒ±nƒ±zla birlikd…ô izl…ôyin</p>
            </div>

            <div class="flex flex-col items-center space-y-4">
                <div class="avatar-upload" onclick="triggerAvatarUpload()">
                    <img id="avatarPreview" class="avatar-preview" alt="Avatar">
                    <div class="avatar-placeholder" id="avatarPlaceholder">
                        <i class="fas fa-camera text-2xl mb-1"></i>
                        <span class="text-xs">≈û…ôkil se√ß</span>
                    </div>
                </div>
                
                <p id="avatarError" class="text-xs text-red-400 hidden">
                    <i class="fas fa-exclamation-circle mr-1"></i>≈û…ôkil se√ßilm…ôlidir
                </p>
            </div>

            <div class="space-y-4">
                <input type="text" id="hostName" placeholder="Adƒ±nƒ±zƒ± daxil edin" 
                    class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/20 text-white text-center focus:outline-none focus:border-red-500">
                
                <button onclick="createRoom()" 
                    class="w-full py-3 rounded-xl font-bold text-white transition hover:opacity-90"
                    style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));">
                    <i class="fas fa-plus-circle mr-2"></i>Otaq Yarat
                </button>

                <div class="relative flex items-center py-2">
                    <div class="flex-grow border-t border-white/20"></div>
                    <span class="px-3 text-xs text-white/50">VE YA</span>
                    <div class="flex-grow border-t border-white/20"></div>
                </div>

                <input type="text" id="joinRoomId" placeholder="Otaq Kodu" 
                    class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/20 text-white text-center uppercase tracking-widest focus:outline-none">
                
                <button onclick="joinRoom()" 
                    class="w-full py-3 bg-neutral-900 hover:bg-neutral-800 rounded-xl font-bold transition border border-white/10 text-white">
                    <i class="fas fa-sign-in-alt mr-2"></i>Qo≈üul
                </button>
            </div>
        </div>
    </div>

    <!-- ROOM INTERFACE -->
    <div id="room" class="hidden flex-1 flex flex-col">
        <header class="glass-red border-b h-16 flex items-center justify-between px-6">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold">Kino<span style="color: var(--primary-color)">Zal</span></h1>
                <div class="px-3 py-1 rounded-full bg-black/40 border border-white/20 text-sm">
                    <span class="text-xs text-white/50 uppercase mr-2">Kod:</span>
                    <span id="roomCode" class="font-mono font-bold" style="color: var(--primary-color)">---</span>
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                <button onclick="openThemePicker()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition">
                    <i class="fas fa-palette" style="color: var(--primary-color)"></i>
                </button>
                <button onclick="copyCode()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition">
                    <i class="fas fa-copy"></i>
                </button>
                <span id="userType" class="px-3 py-1 rounded-full text-xs font-bold bg-neutral-900 border border-white/20">ƒ∞zl…ôyici</span>
                <button onclick="leaveRoom()" class="w-10 h-10 rounded-full hover:bg-red-500/20 text-red-400 flex items-center justify-center transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </header>

        <div class="main-container">
            <div id="videoSection" class="flex-1 relative bg-black">
                <button id="changeVideoBtn" onclick="toggleSearch()" class="hidden absolute top-4 right-4 z-40 glass-red px-4 py-2 rounded-xl text-sm font-bold">
                    <i class="fas fa-film mr-2" style="color: var(--primary-color)"></i>Video D…ôyi≈ü
                </button>
                <div id="player" class="w-full h-full"></div>
            </div>

            <div class="chat-container glass-red">
                <div class="p-4 border-b border-white/10">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-bold uppercase tracking-wider" style="color: var(--primary-color)">ƒ∞≈ütirak√ßƒ±lar</h3>
                    </div>
                    <div id="usersList" class="flex gap-2 overflow-x-auto"></div>
                </div>

                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
                
                <div class="p-4 border-t border-white/10 bg-black/20">
                    <div class="flex gap-2">
                        <input type="text" id="messageInput" placeholder="Mesaj yaz..." 
                            class="flex-1 bg-black/40 border border-white/20 rounded-xl px-4 py-2 text-white focus:outline-none focus:border-red-500"
                            onkeypress="handleKeyPress(event)">
                        <button onclick="sendMessage()" class="w-10 h-10 rounded-full flex items-center justify-center text-white" style="background: var(--primary-color);">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- THEME PICKER -->
    <div id="themePicker" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-red rounded-3xl p-6 max-w-sm w-full m-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold">Tema Se√ß</h3>
                <button onclick="closeThemePicker()" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="grid grid-cols-2 gap-4" id="themeGrid"></div>
        </div>
    </div>

    <style>
        .msg-wrapper { display: flex; margin-bottom: 8px; }
        .msg-bubble { max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 14px; }
        .msg-own { margin-left: auto; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border-bottom-right-radius: 4px; }
        .msg-other { margin-right: auto; background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); border-bottom-left-radius: 4px; }
        .user-chip { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer; white-space: nowrap; font-size: 13px; }
        .user-chip.host { background: rgba(234, 179, 8, 0.1); border-color: rgba(234, 179, 8, 0.3); }
        .theme-option { aspect-ratio: 1; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; }
    </style>

</body>
</html>
