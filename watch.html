<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KinoZal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
        
        * { 
            font-family: 'Space Grotesk', sans-serif; 
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #dc2626;
            --primary-dark: #991b1b;
            --primary-light: #fca5a5;
            --bg-color: #050505;
            --surface: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --hover: rgba(255, 255, 255, 0.06);
        }
        
        body.theme-red { --primary-color: #dc2626; --primary-dark: #991b1b; --primary-light: #fca5a5; }
        body.theme-pink { --primary-color: #ec4899; --primary-dark: #be185d; --primary-light: #fbcfe8; }
        body.theme-green { --primary-color: #22c55e; --primary-dark: #15803d; --primary-light: #86efac; }
        body.theme-blue { --primary-color: #3b82f6; --primary-dark: #1d4ed8; --primary-light: #93c5fd; }
        body.theme-black { --primary-color: #525252; --primary-dark: #171717; --primary-light: #a3a3a3; }
        body.theme-gray { --primary-color: #6b7280; --primary-dark: #374151; --primary-light: #d1d5db; }
        body.theme-darkgreen { --primary-color: #059669; --primary-dark: #065f46; --primary-light: #6ee7b7; }
        body.theme-lightblue { --primary-color: #06b6d4; --primary-dark: #0891b2; --primary-light: #a5f3fc; }
        body.theme-orange { --primary-color: #f97316; --primary-dark: #c2410c; --primary-light: #fdba74; }
        
        body { 
            background: var(--bg-color); 
            color: #fafafa;
            overflow: hidden;
            letter-spacing: -0.02em;
        }

        /* Animated Background */
        .bg-mesh {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: 
                radial-gradient(circle at 0% 0%, var(--primary-color) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, var(--primary-dark) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255,255,255,0.02) 0%, transparent 50%);
            opacity: 0.4;
            animation: meshMove 20s ease-in-out infinite;
        }

        @keyframes meshMove {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        /* Glass Cards - New Style */
        .glass-panel {
            background: var(--surface);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-panel:hover {
            border-color: rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.05);
        }

        /* Buttons - Pill Style */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border: none;
            border-radius: 50px;
            padding: 14px 28px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1) inset;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4), 0 0 20px var(--primary-color);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 14px 28px;
            color: #fafafa;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: var(--hover);
            border-color: rgba(255,255,255,0.2);
        }

        /* Input Fields - Minimal */
        .input-minimal {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px 20px;
            color: white;
            font-size: 15px;
            transition: all 0.3s;
            outline: none;
        }

        .input-minimal:focus {
            border-color: var(--primary-color);
            background: rgba(0,0,0,0.5);
            box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1);
        }

        .input-minimal::placeholder {
            color: rgba(255,255,255,0.3);
        }

        /* Avatar Upload - New Style */
        .avatar-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 2px dashed rgba(255,255,255,0.2);
            position: relative;
            cursor: pointer;
            transition: all 0.4s;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar-container:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.2);
        }

        .avatar-container.has-image {
            border-style: solid;
            border-color: var(--primary-color);
        }

        .avatar-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .avatar-preview.show {
            display: block;
        }

        .avatar-placeholder {
            text-align: center;
            color: rgba(255,255,255,0.4);
            pointer-events: none;
        }

        /* Room Header - Floating */
        .floating-header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 24px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 50px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        /* Video Container - Cinematic */
        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 32px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.8);
        }

        /* Chat - Modern Bubbles */
        .chat-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: var(--surface);
            border-left: 1px solid var(--border);
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 20px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
            animation: messageSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-own {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-bottom-right-radius: 4px;
            margin-left: auto;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .message-other {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.9);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border);
        }

        .chat-input-wrapper {
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid var(--border);
        }

        .chat-textarea {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 14px 20px;
            color: white;
            resize: none;
            outline: none;
            font-size: 14px;
            transition: all 0.3s;
        }

        .chat-textarea:focus {
            border-color: var(--primary-color);
            background: rgba(255,255,255,0.08);
        }

        /* User Chips - Minimal Pills */
        .user-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 50px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .user-pill:hover {
            background: var(--hover);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .user-pill.host {
            background: rgba(234, 179, 8, 0.1);
            border-color: rgba(234, 179, 8, 0.3);
        }

        /* Theme Picker - Grid */
        .theme-grid-new {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            padding: 20px;
        }

        .theme-circle {
            aspect-ratio: 1;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            border: 3px solid transparent;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .theme-circle:hover {
            transform: scale(1.1);
        }

        .theme-circle.active {
            border-color: white;
            box-shadow: 0 0 0 4px rgba(255,255,255,0.1), 0 0 30px currentColor;
        }

        .theme-circle::after {
            content: attr(data-name);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            white-space: nowrap;
        }

        /* Cinema Mode */
        body.cinema-mode .floating-header,
        body.cinema-mode .chat-wrapper {
            opacity: 0;
            pointer-events: none;
        }

        body.cinema-mode .video-container {
            position: fixed;
            inset: 0;
            border-radius: 0;
            z-index: 1000;
        }

        .cinema-toggle-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 2000;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(0,0,0,0.8);
            border: 1px solid var(--border);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .cinema-toggle-btn:hover {
            background: var(--primary-color);
            transform: scale(1.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen overflow-hidden theme-red">
    <div class="bg-mesh"></div>

    <input type="file" id="avatarInput" style="display: none;" accept="image/*" onchange="handleAvatarSelect(event)">

    <!-- LANDING PAGE - NEW DESIGN -->
    <div id="landing" class="h-full flex items-center justify-center p-6 fade-in">
        <div class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
            
            <!-- Left Side - Hero -->
            <div class="text-center lg:text-left space-y-6">
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 border border-white/10 text-sm text-white/60">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    Canlƒ± Sinema T…ôcr√ºb…ôsi
                </div>
                
                <h1 class="text-6xl lg:text-7xl font-bold leading-tight">
                    Birlikd…ô<br>
                    <span style="color: var(--primary-color)" class="text-transparent bg-clip-text bg-gradient-to-r from-current to-white">ƒ∞zl…ôyin</span>
                </h1>
                
                <p class="text-lg text-white/50 max-w-md leading-relaxed">
                    Dostlarƒ±nƒ±zla birlikd…ô eyni anda film v…ô video izl…ôyin. Real-time s√∂hb…ôt v…ô sinxronizasiya il…ô.
                </p>
                
                <div class="flex items-center gap-4 pt-4 justify-center lg:justify-start">
                    <div class="flex -space-x-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 border-2 border-black"></div>
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-500 to-teal-600 border-2 border-black"></div>
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-orange-500 to-red-600 border-2 border-black"></div>
                    </div>
                    <span class="text-sm text-white/40">+1000 istifad…ô√ßi</span>
                </div>
            </div>

            <!-- Right Side - Form -->
            <div class="glass-panel p-8 lg:p-12 space-y-8">
                <div class="text-center space-y-2">
                    <h2 class="text-2xl font-bold">Ba≈ülayƒ±n</h2>
                    <p class="text-white/40 text-sm">Profil m…ôlumatlarƒ±nƒ±zƒ± daxil edin</p>
                </div>

                <!-- Avatar -->
                <div class="flex justify-center">
                    <div class="avatar-container" id="avatarUpload" onclick="triggerAvatarUpload()">
                        <img id="avatarPreview" class="avatar-preview" src="" alt="">
                        <div class="avatar-placeholder" id="avatarPlaceholder">
                            <i class="fas fa-camera text-2xl mb-2"></i>
                            <span class="text-xs">≈û…ôkil se√ß</span>
                        </div>
                    </div>
                </div>

                <div id="avatarError" class="hidden text-center text-sm text-red-400">
                    <i class="fas fa-exclamation-circle mr-1"></i>Profil ≈ü…ôkli se√ßilm…ôlidir
                </div>

                <!-- Inputs -->
                <div class="space-y-4">
                    <input type="text" id="hostName" placeholder="Adƒ±nƒ±z" class="input-minimal text-center">
                    
                    <button onclick="createRoom()" class="btn-primary w-full text-base">
                        <i class="fas fa-plus-circle mr-2"></i>Yeni Otaq Yarat
                    </button>

                    <div class="relative flex items-center gap-4">
                        <div class="flex-1 h-px bg-white/10"></div>
                        <span class="text-xs text-white/30 uppercase tracking-wider">v…ô ya</span>
                        <div class="flex-1 h-px bg-white/10"></div>
                    </div>

                    <input type="text" id="joinRoomId" placeholder="Otaq Kodu (m…ôs: A3B7C9)" class="input-minimal text-center uppercase tracking-widest font-mono">
                    
                    <button onclick="joinRoom()" class="btn-secondary w-full">
                        <i class="fas fa-sign-in-alt mr-2"></i>Otaƒüa Qo≈üul
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- THEME PICKER - NEW DESIGN -->
    <div id="themePicker" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onclick="if(event.target === this) closeThemePicker()">
        <div class="glass-panel p-8 max-w-md w-full" style="animation: fadeIn 0.3s ease-out">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xl font-bold">Tema Se√ßimi</h3>
                <button onclick="closeThemePicker()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="theme-grid-new" id="themeGrid"></div>
            
            <p class="text-center text-xs text-white/30 mt-8">Yalnƒ±z moderator t…ôr…ôfind…ôn d…ôyi≈üil…ô bil…ôr</p>
        </div>
    </div>

    <!-- MODERATOR MODAL - NEW DESIGN -->
    <div id="userModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onclick="if(event.target === this) closeUserModal()">
        <div class="glass-panel p-8 max-w-sm w-full space-y-6" style="animation: fadeIn 0.3s ease-out">
            <div class="flex items-center gap-4">
                <img id="modalUserAvatar" src="" class="w-16 h-16 rounded-full object-cover border-2" style="border-color: var(--primary-color)">
                <div>
                    <h3 id="modalUserName" class="text-lg font-bold"></h3>
                    <p id="modalUserStatus" class="text-sm text-white/50"></p>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex items-center justify-between p-4 rounded-2xl bg-white/5 border border-white/10">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-comment" style="color: var(--primary-color)"></i>
                        <span class="text-sm">Yazƒ± Yazmaq</span>
                    </div>
                    <div class="toggle-switch active" id="permChat" onclick="togglePermission('chat')"></div>
                </div>

                <div class="flex items-center justify-between p-4 rounded-2xl bg-white/5 border border-white/10">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-eye" style="color: var(--primary-color)"></i>
                        <span class="text-sm">Video ƒ∞zl…ôm…ô</span>
                    </div>
                    <div class="toggle-switch active" id="permVideo" onclick="togglePermission('video')"></div>
                </div>

                <div class="flex items-center justify-between p-4 rounded-2xl bg-white/5 border border-white/10">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-film" style="color: var(--primary-color)"></i>
                        <span class="text-sm">Video Se√ßm…ô</span>
                    </div>
                    <div class="toggle-switch" id="permChangeVideo" onclick="togglePermission('changeVideo')"></div>
                </div>
            </div>

            <button onclick="kickUser()" class="w-full py-3 rounded-2xl bg-red-500/10 border border-red-500/30 text-red-400 hover:bg-red-500/20 transition font-medium">
                <i class="fas fa-sign-out-alt mr-2"></i>Otaqdan At
            </button>
        </div>
    </div>

    <!-- REACTION PICKER -->
    <div id="emojiPickerTemplate" class="emoji-picker">
        <button class="emoji-btn" onclick="addReaction('üëç')">üëç</button>
        <button class="emoji-btn" onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
        <button class="emoji-btn" onclick="addReaction('üòÇ')">üòÇ</button>
        <button class="emoji-btn" onclick="addReaction('üòÆ')">üòÆ</button>
        <button class="emoji-btn" onclick="addReaction('üò¢')">üò¢</button>
        <button class="emoji-btn" onclick="addReaction('üî•')">üî•</button>
        <button class="emoji-btn" onclick="addReaction('üëè')">üëè</button>
        <button class="emoji-btn" onclick="addReaction('ü§î')">ü§î</button>
    </div>

    <style>
        .emoji-picker { position: absolute; bottom: 40px; right: 0; background: rgba(0,0,0,0.9); border: 1px solid var(--border); border-radius: 16px; padding: 8px; display: none; grid-template-columns: repeat(4, 1fr); gap: 8px; z-index: 100; backdrop-filter: blur(10px); }
        .emoji-picker.show { display: grid; }
        .emoji-btn { background: transparent; border: none; cursor: pointer; font-size: 20px; padding: 8px; border-radius: 8px; transition: all 0.2s; }
        .emoji-btn:hover { background: var(--primary-color); transform: scale(1.2); }
        .toggle-switch { width: 44px; height: 24px; background: rgba(255,255,255,0.1); border-radius: 12px; position: relative; cursor: pointer; transition: all 0.3s; }
        .toggle-switch.active { background: var(--primary-color); }
        .toggle-switch::after { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: transform 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-switch.active::after { transform: translateX(20px); }
        .reaction-bar { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
        .reaction-item { background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 20px; padding: 4px 10px; font-size: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 4px; backdrop-filter: blur(10px); }
        .reaction-item:hover { background: var(--primary-color); border-color: var(--primary-color); transform: scale(1.05); }
        .reaction-item.user-reacted { background: var(--primary-color); border-color: var(--primary-color); }
        .reaction-btn { position: absolute; bottom: -8px; right: -8px; width: 28px; height: 28px; background: rgba(0,0,0,0.8); border: 1px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: all 0.2s; color: var(--primary-color); font-size: 12px; backdrop-filter: blur(10px); }
        .msg-wrapper:hover .reaction-btn { opacity: 1; }
        .message-own .reaction-btn { right: auto; left: -8px; }
    </style>

    <!-- ROOM INTERFACE - NEW DESIGN -->
    <div id="room" class="hidden h-full flex flex-col relative">
        
        <!-- Floating Header -->
        <div class="floating-header">
            <h1 class="text-lg font-bold tracking-tight">Kino<span style="color: var(--primary-color)">Zal</span></h1>
            
            <div class="h-6 w-px bg-white/20"></div>
            
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10">
                <span class="text-xs text-white/40 uppercase tracking-wider">Kod</span>
                <span id="roomCode" class="font-mono font-bold text-sm tracking-widest" style="color: var(--primary-color)">---</span>
                <button onclick="copyCode()" class="ml-2 text-white/40 hover:text-white transition">
                    <i class="fas fa-copy text-xs"></i>
                </button>
            </div>

            <div class="h-6 w-px bg-white/20"></div>

            <button onclick="openThemePicker()" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center transition" title="Tema">
                <i class="fas fa-palette text-sm" style="color: var(--primary-color)"></i>
            </button>

            <span id="userType" class="text-xs px-3 py-1 rounded-full bg-white/5 border border-white/10">ƒ∞zl…ôyici</span>
            
            <button onclick="leaveRoom()" class="w-8 h-8 rounded-full hover:bg-red-500/20 hover:text-red-400 flex items-center justify-center transition text-white/60">
                <i class="fas fa-times text-sm"></i>
            </button>
        </div>

        <!-- Cinema Toggle -->
        <button class="cinema-toggle-btn" onclick="toggleCinemaMode()">
            <i class="fas fa-expand"></i>
        </button>

        <!-- Main Content -->
        <div class="flex-1 flex overflow-hidden pt-24 pb-6 px-6 gap-6">
            
            <!-- Video Section -->
            <div class="flex-1 flex flex-col gap-4 min-w-0">
                <div class="video-container relative group">
                    <div id="player" class="w-full h-full"></div>
                    <div id="viewerOverlay" class="hidden absolute inset-0 z-10"></div>
                    
                    <!-- Video Controls Overlay -->
                    <div id="hostControls" class="hidden absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                        <div class="flex items-center justify-center gap-6">
                            <button onclick="playerControl('seek', -10)" class="w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center backdrop-blur-sm transition">
                                <i class="fas fa-backward"></i>
                            </button>
                            <button onclick="playerControl('toggle')" class="w-14 h-14 rounded-full flex items-center justify-center transition transform hover:scale-110" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); box-shadow: 0 0 30px var(--primary-color);">
                                <i class="fas fa-play text-lg" id="playIcon"></i>
                                <i class="fas fa-pause text-lg hidden" id="pauseIcon"></i>
                            </button>
                            <button onclick="playerControl('seek', 10)" class="w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center backdrop-blur-sm transition">
                                <i class="fas fa-forward"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Change Video Button -->
                    <button id="changeVideoBtn" onclick="toggleSearch()" class="hidden absolute top-4 right-4 px-4 py-2 rounded-full bg-black/60 backdrop-blur-md border border-white/10 text-sm font-medium hover:bg-black/80 transition">
                        <i class="fas fa-film mr-2" style="color: var(--primary-color)"></i>Video D…ôyi≈ü
                    </button>

                    <!-- Search Overlay -->
                    <div id="searchContainer" class="hidden absolute top-4 left-4 right-4 z-30">
                        <div class="glass-panel p-4 space-y-4">
                            <div class="flex gap-2">
                                <input type="text" id="searchQuery" placeholder="YouTube-da axtar..." class="flex-1 input-minimal" onkeypress="if(event.key==='Enter') searchYouTube()">
                                <button onclick="searchYouTube()" class="btn-primary px-6">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button onclick="closeSearch()" class="w-12 h-12 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition border border-white/10">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="searchResults" class="hidden max-h-64 overflow-y-auto space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="w-96 flex flex-col glass-panel overflow-hidden">
                <!-- Users Bar -->
                <div class="p-4 border-b border-white/10">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xs font-medium text-white/40 uppercase tracking-wider">ƒ∞≈ütirak√ßƒ±lar</span>
                        <span id="onlineCount" class="text-xs px-2 py-1 rounded-full bg-white/5 text-white/60">0 onlayn</span>
                    </div>
                    <div id="usersList" class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                        <!-- Users injected here -->
                    </div>
                </div>

                <!-- Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <div id="typingIndicator" class="hidden flex items-center gap-2 text-xs text-white/40">
                        <div class="flex gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-current animate-bounce"></span>
                            <span class="w-1.5 h-1.5 rounded-full bg-current animate-bounce" style="animation-delay: 0.1s"></span>
                            <span class="w-1.5 h-1.5 rounded-full bg-current animate-bounce" style="animation-delay: 0.2s"></span>
                        </div>
                        <span id="typingText">yazƒ±r...</span>
                    </div>
                </div>

                <!-- Reply Indicator -->
                <div id="replyIndicator" class="hidden px-4 py-2 bg-white/5 border-t border-white/10">
                    <div class="flex items-center justify-between text-xs">
                        <div class="flex items-center gap-2 text-white/60">
                            <i class="fas fa-reply"></i>
                            <span id="replyText" class="truncate max-w-[200px]"></span>
                        </div>
                        <button onclick="cancelReply()" class="text-white/40 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Input -->
                <div class="chat-input-wrapper">
                    <div class="relative">
                        <textarea id="messageInput" placeholder="Mesaj yaz..." rows="1" 
                            class="chat-textarea pr-12"
                            oninput="autoResize(this); handleTyping()"
                            onkeypress="handleKeyPress(event)"></textarea>
                        <button onclick="sendMessage()" class="absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full flex items-center justify-center transition hover:scale-110" style="background: var(--primary-color);">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notificationToast" class="fixed top-6 right-6 z-[9999] transform translate-x-[150%] transition-all duration-500">
        <div class="glass-panel px-6 py-4 flex items-center gap-4 min-w-[300px]">
            <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));">
                <i class="fas fa-info text-sm"></i>
            </div>
            <div>
                <div id="notifTitle" class="font-bold text-sm">Bildiri≈ü</div>
                <div id="notifText" class="text-xs text-white/60 mt-0.5">...</div>
            </div>
        </div>
    </div>

    <script>
        // Firebase v…ô JavaScript funksionallƒ±ƒüƒ± …ôvv…ôlki kimi qalƒ±r
        // (…ôvv…ôlki kodun tam JavaScript hiss…ôsini buraya …ôlav…ô et)
        
        const firebaseConfig = {
            apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PfyJRdk",
            authDomain: "sevgili-testi.firebaseapp.com",
            databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
            projectId: "sevgili-testi",
            storageBucket: "sevgili-testi.firebasestorage.app",
            messagingSenderId: "399260477557",
            appId: "1:399260477557:web:584204a698d7bf145bb03c"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const YOUTUBE_API_KEY = "AIzaSyBterRsxZoTvVbxlsOzESKWBDAY2B8BWc4";
        
        let userId = localStorage.getItem('syncUserId');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('syncUserId', userId);
        }
        
        let currentRoom = null, isHost = false, player = null, serverOffset = 0;
        let ignoreUpdates = false, currentVideoId = null, replyingTo = null;
        let userName = '', userAvatar = localStorage.getItem('userAvatar') || '';
        let selectedUserId = null, typingTimeout = null, cinemaMode = false;
        let currentReactionMessageId = null, listeners = [];
        
        const themes = [
            { id: 'red', name: 'Qƒ±rmƒ±zƒ±', color: '#dc2626' },
            { id: 'pink', name: '√á…ôhrayƒ±', color: '#ec4899' },
            { id: 'green', name: 'Ya≈üƒ±l', color: '#22c55e' },
            { id: 'blue', name: 'Mavi', color: '#3b82f6' },
            { id: 'black', name: 'Qara', color: '#525252' },
            { id: 'gray', name: 'Boz', color: '#6b7280' },
            { id: 'darkgreen', name: 'T√ºnd Ya≈üƒ±l', color: '#059669' },
            { id: 'lightblue', name: 'A√ßƒ±q Mavi', color: '#06b6d4' },
            { id: 'orange', name: 'Narƒ±ncƒ±', color: '#f97316' }
        ];
        
        db.ref(".info/serverTimeOffset").on("value", (snap) => { serverOffset = snap.val() || 0; });
        
        // Init
        document.addEventListener('DOMContentLoaded', () => {
            if (userAvatar) updateAvatarUI(userAvatar);
        });
        
        function updateAvatarUI(src) {
            const preview = document.getElementById('avatarPreview');
            const container = document.getElementById('avatarUpload');
            if (preview) {
                preview.src = src;
                preview.classList.add('show');
            }
            if (container) container.classList.add('has-image');
        }
        
        function triggerAvatarUpload() {
            document.getElementById('avatarInput').click();
        }
        
        function handleAvatarSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) return showNotification('X…ôta', '≈û…ôkil 2MB-dan ki√ßik olmalƒ±dƒ±r');
            if (!file.type.startsWith('image/')) return showNotification('X…ôta', 'Yalnƒ±z ≈ü…ôkil faylƒ±');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                userAvatar = e.target.result;
                localStorage.setItem('userAvatar', userAvatar);
                updateAvatarUI(userAvatar);
                document.getElementById('avatarError').classList.add('hidden');
                showNotification('Uƒüurlu', 'Profil ≈ü…ôkli yenil…ôndi');
            };
            reader.readAsDataURL(file);
        }
        
        function validateInputs() {
            const name = document.getElementById('hostName')?.value.trim();
            if (!name) { showNotification('X…ôta', 'Adƒ±nƒ±zƒ± daxil edin'); return false; }
            if (!userAvatar) { 
                document.getElementById('avatarError').classList.remove('hidden');
                showNotification('X…ôta', 'Profil ≈ü…ôkli se√ßin'); 
                return false; 
            }
            return true;
        }
        
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        function initThemePicker() {
            const grid = document.getElementById('themeGrid');
            if (!grid) return;
            grid.innerHTML = '';
            themes.forEach(t => {
                const div = document.createElement('div');
                div.className = 'theme-circle';
                div.style.background = `linear-gradient(135deg, ${t.color}, ${t.color}dd)`;
                div.style.color = t.color;
                div.dataset.name = t.name;
                div.dataset.theme = t.id;
                div.onclick = () => changeTheme(t.id);
                grid.appendChild(div);
            });
        }
        
        function openThemePicker() {
            if (!isHost && !userPermissions.changeVideo) return showNotification('ƒ∞caz…ô yoxdur', 'Yalnƒ±z moderator');
            document.getElementById('themePicker').classList.remove('hidden');
        }
        
        function closeThemePicker() {
            document.getElementById('themePicker').classList.add('hidden');
        }
        
        function changeTheme(id) {
            if (!currentRoom) return;
            db.ref(`rooms/${currentRoom}/theme`).set({
                color: id, updatedBy: userId, timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            closeThemePicker();
        }
        
        function applyTheme(id) {
            document.body.className = document.body.className.replace(/theme-\w+/g, '') + ` theme-${id}`;
            document.querySelectorAll('.theme-circle').forEach(el => {
                el.classList.toggle('active', el.dataset.theme === id);
            });
        }
        
        let userPermissions = { chat: true, video: true, changeVideo: false };
        
        async function createRoom() {
            if (!validateInputs()) return;
            userName = document.getElementById('hostName').value.trim();
            const code = generateRoomCode();
            
            try {
                await db.ref(`rooms/${code}`).set({
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    hostId: userId,
                    theme: { color: 'red', updatedBy: userId, timestamp: firebase.database.ServerValue.TIMESTAMP },
                    currentVideo: { id: 'jfKfPfyJRdk', title: 'Lofi Girl', time: 0, isPlaying: false, timestamp: firebase.database.ServerValue.TIMESTAMP },
                    users: { [userId]: { name: userName, avatar: userAvatar, isHost: true, joinedAt: firebase.database.ServerValue.TIMESTAMP, status: 'active' }},
                    permissions: {}
                });
                enterRoom(code, true);
            } catch(e) { showNotification('X…ôta', e.message); }
        }
        
        async function joinRoom() {
            const code = document.getElementById('joinRoomId').value.trim().toUpperCase();
            if (!validateInputs() || !code) return showNotification('X…ôta', 'Kodu daxil edin');
            
            userName = document.getElementById('hostName').value.trim();
            const snap = await db.ref(`rooms/${code}`).once('value');
            if (!snap.exists()) return showNotification('X…ôta', 'Otaq tapƒ±lmadƒ±');
            
            if (snap.val().theme) applyTheme(snap.val().theme.color);
            
            await db.ref(`rooms/${code}/users/${userId}`).set({
                name: userName, avatar: userAvatar, isHost: false, joinedAt: firebase.database.ServerValue.TIMESTAMP, status: 'active'
            });
            enterRoom(code, false);
        }
        
        function enterRoom(code, host) {
            currentRoom = code; isHost = host;
            document.getElementById('landing').classList.add('hidden');
            document.getElementById('room').classList.remove('hidden');
            document.getElementById('roomCode').textContent = code;
            
            const userType = document.getElementById('userType');
            if (host) {
                userType.textContent = 'üëë Moderator';
                userType.style.background = 'rgba(234, 179, 8, 0.1)';
                userType.style.color = '#fbbf24';
                document.getElementById('hostControls').classList.remove('hidden');
                document.getElementById('changeVideoBtn').classList.remove('hidden');
                document.getElementById('searchContainer').classList.remove('hidden');
                document.getElementById('viewerOverlay').classList.add('hidden');
                userPermissions = { chat: true, video: true, changeVideo: true };
            } else {
                userType.textContent = 'üëÅÔ∏è ƒ∞zl…ôyici';
                loadUserPermissions();
            }
            
            initThemePicker(); initPlayer(); setupListeners(); setupVisibility();
        }
        
        async function loadUserPermissions() {
            const snap = await db.ref(`rooms/${currentRoom}/permissions/${userId}`).once('value');
            if (snap.val()) {
                userPermissions = {...userPermissions, ...snap.val()};
                if (userPermissions.changeVideo) document.getElementById('changeVideoBtn').classList.remove('hidden');
            }
        }
        
        function setupVisibility() {
            document.addEventListener('visibilitychange', () => {
                if (currentRoom) db.ref(`rooms/${currentRoom}/users/${userId}/status`).set(document.hidden ? 'background' : 'active');
            });
        }
        
        function toggleCinemaMode() {
            cinemaMode = !cinemaMode;
            document.body.classList.toggle('cinema-mode');
            if (cinemaMode && document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(()=>{});
            } else if (!cinemaMode && document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
        
        function initPlayer() {
            if (typeof YT === 'undefined' || !YT.Player) { setTimeout(initPlayer, 100); return; }
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: 'jfKfPfyJRdk',
                playerVars: { autoplay: 0, controls: isHost ? 1 : 0, disablekb: isHost ? 0 : 1, rel: 0, playsinline: 1 },
                events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange }
            });
        }
        
        function onPlayerReady() {
            if (isHost) {
                setInterval(() => {
                    if (player?.getCurrentTime && currentRoom) {
                        db.ref(`rooms/${currentRoom}/currentVideo`).update({
                            time: player.getCurrentTime(),
                            isPlaying: player.getPlayerState() === YT.PlayerState.PLAYING,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                }, 2000);
            }
            syncVideo();
        }
        
        function syncVideo() {
            const videoRef = db.ref(`rooms/${currentRoom}/currentVideo`);
            listeners.push(videoRef);
            videoRef.on('value', (snap) => {
                const video = snap.val(); if (!video || !player?.loadVideoById) return;
                if (currentVideoId !== video.id) {
                    currentVideoId = video.id;
                    player.loadVideoById(video.id);
                    showNotification('Yeni video', video.title?.substring(0,30)+'...');
                }
                if (!isHost) {
                    if (Math.abs(player.getCurrentTime() - video.time) > 2) player.seekTo(video.time, true);
                    const isPlaying = player.getPlayerState() === YT.PlayerState.PLAYING;
                    if (video.isPlaying && !isPlaying) player.playVideo();
                    else if (!video.isPlaying && isPlaying) player.pauseVideo();
                }
            });
            
            const themeRef = db.ref(`rooms/${currentRoom}/theme`);
            listeners.push(themeRef);
            themeRef.on('value', (snap) => { if (snap.val()?.color) applyTheme(snap.val().color); });
        }
        
        function onPlayerStateChange(e) {
            updatePlayIcon(e.data === YT.PlayerState.PLAYING);
            if (isHost && currentRoom) {
                db.ref(`rooms/${currentRoom}/currentVideo`).update({
                    isPlaying: e.data === YT.PlayerState.PLAYING,
                    time: player.getCurrentTime(),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }
        
        function updatePlayIcon(playing) {
            document.getElementById('playIcon').classList.toggle('hidden', playing);
            document.getElementById('pauseIcon').classList.toggle('hidden', !playing);
        }
        
        function toggleSearch() {
            const canChange = isHost || userPermissions.changeVideo;
            if (!canChange) return showNotification('ƒ∞caz…ô yoxdur', 'Video d…ôyi≈üm…ôk √º√ß√ºn icaz…ô yoxdur');
            document.getElementById('searchContainer').classList.toggle('hidden');
        }
        
        function closeSearch() {
            document.getElementById('searchContainer').classList.add('hidden');
            document.getElementById('searchResults').classList.add('hidden');
        }
        
        async function searchYouTube() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) return;
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="flex justify-center p-4"><div class="spinner" style="border-color:var(--primary-color);border-left-color:transparent"></div></div>';
            resultsDiv.classList.remove('hidden');
            
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=8&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}`);
                const data = await res.json();
                resultsDiv.innerHTML = '';
                data.items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'flex gap-3 p-2 rounded-xl hover:bg-white/5 cursor-pointer transition';
                    card.onclick = () => selectVideo(item.id.videoId, item.snippet.title);
                    card.innerHTML = `
                        <img src="${item.snippet.thumbnails.default.url}" class="w-24 h-16 object-cover rounded-lg">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium truncate">${escapeHtml(item.snippet.title)}</div>
                            <div class="text-xs text-white/40">${escapeHtml(item.snippet.channelTitle)}</div>
                        </div>
                    `;
                    resultsDiv.appendChild(card);
                });
            } catch(e) { resultsDiv.innerHTML = '<div class="text-center text-red-400 text-sm">X…ôta ba≈ü verdi</div>'; }
        }
        
        function selectVideo(id, title) {
            if (!isHost && !userPermissions.changeVideo) return;
            currentVideoId = id;
            player.loadVideoById(id);
            closeSearch();
            db.ref(`rooms/${currentRoom}/currentVideo`).set({
                id: id, title: title, time: 0, isPlaying: true,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            showNotification('Video d…ôyi≈üdirildi', title.substring(0,30)+'...');
        }
        
        function playerControl(action, val) {
            if (!isHost || !player) return;
            ignoreUpdates = true;
            setTimeout(() => ignoreUpdates = false, 500);
            if (action === 'toggle') {
                player.getPlayerState() === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo();
            } else if (action === 'seek') {
                player.seekTo(player.getCurrentTime() + val, true);
            }
        }
        
        function setupListeners() {
            const usersRef = db.ref(`rooms/${currentRoom}/users`);
            listeners.push(usersRef);
            usersRef.on('value', (snap) => {
                const users = snap.val() || {};
                const list = document.getElementById('usersList');
                list.innerHTML = ''; let count = 0;
                Object.entries(users).forEach(([uid, data]) => {
                    if (data.status !== 'active') return;
                    count++;
                    const pill = document.createElement('div');
                    pill.className = `user-pill ${data.isHost ? 'host' : ''}`;
                    pill.onclick = () => openUserModal(uid, data);
                    pill.innerHTML = `<img src="${data.avatar || 'https://via.placeholder.com/24'}" class="w-5 h-5 rounded-full object-cover"><span>${escapeHtml(data.name)}</span>${data.isHost ? '<i class="fas fa-crown text-amber-400 text-[10px]"></i>' : ''}`;
                    list.appendChild(pill);
                });
                document.getElementById('onlineCount').textContent = count + ' onlayn';
            });
            
            const messagesRef = db.ref(`rooms/${currentRoom}/messages`).limitToLast(50);
            listeners.push(messagesRef);
            messagesRef.on('child_added', (snap) => displayMessage(snap.key, snap.val()));
            
            const typingRef = db.ref(`rooms/${currentRoom}/typing`);
            listeners.push(typingRef);
            typingRef.on('value', (snap) => {
                const typing = snap.val() || {};
                const names = Object.entries(typing).filter(([uid, d]) => uid !== userId && d.timestamp > Date.now() - 3000).map(([_, d]) => d.name);
                const ind = document.getElementById('typingIndicator');
                if (names.length > 0) {
                    ind.classList.remove('hidden');
                    document.getElementById('typingText').textContent = names.join(', ') + ' yazƒ±r...';
                } else ind.classList.add('hidden');
            });
            
            if (!isHost) {
                db.ref(`rooms/${currentRoom}/permissions/${userId}`).on('value', (snap) => {
                    if (snap.val()) {
                        userPermissions = {...userPermissions, ...snap.val()};
                        document.getElementById('messageInput').disabled = userPermissions.chat === false;
                        document.getElementById('messageInput').placeholder = userPermissions.chat === false ? 'Yazƒ± qadaƒüandƒ±r' : 'Mesaj yaz...';
                    }
                });
                db.ref(`rooms/${currentRoom}/users/${userId}`).on('value', (snap) => {
                    if (!snap.exists()) { alert('Atƒ±ldƒ±nƒ±z!'); location.reload(); }
                });
            }
        }
        
        function handleTyping() {
            if (!currentRoom) return;
            db.ref(`rooms/${currentRoom}/typing/${userId}`).set({ name: userName, timestamp: firebase.database.ServerValue.TIMESTAMP });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => db.ref(`rooms/${currentRoom}/typing/${userId}`).remove(), 3000);
        }
        
        function displayMessage(msgId, msg) {
            const container = document.getElementById('chatMessages');
            const isOwn = msg.userId === userId;
            const div = document.createElement('div');
            div.className = 'relative group';
            div.id = 'msg-' + msgId;
            div.innerHTML = `
                <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} mb-4">
                    ${!isOwn ? `<img src="${msg.avatar}" class="w-8 h-8 rounded-full mr-2 self-end mb-1 cursor-pointer" onclick="setReply('${msgId}', '${escapeHtml(msg.name)}', '${escapeHtml(msg.text)}')">` : ''}
                    <div class="max-w-[80%]">
                        ${!isOwn ? `<div class="text-xs text-white/40 mb-1 ml-1">${escapeHtml(msg.name)}</div>` : ''}
                        <div class="message-bubble ${isOwn ? 'message-own' : 'message-other'}">
                            ${msg.replyTo ? `<div class="text-xs opacity-70 mb-1 border-l-2 border-white/30 pl-2">${escapeHtml(msg.replyTo.text)}</div>` : ''}
                            ${escapeHtml(msg.text)}
                        </div>
                        <div class="reaction-bar" id="reactions-${msgId}"></div>
                    </div>
                    ${isOwn ? `<img src="${msg.avatar}" class="w-8 h-8 rounded-full ml-2 self-end mb-1">` : ''}
                </div>
                <button class="reaction-btn" onclick="showReactionPicker('${msgId}')"><i class="far fa-smile"></i></button>
            `;
            container.insertBefore(div, document.getElementById('typingIndicator'));
            container.scrollTop = container.scrollHeight;
            loadReactions(msgId);
        }
        
        function loadReactions(msgId) {
            const ref = db.ref(`rooms/${currentRoom}/messages/${msgId}/reactions`);
            listeners.push(ref);
            ref.on('value', (snap) => {
                const reactions = snap.val() || {};
                const bar = document.getElementById('reactions-' + msgId);
                if (!bar) return;
                bar.innerHTML = '';
                const counts = {};
                Object.entries(reactions).forEach(([uid, emoji]) => {
                    counts[emoji] = (counts[emoji] || 0) + 1;
                    const div = document.createElement('div');
                    div.className = 'reaction-item ' + (uid === userId ? 'user-reacted' : '');
                    div.innerHTML = `<span>${emoji}</span><span>${counts[emoji]}</span>`;
                    div.onclick = () => toggleReaction(msgId, emoji);
                    bar.appendChild(div);
                });
            });
        }
        
        function showReactionPicker(msgId) {
            if (event) event.stopPropagation();
            currentReactionMessageId = msgId;
            document.querySelectorAll('.emoji-picker').forEach(el => { if(el.id !== 'emojiPickerTemplate') el.remove(); });
            const picker = document.getElementById('emojiPickerTemplate').cloneNode(true);
            picker.id = 'activePicker'; picker.classList.add('show');
            const bubble = document.getElementById('msg-' + msgId).querySelector('.message-bubble');
            bubble.style.position = 'relative';
            bubble.appendChild(picker);
            setTimeout(() => document.addEventListener('click', function close(e) { if(!e.target.closest('.emoji-picker')){picker.remove();document.removeEventListener('click',close);} }, {once:true}), 100);
        }
        
        function addReaction(emoji) {
            if (!currentReactionMessageId) return;
            toggleReaction(currentReactionMessageId, emoji);
            const picker = document.getElementById('activePicker');
            if (picker) picker.remove();
        }
        
        function toggleReaction(msgId, emoji) {
            const ref = db.ref(`rooms/${currentRoom}/messages/${msgId}/reactions/${userId}`);
            ref.once('value').then(snap => { snap.val() === emoji ? ref.remove() : ref.set(emoji); });
        }
        
        function setReply(msgId, name, text) {
            replyingTo = { id: msgId, name, text: text.substring(0,30) };
            document.getElementById('replyIndicator').classList.remove('hidden');
            document.getElementById('replyText').textContent = name + ': ' + text.substring(0,30);
            document.getElementById('messageInput').focus();
        }
        
        function cancelReply() {
            replyingTo = null;
            document.getElementById('replyIndicator').classList.add('hidden');
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !currentRoom) return;
            if (!isHost && userPermissions.chat === false) return showNotification('X…ôta', 'Yazƒ± qadaƒüandƒ±r');
            
            const msg = { type: 'text', text, userId, name: userName, avatar: userAvatar, timestamp: firebase.database.ServerValue.TIMESTAMP };
            if (replyingTo) { msg.replyTo = replyingTo; cancelReply(); }
            db.ref(`rooms/${currentRoom}/messages`).push(msg);
            input.value = ''; input.style.height = 'auto';
            db.ref(`rooms/${currentRoom}/typing/${userId}`).remove();
        }
        
        function handleKeyPress(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
        function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 100) + 'px'; }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        
        function openUserModal(uid, data) {
            if (!isHost || uid === userId) return;
            selectedUserId = uid;
            document.getElementById('modalUserName').textContent = data.name;
            document.getElementById('modalUserAvatar').src = data.avatar || 'https://via.placeholder.com/64';
            document.getElementById('modalUserStatus').textContent = data.isHost ? 'Moderator' : 'ƒ∞zl…ôyici';
            db.ref(`rooms/${currentRoom}/permissions/${uid}`).once('value').then(snap => {
                const perms = snap.val() || {chat:true, video:true, changeVideo:false};
                updateToggleUI(document.getElementById('permChat'), perms.chat!==false);
                updateToggleUI(document.getElementById('permVideo'), perms.video!==false);
                updateToggleUI(document.getElementById('permChangeVideo'), perms.changeVideo===true);
            });
            document.getElementById('userModal').classList.remove('hidden');
        }
        
        function closeUserModal() { document.getElementById('userModal').classList.add('hidden'); selectedUserId = null; }
        function updateToggleUI(el, active) { if(active) el.classList.add('active'); else el.classList.remove('active'); }
        function togglePermission(type) {
            if (!selectedUserId) return;
            const el = document.getElementById('perm' + type.charAt(0).toUpperCase() + type.slice(1));
            const newState = !el.classList.contains('active');
            updateToggleUI(el, newState);
            db.ref(`rooms/${currentRoom}/permissions/${selectedUserId}/${type}`).set(newState);
        }
        
        function kickUser() {
            if (!selectedUserId || !confirm('ƒ∞stifad…ô√ßi atƒ±lsƒ±n?')) return;
            db.ref(`rooms/${currentRoom}/users/${selectedUserId}`).remove();
            db.ref(`rooms/${currentRoom}/permissions/${selectedUserId}`).remove();
            closeUserModal();
            showNotification('ƒ∞stifad…ô√ßi atƒ±ldƒ±', '');
        }
        
        function showNotification(title, text) {
            document.getElementById('notifTitle').textContent = title;
            document.getElementById('notifText').textContent = text;
            const toast = document.getElementById('notificationToast');
            toast.style.transform = 'translateX(0)';
            setTimeout(() => toast.style.transform = 'translateX(150%)', 3000);
        }
        
        function copyCode() {
            navigator.clipboard.writeText(currentRoom);
            showNotification('Kopyalandƒ±', 'Otaq kodu kopyalandƒ±');
        }
        
        function leaveRoom() {
            if (!confirm('√áƒ±xmaq ist…ôdiyiniz…ô …ôminsiniz?')) return;
            listeners.forEach(ref => ref.off());
            if (currentRoom) {
                db.ref(`rooms/${currentRoom}/users/${userId}`).remove();
                db.ref(`rooms/${currentRoom}/typing/${userId}`).remove();
            }
            location.reload();
        }
    </script>
</body>
</html>
