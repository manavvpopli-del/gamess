<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KinoZal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --primary: #dc2626;
            --primary-dark: #991b1b;
            --glass: rgba(20, 0, 0, 0.95);
            --border: rgba(220, 38, 38, 0.3);
        }
        
        body.theme-red { --primary: #dc2626; --primary-dark: #991b1b; --bg: #0a0000; --glass: rgba(20, 0, 0, 0.95); --border: rgba(220, 38, 38, 0.3); }
        body.theme-blue { --primary: #3b82f6; --primary-dark: #1d4ed8; --bg: #000510; --glass: rgba(0, 10, 30, 0.95); --border: rgba(59, 130, 246, 0.3); }
        body.theme-green { --primary: #22c55e; --primary-dark: #15803d; --bg: #000a03; --glass: rgba(0, 20, 5, 0.95); --border: rgba(34, 197, 94, 0.3); }
        
        body { background: var(--bg, #0a0000); color: white; overflow: hidden; height: 100vh; }
        
        .glass { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); }
        
        /* Landing Avatar */
        .avatar-box { 
            width: 100px; height: 100px; border-radius: 50%; 
            border: 2px dashed var(--primary); margin: 0 auto 15px; 
            position: relative; overflow: hidden; cursor: pointer;
            background: rgba(255,255,255,0.03);
        }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-box img.show { display: block; }
        .avatar-box .placeholder { 
            position: absolute; inset: 0; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; pointer-events: none;
            color: var(--primary); font-size: 12px;
        }
        .avatar-box.has-img .placeholder { display: none; }
        
        /* Buttons */
        .btn-main { 
            width: 100%; padding: 12px; border-radius: 12px; border: none; 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            color: white; font-weight: 600; cursor: pointer; font-size: 15px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        .btn-main:active { transform: scale(0.98); }
        
        .btn-secondary { 
            width: 100%; padding: 12px; border-radius: 12px; 
            background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: white; font-weight: 600; cursor: pointer; font-size: 15px;
        }
        
        .input-field {
            width: 100%; padding: 12px 16px; border-radius: 12px;
            background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2);
            color: white; font-size: 15px; outline: none; text-align: center;
        }
        .input-field:focus { border-color: var(--primary); }
        
        /* Room Layout */
        #room { display: none; flex-direction: column; height: 100vh; }
        #room.active { display: flex; }
        
        .video-section { flex: 1; position: relative; background: #000; min-height: 0; }
        .chat-section { 
            width: 380px; display: flex; flex-direction: column; 
            border-left: 1px solid var(--border); height: 100%;
        }
        @media (max-width: 900px) {
            .main-container { flex-direction: column !important; }
            .chat-section { width: 100%; height: 40%; border-left: none; border-top: 1px solid var(--border); }
        }
        
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; margin-bottom: 8px; font-size: 14px; }
        .msg.own { align-self: flex-end; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
        .msg.other { align-self: flex-start; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="theme-red">

    <!-- Gizli Input -->
    <input type="file" id="avatarInput" style="display: none;" accept="image/*">

    <!-- LANDING -->
    <div id="landing" style="height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;">
        <div class="glass rounded-2xl p-6 w-full max-w-md">
            <div style="text-align: center; margin-bottom: 25px;">
                <h1 style="font-size: 28px; margin-bottom: 5px;">üé¨ KinoZal</h1>
                <p style="color: rgba(255,255,255,0.5); font-size: 14px;">Dostlarƒ±nƒ±zla birlikd…ô izl…ôyin</p>
            </div>

            <!-- Avatar -->
            <div class="avatar-box" id="avatarBox" onclick="document.getElementById('avatarInput').click()">
                <img id="avatarPreview" src="" alt="">
                <div class="placeholder">
                    <i class="fas fa-camera" style="font-size: 24px; margin-bottom: 4px;"></i>
                    <span>≈û…ôkil se√ß</span>
                </div>
            </div>
            <div id="avatarError" class="hidden" style="color: #ff4444; text-align: center; font-size: 13px; margin-bottom: 15px;">
                Profil ≈ü…ôkli se√ßilm…ôlidir
            </div>

            <!-- Form -->
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <input type="text" id="hostName" class="input-field" placeholder="Adƒ±nƒ±zƒ± daxil edin">
                
                <button onclick="createRoom()" class="btn-main" id="createBtn">
                    <i class="fas fa-plus-circle"></i> Otaq Yarat
                </button>

                <div style="text-align: center; color: rgba(255,255,255,0.3); font-size: 13px; margin: 5px 0;">veya</div>

                <input type="text" id="joinRoomId" class="input-field" placeholder="Otaq kodu" style="text-transform: uppercase;">
                
                <button onclick="joinRoom()" class="btn-secondary">
                    <i class="fas fa-sign-in-alt"></i> Qo≈üul
                </button>
            </div>
        </div>
    </div>

    <!-- ROOM -->
    <div id="room">
        <!-- Header -->
        <div class="glass" style="padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);">
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="font-weight: 700; font-size: 20px;">Kino<span style="color: var(--primary)">Zal</span></span>
                <div style="background: rgba(0,0,0,0.4); padding: 4px 12px; border-radius: 20px; font-size: 14px; border: 1px solid rgba(255,255,255,0.1);">
                    <span style="color: rgba(255,255,255,0.5); font-size: 11px; margin-right: 6px; text-transform: uppercase;">Kod</span>
                    <span id="roomCodeDisplay" style="font-family: monospace; font-weight: bold; color: var(--primary);">----</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="toggleTheme()" style="width: 36px; height: 36px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: white; cursor: pointer;">
                    <i class="fas fa-palette" style="color: var(--primary);"></i>
                </button>
                <button onclick="leaveRoom()" style="width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(239,68,68,0.2); color: #ff6666; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Main -->
        <div class="main-container" style="display: flex; flex: 1; overflow: hidden;">
            <!-- Video -->
            <div class="video-section">
                <div id="player" style="width: 100%; height: 100%;"></div>
            </div>

            <!-- Chat -->
            <div class="chat-section glass">
                <div style="padding: 12px; border-bottom: 1px solid var(--border); overflow-x: auto;">
                    <div id="usersList" style="display: flex; gap: 8px;"></div>
                </div>
                
                <div id="messagesList" style="flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column;"></div>
                
                <div style="padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px;">
                    <input type="text" id="messageInput" placeholder="Mesaj yaz..." style="flex: 1; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 8px 16px; color: white; outline: none;" onkeypress="if(event.key==='Enter') sendMessage()">
                    <button onclick="sendMessage()" style="width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--primary); color: white; cursor: pointer;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. FIREBASE BA≈ûLAT (∆èn ba≈üda)
        const firebaseConfig = {
            apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PfyJRdk",
            authDomain: "sevgili-testi.firebaseapp.com",
            databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
            projectId: "sevgili-testi",
            storageBucket: "sevgili-testi.appspot.com",
            messagingSenderId: "399260477557",
            appId: "1:399260477557:web:584204a698d7bf145bb03c"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // 2. GLOBAL D∆èYƒ∞≈û∆èNL∆èR
        let myId = localStorage.getItem('myId');
        if (!myId) {
            myId = 'user_' + Math.random().toString(36).substr(2, 8);
            localStorage.setItem('myId', myId);
        }
        
        let myName = '';
        let myAvatar = localStorage.getItem('myAvatar') || '';
        let currentRoomId = null;
        let isHost = false;
        
        // 3. AVATAR Y√úKL∆èM∆è (D√ºzg√ºn i≈ül…ôm…ôsi √º√ß√ºn)
        document.getElementById('avatarInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                alert('≈û…ôkil 2MB-dan b√∂y√ºk olmamalƒ±dƒ±r!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                myAvatar = event.target.result;
                localStorage.setItem('myAvatar', myAvatar);
                
                // UI Update
                const img = document.getElementById('avatarPreview');
                img.src = myAvatar;
                img.classList.add('show');
                document.getElementById('avatarBox').classList.add('has-img');
                document.getElementById('avatarError').classList.add('hidden');
                
                console.log('Avatar se√ßildi'); // Debug
            };
            reader.readAsDataURL(file);
        });
        
        // ∆èvv…ôlki avatar varsa g√∂st…ôr
        if (myAvatar) {
            document.getElementById('avatarPreview').src = myAvatar;
            document.getElementById('avatarPreview').classList.add('show');
            document.getElementById('avatarBox').classList.add('has-img');
        }
        
        // 4. OTAQ YARAT (D√ºz…ôldilmi≈ü versiya)
        async function createRoom() {
            console.log('Create Room clicked'); // Debug
            
            // Inputlarƒ± yoxla
            const nameInput = document.getElementById('hostName');
            myName = nameInput.value.trim();
            
            if (!myName) {
                alert('Adƒ±nƒ±zƒ± daxil edin!');
                nameInput.focus();
                return;
            }
            
            if (!myAvatar) {
                document.getElementById('avatarError').classList.remove('hidden');
                alert('Profil ≈ü…ôkli se√ßin!');
                return;
            }
            
            // Room kodu yarat
            const roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            console.log('Room Code:', roomCode); // Debug
            
            try {
                // Firebase-…ô yaz
                await database.ref('rooms/' + roomCode).set({
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    hostId: myId,
                    video: { id: 'jfKfPfyJRdk', time: 0, playing: false },
                    users: {
                        [myId]: {
                            name: myName,
                            avatar: myAvatar,
                            isHost: true,
                            joined: firebase.database.ServerValue.TIMESTAMP
                        }
                    }
                });
                
                console.log('Room created successfully'); // Debug
                
                // Otaƒüa daxil ol
                enterRoom(roomCode, true);
                
            } catch (error) {
                console.error('Error:', error);
                alert('X…ôta ba≈ü verdi: ' + error.message);
            }
        }
        
        // 5. OTAƒûA QO≈ûUL
        async function joinRoom() {
            const codeInput = document.getElementById('joinRoomId');
            const code = codeInput.value.trim().toUpperCase();
            const nameInput = document.getElementById('hostName');
            myName = nameInput.value.trim();
            
            if (!myName) {
                alert('Adƒ±nƒ±zƒ± daxil edin!');
                return;
            }
            if (!code) {
                alert('Otaq kodunu daxil edin!');
                return;
            }
            
            try {
                const snapshot = await database.ref('rooms/' + code).once('value');
                if (!snapshot.exists()) {
                    alert('Otaq tapƒ±lmadƒ±!');
                    return;
                }
                
                // ƒ∞stifad…ô√ßi …ôlav…ô et
                await database.ref(`rooms/${code}/users/${myId}`).set({
                    name: myName,
                    avatar: myAvatar,
                    isHost: false,
                    joined: firebase.database.ServerValue.TIMESTAMP
                });
                
                enterRoom(code, false);
                
            } catch (error) {
                alert('X…ôta: ' + error.message);
            }
        }
        
        // 6. OTAƒûA DAXƒ∞L OL
        function enterRoom(code, host) {
            currentRoomId = code;
            isHost = host;
            
            // UI d…ôyi≈ü
            document.getElementById('landing').style.display = 'none';
            document.getElementById('room').classList.add('active');
            document.getElementById('roomCodeDisplay').textContent = code;
            
            // Listeners ba≈ülat
            listenUsers();
            listenMessages();
            
            // YouTube (console-da iframe_api y√ºkl…ônm…ôsini g√∂zl…ôyirik)
            if (typeof YT !== 'undefined' && YT.Player) {
                initPlayer();
            } else {
                window.onYouTubeIframeAPIReady = initPlayer;
            }
        }
        
        function initPlayer() {
            new YT.Player('player', {
                videoId: 'jfKfPfyJRdk',
                height: '100%',
                width: '100%',
                playerVars: { controls: isHost ? 1 : 0 }
            });
        }
        
        // 7. REALTIME LISTENERS
        function listenUsers() {
            database.ref(`rooms/${currentRoomId}/users`).on('value', (snapshot) => {
                const users = snapshot.val() || {};
                const container = document.getElementById('usersList');
                container.innerHTML = '';
                
                Object.entries(users).forEach(([uid, user]) => {
                    const div = document.createElement('div');
                    div.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 13px; white-space: nowrap;';
                    div.innerHTML = `<img src="${user.avatar}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;"> ${user.name} ${user.isHost ? 'üëë' : ''}`;
                    container.appendChild(div);
                });
            });
        }
        
        function listenMessages() {
            database.ref(`rooms/${currentRoomId}/messages`).limitToLast(50).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                const div = document.createElement('div');
                div.className = 'msg ' + (msg.userId === myId ? 'own' : 'other');
                div.innerHTML = `<div style="font-size: 12px; opacity: 0.7; margin-bottom: 2px;">${msg.userName}</div>${msg.text}`;
                document.getElementById('messagesList').appendChild(div);
                div.scrollIntoView({ behavior: 'smooth' });
            });
        }
        
        // 8. MESAJ G√ñND∆èR
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !currentRoomId) return;
            
            database.ref(`rooms/${currentRoomId}/messages`).push({
                text: text,
                userId: myId,
                userName: myName,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            input.value = '';
        }
        
        // 9. √áIXI≈û
        function leaveRoom() {
            if (!confirm('Otaqdan √ßƒ±xmaq ist…ôyirsiniz?')) return;
            if (currentRoomId) {
                database.ref(`rooms/${currentRoomId}/users/${myId}`).remove();
            }
            location.reload();
        }
        
        // 10. TEMA
        function toggleTheme() {
            const themes = ['theme-red', 'theme-blue', 'theme-green'];
            const current = document.body.className;
            let next = 'theme-red';
            if (current.includes('theme-red')) next = 'theme-blue';
            else if (current.includes('theme-blue')) next = 'theme-green';
            document.body.className = next;
        }
        
        console.log('Script loaded, ready'); // Debug
    </script>

</body>
</html>
