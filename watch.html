<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Browser - Sync Movie</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0f0f0f;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        /* Login */
        #login {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .login-box {
            background: rgba(255,255,255,0.95);
            padding: 40px;
            border-radius: 24px;
            width: 90%;
            max-width: 480px;
            color: #1f2937;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4);
            text-align: center;
        }
        
        .login-box h1 {
            font-size: 32px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin: 24px 0;
            background: #f3f4f6;
            padding: 6px;
            border-radius: 12px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            color: #764ba2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        input {
            width: 100%;
            padding: 14px 18px;
            margin: 8px 0;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
        }
        
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }

        /* App */
        #app { display: none; height: 100vh; flex-direction: column; }

        .header {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 700;
        }
        
        .brand i { color: #ec4899; }
        
        .room-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .code-badge {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.4);
            color: #c7d2fe;
            padding: 6px 14px;
            border-radius: 8px;
            font-family: monospace;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .code-badge:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }
        
        .role-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .role-badge.mod {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .role-badge.viewer {
            background: rgba(255,255,255,0.1);
            color: #9ca3af;
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
            gap: 1px;
            background: rgba(255,255,255,0.1);
        }

        /* Virtual Browser Container */
        .browser-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            position: relative;
        }

        /* Browser Chrome/Interface */
        .browser-chrome {
            background: #1f2937;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .chrome-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #9ca3af;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .chrome-btn:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .address-bar {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .address-bar:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(0,0,0,0.4);
        }
        
        .mod-indicator {
            padding: 6px 12px;
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.4);
            color: #fbbf24;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* The Shared Iframe */
        .virtual-screen {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
        }
        
        #sharedFrame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        /* Floating Controls for Moderator */
        .floating-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px;
            border-radius: 50px;
            display: none;
            gap: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 100;
        }
        
        .floating-controls.active {
            display: flex;
        }
        
        .ctrl-btn {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .ctrl-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .ctrl-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .ctrl-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Sidebar Chat */
        .sidebar {
            width: 360px;
            background: rgba(255,255,255,0.02);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .online-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #10b981;
            margin-top: 6px;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .msg {
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .msg-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            padding: 0 4px;
        }
        
        .msg-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }
        
        .msg-author {
            font-weight: 600;
            font-size: 13px;
            color: #e5e7eb;
        }
        
        .msg-time {
            font-size: 11px;
            color: #6b7280;
        }
        
        .msg-body {
            background: rgba(255,255,255,0.08);
            padding: 10px 14px;
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            font-size: 14px;
            line-height: 1.4;
            color: #f3f4f6;
        }
        
        .msg.own { align-self: flex-end; }
        .msg.own .msg-body {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 4px;
        }
        .msg.own .msg-header { flex-direction: row-reverse; }
        
        .msg.system { align-self: center; }
        .msg.system .msg-body {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #fbbf24;
            font-size: 13px;
            padding: 8px 16px;
        }
        .msg.system .msg-header { display: none; }

        .chat-input {
            padding: 16px;
            background: rgba(255,255,255,0.03);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .input-wrap {
            display: flex;
            gap: 8px;
            background: rgba(255,255,255,0.05);
            padding: 6px;
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .input-wrap input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 10px 14px;
            font-size: 14px;
            margin: 0;
        }
        
        .input-wrap input:focus { outline: none; }
        
        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
            margin: 0;
        }
        
        .send-btn:hover { background: #764ba2; transform: scale(1.05); }

        /* Overlays */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .loading-overlay.active { display: flex; }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-overlay {
            position: absolute;
            inset: 0;
            background: rgba(220, 38, 38, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            z-index: 60;
        }
        
        .error-overlay.active { display: flex; }
        
        .cors-hint {
            margin-top: 12px;
            padding: 12px 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 13px;
            color: #fecaca;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        
        @media (max-width: 900px) {
            .sidebar { position: absolute; right: 0; top: 60px; bottom: 0; transform: translateX(100%); transition: 0.3s; z-index: 200; }
            .sidebar.open { transform: translateX(0); width: 100%; }
        }
    </style>
</head>
<body>

<div id="login">
    <div class="login-box">
        <h1><i class="fas fa-globe"></i> Virtual Browser</h1>
        <p style="color: #6b7280; margin-bottom: 20px;">Sinxron brauzerd…ô birlikd…ô film izl…ô</p>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('create')">Otaq Yarat</button>
            <button class="tab" onclick="switchTab('join')">Qo≈üul</button>
        </div>
        
        <div id="createForm">
            <input type="text" id="createName" placeholder="Adƒ±nƒ±z" maxlength="20">
            <input type="text" id="createCode" placeholder="Unikal kod (m…ôs…ôl…ôn: CINEMA)" maxlength="15">
            <button onclick="createRoom()" class="btn-primary">
                <i class="fas fa-plus-circle"></i> Moderator Ol
            </button>
        </div>
        
        <div id="joinForm" style="display:none">
            <input type="text" id="joinName" placeholder="Adƒ±nƒ±z" maxlength="20">
            <input type="text" id="joinCode" placeholder="Otaq kodu" maxlength="15">
            <button onclick="joinRoom()" class="btn-primary">
                <i class="fas fa-sign-in-alt"></i> Qo≈üul
            </button>
        </div>
    </div>
</div>

<div id="app">
    <div class="header">
        <div class="brand">
            <i class="fas fa-desktop"></i>
            <span>Virtual Cinema</span>
        </div>
        <div class="room-info">
            <span id="userDisplay" style="color: #9ca3af; font-size: 14px;"></span>
            <span id="roleDisplay" class="role-badge mod">Moderator</span>
            <div class="code-badge" onclick="copyCode()" title="Kopyalamaq √º√ß√ºn klikl…ô">
                <i class="fas fa-lock" style="margin-right: 6px;"></i> <span id="codeDisplay">CODE</span>
            </div>
        </div>
    </div>

    <div class="main">
        <!-- Virtual Browser Area -->
        <div class="browser-container">
            <!-- Browser Interface -->
            <div class="browser-chrome">
                <button class="chrome-btn" onclick="goBack()" title="Geri"><i class="fas fa-arrow-left"></i></button>
                <button class="chrome-btn" onclick="refreshPage()" title="Yenil…ô"><i class="fas fa-redo"></i></button>
                <input type="text" class="address-bar" id="addressBar" 
                       value="https://archive.org/details/movies" 
                       onkeypress="if(event.key==='Enter')navigateTo(this.value)"
                       placeholder="URL daxil et...">
                <button class="chrome-btn" onclick="navigateTo(document.getElementById('addressBar').value)" title="Get">
                    <i class="fas fa-arrow-right"></i>
                </button>
                <div class="mod-indicator" id="modIndicator" style="display:none">
                    <i class="fas fa-crown"></i> S…ôn idar…ô edirs…ôn
                </div>
            </div>

            <!-- Shared Screen (Everyone sees this) -->
            <div class="virtual-screen">
                <iframe id="sharedFrame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-downloads"></iframe>
                
                <!-- Loading State -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="spinner"></div>
                    <div>S…ôhif…ô y√ºkl…ônir...</div>
                </div>
                
                <!-- CORS Error -->
                <div class="error-overlay" id="errorOverlay">
                    <i class="fas fa-shield-alt" style="font-size: 48px; margin-bottom: 16px;"></i>
                    <h3 style="margin-bottom: 8px;">Bu Sayt Bloklanƒ±b</h3>
                    <p style="opacity: 0.9; max-width: 400px;">
                        T…ôhl√ºk…ôsizlik s…ôb…ôbind…ôn bu sayt iframe-d…ô a√ßƒ±la bilmir. 
                        A≈üaƒüƒ±dakƒ± alternativl…ôrd…ôn istifad…ô edin:
                    </p>
                    <div class="cors-hint">
                        <strong>ƒ∞≈ül…ôy…ôn saytlar:</strong><br>
                        archive.org ‚Ä¢ openload ‚Ä¢ direct video links
                    </div>
                    <button onclick="hideError()" style="margin-top: 16px; padding: 10px 24px; width: auto; border-radius: 8px;">
                        Baƒüla
                    </button>
                </div>

                <!-- Moderator Quick Controls -->
                <div class="floating-controls" id="floatControls">
                    <button class="ctrl-btn primary" onclick="syncToEveryone()">
                        <i class="fas fa-sync"></i> Hamƒ±ya Sinxronla≈üdƒ±r
                    </button>
                    <button class="ctrl-btn secondary" onclick="toggleFullscreen()">
                        <i class="fas fa-expand"></i> Tam Ekran
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div style="font-weight: 600; font-size: 16px;">üí¨ Canlƒ± S√∂hb…ôt</div>
                <div class="online-status">
                    <i class="fas fa-circle" style="font-size: 8px;"></i>
                    <span id="onlineCount">1</span> n…ôf…ôr onlayn
                </div>
            </div>
            <div class="messages" id="chatBox"></div>
            <div class="chat-input">
                <div class="input-wrap">
                    <input type="text" id="msgInput" placeholder="Mesaj yaz..." onkeypress="if(event.key==='Enter')sendMsg()">
                    <button class="send-btn" onclick="sendMsg()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
    authDomain: "sevgili-testi.firebaseapp.com",
    databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
    projectId: "sevgili-testi",
    storageBucket: "sevgili-testi.firebasestorage.app",
    messagingSenderId: "399260477557",
    appId: "1:399260477557:web:584204a698d7bf145bb03c"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = '', roomCode = '', isModerator = false;
let roomRef, browserRef, chatRef;
let currentUrl = 'https://archive.org/details/movies';

function switchTab(t) {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('createForm').style.display = t === 'create' ? 'block' : 'none';
    document.getElementById('joinForm').style.display = t === 'join' ? 'block' : 'none';
}

function createRoom() {
    const name = document.getElementById('createName').value.trim();
    const code = document.getElementById('createCode').value.trim().toUpperCase();
    
    if(!name || !code) return alert('B√ºt√ºn xanalarƒ± doldurun!');
    
    db.ref('rooms/' + code).once('value').then(snap => {
        if(snap.exists()) return alert('Bu kod artƒ±q m√∂vcuddur!');
        
        currentUser = name;
        roomCode = code;
        isModerator = true;
        
        roomRef = db.ref('rooms/' + code);
        roomRef.set({
            creator: name,
            created: firebase.database.ServerValue.TIMESTAMP,
            browser: {
                url: 'https://archive.org/details/movies',
                lastUpdate: firebase.database.ServerValue.TIMESTAMP,
                updatedBy: name
            }
        });
        
        enterRoom();
    });
}

function joinRoom() {
    const name = document.getElementById('joinName').value.trim();
    const code = document.getElementById('joinCode').value.trim().toUpperCase();
    
    if(!name || !code) return alert('B√ºt√ºn xanalarƒ± doldurun!');
    
    db.ref('rooms/' + code).once('value').then(snap => {
        if(!snap.exists()) return alert('Otaq tapƒ±lmadƒ±!');
        
        currentUser = name;
        roomCode = code;
        isModerator = false;
        roomRef = db.ref('rooms/' + code);
        
        enterRoom();
    });
}

function enterRoom() {
    document.getElementById('login').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    document.getElementById('userDisplay').textContent = currentUser;
    document.getElementById('codeDisplay').textContent = roomCode;
    
    const roleBadge = document.getElementById('roleDisplay');
    if(isModerator) {
        roleBadge.textContent = 'Moderator';
        roleBadge.className = 'role-badge mod';
        document.getElementById('modIndicator').style.display = 'flex';
        document.getElementById('floatControls').classList.add('active');
        document.getElementById('addressBar').readOnly = false;
    } else {
        roleBadge.textContent = 'Tama≈üa√ßƒ±';
        roleBadge.className = 'role-badge viewer';
        document.getElementById('addressBar').readOnly = true;
        document.getElementById('addressBar').style.opacity = '0.7';
    }
    
    setupRealtimeSync();
    setupChat();
    addUserToRoom();
}

function setupRealtimeSync() {
    browserRef = roomRef.child('browser');
    
    // Listen for URL changes (THE MAGIC)
    browserRef.on('value', (snap) => {
        const data = snap.val();
        if(!data || !data.url) return;
        
        const frame = document.getElementById('sharedFrame');
        const addressBar = document.getElementById('addressBar');
        
        // Update address bar for everyone
        if(addressBar.value !== data.url) {
            addressBar.value = data.url;
        }
        
        // Load URL in iframe if different
        if(frame.src !== data.url && data.url !== '') {
            showLoading(true);
            frame.src = data.url;
            currentUrl = data.url;
            
            // Check if iframe loaded successfully after 3 seconds
            setTimeout(() => {
                checkIframeLoaded();
            }, 3000);
        }
        
        // Show who updated (for viewers)
        if(!isModerator && data.updatedBy && data.updatedBy !== currentUser) {
            showSystemMessage(`üåê ${data.updatedBy} yeni s…ôhif…ô a√ßdƒ±`);
        }
    });
    
    // Setup iframe load detection
    const frame = document.getElementById('sharedFrame');
    frame.onload = () => {
        showLoading(false);
        hideError();
    };
    
    frame.onerror = () => {
        showLoading(false);
        if(!isModerator) showError();
    };
}

function navigateTo(url) {
    if(!isModerator) {
        alert('Yalnƒ±z moderator s…ôhif…ô d…ôyi≈üdir…ô bil…ôr!');
        return;
    }
    
    // Add https if missing
    let fullUrl = url;
    if(!url.startsWith('http')) {
        fullUrl = 'https://' + url;
    }
    
    // Update Firebase - everyone will sync automatically
    browserRef.set({
        url: fullUrl,
        lastUpdate: firebase.database.ServerValue.TIMESTAMP,
        updatedBy: currentUser,
        history: firebase.database.ServerValue.increment(1)
    });
    
    showSystemMessage(`üîÑ Yeni s…ôhif…ô: ${fullUrl.substring(0, 30)}...`);
}

function goBack() {
    if(!isModerator) return alert('Yalnƒ±z moderator idar…ô ed…ô bil…ôr!');
    // In real implementation, you'd maintain a history array
    alert('Geri funksiyasƒ± demo versiyasƒ±nda aktiv deyil');
}

function refreshPage() {
    if(!isModerator) return;
    const frame = document.getElementById('sharedFrame');
    frame.src = frame.src;
    showLoading(true);
}

function syncToEveryone() {
    if(!isModerator) return;
    // Force resync current URL
    browserRef.update({
        lastUpdate: firebase.database.ServerValue.TIMESTAMP,
        forceSync: Date.now()
    });
    showSystemMessage('üîÑ Sinxronizasiya yenil…ôndi');
}

function showLoading(show) {
    document.getElementById('loadingOverlay').classList.toggle('active', show);
}

function showError() {
    document.getElementById('errorOverlay').classList.add('active');
}

function hideError() {
    document.getElementById('errorOverlay').classList.remove('active');
}

function checkIframeLoaded() {
    try {
        // Try to access iframe content to see if it loaded
        const frame = document.getElementById('sharedFrame');
        const frameDoc = frame.contentDocument || frame.contentWindow.document;
        // If we can access it, it's loaded (unless it's about:blank)
        if(frameDoc && frameDoc.body && frameDoc.body.innerHTML !== '') {
            showLoading(false);
        }
    } catch(e) {
        // Cross-origin, can't access - assume loaded but might show error overlay if remained blank
        showLoading(false);
    }
}

function toggleFullscreen() {
    const elem = document.querySelector('.browser-container');
    if(!document.fullscreenElement) {
        elem.requestFullscreen().catch(err => {
            console.error('Fullscreen error:', err);
        });
    } else {
        document.exitFullscreen();
    }
}

function copyCode() {
    navigator.clipboard.writeText(roomCode).then(() => {
        alert('Otaq kodu kopyalandƒ±: ' + roomCode);
    });
}

// Chat Functions
function setupChat() {
    chatRef = roomRef.child('chat');
    
    chatRef.limitToLast(50).on('child_added', (snap) => {
        const msg = snap.val();
        displayMessage(msg);
    });
}

function addUserToRoom() {
    const userRef = roomRef.child('users/' + currentUser);
    userRef.set({
        name: currentUser,
        isModerator: isModerator,
        joinedAt: firebase.database.ServerValue.TIMESTAMP,
        online: true
    });
    userRef.onDisconnect().remove();
    
    // Count users
    roomRef.child('users').on('value', (snap) => {
        const count = snap.numChildren();
        document.getElementById('onlineCount').textContent = count;
    });
    
    // Send join message
    if(!isModerator) {
        chatRef.push({
            system: true,
            text: `üëã ${currentUser} otaƒüa qo≈üuldu`,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }
}

function displayMessage(msg) {
    const container = document.getElementById('chatBox');
    const div = document.createElement('div');
    
    if(msg.system) {
        div.className = 'msg system';
        div.innerHTML = `<div class="msg-body">${msg.text}</div>`;
    } else {
        const isOwn = msg.user === currentUser;
        div.className = 'msg ' + (isOwn ? 'own' : '');
        const time = new Date(msg.timestamp).toLocaleTimeString('az-AZ', {hour:'2-digit', minute:'2-digit'});
        
        div.innerHTML = `
            <div class="msg-header">
                <div class="msg-avatar">${msg.user.charAt(0).toUpperCase()}</div>
                <span class="msg-author">${msg.user}</span>
                <span class="msg-time">${time}</span>
            </div>
            <div class="msg-body">${escapeHtml(msg.text)}</div>
        `;
    }
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function sendMsg() {
    const input = document.getElementById('msgInput');
    const text = input.value.trim();
    if(!text) return;
    
    chatRef.push({
        user: currentUser,
        text: text,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    
    input.value = '';
}

function showSystemMessage(text) {
    chatRef.push({
        system: true,
        text: text,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Prevent accidental navigation for viewers
document.addEventListener('click', (e) => {
    if(!isModerator && e.target.closest('.chrome-btn')) {
        e.preventDefault();
        alert('Yalnƒ±z moderator idar…ô ed…ô bil…ôr!');
    }
});
</script>

</body>
</html>
