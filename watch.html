<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SyncRoom - Premium Watch Party</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Inter', sans-serif; }
        
        body { background: #0a0a0a; color: white; overflow: hidden; touch-action: manipulation; }
        
        .glass { 
            background: rgba(20, 20, 25, 0.85); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        
        .glass-panel { 
            background: rgba(30, 30, 35, 0.6); 
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: rgba(255,255,255,0.15); 
            border-radius: 10px; 
        }
        
        .gradient-text { background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .message-bubble {
            position: relative;
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            animation: messageSlide 0.3s ease;
            word-wrap: break-word;
        }
        
        .message-self {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        .message-other {
            background: rgba(60, 60, 70, 0.8);
            color: #e5e7eb;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .message-reply {
            background: rgba(255,255,255,0.1);
            border-left: 3px solid rgba(255,255,255,0.3);
            padding: 6px 10px;
            margin-bottom: 6px;
            border-radius: 8px;
            font-size: 12px;
            opacity: 0.9;
        }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .avatar-upload {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px dashed rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            background: rgba(255,255,255,0.05);
        }
        
        .avatar-upload:hover { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .avatar-upload.has-image { border-style: solid; border-color: #ef4444; }
        
        .avatar-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .avatar-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.5);
        }
        
        .user-pill {
            transition: all 0.2s;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
        }
        
        .status-active { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-background { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
        .status-inactive { background: #6b7280; }
        
        .viewer-overlay { position: absolute; inset: 0; z-index: 50; cursor: default; }
        
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: #ef4444; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .sync-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .4; } }
        
        .reply-indicator {
            position: relative;
            background: rgba(30, 30, 35, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .notification-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(30, 30, 35, 0.95);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 12px 16px;
            border-radius: 12px;
            z-index: 100;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
        }
        
        .notification-toast.show { transform: translateX(0); }
        
        .video-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        .video-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.1); }
        
        .change-video-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 40;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
        }

        /* Safe area for mobile bottom */
        .safe-bottom {
            padding-bottom: max(16px, env(safe-area-inset-bottom));
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
            authDomain: "sevgili-testi.firebaseapp.com",
            databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
            projectId: "sevgili-testi",
            storageBucket: "sevgili-testi.firebasestorage.app",
            messagingSenderId: "399260477557",
            appId: "1:399260477557:web:584204a698d7bf145bb03c",
            measurementId: "G-44P21XCZ7G"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const YOUTUBE_API_KEY = "AIzaSyBterRsxZoTvVbxlsOzESKWBDAY2B8BWc4";
        
        let userId = localStorage.getItem('syncUserId') || 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('syncUserId', userId);
        
        let currentRoom = null, isHost = false, player = null, serverOffset = 0;
        let ignoreUpdates = false, currentVideoId = null;
        let replyingTo = null, userName = '', userAvatar = '';
        
        db.ref(".info/serverTimeOffset").on("value", (snap) => { serverOffset = snap.val() || 0; });
        const getServerTime = () => Date.now() + serverOffset;
    </script>

    <!-- LANDING PAGE -->
    <div id="landing" class="flex-1 flex items-center justify-center p-4 bg-gradient-to-br from-gray-900 via-black to-gray-900 overflow-auto">
        <div class="max-w-md w-full space-y-6 pb-10">
            <div class="text-center space-y-2">
                <h1 class="text-5xl font-bold gradient-text mb-2">SyncRoom</h1>
                <p class="text-gray-400 text-sm">Premium sinxron izl…ôm…ô v…ô s√∂hb…ôt</p>
            </div>

            <div class="glass rounded-3xl p-8 space-y-6 shadow-2xl">
                <div class="flex flex-col items-center space-y-3">
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Profil ≈û…ôkli</label>
                    <div class="avatar-upload" id="avatarUpload" onclick="document.getElementById('avatarInput').click()">
                        <div class="avatar-placeholder">
                            <i class="fas fa-camera text-2xl mb-1"></i>
                            <span class="text-xs">≈û…ôkil se√ß</span>
                        </div>
                        <img id="avatarPreview" class="avatar-preview hidden" alt="Avatar">
                    </div>
                    <input type="file" id="avatarInput" accept="image/*" class="hidden" onchange="handleAvatarSelect(event)">
                    <p class="text-xs text-red-500 hidden" id="avatarError"><i class="fas fa-exclamation-circle mr-1"></i>Profil ≈ü…ôkli t…ôl…ôb olunur</p>
                </div>

                <div class="space-y-3">
                    <input type="text" id="hostName" placeholder="Adƒ±nƒ±zƒ± daxil edin" class="w-full px-4 py-3 rounded-xl bg-black/40 border border-gray-700 text-white focus:outline-none focus:border-red-600 transition text-center font-medium">
                    
                    <button onclick="createRoom()" id="createBtn" class="w-full py-3.5 bg-gradient-to-r from-red-700 to-red-900 rounded-xl font-bold hover:opacity-90 transition shadow-lg shadow-red-900/30 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-plus-circle mr-2"></i>Otaq Yarat
                    </button>
                </div>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-700"></div>
                    <span class="px-4 text-gray-500 text-xs font-medium">VE YA</span>
                    <div class="flex-grow border-t border-gray-700"></div>
                </div>

                <div class="space-y-3">
                    <input type="text" id="joinRoomId" placeholder="Otaq Kodu (ABC123)" class="w-full px-4 py-3 rounded-xl bg-black/40 border border-gray-700 text-white placeholder-gray-500 focus:outline-none focus:border-red-600 transition uppercase text-center font-bold tracking-widest">
                    <button onclick="joinRoom()" id="joinBtn" class="w-full py-3.5 bg-gray-800 hover:bg-gray-700 rounded-xl font-bold transition border border-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-sign-in-alt mr-2"></i>Qo≈üul
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ROOM INTERFACE -->
    <div id="room" class="hidden flex-1 flex flex-col h-screen bg-black">
        <!-- Header -->
        <header class="glass border-b border-gray-800 h-16 flex items-center justify-between px-4 shrink-0 z-20">
            <div class="flex items-center space-x-3">
                <h1 class="text-lg font-bold tracking-tight text-white">Sync<span class="text-red-600">Room</span></h1>
                
                <!-- Room Code with Share -->
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-xl bg-gray-900/80 border border-gray-700">
                    <span class="text-xs text-gray-400 uppercase font-bold">Kod:</span>
                    <span id="roomCode" class="font-mono text-red-400 font-bold tracking-widest text-sm">---</span>
                    <div class="flex items-center gap-1 ml-1 border-l border-gray-700 pl-2">
                        <button onclick="copyCode()" class="p-1.5 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg transition" title="Kopyala">
                            <i class="fas fa-copy text-xs"></i>
                        </button>
                        <button onclick="shareCode()" class="p-1.5 text-gray-400 hover:text-red-400 hover:bg-gray-800 rounded-lg transition" title="Payla≈ü">
                            <i class="fas fa-share-alt text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center space-x-2">
                <div id="activeUsersCount" class="hidden md:flex items-center space-x-2 px-3 py-1.5 rounded-full bg-gray-800/50 border border-gray-700 text-xs">
                    <i class="fas fa-users text-gray-400"></i>
                    <span class="text-gray-300" id="usersCountText">1</span>
                </div>
                <span id="userType" class="px-3 py-1.5 rounded-full text-xs font-bold bg-gray-800 text-gray-300 border border-gray-700">ƒ∞zl…ôyici</span>
                <button onclick="leaveRoom()" class="w-8 h-8 flex items-center justify-center bg-red-600/10 text-red-500 border border-red-600/30 rounded-full hover:bg-red-600/20 transition">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">
            <!-- Video Section -->
            <div class="flex-1 relative bg-black flex flex-col min-h-0 lg:h-auto" style="height: 55vh; lg: height: auto;">
                <button id="changeVideoBtn" onclick="toggleSearch()" class="hidden change-video-btn glass px-4 py-2 rounded-xl border border-gray-700 hover:border-red-500 text-sm font-bold text-white shadow-lg">
                    <i class="fas fa-film mr-2"></i>Video D…ôyi≈ü
                </button>

                <div id="searchContainer" class="hidden absolute top-16 left-1/2 transform -translate-x-1/2 z-30 w-full max-w-2xl px-4">
                    <div class="glass rounded-2xl overflow-hidden shadow-2xl border border-gray-700">
                        <div class="flex items-center px-4 py-3 border-b border-gray-700 bg-gray-900/80">
                            <i class="fas fa-search text-gray-400 mr-3"></i>
                            <input type="text" id="searchQuery" placeholder="YouTube-da axtar..." class="flex-1 bg-transparent border-none outline-none text-white placeholder-gray-500 text-sm" onkeypress="if(event.key==='Enter') searchYouTube()">
                            <button onclick="searchYouTube()" class="px-4 py-1.5 bg-red-600 rounded-lg text-sm font-bold hover:bg-red-700 transition">Axtar</button>
                            <button onclick="closeSearch()" class="ml-3 p-1.5 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg transition">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="searchResults" class="hidden max-h-[40vh] overflow-y-auto p-3 bg-gray-900/95 space-y-2"></div>
                    </div>
                </div>

                <div class="flex-1 relative flex items-center justify-center bg-black min-h-0">
                    <div id="playerWrapper" class="w-full h-full relative">
                        <div id="player"></div>
                        <div id="viewerOverlay" class="hidden viewer-overlay"></div>
                    </div>
                    <div id="playerLoader" class="absolute inset-0 flex items-center justify-center bg-black z-10">
                        <div class="spinner"></div>
                    </div>
                </div>

                <div id="hostControls" class="hidden glass border-t border-gray-800 p-3 shrink-0">
                    <div class="max-w-3xl mx-auto flex items-center justify-center space-x-4">
                        <button onclick="playerControl('seek', -10)" class="p-2 hover:bg-white/10 rounded-xl text-gray-300 transition">
                            <i class="fas fa-backward"></i>
                        </button>
                        <button id="playPauseBtn" onclick="playerControl('toggle')" class="w-12 h-12 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 active:scale-95 transition shadow-lg">
                            <i class="fas fa-play ml-1" id="playIcon"></i>
                            <i class="fas fa-pause hidden" id="pauseIcon"></i>
                        </button>
                        <button onclick="playerControl('seek', 10)" class="p-2 hover:bg-white/10 rounded-xl text-gray-300 transition">
                            <i class="fas fa-forward"></i>
                        </button>
                        <div class="flex-1 max-w-md px-4 hidden sm:block">
                            <div class="text-xs text-gray-400 mb-1 truncate" id="currentVideoTitle">Video se√ßilm…ôyib</div>
                            <div class="w-full bg-gray-800 rounded-full h-1 overflow-hidden">
                                <div id="progressBar" class="bg-red-600 h-full w-0 transition-all duration-1000"></div>
                            </div>
                        </div>
                        <button onclick="forceSync()" class="px-3 py-1.5 bg-green-600/20 text-green-400 border border-green-600/30 rounded-lg text-xs font-bold hover:bg-green-600/30 transition">
                            <i class="fas fa-sync-alt mr-1"></i>Sinxron
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Section - YUXARI QALDIRILDI (h-[45vh]) -->
            <div class="w-full lg:w-96 glass border-t lg:border-t-0 lg:border-l border-gray-800 flex flex-col shrink-0 h-[45vh] lg:h-auto relative z-10">
                <!-- Active Users -->
                <div class="p-3 border-b border-gray-800 shrink-0 bg-gray-900/20">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">
                            <i class="fas fa-users mr-1"></i>Otaqda
                        </h3>
                        <span class="text-[10px] text-gray-500" id="onlineCount">0 onlayn</span>
                    </div>
                    <div id="usersList" class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                        <!-- Users -->
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="flex-1 flex flex-col min-h-0 bg-gradient-to-b from-transparent to-black/10">
                    <div id="chatMessages" class="flex-1 overflow-y-auto p-3 space-y-3 scroll-smooth"></div>
                    
                    <!-- Input Area - YUXARIDA (pb-6 …ôlav…ô edildi) -->
                    <div class="p-3 border-t border-gray-800 bg-gray-900/40 shrink-0 safe-bottom">
                        <!-- Reply Indicator -->
                        <div id="replyIndicator" class="reply-indicator mx-0">
                            <div class="flex-1 min-w-0">
                                <div class="text-[10px] text-gray-400 mb-0.5">Cavab:</div>
                                <div class="text-xs text-white truncate" id="replyText"></div>
                            </div>
                            <button onclick="cancelReply()" class="p-1 hover:bg-white/10 rounded text-gray-400">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Input -->
                        <div class="flex items-end gap-2">
                            <div class="flex-1 relative">
                                <textarea id="messageInput" placeholder="Mesaj yaz..." rows="1" 
                                    class="w-full px-3 py-2.5 pr-10 bg-black/40 border border-gray-700 rounded-2xl text-sm focus:outline-none focus:border-red-600 transition text-white resize-none overflow-hidden max-h-24"
                                    oninput="autoResize(this)"
                                    onkeypress="handleEnter(event)"></textarea>
                                <button onclick="sendMessage()" class="absolute right-2 bottom-2 p-1.5 text-red-500 hover:text-red-400 transition">
                                    <i class="fas fa-paper-plane text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center shrink-0">
                <i class="fas fa-info text-red-500 text-xs"></i>
            </div>
            <div>
                <div class="text-xs font-bold text-white mb-0.5" id="notifTitle">Bildiri≈ü</div>
                <div class="text-xs text-gray-400" id="notifText">...</div>
            </div>
        </div>
    </div>

    <script>
        // Avatar handling
        function handleAvatarSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                alert('≈û…ôkil 2MB-dan ki√ßik olmalƒ±dƒ±r!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                userAvatar = e.target.result;
                document.getElementById('avatarPreview').src = userAvatar;
                document.getElementById('avatarPreview').classList.remove('hidden');
                document.querySelector('.avatar-placeholder').classList.add('hidden');
                document.getElementById('avatarUpload').classList.add('has-image');
                document.getElementById('avatarError').classList.add('hidden');
                localStorage.setItem('userAvatar', userAvatar);
            };
            reader.readAsDataURL(file);
        }
        
        function validateInputs() {
            const name = document.getElementById('hostName').value.trim();
            const avatarSet = !document.getElementById('avatarPreview').classList.contains('hidden');
            
            if (!name) {
                alert('Z…ôhm…ôt olmasa adƒ±nƒ±zƒ± daxil edin!');
                return false;
            }
            if (!avatarSet) {
                document.getElementById('avatarError').classList.remove('hidden');
                document.getElementById('avatarUpload').scrollIntoView({ behavior: 'smooth' });
                return false;
            }
            return true;
        }

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        async function createRoom() {
            if (!validateInputs()) return;
            
            userName = document.getElementById('hostName').value.trim();
            const code = generateRoomCode();
            
            await db.ref(`rooms/${code}`).set({
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                hostId: userId,
                currentVideo: null,
                users: {
                    [userId]: {
                        name: userName,
                        avatar: userAvatar,
                        isHost: true,
                        joinedAt: firebase.database.ServerValue.TIMESTAMP,
                        status: 'active',
                        focused: true
                    }
                }
            });
            
            enterRoom(code, true);
        }

        async function joinRoom() {
            const code = document.getElementById('joinRoomId').value.trim().toUpperCase();
            if (!validateInputs()) return;
            if (!code) return alert('Otaq kodunu daxil edin!');
            
            userName = document.getElementById('hostName').value.trim();
            const snap = await db.ref(`rooms/${code}`).once('value');
            if (!snap.exists()) return alert('Otaq tapƒ±lmadƒ±!');
            
            await db.ref(`rooms/${code}/users/${userId}`).set({
                name: userName,
                avatar: userAvatar,
                isHost: false,
                joinedAt: firebase.database.ServerValue.TIMESTAMP,
                status: 'active',
                focused: true
            });
            
            enterRoom(code, false);
        }

        function enterRoom(code, host) {
            currentRoom = code;
            isHost = host;
            
            document.getElementById('landing').classList.add('hidden');
            document.getElementById('room').classList.remove('hidden');
            document.getElementById('roomCode').textContent = code;
            document.getElementById('userType').textContent = host ? 'üëë Moderator' : 'üëÅÔ∏è ƒ∞zl…ôyici';
            document.getElementById('userType').className = host ? 
                'px-3 py-1.5 rounded-full text-xs font-bold bg-red-600/20 text-red-400 border border-red-600/30' : 
                'px-3 py-1.5 rounded-full text-xs font-bold bg-blue-600/20 text-blue-400 border border-blue-600/30';
            
            if (host) {
                document.getElementById('hostControls').classList.remove('hidden');
                document.getElementById('changeVideoBtn').classList.remove('hidden');
                document.getElementById('searchContainer').classList.remove('hidden');
            } else {
                document.getElementById('viewerOverlay').classList.remove('hidden');
            }
            
            initPlayer();
            setupListeners();
            setupVisibilityTracking();
        }

        function setupVisibilityTracking() {
            document.addEventListener('visibilitychange', () => {
                const status = document.hidden ? 'background' : 'active';
                db.ref(`rooms/${currentRoom}/users/${userId}/status`).set(status);
            });
            
            window.addEventListener('blur', () => {
                db.ref(`rooms/${currentRoom}/users/${userId}/focused`).set(false);
            });
            
            window.addEventListener('focus', () => {
                db.ref(`rooms/${currentRoom}/users/${userId}/focused`).set(true);
                db.ref(`rooms/${currentRoom}/users/${userId}/status`).set('active');
            });
        }

        function initPlayer() {
            if (typeof YT === 'undefined') {
                setTimeout(initPlayer, 100);
                return;
            }
            
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: 'jfKfPfyJRdk',
                playerVars: { 
                    autoplay: 0, 
                    controls: isHost ? 1 : 0,
                    disablekb: isHost ? 0 : 1,
                    rel: 0,
                    playsinline: 1
                },
                events: {
                    onReady: onPlayerReady,
                    onStateChange: onPlayerStateChange
                }
            });
            
            document.getElementById('playerLoader').style.display = 'none';
        }

        function onPlayerReady() {
            if (isHost) {
                setInterval(() => {
                    if (ignoreUpdates || !player?.getCurrentTime) return;
                    db.ref(`rooms/${currentRoom}/currentVideo`).update({
                        time: player.getCurrentTime(),
                        isPlaying: player.getPlayerState() === YT.PlayerState.PLAYING,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }, 2000);
            }
        }

        function onPlayerStateChange(e) {
            updatePlayBtn(e.data === YT.PlayerState.PLAYING);
            if (!isHost || ignoreUpdates) return;
            
            db.ref(`rooms/${currentRoom}/currentVideo`).update({
                isPlaying: e.data === YT.PlayerState.PLAYING,
                time: player.getCurrentTime(),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function toggleSearch() {
            document.getElementById('searchContainer').classList.toggle('hidden');
        }

        function closeSearch() {
            document.getElementById('searchContainer').classList.add('hidden');
            document.getElementById('searchResults').classList.add('hidden');
        }

        async function searchYouTube() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) return;
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="flex justify-center p-4"><div class="spinner"></div></div>';
            resultsDiv.classList.remove('hidden');
            
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=8&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}`);
                const data = await res.json();
                
                if (data.error) throw new Error(data.error.message);
                
                resultsDiv.innerHTML = '';
                data.items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'video-card flex space-x-3 p-3 rounded-xl bg-gray-800/40 hover:bg-gray-800 border border-transparent hover:border-gray-600 transition group';
                    card.onclick = () => selectVideo(item.id.videoId, item.snippet.title);
                    card.innerHTML = `
                        <div class="relative w-28 h-16 shrink-0">
                            <img src="${item.snippet.thumbnails.medium.url}" class="w-full h-full object-cover rounded-lg bg-gray-900">
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition rounded-lg">
                                <i class="fas fa-play text-white"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0 py-0.5">
                            <h4 class="text-xs font-bold text-white line-clamp-2 leading-snug mb-1">${item.snippet.title}</h4>
                            <p class="text-[10px] text-gray-500">${item.snippet.channelTitle}</p>
                        </div>
                    `;
                    resultsDiv.appendChild(card);
                });
            } catch (err) {
                resultsDiv.innerHTML = `<div class="text-red-400 text-sm text-center p-4"><i class="fas fa-exclamation-triangle mr-2"></i>${err.message}</div>`;
            }
        }

        function selectVideo(id, title) {
            if (!isHost) return;
            currentVideoId = id;
            player.loadVideoById(id);
            document.getElementById('currentVideoTitle').textContent = title;
            closeSearch();
            
            db.ref(`rooms/${currentRoom}/currentVideo`).set({
                id: id,
                title: title,
                time: 0,
                isPlaying: true,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function playerControl(action, val) {
            if (!isHost || !player) return;
            ignoreUpdates = true;
            setTimeout(() => ignoreUpdates = false, 500);
            
            if (action === 'toggle') {
                const state = player.getPlayerState();
                if (state === YT.PlayerState.PLAYING) player.pauseVideo();
                else player.playVideo();
            } else if (action === 'seek') {
                player.seekTo(player.getCurrentTime() + val, true);
            }
        }

        function updatePlayBtn(playing) {
            document.getElementById('playIcon').classList.toggle('hidden', playing);
            document.getElementById('pauseIcon').classList.toggle('hidden', !playing);
        }

        function forceSync() {
            if (!isHost || !player) return;
            db.ref(`rooms/${currentRoom}/currentVideo`).update({
                time: player.getCurrentTime(),
                isPlaying: player.getPlayerState() === YT.PlayerState.PLAYING,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function setupListeners() {
            if (!isHost) {
                db.ref(`rooms/${currentRoom}/currentVideo`).on('value', (snap) => {
                    const data = snap.val();
                    if (!data || !player) return;
                    
                    if (data.id !== currentVideoId) {
                        currentVideoId = data.id;
                        player.loadVideoById(data.id);
                        document.getElementById('currentVideoTitle').textContent = data.title || 'Video';
                    }
                    
                    const serverTime = getServerTime();
                    const latency = (serverTime - data.timestamp) / 1000;
                    const targetTime = data.time + (data.isPlaying ? latency : 0);
                    const current = player.getCurrentTime();
                    
                    if (Math.abs(current - targetTime) > 1) player.seekTo(targetTime, true);
                    
                    const isPlaying = player.getPlayerState() === YT.PlayerState.PLAYING;
                    if (data.isPlaying && !isPlaying) player.playVideo();
                    else if (!data.isPlaying && isPlaying) player.pauseVideo();
                });
            }
            
            db.ref(`rooms/${currentRoom}/users`).on('value', (snap) => {
                const users = snap.val() || {};
                const list = document.getElementById('usersList');
                list.innerHTML = '';
                
                let activeCount = 0;
                Object.entries(users).forEach(([uid, u]) => {
                    if (u.status !== 'background') activeCount++;
                    
                    const div = document.createElement('div');
                    div.className = 'user-pill flex items-center gap-2 px-2.5 py-1.5 rounded-full bg-gray-800/80 border border-gray-700 shrink-0';
                    
                    const statusClass = u.status === 'background' ? 'status-background' : u.focused === false ? 'status-inactive' : 'status-active';
                    
                    div.innerHTML = `
                        <div class="relative">
                            <img src="${u.avatar || 'https://via.placeholder.com/32'}" class="w-6 h-6 rounded-full object-cover border border-gray-600">
                            <div class="status-dot ${statusClass} absolute -bottom-0.5 -right-0.5 border-2 border-gray-800 w-2 h-2"></div>
                        </div>
                        <span class="text-[11px] font-bold ${u.isHost ? 'text-yellow-400' : 'text-gray-200'} truncate max-w-[60px]">${u.name}</span>
                    `;
                    list.appendChild(div);
                    
                    if (isHost && u.status === 'background' && uid !== userId) {
                        showNotification('ƒ∞stifad…ô√ßi arxa planda', `${u.name} saytƒ± arxa plana aldƒ±`);
                    }
                });
                
                document.getElementById('usersCountText').textContent = Object.keys(users).length;
                document.getElementById('onlineCount').textContent = `${activeCount} aktiv`;
            });
            
            db.ref(`rooms/${currentRoom}/chat`).on('child_added', (snap) => {
                const msg = snap.val();
                if (!isMe(msg.userId) && (document.hidden || !document.hasFocus())) {
                    if ('vibrate' in navigator) navigator.vibrate([100, 50, 100]);
                }
                appendMessage(msg, snap.key);
            });
        }

        function isMe(uid) { return uid === userId; }

        function appendMessage(msg, msgId) {
            const container = document.getElementById('chatMessages');
            const isSelf = isMe(msg.userId);
            
            const div = document.createElement('div');
            div.className = `flex ${isSelf ? 'justify-end' : 'justify-start'} group mb-2`;
            div.id = `msg-${msgId}`;
            
            let replyHtml = '';
            if (msg.replyTo) {
                replyHtml = `
                    <div class="message-reply mb-1 ${isSelf ? 'border-white/30' : 'border-gray-500'}">
                        <div class="text-[10px] opacity-70 mb-0.5">${msg.replyTo.name}</div>
                        <div class="truncate">${escapeHtml(msg.replyTo.text)}</div>
                    </div>
                `;
            }
            
            div.innerHTML = `
                ${!isSelf ? `<img src="${msg.avatar || 'https://via.placeholder.com/32'}" class="w-8 h-8 rounded-full object-cover mr-2 mt-1 border border-gray-700 shrink-0">` : ''}
                
                <div class="flex flex-col ${isSelf ? 'items-end' : 'items-start'} max-w-[85%]">
                    ${!isSelf ? `<span class="text-[10px] text-gray-400 mb-0.5 ml-1">${msg.name}</span>` : ''}
                    <div class="message-bubble ${isSelf ? 'message-self' : 'message-other'}">
                        ${replyHtml}
                        <div>${escapeHtml(msg.text)}</div>
                        <div class="text-[10px] mt-1 opacity-70 flex items-center justify-between gap-2">
                            <span>${new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            ${isSelf ? '<i class="fas fa-check-double text-[10px]"></i>' : ''}
                        </div>
                    </div>
                    ${!isSelf ? `
                    <button onclick="startReply('${msgId}', '${msg.name}', '${msg.text.replace(/'/g, "\\'")}')" 
                        class="opacity-0 group-hover:opacity-100 transition mt-0.5 px-2 py-0.5 text-[10px] text-gray-500 hover:text-white flex items-center gap-1">
                        <i class="fas fa-reply"></i> Cavab
                    </button>` : ''}
                </div>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function startReply(msgId, name, text) {
            replyingTo = { msgId, name, text };
            document.getElementById('replyText').textContent = text.length > 30 ? text.substring(0, 30) + '...' : text;
            document.getElementById('replyIndicator').style.display = 'flex';
            document.getElementById('messageInput').focus();
        }

        function cancelReply() {
            replyingTo = null;
            document.getElementById('replyIndicator').style.display = 'none';
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 96) + 'px';
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;
            
            const msgData = {
                userId,
                name: userName,
                avatar: userAvatar,
                text,
                isHost,
                time: firebase.database.ServerValue.TIMESTAMP
            };
            
            if (replyingTo) {
                msgData.replyTo = replyingTo;
                cancelReply();
            }
            
            db.ref(`rooms/${currentRoom}/chat`).push(msgData);
            input.value = '';
            input.style.height = 'auto';
        }

        function showNotification(title, text) {
            const toast = document.getElementById('notificationToast');
            document.getElementById('notifTitle').textContent = title;
            document.getElementById('notifText').textContent = text;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        function copyCode() {
            navigator.clipboard.writeText(currentRoom).then(() => {
                showNotification('Kod kopyalandƒ±', `${currentRoom} panoya kopyalandƒ±`);
            });
        }

        function shareCode() {
            const shareData = {
                title: 'SyncRoom Otaƒüƒ±',
                text: `SyncRoom-da birlikd…ô video izl…ôy…ôk! Otaq kodu: ${currentRoom}`,
                url: window.location.href.split('?')[0] + '?room=' + currentRoom
            };
            
            if (navigator.share) {
                navigator.share(shareData);
            } else {
                copyCode();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function leaveRoom() {
            if (currentRoom) {
                db.ref(`rooms/${currentRoom}/users/${userId}`).remove();
                if (isHost) setTimeout(() => db.ref(`rooms/${currentRoom}`).remove(), 2000);
            }
            location.reload();
        }

        window.onbeforeunload = leaveRoom;
        
        // Preload avatar
        const savedAvatar = localStorage.getItem('userAvatar');
        if (savedAvatar) {
            userAvatar = savedAvatar;
            document.getElementById('avatarPreview').src = savedAvatar;
            document.getElementById('avatarPreview').classList.remove('hidden');
            document.querySelector('.avatar-placeholder').classList.add('hidden');
            document.getElementById('avatarUpload').classList.add('has-image');
        }
        
        // Check URL for room param
        const urlParams = new URLSearchParams(window.location.search);
        const roomParam = urlParams.get('room');
        if (roomParam) {
            document.getElementById('joinRoomId').value = roomParam;
        }
    </script>
</body>
</html>
