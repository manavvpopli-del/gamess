<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doƒüruluq v…ô ya C…ôsar…ôt - Multiplayer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background: #1a1a2e;
            color: #fff;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Giri≈ü Ekranƒ± */
        #login-screen {
            background: rgba(255, 255, 255, 0.1);
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            margin: 5px;
            width: 200px;
        }

        button {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            background: #e94560;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }

        button:hover {
            background: #ff2e63;
        }

        /* Oyun Sah…ôsi */
        #game-area {
            display: none;
            position: relative;
            width: 100%;
            height: 100%;
            display: flex; /* D…ôyi≈üdirildi JS il…ô */
            justify-content: center;
            align-items: center;
        }

        .table {
            width: 300px;
            height: 300px;
            background: #16213e;
            border-radius: 50%;
            position: relative;
            border: 5px solid #0f3460;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        .bottle-container {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .bottle {
            width: 60px;
            height: 200px;
            background: url('https://cdn-icons-png.flaticon.com/512/3100/3100593.png') no-repeat center center; /* Butulka ikonu */
            background-size: contain;
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
            margin-top: -100px; /* M…ôrk…ôzl…ôm…ô */
            margin-left: -30px;
            transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1);
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
        }

        .player {
            position: absolute;
            width: 60px;
            height: 60px;
            background: #e94560;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px #e94560;
            transition: all 0.3s;
        }

        .player.active {
            background: #fcdab7;
            color: #000;
            box-shadow: 0 0 20px #fcdab7;
            z-index: 20;
        }

        /* ƒ∞dar…ôetm…ô Paneli */
        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        /* Modal P…ônc…ôr…ô */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            text-align: center;
        }

        .modal-content {
            background: #fff;
            color: #333;
            padding: 30px;
            border-radius: 20px;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 0 30px rgba(233, 69, 96, 0.5);
        }

        .choice-btn {
            width: 150px;
            margin: 10px;
            padding: 15px;
            font-size: 1.2rem;
        }

        .choice-truth { background: #3498db; }
        .choice-dare { background: #e74c3c; }

        .question-text {
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        #room-info {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .music-control {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: 1px solid #fff;
            font-size: 0.8rem;
        }

    </style>
</head>
<body>

    <audio id="bg-music" loop>
        <source src="mmm.mp3" type="audio/mpeg">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <div id="login-screen">
        <h1>Doƒüruluq vs C…ôsar…ôt</h1>
        <p>Otaq yaradƒ±n v…ô ya qo≈üulun</p>
        <input type="text" id="username" placeholder="Adƒ±nƒ±z" maxlength="10">
        <input type="text" id="room-id" placeholder="Otaq Kodu (m…ôs: 123)" maxlength="5">
        <br><br>
        <button onclick="joinGame()">Oyuna Ba≈üla</button>
    </div>

    <div id="game-area" style="display: none;">
        <div id="room-info">Otaq: <span id="display-room"></span> | Oyun√ßu: <span id="display-name"></span></div>
        <button class="music-control" onclick="toggleMusic()">üéµ Musiqi</button>
        
        <div class="table" id="table">
            <div class="bottle-container">
                <div class="bottle" id="bottle"></div>
            </div>
        </div>

        <div class="controls">
            <h2 id="status-text">Dig…ôr oyun√ßular g√∂zl…ônilir...</h2>
            <button id="spin-btn" onclick="spinBottleAction()" style="display:none; font-size: 1.2rem;">üçæ Butulkanƒ± Fƒ±rlat</button>
        </div>
    </div>

    <div id="choice-modal" class="modal">
        <h2 style="color:white; margin-bottom: 20px;">Se√ßimini Et!</h2>
        <div>
            <button class="choice-btn choice-truth" onclick="makeChoice('truth')">Doƒüruluq</button>
            <button class="choice-btn choice-dare" onclick="makeChoice('dare')">C…ôsar…ôt</button>
        </div>
    </div>

    <div id="task-modal" class="modal">
        <div class="modal-content">
            <h3 id="task-type-title">SUAL</h3>
            <p class="question-text" id="task-text">...</p>
            <button onclick="completeTurn()">Tamamladƒ±m</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
            authDomain: "sevgili-testi.firebaseapp.com",
            databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
            projectId: "sevgili-testi",
            storageBucket: "sevgili-testi.firebasestorage.app",
            messagingSenderId: "399260477557",
            appId: "1:399260477557:web:584204a698d7bf145bb03c",
            measurementId: "G-44P21XCZ7G"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- M∆èLUMAT BAZASI (Suallar) ---
        const truthQuestions = [
            "∆èn b√∂y√ºk qorxun n…ôdir?", "He√ß vaxt kim…ôs…ô x…ôyan…ôt etmis…ôn?", "Telefonunda gizl…ôtdiyin son ≈ü…ôkil n…ôdir?",
            "Buradakƒ± oyun√ßulardan kiminl…ô adaya d√º≈üm…ôk ist…ôrdin?", "U≈üaqlƒ±ƒüƒ±nda etdiyin …ôn utancverici h…ôr…ôk…ôt?",
            "He√ß sevm…ôdiyin halda kim…ôs…ô 's…ôni sevir…ôm' demis…ôn?", "∆èn son n…ô vaxt aƒülamƒ±san v…ô niy…ô?",
            "Whatsapp-da …ôn son kim…ô mesaj yazmƒ±san?", "Ke√ßmi≈ü sevgilin haqqƒ±nda n…ô d√º≈ü√ºn√ºrs…ôn?",
            "Bir g√ºn g√∂r√ºnm…ôz olsan ilk n…ô ed…ôrdin?", "√ñz√ºnd…ô b…ôy…ônm…ôdiyin 3 x√ºsusiyy…ôt?",
            "He√ß maƒüazadan oƒüurluq etmis…ôn?", "Valideynl…ôrin…ô dediyin …ôn b√∂y√ºk yalan n…ô olub?",
            "Buradakƒ± oyun√ßulardan kimin geyim t…ôrzini b…ôy…ônmirs…ôn?", "Telefonunun qalereyasƒ±ndakƒ± 10-cu ≈ü…ôkli g√∂st…ôr."
        ];

        const dareTasks = [
            "Qrupdakƒ± h…ôr k…ôs…ô mahnƒ± oxu.", "Yanƒ±ndakƒ± oyun√ßunu 1 d…ôqiq…ô qucaqla.", "Telefonunu g√∂t√ºr v…ô son z…ông ed…ôn…ô 'M…ôn yadplanetliy…ôm' yaz.",
            "50 d…ôf…ô oturub-dur (Squat).", "1 d…ôqiq…ô boyunca it kimi h√ºr.", "ƒ∞nstagram-da son postunun altƒ±na utancverici bir ≈ü…ôrh yaz.",
            "P…ônc…ôr…ôni a√ß v…ô var g√ºc√ºnl…ô 'M…ôn d…ôliy…ôm!' qƒ±≈üqƒ±r.", "Qrupdakƒ± bir n…ôf…ôrin ayaqqabƒ±sƒ±nƒ± iyl…ô.",
            "1 d…ôqiq…ô he√ß g√ºlm…ôd…ôn dur.", "H…ôr k…ôs…ô r…ôqs et.", "∆èn √ßirkin √ºz ifad…ôni al v…ô selfi √ß…ôkib hamƒ±ya g√∂st…ôr.",
            "Yanƒ±ndakƒ± oyun√ßuya s…ônin makiyajƒ±nƒ± etm…ôy…ô (v…ô ya √ºz√ºn…ô n…ôs…ô √ß…ôkm…ôy…ô) icaz…ô ver.",
            "Bir st…ôkan suyu ba≈üƒ±na t√∂k.", "Telefonunu yanƒ±ndakƒ± adama ver, ist…ôdiyi bir mesaja baxsƒ±n.",
            "Zalda 'moonwalk' yeri≈üi et."
        ];

        // --- GLOBAL D∆èYƒ∞≈û∆èNL∆èR ---
        let myId = localStorage.getItem('playerId') || 'player_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('playerId', myId);
        
        let roomId = null;
        let myName = null;
        let players = [];
        let currentRotation = 0;
        let isHost = false;

        // HTML elementl…ôri
        const loginScreen = document.getElementById('login-screen');
        const gameArea = document.getElementById('game-area');
        const table = document.getElementById('table');
        const bottle = document.getElementById('bottle');
        const spinBtn = document.getElementById('spin-btn');
        const statusText = document.getElementById('status-text');
        
        // Musiqi
        const bgMusic = document.getElementById('bg-music');
        bgMusic.volume = 0.3;

        // Funksiyalarƒ± window obyektin…ô baƒüla (HTML-d…ôn √ßaƒüƒ±rmaq √º√ß√ºn)
        window.joinGame = joinGame;
        window.spinBottleAction = spinBottleAction;
        window.makeChoice = makeChoice;
        window.completeTurn = completeTurn;
        window.toggleMusic = toggleMusic;

        function toggleMusic() {
            if (bgMusic.paused) bgMusic.play();
            else bgMusic.pause();
        }

        async function joinGame() {
            const nameInput = document.getElementById('username').value.trim();
            const roomInput = document.getElementById('room-id').value.trim();

            if (!nameInput || !roomInput) {
                alert("Z…ôhm…ôt olmasa ad v…ô otaq kodu daxil edin!");
                return;
            }

            myName = nameInput;
            roomId = roomInput;

            // UI d…ôyi≈üikliyi
            loginScreen.style.display = 'none';
            gameArea.style.display = 'flex';
            document.getElementById('display-room').innerText = roomId;
            document.getElementById('display-name').innerText = myName;

            // Musiqini ba≈ülat (istifad…ô√ßi qar≈üƒ±lƒ±qlƒ± …ôlaq…ôsi olduƒüu √º√ß√ºn indi i≈ül…ôy…ôc…ôk)
            try {
                bgMusic.play();
            } catch(e) { console.log("Audio autoplay blocked"); }

            // Oyun√ßunu …ôlav…ô et
            const playerRef = ref(db, `rooms/${roomId}/players/${myId}`);
            await set(playerRef, {
                name: myName,
                id: myId,
                joinedAt: Date.now()
            });
            
            // √áƒ±xanda silinsin
            onDisconnect(playerRef).remove();

            // Otaq dinl…ôyicil…ôri
            listenToRoom();
        }

        function listenToRoom() {
            const roomRef = ref(db, `rooms/${roomId}`);

            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                
                if (!data) return;

                // Oyun√ßularƒ± yenil…ô
                if (data.players) {
                    players = Object.values(data.players).sort((a, b) => a.joinedAt - b.joinedAt);
                    renderPlayers();
                }

                // D√∂nd…ôrm…ô bucaƒüƒ± yenil…ônibs…ô
                if (data.rotation && data.rotation !== currentRotation) {
                    currentRotation = data.rotation;
                    rotateVisual(currentRotation);
                }

                // Oyun statusu
                handleGameStatus(data);
            });
        }

        function renderPlayers() {
            // K√∂hn…ô oyun√ßularƒ± t…ômizl…ô
            document.querySelectorAll('.player').forEach(el => el.remove());

            const radius = 190; // Masanƒ±n …ôtrafƒ±
            const centerX = table.offsetWidth / 2;
            const centerY = table.offsetHeight / 2;
            const step = 360 / players.length;

            players.forEach((player, index) => {
                const el = document.createElement('div');
                el.className = 'player';
                el.innerText = player.name;
                
                // Dair…ôvi yerl…ô≈üdirm…ô riyaziyyatƒ± (offset -90 d…ôr…ôc…ô yuxarƒ±dan ba≈ülamaq √º√ß√ºn)
                const angle = (step * index) - 90; 
                const radian = angle * (Math.PI / 180);
                
                const x = centerX + radius * Math.cos(radian);
                const y = centerY + radius * Math.sin(radian);

                el.style.left = x + 'px';
                el.style.top = y + 'px';
                el.id = `player-ui-${player.id}`;

                table.appendChild(el);
            });

            // ƒ∞lk g…ôl…ôn oyun√ßu "Host" sayƒ±lƒ±r v…ô fƒ±rlatmaq haqqƒ± ondadƒ±r (ilk d√∂vr…ôd…ô)
            // Daha yax≈üƒ± m…ôntiq: ∆èg…ôr status 'waiting'dirs…ô, h…ôr k…ôs g√∂r…ô bil…ôr v…ô ya n√∂vb…ôli
            // Sad…ôlik √º√ß√ºn: Status 'waiting' olanda d√ºym…ô g√∂r√ºn√ºr.
        }

        function rotateVisual(deg) {
            bottle.style.transform = `translate(-50%, -50%) rotate(${deg}deg)`;
        }

        function handleGameStatus(data) {
            const status = data.status || 'waiting';
            const statusTextEl = document.getElementById('status-text');
            const spinBtnEl = document.getElementById('spin-btn');
            const choiceModal = document.getElementById('choice-modal');
            const taskModal = document.getElementById('task-modal');
            const activePlayerId = data.activePlayer;

            // Reset UI
            spinBtnEl.style.display = 'none';
            choiceModal.style.display = 'none';
            taskModal.style.display = 'none';
            document.querySelectorAll('.player').forEach(p => p.classList.remove('active'));

            if (status === 'waiting') {
                statusTextEl.innerText = "N√∂vb…ôti oyun √º√ß√ºn hazƒ±r!";
                spinBtnEl.style.display = 'inline-block';
            } 
            else if (status === 'spinning') {
                statusTextEl.innerText = "Butulka fƒ±rlanƒ±r...";
            } 
            else if (status === 'selected') {
                // Qalibi tapmaq
                const winner = players.find(p => p.id === activePlayerId);
                if (winner) {
                    statusTextEl.innerText = `Se√ßildi: ${winner.name}`;
                    document.getElementById(`player-ui-${winner.id}`).classList.add('active');

                    // ∆èg…ôr m…ôn…ôms…ô, se√ßim g√∂st…ôr
                    if (winner.id === myId) {
                        choiceModal.style.display = 'flex';
                    } else {
                        statusTextEl.innerText = `${winner.name} se√ßim edir...`;
                    }
                }
            } 
            else if (status === 'doing') {
                const winner = players.find(p => p.id === activePlayerId);
                if (winner) {
                     document.getElementById(`player-ui-${winner.id}`).classList.add('active');
                     
                     // Tap≈üƒ±rƒ±ƒüƒ± hamƒ±ya g√∂st…ôr
                     taskModal.style.display = 'flex';
                     document.getElementById('task-type-title').innerText = data.currentType === 'truth' ? "DOƒûRULUQ SUALI" : "C∆èSAR∆èT TAP≈ûIRIƒûI";
                     document.getElementById('task-text').innerText = data.currentText;

                     // "Tamamladƒ±m" d√ºym…ôsi yalnƒ±z aktiv oyun√ßuya g√∂r√ºns√ºn
                     const doneBtn = taskModal.querySelector('button');
                     if (activePlayerId === myId) {
                         doneBtn.style.display = 'inline-block';
                     } else {
                         doneBtn.style.display = 'none';
                         statusTextEl.innerText = `${winner.name} cavab verir/yerin…ô yetirir...`;
                     }
                }
            }
        }

        function spinBottleAction() {
            if (players.length < 2) {
                alert("Oynamaq √º√ß√ºn …ôn az 2 n…ôf…ôr lazƒ±mdƒ±r!");
                return;
            }

            // Database status update: Spinning
            update(ref(db, `rooms/${roomId}`), { status: 'spinning' });

            // Random bucaq (…ôlav…ô 720-1440 d…ôr…ôc…ô fƒ±rlansƒ±n)
            const randomRot = Math.floor(Math.random() * 720) + 720;
            const newRotation = currentRotation + randomRot;

            // ƒ∞ndi qalibi hesablayaq ki, DB-…ô yazaq
            // Butulkanƒ±n ucu ≈ü…ôkild…ô yuxarƒ± baxƒ±r (0 d…ôr…ôc…ô).
            // CSS rotasiyasƒ± saat …ôqr…ôbi istiqam…ôtind…ôdir.
            // Bucaƒüƒ± normalla≈üdƒ±r (0-360)
            const normalizedAngle = newRotation % 360;
            
            // Oyun√ßu seqmentl…ôri
            const segmentSize = 360 / players.length;
            
            // Riyazi hesab: 0 d…ôr…ôc…ô yuxarƒ±dƒ±r (index 0).
            // Amma CSS-d…ô 0 d…ôr…ôc…ô yuxarƒ±dƒ±r, artdƒ±qca saƒüa gedir.
            // Oyun√ßular da saat …ôqr…ôbi √ºzr…ô d√ºz√ºl√ºb.
            // Butulkanƒ±n g√∂st…ôrdiyi bucaƒüa uyƒüun seqmenti tapmaq:
            
            // M…ôs…ôl…ôn: 2 oyun√ßu. 0 v…ô 180. Seqment 180.
            // Butulka 90dadƒ±rsa? 0-cƒ± oyun√ßuya yaxƒ±ndƒ±r yoxsa 1? 
            // Sad…ôlik √º√ß√ºn: Tam seqmenti b√∂l√ºr√ºk.
            // Offset n…ôz…ôr…ô alƒ±nmalƒ±dƒ±r. Butulka 0 olanda 1-ci oyun√ßuya baxƒ±r.
            
            let winningIndex = Math.floor(((normalizedAngle + (segmentSize/2)) % 360) / segmentSize);
            
            // Index array-d…ôn k…ônara √ßƒ±xsa d√ºz…ôlt
            if (winningIndex >= players.length) winningIndex = 0;
            
            // B…ôz…ôn t…ôrs ola bilir, oyun√ßu d√ºz√ºl√º≈ü√ºnd…ôn asƒ±lƒ± olaraq. 
            // ≈û…ôkil fƒ±rlanƒ±r, oyun√ßular sabitdir.
            // Sad…ô index m…ôntiqi (d…ôqiq hesablamasƒ±z da t…ôxmini i≈ül…ôyir):
            // (360 - (angle % 360)) / segmentSize  -> T…ôxmin…ôn.
            
            // G…ôlin d…ôqiq hesablayaq: Butulkanƒ±n ucu hara baxƒ±r?
            // Butulka saat …ôqr…ôbi il…ô fƒ±rlanƒ±r.
            // Oyun√ßu 0: -90 (v…ô ya 270) d…ôr…ôc…ôd…ôdir (Top Center).
            // Bu kodu sad…ôl…ô≈üdirm…ôk √º√ß√ºn qalibi random se√ßib butulkanƒ± ona t…ôr…ôf fƒ±rladaq?
            // Xeyr, fizika daha maraqlƒ±dƒ±r. 
            // T…ôxmini qalib:
            const winningPlayer = players[ Math.floor(Math.random() * players.length) ];

            // ƒ∞ndi bucaƒüƒ± h…ômin oyun√ßuya g√∂r…ô d√ºz…ôld…ôk ki, d√ºz √ºst√ºnd…ô dayansƒ±n
            // Oyun√ßunun bucaƒüƒ±:
            const playerIndex = players.findIndex(p => p.id === winningPlayer.id);
            const targetAngle = (playerIndex * segmentSize); 
            // 0-cƒ± oyun√ßu -90 d…ôr…ôc…ôd…ôdir …ôslind…ô CSS-d…ô top:0, left:50%
            // Bizim 'bottle' default 0 d…ôr…ôc…ôsi ≈üaquli yuxarƒ±dƒ±r.
            // Dem…ôli targetAngle tam oyun√ßunun √ºst√ºd√ºr.
            
            // Fƒ±rlanmanƒ± el…ô hesablayaq ki, targetAngle-da dayansƒ±n + extra spins
            const extraSpins = 5 * 360; 
            const finalRot = currentRotation + extraSpins + (targetAngle - (currentRotation % 360));

            update(ref(db, `rooms/${roomId}`), {
                rotation: finalRot,
                status: 'spinning'
            });

            // 3 saniy…ô sonra n…ôtic…ôni elan et (CSS transition m√ºdd…ôti)
            setTimeout(() => {
                update(ref(db, `rooms/${roomId}`), {
                    status: 'selected',
                    activePlayer: winningPlayer.id
                });
            }, 3100);
        }

        function makeChoice(type) {
            let text = "";
            let dataArr = [];

            if (type === 'truth') {
                dataArr = truthQuestions;
            } else {
                dataArr = dareTasks;
            }

            // T…ôkrarlanmayan random se√ßimi √º√ß√ºn index
            const randIndex = Math.floor(Math.random() * dataArr.length);
            text = dataArr[randIndex];

            update(ref(db, `rooms/${roomId}`), {
                status: 'doing',
                currentType: type,
                currentText: text
            });
        }

        function completeTurn() {
            update(ref(db, `rooms/${roomId}`), {
                status: 'waiting',
                activePlayer: null,
                currentText: null,
                currentType: null
            });
        }

    </script>
</body>
</html>