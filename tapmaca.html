<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doƒüruluq v…ô ya C…ôsar…ôt - Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background: #0f0c29;  /* fallback for old browsers */
            background: -webkit-linear-gradient(to right, #24243e, #302b63, #0f0c29);  /* Chrome 10-25, Safari 5.1-6 */
            background: linear-gradient(to right, #24243e, #302b63, #0f0c29); /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
            color: #fff;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Giri≈ü Ekranƒ± */
        #login-screen {
            background: rgba(255, 255, 255, 0.05);
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            backdrop-filter: blur(15px);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
        }

        h1 { margin-bottom: 20px; font-size: 2.5rem; text-transform: uppercase; letter-spacing: 2px; }

        input {
            padding: 15px;
            border-radius: 30px;
            border: none;
            margin: 10px;
            width: 250px;
            text-align: center;
            font-size: 1rem;
            outline: none;
            background: rgba(255,255,255,0.9);
        }

        button {
            padding: 15px 40px;
            border-radius: 30px;
            border: none;
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: 0.3s;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(255, 75, 43, 0.4);
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(255, 75, 43, 0.6);
        }

        /* Oyun Sah…ôsi */
        #game-area {
            display: none;
            position: relative;
            width: 100%;
            height: 100%;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .table {
            width: 320px;
            height: 320px;
            background: radial-gradient(circle, #2a2a2a 0%, #000000 100%);
            border-radius: 50%;
            position: relative;
            border: 8px solid #444;
            box-shadow: 0 0 60px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.8);
        }

        .bottle-container {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            z-index: 10;
        }

        .bottle {
            width: 80px;
            height: 240px;
            /* Yeni Butulka ≈û…ôkli */
            background: url('https://purepng.com/public/uploads/large/purepng.com-green-glass-bottlebottleglass-bottlecontainergreen-bottle-1701528343725d99gs.png') no-repeat center center;
            background-size: contain;
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
            margin-top: -120px; /* H√ºnd√ºrl√ºy√ºn yarƒ±sƒ± */
            margin-left: -40px; /* Enin yarƒ±sƒ± */
            transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1);
            filter: drop-shadow(5px 10px 10px rgba(0,0,0,0.6));
        }

        .player {
            position: absolute;
            width: 70px;
            height: 70px;
            background: linear-gradient(45deg, #2193b0, #6dd5ed);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            font-weight: bold;
            text-align: center;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(33, 147, 176, 0.5);
            border: 2px solid white;
            transition: all 0.3s;
            overflow: hidden;
            word-break: break-all;
            padding: 5px;
        }

        .player.active {
            background: linear-gradient(45deg, #f12711, #f5af19);
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 0 30px rgba(245, 175, 25, 0.8);
            z-index: 20;
            border: 2px solid #fff;
        }

        /* ƒ∞dar…ôetm…ô Paneli */
        .controls {
            position: absolute;
            bottom: 40px;
            text-align: center;
            width: 100%;
        }
        
        #status-text {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* Modal P…ônc…ôr…ô */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            text-align: center;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: #fff;
            color: #333;
            padding: 40px;
            border-radius: 20px;
            max-width: 90%;
            width: 500px;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .choice-btn {
            width: 160px;
            margin: 15px;
            padding: 20px;
            font-size: 1.3rem;
            border-radius: 15px;
            color: white;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .choice-btn:hover { transform: scale(1.05); }
        .choice-truth { background: linear-gradient(45deg, #00b09b, #96c93d); }
        .choice-dare { background: linear-gradient(45deg, #8e2de2, #4a00e0); }

        .question-text {
            font-size: 1.6rem;
            margin: 30px 0;
            font-weight: bold;
            color: #2c3e50;
            line-height: 1.4;
        }
        
        #task-type-title {
            font-size: 2rem;
            text-transform: uppercase;
            color: #e74c3c;
            letter-spacing: 3px;
        }

        #room-info {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1rem;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 20px;
        }

        /* Gizli musiqi elementi */
        audio { display: none; }

    </style>
</head>
<body>

    <audio id="bg-music" loop>
        <source src="mmm.mp3" type="audio/mpeg">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <div id="login-screen">
        <h1>Doƒüruluq vs C…ôsar…ôt</h1>
        <p>Otaq yaradƒ±n v…ô ya m√∂vcud otaƒüa qo≈üulun</p>
        <input type="text" id="username" placeholder="Adƒ±nƒ±z (m…ôs: ∆èli)" maxlength="12">
        <input type="text" id="room-id" placeholder="Otaq Kodu (m…ôs: 555)" maxlength="6">
        <br>
        <button onclick="joinGame()">OYUNA BA≈ûLA</button>
    </div>

    <div id="game-area">
        <div id="room-info">Otaq: <strong id="display-room">...</strong> | Oyun√ßu: <strong id="display-name">...</strong></div>
        
        <div class="table" id="table">
            <div class="bottle-container">
                <div class="bottle" id="bottle"></div>
            </div>
        </div>

        <div class="controls">
            <h2 id="status-text">Dig…ôr oyun√ßular g√∂zl…ônilir...</h2>
            <button id="spin-btn" onclick="spinBottleAction()" style="display:none;">üçæ BUTULKANI FIRLAT</button>
        </div>
    </div>

    <div id="choice-modal" class="modal">
        <h2 style="color:white; font-size: 3rem; margin-bottom: 30px;">Se√ßimini Et!</h2>
        <div>
            <button class="choice-btn choice-truth" onclick="makeChoice('truth')">DOƒûRULUQ</button>
            <button class="choice-btn choice-dare" onclick="makeChoice('dare')">C∆èSAR∆èT</button>
        </div>
    </div>

    <div id="task-modal" class="modal">
        <div class="modal-content">
            <h3 id="task-type-title">SUAL</h3>
            <p class="question-text" id="task-text">...</p>
            <button onclick="completeTurn()">TAMAMLADIM</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
            authDomain: "sevgili-testi.firebaseapp.com",
            databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
            projectId: "sevgili-testi",
            storageBucket: "sevgili-testi.firebasestorage.app",
            messagingSenderId: "399260477557",
            appId: "1:399260477557:web:584204a698d7bf145bb03c",
            measurementId: "G-44P21XCZ7G"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 100 DOƒûRULUQ SUALI ---
        const truthQuestions = [
            "∆èn b√∂y√ºk qorxun n…ôdir?", 
            "He√ß vaxt kim…ôs…ô x…ôyan…ôt etmis…ôn?", 
            "Telefonunda gizl…ôtdiyin son ≈ü…ôkil n…ôdir?",
            "Buradakƒ± oyun√ßulardan kiminl…ô adaya d√º≈üm…ôk ist…ôrdin?", 
            "U≈üaqlƒ±ƒüƒ±nda etdiyin …ôn utancverici h…ôr…ôk…ôt?",
            "He√ß sevm…ôdiyin halda kim…ôs…ô 's…ôni sevir…ôm' demis…ôn?", 
            "∆èn son n…ô vaxt aƒülamƒ±san v…ô niy…ô?",
            "Whatsapp-da …ôn son kim…ô mesaj yazmƒ±san?", 
            "Ke√ßmi≈ü sevgilin haqqƒ±nda n…ô d√º≈ü√ºn√ºrs…ôn?",
            "Bir g√ºn g√∂r√ºnm…ôz olsan ilk n…ô ed…ôrdin?", 
            "√ñz√ºnd…ô b…ôy…ônm…ôdiyin 3 x√ºsusiyy…ôt?",
            "He√ß maƒüazadan oƒüurluq etmis…ôn?", 
            "Valideynl…ôrin…ô dediyin …ôn b√∂y√ºk yalan n…ô olub?",
            "Buradakƒ± oyun√ßulardan kimin geyim t…ôrzini b…ôy…ônmirs…ôn?", 
            "Telefonunun qalereyasƒ±ndakƒ± 10-cu ≈ü…ôkli g√∂st…ôr.",
            "∆èg…ôr cinsiyy…ôtini d…ôyi≈üs…ôydin, ed…ôc…ôyin ilk ≈üey n…ô olardƒ±?",
            "He√ß ictimai yerd…ô b…ôrkd…ôn qaz buraxmƒ±san?",
            "∆èn axmaq l…ôq…ôbin n…ô olub?",
            "Du≈ü q…ôbul ed…ôrk…ôn mahnƒ± oxuyursan?",
            "He√ß dostunun sevgilisin…ô a≈üiq olmusan?",
            "∆èn son n…ô vaxt yalan danƒ±≈ümƒ±san?",
            "Telefonunun brauzer tarix√ß…ôsini hamƒ±ya g√∂st…ôr…ô bil…ôrs…ôn?",
            "Kimins…ô di≈ü fƒ±r√ßasƒ±nƒ± gizlic…ô istifad…ô etmis…ôn?",
            "∆èg…ôr bu otaqdan bir n…ôf…ôri evl…ônm…ôk √º√ß√ºn se√ßm…ôli olsan, kimi se√ß…ôrdin?",
            "S…ôrxo≈ü olub etdiyin …ôn axmaq h…ôr…ôk…ôt?",
            "He√ß polisl…ô problemin olub?",
            "Buradakƒ± kimin …ôn √ßox yalan danƒ±≈üdƒ±ƒüƒ±nƒ± d√º≈ü√ºn√ºrs…ôn?",
            "H…ôyatƒ±nda …ôn √ßox pe≈üman olduƒüun an?",
            "ƒ∞ndiy…ô q…ôd…ôr aldƒ±ƒüƒ±n …ôn pis h…ôdiyy…ô?",
            "He√ß kimins…ô yem…ôyin…ô t√ºp√ºrm√ºs…ôn?",
            "T…ôk qalanda burnunu qurdalayƒ±rsan?",
            "Yuxuda danƒ±≈üƒ±rsan v…ô ya xoruldayƒ±rsan?",
            "∆èn √ßox kim…ô qibt…ô edirs…ôn?",
            "He√ß valideynl…ôrinin pulqabƒ±sƒ±ndan pul g√∂t√ºrm√ºs…ôn?",
            "∆èg…ôr √∂l…ôc…ôyini bils…ôydin, son z…ôngini kim…ô ed…ôrdin?",
            "B…ôd…ônind…ô …ôn b…ôy…ôndiyin yer haradƒ±r?",
            "ƒ∞lk √∂p√º≈ü√ºn nec…ô olub?",
            "He√ß saxta profil a√ßƒ±b kimi is…ô izl…ômis…ôn?",
            "M√º…ôllimini b…ôy…ônmis…ôn?",
            "ƒ∞mtahanda k√∂√ß√ºrm…ô etmis…ôn?",
            "Yolda pul tapsan sahibini axtararsan yoxsa g√∂t√ºr…ôrs…ôn?",
            "∆èn iyr…ônc v…ôrdi≈üin n…ôdir?",
            "He√ß vanna otaƒüƒ±nda i≈üiyibsan?",
            "Hansƒ± m…ô≈ühura a≈üiqs…ôn?",
            "Telefonundakƒ± …ôn son silinmi≈ü mesaj n…ô idi?",
            "Buradakƒ± kiminl…ô he√ß vaxt yola getm…ôzs…ôn?",
            "∆èn son n…ô vaxt du≈ü q…ôbul etmis…ôn?",
            "G√ºnd…ô ne√ß…ô d…ôf…ô g√ºzg√ºy…ô baxƒ±rsan?",
            "√ñz√ºn…ô yalan danƒ±≈üdƒ±ƒüƒ±n an olubmu?",
            "He√ß kimins…ô sirrini ba≈üqasƒ±na demis…ôn?",
            "Ke√ßmi≈ü sevgilini bloklamƒ±san?",
            "Sosial ≈ü…ôb…ôk…ôd…ô kimis…ô 'stalk' edirs…ôn?",
            "∆èg…ôr 1 milyon manatƒ±n olsa, ilk n…ô alarsan?",
            "∆èn son n…ôy…ô g√∂r…ô g√ºlm√ºs…ôn?",
            "He√ß heyvanlarla danƒ±≈üƒ±rsan?",
            "U≈üaq vaxtƒ± …ôn sevdiyin oyuncaq n…ô idi?",
            "Yataƒüƒ±nƒ±n altƒ±nda qorxulu bir ≈üey olduƒüunu d√º≈ü√ºn√ºrs…ôn?",
            "∆èn son oxuduƒüun kitab?",
            "Kinoda aƒülamƒ±san?",
            "He√ß eyni alt paltarƒ±nƒ± iki g√ºn ardƒ±cƒ±l geyinmis…ôn?",
            "Ayaq barmaqlarƒ±nƒ±n ≈ü…ôkill…ôrini √ß…ôkmis…ôn?",
            "He√ß kimins…ô mesajlarƒ±nƒ± gizlic…ô oxumusan?",
            "∆èg…ôr heyvan olsaydƒ±n, hansƒ± olardƒ±n?",
            "He√ß lift-d…ô qaz buraxƒ±b ba≈üqasƒ±nƒ±n √ºst√ºn…ô atmƒ±san?",
            "∆èn b√∂y√ºk x…ôyalƒ±n n…ôdir?",
            "S…ônc…ô buradakƒ± …ôn aƒüƒ±llƒ± insan kimdir?",
            "He√ß kimins…ô ad g√ºn√ºn√º unutmusan?",
            "∆èg…ôr ke√ßmi≈ü…ô qayƒ±da bils…ôydin, n…ôyi d…ôyi≈ü…ôrdin?",
            "∆èn √ßox n…ôd…ôn utanarsan?",
            "He√ß sevm…ôdiyin yem…ôyi qonaqlƒ±qda m…ôcbur yemis…ôn?",
            "S…ôni …ôn tez n…ô …ôs…ôbil…ô≈üdirir?",
            "He√ß kim…ôs…ô yumruq atmƒ±san?",
            "G…ôl…ôc…ôyi g√∂rm…ôk ist…ôrdin?",
            "Cibind…ô ad…ôt…ôn n…ô q…ôd…ôr pul olur?",
            "He√ß avtobusda v…ô ya metroda yatmƒ±san?",
            "∆èn pis geyim t…ôrzin nec…ô olub?",
            "He√ß sa√ßƒ±nƒ± r…ôngl…ôtm…ôk ist…ômis…ôn, amma c…ôsar…ôt etm…ômis…ôn?",
            "S…ônc…ô yadplanetlil…ôr var?",
            "He√ß ruh √ßaƒüƒ±rmƒ±san?",
            "∆èn √ßox hansƒ± f…ôsili sevirs…ôn v…ô niy…ô?",
            "He√ß di≈ü h…ôkimind…ôn qorxmusan?",
            "S…ôh…ôr yuxudan duranda ilk i≈üin n…ô olur?",
            "Yatmazdan …ôvv…ôl n…ô d√º≈ü√ºn√ºrs…ôn?",
            "He√ß kimis…ô d√∂ym…ôk ist…ômis…ôn?",
            "∆èn sevdiyin s√∂y√º≈ü hansƒ±dƒ±r?",
            "He√ß kimins…ô ≈ü…ôklin…ô baxƒ±b aƒülamƒ±san?",
            "√ñz toyunda hansƒ± mahnƒ±nƒ±n √ßalƒ±nmasƒ±nƒ± ist…ôrdin?",
            "He√ß sevgilin…ô x…ôyan…ôt etm…ôyi d√º≈ü√ºnm√ºs…ôn?",
            "∆èn son yediyin yem…ôk?",
            "S…ôni bu h…ôyatda …ôn √ßox kim ba≈üa d√º≈ü√ºr?",
            "He√ß intihar etm…ôyi d√º≈ü√ºnm√ºs…ôn?",
            "∆èg…ôr adƒ±nƒ± d…ôyi≈üs…ôydin, n…ô qoyardƒ±n?",
            "He√ß m…ôkt…ôbd…ôn qa√ßmƒ±san?",
            "S…ônc…ô pul xo≈üb…ôxtlik g…ôtirir?",
            "∆èn √ßox hansƒ± r…ôngi sevirs…ôn?",
            "He√ß kimins…ô evind…ô n…ôyis…ô sƒ±ndƒ±rƒ±b gizl…ôtmis…ôn?",
            "S…ônc…ô d√ºnya d√ºzd√ºr yoxsa yumru?",
            "∆èn b√∂y√ºk uƒüursuzluƒüun n…ô olub?",
            "He√ß kim…ôs…ô paxƒ±llƒ±q etmis…ôn?",
            "ƒ∞deal sevgilin nec…ô olmalƒ±dƒ±r?"
        ];

        const dareTasks = [
            "Qrupdakƒ± h…ôr k…ôs…ô mahnƒ± oxu.", 
            "Yanƒ±ndakƒ± oyun√ßunu 1 d…ôqiq…ô qucaqla.", 
            "Telefonunu g√∂t√ºr v…ô son z…ông ed…ôn…ô 'M…ôn yadplanetliy…ôm' yaz.",
            "20 d…ôf…ô oturub-dur (Squat).", 
            "1 d…ôqiq…ô boyunca it kimi h√ºr.", 
            "ƒ∞nstagram-da son postunun altƒ±na utancverici bir ≈ü…ôrh yaz.",
            "P…ônc…ôr…ôni a√ß v…ô var g√ºc√ºnl…ô 'M…ôn d…ôliy…ôm!' qƒ±≈üqƒ±r.", 
            "Qrupdakƒ± bir n…ôf…ôrin ayaqqabƒ±sƒ±nƒ± iyl…ô.",
            "1 d…ôqiq…ô he√ß g√ºlm…ôd…ôn dur.", 
            "H…ôr k…ôs…ô r…ôqs et (Makarena v…ô ya Lezginka).", 
            "∆èn √ßirkin √ºz ifad…ôni al v…ô selfi √ß…ôkib hamƒ±ya g√∂st…ôr.",
            "Yanƒ±ndakƒ± oyun√ßuya s…ônin √ºz√ºn…ô q…ôl…ôml…ô bƒ±ƒü √ß…ôkm…ôy…ô icaz…ô ver.",
            "Bir st…ôkan suyu ba≈üƒ±na t√∂k.", 
            "Telefonunu yanƒ±ndakƒ± adama ver, ist…ôdiyi bir mesaja baxsƒ±n.",
            "Zalda 'moonwalk' yeri≈üi et.",
            "Aƒüzƒ±na su al v…ô qar≈üƒ±ndakƒ± adam s…ôni g√ºld√ºr…ôn…ô q…ôd…ôr saxla.",
            "D√∂≈ü…ôm…ôd…ô s√ºr√ºn…ôr…ôk otaƒüƒ±n o ba≈üƒ±na get.",
            "Qrupdakƒ± bir n…ôf…ôri belind…ô da≈üƒ±.",
            "G√∂zl…ôrini baƒüla v…ô bir n…ôf…ôrin √ºz√ºn…ô toxunaraq kim olduƒüunu tap.",
            "Telefonda kontaktlardan t…ôsad√ºfi birin…ô z…ông et v…ô ona ≈üeir de.",
            "√ñz√ºn√º 1 d…ôqiq…ô …ôrzind…ô toyuq kimi apar.",
            "Qrupdan bir n…ôf…ôrin corabƒ±nƒ± di≈üinl…ô √ßƒ±xar.",
            "5 d…ôqiq…ô boyunca yalnƒ±z suallarla danƒ±≈ü.",
            "Hamƒ±nƒ±n qar≈üƒ±sƒ±nda qarnƒ±nƒ± a√ß v…ô g√∂b…ôyini g√∂st…ôr.",
            "Yanƒ±ndakƒ± adamƒ±n qulaƒüƒ±nƒ± yala.",
            "Stolun altƒ±na gir v…ô oradan √ßƒ±xana q…ôd…ôr danƒ±≈üma.",
            "√ñz√ºn haqqƒ±nda pis bir ≈üayi…ô uydur v…ô hamƒ±ya danƒ±≈ü.",
            "∆èlind…ô x…ôyali bir gitara varmƒ±≈ü kimi solo ifa et.",
            "Telefonunda son √ß…ôkilmi≈ü 3 ≈ü…ôkli hamƒ±ya g√∂st…ôr.",
            "Bir qa≈üƒ±q duz ye (v…ô ya acƒ± istiot)."
        ];

        // --- GLOBAL D∆èYƒ∞≈û∆èNL∆èR ---
        let myId = localStorage.getItem('playerId') || 'player_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('playerId', myId);
        
        let roomId = null;
        let myName = null;
        let players = [];
        let currentRotation = 0;

        // HTML elementl…ôri
        const loginScreen = document.getElementById('login-screen');
        const gameArea = document.getElementById('game-area');
        const table = document.getElementById('table');
        const bottle = document.getElementById('bottle');
        const spinBtn = document.getElementById('spin-btn');
        const statusText = document.getElementById('status-text');
        
        // Musiqi Elementi
        const bgMusic = document.getElementById('bg-music');
        bgMusic.volume = 0.5;

        // Export functions to window
        window.joinGame = joinGame;
        window.spinBottleAction = spinBottleAction;
        window.makeChoice = makeChoice;
        window.completeTurn = completeTurn;

        async function joinGame() {
            const nameInput = document.getElementById('username').value.trim();
            const roomInput = document.getElementById('room-id').value.trim();

            if (!nameInput || !roomInput) {
                alert("Z…ôhm…ôt olmasa ad v…ô otaq kodu daxil edin!");
                return;
            }

            // *** MUSƒ∞Qƒ∞Nƒ∞ OYNAT (ƒ∞stifad…ô√ßi d√ºym…ôy…ô basdƒ±ƒüƒ± √º√ß√ºn brauzer icaz…ô ver…ôc…ôk) ***
            try {
                bgMusic.play().catch(e => console.log("Audio play error:", e));
            } catch(e) {
                console.log("Audio play failed");
            }

            myName = nameInput;
            roomId = roomInput;

            // UI update
            loginScreen.style.display = 'none';
            gameArea.style.display = 'flex';
            document.getElementById('display-room').innerText = roomId;
            document.getElementById('display-name').innerText = myName;

            // Join Firebase Room
            const playerRef = ref(db, `rooms/${roomId}/players/${myId}`);
            await set(playerRef, {
                name: myName,
                id: myId,
                joinedAt: Date.now()
            });
            
            // Remove on disconnect
            onDisconnect(playerRef).remove();

            // Listeners
            listenToRoom();
        }

        function listenToRoom() {
            const roomRef = ref(db, `rooms/${roomId}`);

            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                
                if (!data) return;

                // Players
                if (data.players) {
                    players = Object.values(data.players).sort((a, b) => a.joinedAt - b.joinedAt);
                    renderPlayers();
                }

                // Rotation
                if (data.rotation && data.rotation !== currentRotation) {
                    currentRotation = data.rotation;
                    rotateVisual(currentRotation);
                }

                // Status Logic
                handleGameStatus(data);
            });
        }

        function renderPlayers() {
            document.querySelectorAll('.player').forEach(el => el.remove());

            const radius = 200; // Masadan m…ôsaf…ô
            const centerX = table.offsetWidth / 2;
            const centerY = table.offsetHeight / 2;
            const step = 360 / players.length;

            players.forEach((player, index) => {
                const el = document.createElement('div');
                el.className = 'player';
                el.innerText = player.name;
                
                const angle = (step * index) - 90; 
                const radian = angle * (Math.PI / 180);
                
                const x = centerX + radius * Math.cos(radian);
                const y = centerY + radius * Math.sin(radian);

                el.style.left = x + 'px';
                el.style.top = y + 'px';
                el.id = `player-ui-${player.id}`;

                table.appendChild(el);
            });
        }

        function rotateVisual(deg) {
            bottle.style.transform = `translate(-50%, -50%) rotate(${deg}deg)`;
        }

        function handleGameStatus(data) {
            const status = data.status || 'waiting';
            const statusTextEl = document.getElementById('status-text');
            const spinBtnEl = document.getElementById('spin-btn');
            const choiceModal = document.getElementById('choice-modal');
            const taskModal = document.getElementById('task-modal');
            const activePlayerId = data.activePlayer;

            // Reset States
            spinBtnEl.style.display = 'none';
            choiceModal.style.display = 'none';
            taskModal.style.display = 'none';
            document.querySelectorAll('.player').forEach(p => p.classList.remove('active'));

            if (status === 'waiting') {
                statusTextEl.innerText = "N√∂vb…ôti oyun √º√ß√ºn hazƒ±r!";
                spinBtnEl.style.display = 'inline-block';
            } 
            else if (status === 'spinning') {
                statusTextEl.innerText = "Butulka fƒ±rlanƒ±r...";
            } 
            else if (status === 'selected') {
                const winner = players.find(p => p.id === activePlayerId);
                if (winner) {
                    statusTextEl.innerText = `Se√ßildi: ${winner.name}`;
                    document.getElementById(`player-ui-${winner.id}`).classList.add('active');

                    if (winner.id === myId) {
                        choiceModal.style.display = 'flex';
                    } else {
                        statusTextEl.innerText = `${winner.name} se√ßim edir...`;
                    }
                }
            } 
            else if (status === 'doing') {
                const winner = players.find(p => p.id === activePlayerId);
                if (winner) {
                     document.getElementById(`player-ui-${winner.id}`).classList.add('active');
                     
                     taskModal.style.display = 'flex';
                     document.getElementById('task-type-title').innerText = data.currentType === 'truth' ? "DOƒûRULUQ" : "C∆èSAR∆èT";
                     document.getElementById('task-text').innerText = data.currentText;

                     const doneBtn = taskModal.querySelector('button');
                     if (activePlayerId === myId) {
                         doneBtn.style.display = 'inline-block';
                     } else {
                         doneBtn.style.display = 'none';
                         statusTextEl.innerText = `${winner.name} icra edir...`;
                     }
                }
            }
        }

        function spinBottleAction() {
            if (players.length < 2) {
                alert("Oynamaq √º√ß√ºn …ôn az 2 n…ôf…ôr lazƒ±mdƒ±r!");
                return;
            }

            update(ref(db, `rooms/${roomId}`), { status: 'spinning' });

            const randomRot = Math.floor(Math.random() * 720) + 720;
            const newRotation = currentRotation + randomRot;
            const segmentSize = 360 / players.length;

            // Random qalib se√ßirik
            const winningPlayer = players[ Math.floor(Math.random() * players.length) ];
            const playerIndex = players.findIndex(p => p.id === winningPlayer.id);
            
            // Oyun√ßunun bucaƒüƒ±
            const targetAngle = (playerIndex * segmentSize); 
            
            // Tam oyun√ßunun √ºst√ºnd…ô dayansƒ±n
            const extraSpins = 4 * 360; 
            const finalRot = currentRotation + extraSpins + (targetAngle - (currentRotation % 360));

            update(ref(db, `rooms/${roomId}`), {
                rotation: finalRot,
                status: 'spinning'
            });

            setTimeout(() => {
                update(ref(db, `rooms/${roomId}`), {
                    status: 'selected',
                    activePlayer: winningPlayer.id
                });
            }, 3100);
        }

        function makeChoice(type) {
            let text = "";
            let dataArr = [];

            if (type === 'truth') dataArr = truthQuestions;
            else dataArr = dareTasks;

            const randIndex = Math.floor(Math.random() * dataArr.length);
            text = dataArr[randIndex];

            update(ref(db, `rooms/${roomId}`), {
                status: 'doing',
                currentType: type,
                currentText: text
            });
        }

        function completeTurn() {
            update(ref(db, `rooms/${roomId}`), {
                status: 'waiting',
                activePlayer: null,
                currentText: null,
                currentType: null
            });
        }
    </script>
</body>
</html>