<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindBattle - Realtime Multiplayer Tapmaca</title>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, set, onValue, update, remove, serverTimestamp, onDisconnect } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PjoLU",
            authDomain: "sevgili-testi.firebaseapp.com",
            databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
            projectId: "sevgili-testi",
            storageBucket: "sevgili-testi.firebasestorage.app",
            messagingSenderId: "399260477557",
            appId: "1:399260477557:web:584204a698d7bf145bb03c",
            measurementId: "G-44P21XCZ7G"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        window.firebaseDB = db;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
        window.firebaseRemove = remove;
        window.firebaseOnValue = onValue;
        window.serverTimestamp = serverTimestamp;
        window.onDisconnect = onDisconnect;
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            overflow-x: hidden;
        }
        
        .bg-animation {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; overflow: hidden;
        }
        
        .bg-animation div {
            position: absolute; border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 20s infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-100px) rotate(180deg); opacity: 0.1; }
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            padding: 40px; max-width: 600px; width: 90%;
            text-align: center; position: relative;
        }
        
        h1 {
            font-size: 2.5em; margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(255,255,255,0.5);
            font-weight: 800;
        }
        
        .subtitle { font-size: 1.1em; opacity: 0.9; margin-bottom: 30px; }
        
        input {
            width: 100%; padding: 15px 20px; margin: 10px 0;
            border: none; border-radius: 15px;
            background: rgba(255, 255, 255, 0.15);
            color: white; font-size: 1.1em; outline: none;
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        input::placeholder { color: rgba(255,255,255,0.6); }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; padding: 15px 40px; color: white;
            font-size: 1.1em; border-radius: 50px;
            cursor: pointer; margin: 10px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        
        .btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(0,0,0,0.4); }
        
        .btn-option {
            display: block; width: 100%; margin: 10px 0;
            text-align: left; padding: 20px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .btn-option:hover { background: rgba(255,255,255,0.2); transform: translateX(10px); }
        .btn-option.correct { background: rgba(46, 204, 113, 0.6); border-color: #2ecc71; }
        .btn-option.wrong { background: rgba(231, 76, 60, 0.6); border-color: #e74c3c; }
        .btn-option.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        
        .selection-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 15px; margin: 30px 0;
        }
        
        .selection-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 20px; padding: 30px 15px;
            cursor: pointer; transition: all 0.3s;
        }
        
        .selection-card:hover {
            transform: translateY(-5px); background: rgba(255,255,255,0.2);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        
        .selection-card.selected {
            background: rgba(255,255,255,0.3);
            border-color: #fff; box-shadow: 0 0 30px rgba(255,255,255,0.3);
        }
        
        .timer-bar {
            width: 100%; height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px; overflow: hidden; margin: 20px 0;
        }
        
        .timer-fill {
            height: 100%; background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
            transition: width 1s linear; border-radius: 10px;
        }
        
        .score-board {
            display: flex; justify-content: space-around;
            margin: 20px 0; padding: 20px;
            background: rgba(0,0,0,0.2); border-radius: 15px;
        }
        
        .player-score { text-align: center; }
        .player-score .score { font-size: 2em; font-weight: bold; color: #ffd700; }
        
        .question-box {
            background: rgba(0,0,0,0.2); padding: 30px;
            border-radius: 20px; margin: 20px 0;
            font-size: 1.3em; min-height: 120px;
            display: flex; align-items: center; justify-content: center;
        }
        
        .status-message {
            padding: 15px; border-radius: 10px;
            margin: 15px 0; font-weight: 600;
        }
        
        .status-waiting { background: rgba(52, 152, 219, 0.3); border: 1px solid #3498db; }
        .status-success { background: rgba(46, 204, 113, 0.3); border: 1px solid #2ecc71; }
        .status-error { background: rgba(231, 76, 60, 0.3); border: 1px solid #e74c3c; }
        
        .room-code-display {
            background: rgba(0,0,0,0.3); padding: 15px 30px;
            border-radius: 15px; font-size: 2em; font-weight: bold;
            letter-spacing: 5px; margin: 20px 0;
            border: 2px dashed rgba(255,255,255,0.3);
            font-family: monospace;
        }
        
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .winner-crown { font-size: 4em; margin-bottom: 20px; animation: bounce 1s infinite; }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .hidden { display: none !important; }
        
        @media (max-width: 600px) {
            .container { padding: 20px; }
            h1 { font-size: 1.8em; }
            .selection-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="bg-animation" id="bgAnimation"></div>

    <div class="container">
        <div id="loginScreen" class="screen">
            <h1>üß† MindBattle</h1>
            <p class="subtitle">Real-time Multiplayer Tapmaca Oyunu</p>
            <input type="text" id="playerName" placeholder="Adƒ±nƒ±zƒ± daxil edin" maxlength="15">
            <input type="text" id="roomCode" placeholder="Otaq kodu" maxlength="6" style="text-transform: uppercase;">
            <button class="btn" onclick="joinRoom()">Oyuna Qo≈üul</button>
            <button class="btn" onclick="createRoom()" style="background: rgba(255,255,255,0.2);">Yeni Otaq Yarat</button>
        </div>

        <div id="lobbyScreen" class="screen hidden">
            <h2>Otaq: <span id="displayRoomCode"></span></h2>
            <div class="room-code-display" id="roomCodeDisplay"></div>
            <button class="btn" onclick="copyRoomCode()" style="padding: 8px 20px; font-size: 0.9em;">Kodu Kopyala</button>
            
            <div id="waitingMessage" class="status-message status-waiting">
                R…ôqibin qo≈üulmasƒ± g√∂zl…ônilir...
                <div class="spinner"></div>
            </div>

            <div id="playerList" style="margin: 20px 0;"></div>

            <div id="gameSettings" class="hidden">
                <p style="margin: 20px 0; font-size: 1.1em;">Tapmaca sayƒ±nƒ± se√ßin:</p>
                <div class="selection-grid">
                    <div class="selection-card" onclick="selectQuestionCount(20)">
                        <h3>20</h3>
                        <p>Tapmaca</p>
                    </div>
                    <div class="selection-card" onclick="selectQuestionCount(40)">
                        <h3>40</h3>
                        <p>Tapmaca</p>
                    </div>
                    <div class="selection-card" onclick="selectQuestionCount(60)">
                        <h3>60</h3>
                        <p>Tapmaca</p>
                    </div>
                </div>
                <div id="selectionStatus" style="margin-top: 15px; font-weight: 600;"></div>
            </div>
        </div>

        <div id="gameScreen" class="screen hidden">
            <div class="score-board">
                <div class="player-score">
                    <h4 id="player1Name">Siz</h4>
                    <div class="score" id="score1">0</div>
                </div>
                <div style="font-size: 1.5em; font-weight: bold; opacity: 0.5; display: flex; align-items: center;">VS</div>
                <div class="player-score">
                    <h4 id="player2Name">R…ôqib</h4>
                    <div class="score" id="score2">0</div>
                </div>
            </div>

            <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px; color: #f5576c;">
                Qalan vaxt: <span id="timeLeft">20</span>s
            </div>
            <div class="timer-bar">
                <div class="timer-fill" id="timerBar" style="width: 100%;"></div>
            </div>

            <div class="question-box" id="questionText">Tapmaca y√ºkl…ônir...</div>
            <div id="optionsContainer" style="margin-top: 20px;"></div>
            <div id="answerFeedback" style="margin-top: 20px; font-weight: 600; min-height: 30px;"></div>
        </div>

        <div id="resultScreen" class="screen hidden">
            <div class="winner-crown">üëë</div>
            <h1 id="winnerText">Qalib!</h1>
            <div style="display: flex; justify-content: center; gap: 40px; margin: 30px 0;">
                <div style="text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.8;">Siz</div>
                    <div style="font-size: 2.5em; font-weight: bold; color: #ffd700;" id="finalScore1">0</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.8;">R…ôqib</div>
                    <div style="font-size: 2.5em; font-weight: bold; color: #ffd700;" id="finalScore2">0</div>
                </div>
            </div>
            <div id="gameOverReason" style="margin: 20px 0; padding: 15px; border-radius: 10px; background: rgba(0,0,0,0.2);"></div>
            <button class="btn" onclick="resetGame()">Yeni Oyun</button>
        </div>
    </div>

    <script>
        const questions = [
            { q: "G√ºnd√ºz yatƒ±r, gec…ô qalxƒ±r. N…ôdir?", options: ["Ulduz", "G√ºn…ô≈ü", "Ay"], correct: 0 },
            { q: "Su i√ßind…ô g√ºl bitm…ôz. N…ôdir?", options: ["Buz", "Da≈ü", "Balƒ±q"], correct: 0 },
            { q: "M…ôni yelledikc…ô uzanƒ±ram. N…ôdir?", options: ["ƒ∞p", "Yol", "√áay"], correct: 0 },
            { q: "Ba≈üƒ± var, ayaƒüƒ± yoxdur. N…ôdir?", options: ["Masa", "ƒ∞nsan", "Heyvan"], correct: 0 },
            { q: "∆èli var, vurmur. N…ôdir?", options: ["Saat", "D√∂y√º≈ü√ß√º", "Aƒüac"], correct: 0 },
            { q: "Qulaƒüƒ± var, e≈üitmir. N…ôdir?", options: ["Kupa", "Da≈ü", "M…ôktub"], correct: 0 },
            { q: "Di≈üi var, √ßeyn…ôm…ôz. N…ôdir?", options: ["Tara", "∆èjdaha", "P…ôrd…ô"], correct: 0 },
            { q: "Y√ºz√º var, g√∂r√ºnm…ôz. N…ôdir?", options: ["Pul", "G√ºzg√º", "Vaxt"], correct: 0 },
            { q: "Dili var, danƒ±≈ümaz. N…ôdir?", options: ["Ayaqqabƒ±", "Q…ôl…ôm", "Kitab"], correct: 0 },
            { q: "Qanadƒ± var, u√ßmaz. N…ôdir?", options: ["Ev", "Qu≈ü", "T…ôyyar…ô"], correct: 0 },
            { q: "G√∂zl…ôri var, g√∂rm…ôz. N…ôdir?", options: ["ƒ∞yn…ô", "Kartof", "Torpag"], correct: 0 },
            { q: "Paltarƒ± var, soyunmaz. N…ôdir?", options: ["Soƒüan", "ƒ∞nsan", "Meymun"], correct: 0 },
            { q: "T√ºk√º var, darƒ±xmaz. N…ôdir?", options: ["Yastƒ±q", "Heyvan", "Bitki"], correct: 0 },
            { q: "Ayaƒüƒ± var, g…ôzm…ôz. N…ôdir?", options: ["Stul", "Masa", "Sandiqi"], correct: 0 },
            { q: "S√ºm√ºy√º var, …ôti yoxdur. N…ôdir?", options: ["Quru√ßay", "Da≈ü", "Aƒüac"], correct: 0 },
            { q: "√úr…ôyi var, d√∂y√ºnm…ôz. N…ôdir?", options: ["Arti≈üok", "ƒ∞nsan", "Heyvan"], correct: 0 },
            { q: "N…ôf…ôsi var, ya≈üamaz. N…ôdir?", options: ["K√ºl…ôk", "D…ôrman", "Qaz"], correct: 0 },
            { q: "S…ôsi var, danƒ±≈ümaz. N…ôdir?", options: ["Radio", "Telefon", "Televizor"], correct: 0 },
            { q: "Boynu var, ba≈üƒ± yoxdur. N…ôdir?", options: ["≈û√º≈ü…ô", "Torba", "Qab"], correct: 0 },
            { q: "P…ônc…ôsi var, tutmaz. N…ôdir?", options: ["Stol", "Pi≈üik", "Ayƒ±"], correct: 0 },
            { q: "Qulaq asar, e≈üitm…ôz. N…ôdir?", options: ["K√ºr…ôk", "Qulaq", "M…ôktub"], correct: 0 },
            { q: "Dodaƒüƒ± var, √∂pm…ôz. N…ôdir?", options: ["√áaydan", "ƒ∞nsan", "G√ºl"], correct: 0 },
            { q: "Qa≈ülarƒ± var, g√∂z√º yoxdur. N…ôdir?", options: ["K…ôp…ôn…ôk", "ƒ∞yn…ô", "T…ôr…ôv…ôz"], correct: 0 },
            { q: "Sa√ßlarƒ± var, daramaz. N…ôdir?", options: ["Qar", "Xal√ßa", "Paltar"], correct: 0 },
            { q: "Aƒüzƒ± var, yem…ôz. N…ôdir?", options: ["√áanta", "≈ûir", "ƒ∞nsan"], correct: 0 },
            { q: "Burnu var, iy duymaz. N…ôdir?", options: ["∆ètir", "Papaq", "M…ôtb…ôx"], correct: 0 },
            { q: "Beli var, …ôym…ôz. N…ôdir?", options: ["Daƒü", "ƒ∞nsan", "∆èjdaha"], correct: 0 },
            { q: "Dizi var, √ß√∂km…ôz. N…ôdir?", options: ["≈ûalvar", "Stul", "Masa"], correct: 0 },
            { q: "Dudaƒüƒ± var, danƒ±≈ümaz. N…ôdir?", options: ["Qab", "ƒ∞nsan", "Qu≈ü"], correct: 0 },
            { q: "Qƒ±lƒ±ncƒ± var, vurmaz. N…ôdir?", options: ["Samuray", "∆èjdaha", "Balƒ±q"], correct: 0 },
            { q: "∆èti var, yeyilm…ôz. N…ôdir?", options: ["Da≈ü", "Heyvan", "Meyv…ô"], correct: 0 },
            { q: "S√ºm√ºy√º var, g…ôzm…ôz. N…ôdir?", options: ["Balƒ±q", "ƒ∞nsan", "Qu≈ü"], correct: 0 },
            { q: "Kanadƒ± var, u√ßmaz. N…ôdir?", options: ["Vindov", "K…ôrg…ôdan", "Ev"], correct: 0 },
            { q: "T√ºy√º var, u√ßmaz. N…ôdir?", options: ["Pinqvin", "Toyuq", "Qu≈ü"], correct: 0 },
            { q: "Buynuzu var, vurmaz. N…ôdir?", options: ["K…ôp…ôn…ôk", "Ke√ßi", "√ñk√ºz"], correct: 0 },
            { q: "Quyruƒüu var, qovmaz. N…ôdir?", options: ["Ulduz", "Pi≈üik", "ƒ∞t"], correct: 0 },
            { q: "T…ôp…ôsi var, ba≈üƒ± yoxdur. N…ôdir?", options: ["Daƒü", "Ev", "Aƒüac"], correct: 0 },
            { q: "K√∂k√º var, bitm…ôz. N…ôdir?", options: ["Problem", "Aƒüac", "√ái√ß…ôk"], correct: 0 },
            { q: "Yarpaƒüƒ± var, solmaz. N…ôdir?", options: ["Kitab", "Aƒüac", "G√ºl"], correct: 0 },
            { q: "Meyv…ôsi var, yeyilm…ôz. N…ôdir?", options: ["Aƒüac", "Fƒ±ndƒ±q", "Alma"], correct: 0 },
            { q: "√ái√ß…ôyi var, iy verm…ôz. N…ôdir?", options: ["R…ôsm", "Qƒ±zƒ±lg√ºl", "Lal…ô"], correct: 0 },
            { q: "Tikanƒ± var, batmaz. N…ôdir?", options: ["M√ºbahis…ô", "G√ºl", "Kaktus"], correct: 0 },
            { q: "K√∂lg…ôsi var, g√∂r√ºnm…ôz. N…ôdir?", options: ["S…ôs", "ƒ∞nsan", "Aƒüac"], correct: 0 },
            { q: "ƒ∞zi var, g√∂r√ºnm…ôz. N…ôdir?", options: ["Vaxt", "Qu≈ü", "ƒ∞nsan"], correct: 0 },
            { q: "K√∂hn…ôl…ôr, ancaq yeni olar. N…ôdir?", options: ["G√ºn", "Ay", "ƒ∞l"], correct: 0 },
            { q: "Yuxarƒ± baxar, a≈üaƒüƒ± d√º≈ü…ôr. N…ôdir?", options: ["Yaƒüƒ±≈ü", "Qu≈ü", "G√ºn…ô≈ü"], correct: 0 },
            { q: "Yerind…ô durar, h…ôr…ôk…ôt ed…ôr. N…ôdir?", options: ["Saat", "Da≈ü", "Aƒüac"], correct: 0 },
            { q: "∆èksin…ô ged…ôr, ir…ôli g…ôl…ôr. N…ôdir?", options: ["T…ôk…ôr", "ƒ∞nsan", "Araba"], correct: 0 },
            { q: "H…ôr k…ôs…ô √ßatar, he√ß k…ôs g√∂rm…ôz. N…ôdir?", options: ["Hava", "Su", "Od"], correct: 0 },
            { q: "Yeyil…ôr, ancaq tox qalmaz. N…ôdir?", options: ["M…ôtb…ôx", "Yem…ôk", "Soyuducu"], correct: 0 },
            { q: "D…ônizd…ô olar, islanmaz. N…ôdir?", options: ["G…ômi", "Balƒ±q", "Qu≈ü"], correct: 0 },
            { q: "G√∂y…ô baxar, yerd…ô qalar. N…ôdir?", options: ["G√ºl", "Aƒüac", "Da≈ü"], correct: 0 },
            { q: "∆èl il…ô tutular, g√∂r√ºnm…ôz. N…ôdir?", options: ["S√∂z", "K√ºl…ôk", "Su"], correct: 0 },
            { q: "D…ôy…ôr, s…ôs √ßƒ±xarmaz. N…ôdir?", options: ["Pul", "Z…ôrb", "Z…ôrb"], correct: 0 },
            { q: "Parlayar, isti verm…ôz. N…ôdir?", options: ["Ay", "G√ºn…ô≈ü", "Od"], correct: 0 },
            { q: "Yanar, yandƒ±rmaz. N…ôdir?", options: ["Mum", "G√ºn…ô≈ü", "Odun"], correct: 0 },
            { q: "Soyuyar, isti verm…ôz. N…ôdir?", options: ["Buz", "K√ºl…ôk", "Qar"], correct: 0 },
            { q: "Qapaƒüƒ± var, i√ßi bo≈üdur. N…ôdir?", options: ["≈û√º≈ü…ô", "Qutu", "Ev"], correct: 0 },
            { q: "A√ßarƒ± var, kilidi yoxdur. N…ôdir?", options: ["Saat", "Qapƒ±", "Avtomobil"], correct: 0 },
            { q: "√áuxuru var, torpaq yoxdur. N…ôdir?", options: ["Tiy…ô", "Qazma", "√áuxur"], correct: 0 },
            { q: "D…ômir il…ô vurarlar, √∂lm…ôz. N…ôdir?", options: ["D…ômir", "Da≈ü", "Taxta"], correct: 0 },
            { q: "Su il…ô …ôzilir, daƒüƒ±lmaz. N…ôdir?", options: ["≈û…ôk…ôr", "Duz", "Un"], correct: 0 }
        ];

        let db, currentRoom, playerId, playerName, isHost, roomRef, gameState, timerInterval, currentQuestion, hasAnswered, selectedCount, unsubscribe;

        function initBackground() {
            const container = document.getElementById('bgAnimation');
            for (let i = 0; i < 15; i++) {
                const div = document.createElement('div');
                const size = Math.random() * 100 + 50;
                div.style.width = size + 'px';
                div.style.height = size + 'px';
                div.style.left = Math.random() * 100 + '%';
                div.style.top = Math.random() * 100 + '%';
                div.style.animationDelay = Math.random() * 5 + 's';
                div.style.animationDuration = (Math.random() * 10 + 10) + 's';
                container.appendChild(div);
            }
        }

        window.addEventListener('load', () => {
            setTimeout(() => {
                db = window.firebaseDB;
                initBackground();
            }, 1000);
        });

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showMessage(message, type = 'waiting') {
            const div = document.createElement('div');
            div.className = `status-message status-${type}`;
            div.textContent = message;
            const container = document.querySelector('.container');
            container.insertBefore(div, container.firstChild);
            setTimeout(() => div.remove(), 3000);
        }

        async function createRoom() {
            playerName = document.getElementById('playerName').value.trim();
            if (!playerName) { showMessage('Adƒ±nƒ±zƒ± daxil edin!', 'error'); return; }

            currentRoom = generateRoomCode();
            isHost = true;
            playerId = 'player1';
            
            document.getElementById('roomCodeDisplay').textContent = currentRoom;
            document.getElementById('displayRoomCode').textContent = currentRoom;
            
            await setupRoom();
            showScreen('lobbyScreen');
            listenToRoom();
        }

        async function joinRoom() {
            playerName = document.getElementById('playerName').value.trim();
            currentRoom = document.getElementById('roomCode').value.trim().toUpperCase();
            
            if (!playerName) { showMessage('Adƒ±nƒ±zƒ± daxil edin!', 'error'); return; }
            if (!currentRoom) { showMessage('Otaq kodunu daxil edin!', 'error'); return; }

            const roomSnapshot = await new Promise(resolve => {
                const ref = window.firebaseRef(db, 'rooms/' + currentRoom);
                window.firebaseOnValue(ref, (snap) => { resolve(snap); }, { onlyOnce: true });
            });

            if (!roomSnapshot.exists()) { showMessage('Otaq tapƒ±lmadƒ±!', 'error'); return; }
            
            const roomData = roomSnapshot.val();
            if (roomData.player2) { showMessage('Otaq doludur!', 'error'); return; }

            isHost = false;
            playerId = 'player2';
            
            document.getElementById('roomCodeDisplay').textContent = currentRoom;
            document.getElementById('displayRoomCode').textContent = currentRoom;
            
            await window.firebaseUpdate(window.firebaseRef(db, 'rooms/' + currentRoom), {
                player2: { name: playerName, score: 0, ready: false, selectedCount: 0, joinedAt: window.serverTimestamp() },
                status: 'waiting'
            });

            showScreen('lobbyScreen');
            listenToRoom();
        }

        async function setupRoom() {
            const roomData = {
                player1: { name: playerName, score: 0, ready: false, selectedCount: 0, joinedAt: window.serverTimestamp() },
                status: 'waiting', currentQuestion: 0, gameStarted: false,
                settings: { totalQuestions: 0 }
            };
            
            await window.firebaseSet(window.firebaseRef(db, 'rooms/' + currentRoom), roomData);
            const playerRef = window.firebaseRef(db, 'rooms/' + currentRoom + '/player1');
            window.onDisconnect(playerRef).remove();
        }

        function copyRoomCode() {
            navigator.clipboard.writeText(currentRoom).then(() => showMessage('Kod kopyalandƒ±!', 'success'));
        }

        function listenToRoom() {
            roomRef = window.firebaseRef(db, 'rooms/' + currentRoom);
            unsubscribe = window.firebaseOnValue(roomRef, (snapshot) => {
                if (!snapshot.exists()) { showMessage('Otaq baƒülandƒ±!', 'error'); setTimeout(() => location.reload(), 2000); return; }
                
                gameState = snapshot.val();
                updateLobby();
                if (gameState.status === 'playing') handleGameState();
                else if (gameState.status === 'finished') showResults();
            });
        }

        function updateLobby() {
            const p1 = gameState.player1, p2 = gameState.player2;
            let html = '';
            
            if (p1) html += `<div class="player-score" style="color: ${p1.ready ? '#2ecc71' : '#fff'}"><h4>${p1.name} ${p1.ready ? '‚úì' : ''}</h4><div style="font-size: 0.8em;">${p1.selectedCount > 0 ? p1.selectedCount + ' tapmaca' : 'G√∂zl…ônilir...'}</div></div>`;
            
            if (p2) {
                html += `<div class="player-score" style="color: ${p2.ready ? '#2ecc71' : '#fff'}"><h4>${p2.name} ${p2.ready ? '‚úì' : ''}</h4><div style="font-size: 0.8em;">${p2.selectedCount > 0 ? p2.selectedCount + ' tapmaca' : 'G√∂zl…ônilir...'}</div></div>`;
                document.getElementById('waitingMessage').classList.add('hidden');
                document.getElementById('gameSettings').classList.remove('hidden');
                
                if (p1.selectedCount > 0 && p2.selectedCount > 0) {
                    if (p1.selectedCount === p2.selectedCount && !gameState.gameStarted) startGame(p1.selectedCount);
                    else if (p1.selectedCount !== p2.selectedCount) {
                        document.getElementById('selectionStatus').textContent = 'Eyni sayda tapmaca se√ßm…ôlisiniz!';
                        document.getElementById('selectionStatus').style.color = '#e74c3c';
                    }
                }
            } else {
                document.getElementById('waitingMessage').classList.remove('hidden');
                document.getElementById('gameSettings').classList.add('hidden');
            }
            document.getElementById('playerList').innerHTML = html;
        }

        function selectQuestionCount(count) {
            selectedCount = count;
            document.querySelectorAll('.selection-card').forEach((card, index) => {
                card.classList.remove('selected');
                if ([20, 40, 60][index] === count) card.classList.add('selected');
            });
            
            const update = {};
            update[playerId + '/selectedCount'] = count;
            update[playerId + '/ready'] = true;
            window.firebaseUpdate(roomRef, update);
            
            document.getElementById('selectionStatus').textContent = count + ' tapmaca se√ßildi. R…ôqibin se√ßimi g√∂zl…ônilir...';
            document.getElementById('selectionStatus').style.color = '#f1c40f';
        }

        async function startGame(totalQuestions) {
            const shuffled = [...questions].sort(() => 0.5 - Math.random());
            const gameQuestions = shuffled.slice(0, totalQuestions);
            
            await window.firebaseUpdate(roomRef, {
                status: 'playing', gameStarted: true,
                settings: { totalQuestions: totalQuestions, questions: gameQuestions, startTime: window.serverTimestamp() },
                currentQuestion: 0, answers: {}, questionStartTime: window.serverTimestamp()
            });
            showScreen('gameScreen');
        }

        function handleGameState() {
            if (!gameState.settings || !gameState.settings.questions) return;
            const qIndex = gameState.currentQuestion || 0;
            const total = gameState.settings.totalQuestions;
            
            if (qIndex >= total) { endGame(); return; }
            
            document.getElementById('score1').textContent = gameState.player1?.score || 0;
            document.getElementById('score2').textContent = gameState.player2?.score || 0;
            document.getElementById('player1Name').textContent = gameState.player1?.name || 'Oyun√ßu 1';
            document.getElementById('player2Name').textContent = gameState.player2?.name || 'Oyun√ßu 2';
            
            const currentQ = gameState.settings.questions[qIndex];
            if (currentQ && (!currentQuestion || currentQuestion.q !== currentQ.q)) {
                currentQuestion = currentQ;
                loadQuestion(currentQ);
            }
            checkRoundResults();
        }

        function loadQuestion(q) {
            hasAnswered = false;
            document.getElementById('questionText').textContent = `Sual ${(gameState.currentQuestion || 0) + 1}/${gameState.settings.totalQuestions}: ${q.q}`;
            const optionsDiv = document.getElementById('optionsContainer');
            optionsDiv.innerHTML = '';
            
            q.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-option';
                btn.textContent = ['A', 'B', 'C'][index] + ') ' + opt;
                btn.onclick = () => submitAnswer(index);
                optionsDiv.appendChild(btn);
            });
            document.getElementById('answerFeedback').textContent = '';
            startTimer();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            let timeLeft = 20;
            const timerBar = document.getElementById('timerBar');
            const timerText = document.getElementById('timeLeft');
            
            timerBar.style.width = '100%';
            timerInterval = setInterval(() => {
                timeLeft--;
                timerText.textContent = timeLeft;
                timerBar.style.width = (timeLeft / 20) * 100 + '%';
                if (timeLeft <= 5) timerBar.style.background = '#e74c3c';
                if (timeLeft <= 0) { clearInterval(timerInterval); if (!hasAnswered) submitAnswer(-1); }
            }, 1000);
        }

        async function submitAnswer(answerIndex) {
            if (hasAnswered) return;
            hasAnswered = true;
            if (timerInterval) clearInterval(timerInterval);
            
            document.querySelectorAll('.btn-option').forEach((btn, idx) => {
                btn.classList.add('disabled');
                if (idx === currentQuestion.correct) btn.classList.add('correct');
                else if (idx === answerIndex && answerIndex !== currentQuestion.correct) btn.classList.add('wrong');
            });
            
            const answerData = { answer: answerIndex, timestamp: window.serverTimestamp(), correct: answerIndex === currentQuestion.correct };
            const update = {}; update['answers/' + playerId] = answerData;
            await window.firebaseUpdate(roomRef, update);
            
            const feedback = document.getElementById('answerFeedback');
            if (answerIndex === -1) { feedback.textContent = 'Vaxt bitdi!'; feedback.style.color = '#e74c3c'; }
            else if (answerIndex === currentQuestion.correct) { feedback.textContent = 'D√ºzg√ºn cavab!'; feedback.style.color = '#2ecc71'; }
            else { feedback.textContent = 'S…ôhv cavab!'; feedback.style.color = '#e74c3c'; }
        }

        async function checkRoundResults() {
            if (!gameState.answers) return;
            const p1Answer = gameState.answers.player1;
            const p2Answer = gameState.answers.player2;
            
            if (p1Answer && p2Answer && !gameState.processingRound) {
                await window.firebaseUpdate(roomRef, { processingRound: true });
                const p1Correct = p1Answer.correct, p2Correct = p2Answer.correct;
                let p1Add = 0, p2Add = 0, roundMessage = '', resetGame = false;
                
                if (p1Correct && p2Correct) { p1Add = 5; p2Add = 5; roundMessage = 'H…ôr ikiniz d√ºz bildiniz! H…ôr ikiniz…ô 5 xal!'; }
                else if (p1Correct && !p2Correct) { p1Add = 10; roundMessage = `${gameState.player1.name} d√ºz tapdƒ±! +10 xal`; }
                else if (!p1Correct && p2Correct) { p2Add = 10; roundMessage = `${gameState.player2.name} d√ºz tapdƒ±! +10 xal`; }
                else { resetGame = true; roundMessage = 'H…ôr ikiniz s…ôhv tapdƒ±ƒüƒ±nƒ±z √º√ß√ºn oyun sƒ±fƒ±rlandƒ±!'; }
                
                const feedback = document.getElementById('answerFeedback');
                feedback.textContent = roundMessage;
                feedback.style.color = resetGame ? '#e74c3c' : '#f1c40f';
                
                if (resetGame) {
                    setTimeout(async () => {
                        await window.firebaseUpdate(roomRef, { status: 'finished', resetReason: 'both_wrong', winner: 'none' });
                    }, 2000);
                    return;
                }
                
                setTimeout(async () => {
                    const currentQ = (gameState.currentQuestion || 0) + 1;
                    const newP1Score = (gameState.player1.score || 0) + p1Add;
                    const newP2Score = (gameState.player2.score || 0) + p2Add;
                    await window.firebaseUpdate(roomRef, {
                        currentQuestion: currentQ, 'player1/score': newP1Score, 'player2/score': newP2Score,
                        answers: {}, processingRound: false, questionStartTime: window.serverTimestamp()
                    });
                }, 2000);
            }
        }

        function endGame() {
            const p1Score = gameState.player1?.score || 0, p2Score = gameState.player2?.score || 0;
            let winner = p1Score > p2Score ? gameState.player1?.name : p2Score > p1Score ? gameState.player2?.name : 'B…ôrab…ôr…ô';
            window.firebaseUpdate(roomRef, { status: 'finished', winner: winner });
        }

        function showResults() {
            showScreen('resultScreen');
            const p1Score = gameState.player1?.score || 0, p2Score = gameState.player2?.score || 0;
            document.getElementById('finalScore1').textContent = p1Score;
            document.getElementById('finalScore2').textContent = p2Score;
            
            const winnerText = document.getElementById('winnerText');
            const reasonDiv = document.getElementById('gameOverReason');
            
            if (gameState.resetReason === 'both_wrong') {
                winnerText.textContent = 'Oyun Sƒ±fƒ±rlandƒ±!'; winnerText.style.color = '#e74c3c';
                reasonDiv.textContent = 'H…ôr ikiniz eyni anda s…ôhv cavab verdiyiniz √º√ß√ºn oyun ba≈üa √ßatdƒ±.';
                document.querySelector('.winner-crown').textContent = 'üíî';
            } else {
                if (gameState.winner === 'B…ôrab…ôr…ô') {
                    winnerText.textContent = 'B…ôrab…ôr…ô!'; winnerText.style.color = '#f1c40f';
                    document.querySelector('.winner-crown').textContent = 'ü§ù';
                    reasonDiv.textContent = 'H…ôr ikiniz eyni xal topladƒ±nƒ±z!';
                } else {
                    const isWinner = (gameState.winner === playerName);
                    winnerText.textContent = isWinner ? 'Siz Qalib G…ôldiniz!' : gameState.winner + ' Qalib G…ôldi!';
                    winnerText.style.color = isWinner ? '#2ecc71' : '#e74c3c';
                    document.querySelector('.winner-crown').textContent = isWinner ? 'üëë' : 'ü•à';
                    reasonDiv.textContent = isWinner ? 'T…ôbrikl…ôr! R…ôqibinizi m…ôƒülub etdiniz.' : 'N√∂vb…ôti d…ôf…ô daha yax≈üƒ± ≈üans!';
                }
            }
        }

        function resetGame() {
            if (unsubscribe) unsubscribe();
            location.reload();
        }

        window.addEventListener('beforeunload', async () => {
            if (currentRoom && playerId) {
                const playerRef = window.firebaseRef(db, 'rooms/' + currentRoom + '/' + playerId);
                await window.firebaseRemove(playerRef);
            }
        });
    </script>
</body>
</html>
