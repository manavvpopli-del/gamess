<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KinoZal • Stabil Versiya</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --primary-color: #dc2626;
            --primary-dark: #991b1b;
            --primary-light: #fca5a5;
            --bg-color: #0a0000;
            --glass-bg: rgba(20, 0, 0, 0.92);
            --border-color: rgba(220, 38, 38, 0.28);
            --shadow-color: rgba(220, 38, 38, 0.14);
        }
        
        body { 
            background: var(--bg-color); 
            color: white; 
            overflow: hidden; 
            touch-action: manipulation;
            -webkit-touch-callout: none;
            user-select: none;
            margin: 0;
            padding: 0;
            height: 100vh;
        }
        
        body.cinema-mode { background: #000 !important; }
        body.cinema-mode header, body.cinema-mode .chat-container, body.cinema-mode #hostControls { opacity: 0; pointer-events: none; }
        
        .glass { 
            background: var(--glass-bg); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px); 
            border: 1px solid var(--border-color); 
            box-shadow: 0 8px 32px var(--shadow-color); 
        }
        
        .cinema-toggle, .cinema-exit { z-index: 100; }
        .screen-message-overlay { z-index: 9999; }
        
        .chat-textarea { 
            background: transparent; 
            border: none; 
            outline: none; 
            resize: none; 
            color: white; 
            font-size: 15px; 
            padding: 10px 14px; 
            max-height: 90px; 
            min-height: 38px; 
            line-height: 1.4; 
        }
        
        .chat-textarea:focus { outline: none; }
        
        .msg-bubble { 
            padding: 8px 14px; 
            border-radius: 18px; 
            font-size: 13.5px; 
            line-height: 1.38; 
            word-break: break-word; 
            hyphens: auto; 
        }
        
        .msg-own { 
            margin-left: auto; 
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); 
            border-bottom-right-radius: 4px; 
        }
        
        .msg-other { 
            margin-right: auto; 
            background: rgba(255,255,255,0.06); 
            border: 1px solid var(--border-color); 
            border-bottom-left-radius: 4px; 
        }
        
        .typing-dots span { animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%,80%,100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .screen-message-content { 
            font-size: clamp(2.5rem, 12vw, 5.5rem); 
            font-weight: 900; 
            text-align: center; 
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #ef4444, #ec4899); 
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent; 
            animation: gradientShift 4s ease infinite; 
        }
        
        @keyframes gradientShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        
        .shake { animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%,90% { transform: translate3d(-1px,0,0) } 20%,80% { transform: translate3d(2px,0,0) } 30%,50%,70% { transform: translate3d(-3px,0,0) } 40%,60% { transform: translate3d(3px,0,0) } }
        
        .pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.06); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="theme-red">

    <!-- Ekran mesajı overlay -->
    <div id="screenMessageOverlay" class="screen-message-overlay fixed inset-0 bg-black/95 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-400">
        <div class="text-center px-6 max-w-[90%]">
            <div id="screenMessageText" class="screen-message-content"></div>
            <div id="screenMessageSender" class="mt-6 text-lg opacity-70 tracking-wide"></div>
        </div>
    </div>

    <!-- Qurucu giriş animasiyası (yalnız bir dəfə) -->
    <div id="creatorSplash" class="fixed inset-0 bg-black/95 flex flex-col items-center justify-center z-[10000] opacity-0 pointer-events-none transition-opacity duration-600">
        <div class="text-6xl md:text-8xl font-black tracking-widest bg-gradient-to-r from-amber-400 via-amber-500 to-orange-600 bg-clip-text text-transparent animate-pulse">
            QURUCU
        </div>
        <div class="mt-4 text-xl md:text-2xl text-amber-300/80">Xüsusi səlahiyyətlər aktivləşdirildi</div>
    </div>

    <!-- Əsas məzmun -->
    <div id="landing" class="flex flex-col h-screen items-center justify-center p-5 bg-gradient-to-b from-black via-red-950/30 to-black">
        <!-- ... əvvəlki landing səhifəsi kodunu buraya qoy (avatar, ad, otaq yarat/qoşul, creator girişi) ... -->
        <!-- Mən tam kodu qısaltmaq üçün buranı atladım, amma struktur eynidir -->
    </div>

    <div id="room" class="hidden flex flex-col h-screen">
        <header class="glass h-14 flex items-center justify-between px-4 border-b border-[var(--border-color)] shrink-0">
            <!-- header məzmunu (otaq kodu, tema seç, çıxış düyməsi və s.) -->
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Video bölməsi -->
            <div id="videoSection" class="relative flex-1 bg-black">
                <div id="player"></div>
                <div id="playerLoader" class="absolute inset-0 flex items-center justify-center">
                    <div class="w-10 h-10 border-4 border-t-[var(--primary-color)] border-gray-600 rounded-full animate-spin"></div>
                </div>
            </div>

            <!-- Chat bölməsi -->
            <div class="chat-container w-full lg:w-96 border-l border-[var(--border-color)] flex flex-col bg-[var(--bg-color)]">
                <!-- Users bar, messages, input -->
            </div>
        </div>
    </div>

    <script>
        // ────────────────────────────────────────────────
        //  CONFIG
        // ────────────────────────────────────────────────
        const firebaseConfig = {
            // sənin config-in
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const YOUTUBE_API_KEY = "AIzaSyBterRsxZoTvVbxlsOzESKWBDAY2B8BWc4";

        // ────────────────────────────────────────────────
        //  GLOBAL DƏYİŞƏNLƏR
        // ────────────────────────────────────────────────
        let userId        = localStorage.getItem('syncUserId') || 'u_' + Math.random().toString(36).slice(2,10);
        let currentRoom   = null;
        let isHost        = false;
        let isCreator     = false;
        let player        = null;
        let playerReady   = false;
        let userName      = '';
        let userAvatar    = localStorage.getItem('userAvatar') || '';
        let lastVideoSync = { time: 0, state: -1, ts: 0 };
        let typingTimer   = null;
        let sendLock      = false;

        // ────────────────────────────────────────────────
        //  SERVER TIME OFFSET
        // ────────────────────────────────────────────────
        let serverOffset = 0;
        db.ref(".info/serverTimeOffset").on("value", snap => {
            serverOffset = snap.val() || 0;
        });
        const serverTime = () => Date.now() + serverOffset;

        // ────────────────────────────────────────────────
        //  VIDEO SYNC – ƏN KRİTİK HISSƏ (yenilənmiş)
        // ────────────────────────────────────────────────
        function initPlayer() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: 'dQw4w9WgXcQ', // placeholder
                playerVars: {
                    autoplay: 0,
                    controls: isHost || isCreator ? 1 : 0,
                    disablekb: isHost || isCreator ? 0 : 1,
                    rel: 0,
                    playsinline: 1,
                    enablejsapi: 1
                },
                events: {
                    onReady: () => {
                        playerReady = true;
                        document.getElementById('playerLoader')?.remove();
                        loadInitialVideo();
                        if (isHost || isCreator) startHostHeartbeat();
                    },
                    onStateChange: onPlayerStateChange
                }
            });
        }

        function loadInitialVideo() {
            db.ref(`rooms/${currentRoom}/currentVideo`).once('value').then(snap => {
                const v = snap.val();
                if (v?.id) {
                    player.loadVideoById({ videoId: v.id, startSeconds: v.time || 0 });
                    if (!v.isPlaying) setTimeout(() => player.pauseVideo(), 800);
                }
            });
        }

        function startHostHeartbeat() {
            setInterval(() => {
                if (!playerReady || !currentRoom) return;
                const state = player.getPlayerState();
                if (state !== YT.PlayerState.PLAYING) return;

                const now = Date.now();
                if (now - lastVideoSync.ts < 4500) return; // ~4.5 saniyə

                const t = player.getCurrentTime();
                if (Math.abs(t - lastVideoSync.time) < 0.7) return;

                db.ref(`rooms/${currentRoom}/currentVideo`).update({
                    time: t,
                    isPlaying: true,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedBy: userId
                });

                lastVideoSync = { time: t, ts: now };
            }, 4500);
        }

        function setupVideoSyncForViewers() {
            db.ref(`rooms/${currentRoom}/currentVideo`).on('value', snap => {
                if (isHost || isCreator || !playerReady) return;
                const v = snap.val();
                if (!v?.id) return;

                if (v.id !== player.getVideoData()?.video_id) {
                    player.loadVideoById({ videoId: v.id, startSeconds: v.time || 0 });
                    return;
                }

                const localTime = player.getCurrentTime() || 0;
                const diff = Math.abs(localTime - v.time);

                // 2 saniyədən artıq fərq → seek
                if (diff > 2) {
                    player.seekTo(v.time, true);
                }

                // Play/pause
                const shouldPlay = v.isPlaying;
                const isPlayingNow = player.getPlayerState() === 1;

                if (shouldPlay && !isPlayingNow && player.getPlayerState() !== 3) {
                    setTimeout(() => player.playVideo(), 300);
                } else if (!shouldPlay && isPlayingNow) {
                    player.pauseVideo();
                }
            });
        }

        function onPlayerStateChange(e) {
            if (!isHost && !isCreator) return;

            const state = e.data;
            const t = player.getCurrentTime();

            // Yalnız əhəmiyyətli dəyişikliklərdə göndər
            if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.PAUSED || state === YT.PlayerState.ENDED) {
                db.ref(`rooms/${currentRoom}/currentVideo`).update({
                    time: t,
                    isPlaying: state === YT.PlayerState.PLAYING,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedBy: userId
                });
            }
        }

        // ────────────────────────────────────────────────
        //  MESAJ / TYPING / DIGƏR FUNKSIYALAR
        // ────────────────────────────────────────────────
        // (burada əvvəlki funksiyaları saxla, sadəcə double-send qarşısını al)

        function sendMessage() {
            if (sendLock) return;
            sendLock = true;

            // ... mesaj göndərmə kodu ...

            setTimeout(() => { sendLock = false; }, 600); // anti-spam
        }

        // ────────────────────────────────────────────────
        //  INIT
        // ────────────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', () => {
            localStorage.setItem('syncUserId', userId);
            if (userAvatar) {
                // avatar preview yenilə
            }
        });

    </script>
</body>
</html>