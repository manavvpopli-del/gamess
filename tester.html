<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KinoZal - Pro Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Sizin mövcud CSS stilləriniz bura daxildir (Dəyişilməyib) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --primary-color: #dc2626; --bg-color: #0a0000; --glass-bg: rgba(20, 0, 0, 0.95); --border-color: rgba(220, 38, 38, 0.3); }
        body { background: var(--bg-color); color: white; overflow: hidden; margin: 0; padding-bottom: env(safe-area-inset-bottom); }
        /* ... (Digər CSS-lər eynidir) ... */
        .msg-bubble { max-width: 85%; word-wrap: break-word; }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: var(--primary-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col theme-red">

    <div id="screenMessageOverlay" class="screen-message-overlay" onclick="closeScreenMessage()">
        <div class="screen-message-content" id="screenMessageText">MESAJ</div>
        <div class="screen-message-sender" id="screenMessageSender">Göndərən: BOSS</div>
    </div>

    <script>
        // --- KONFİQURASİYA ---
        const firebaseConfig = {
            apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PfyJRdk", // QEYD: Real layihədə gizlədilməlidir
            databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
            projectId: "sevgili-testi"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let userId = localStorage.getItem('syncUserId') || 'u_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('syncUserId', userId);

        let state = {
            currentRoom: null,
            isHost: false,
            isCreator: false,
            player: null,
            playerReady: false,
            isLocalChange: false, // Döngənin qarşısını almaq üçün
            userAvatar: localStorage.getItem('userAvatar') || '',
            userName: '',
            currentVideoId: null,
            lastServerUpdate: 0
        };

        // --- YOUTUBE API ---
        function onYouTubeIframeAPIReady() {
            state.player = new YT.Player('player', {
                height: '100%', width: '100%',
                videoId: 'jfKfPfyJRdk',
                playerVars: { 
                    autoplay: 0, controls: 0, disablekb: 1, 
                    rel: 0, playsinline: 1, enablejsapi: 1 
                },
                events: { 
                    onReady: onPlayerReady, 
                    onStateChange: onPlayerStateChange 
                }
            });
        }

        function onPlayerReady() {
            state.playerReady = true;
            document.getElementById('playerLoader').style.display = 'none';
            if (state.currentRoom) syncVideoFromFirebase();
        }

        function onPlayerStateChange(event) {
            if (!state.playerReady || state.isLocalChange || (!state.isHost && !state.isCreator)) return;

            const videoRef = db.ref(`rooms/${state.currentRoom}/currentVideo`);
            const currentTime = state.player.getCurrentTime();
            const isPlaying = (event.data === YT.PlayerState.PLAYING);

            videoRef.update({
                time: currentTime,
                isPlaying: isPlaying,
                updatedBy: userId,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }

        // --- SİNXRONİZASİYA MƏNTİQİ ---
        function syncVideoFromFirebase() {
            const videoRef = db.ref(`rooms/${state.currentRoom}/currentVideo`);
            
            videoRef.on('value', (snap) => {
                const data = snap.val();
                if (!data || data.updatedBy === userId || !state.playerReady) return;

                state.isLocalChange = true; // Firebase-dən gələn dəyişiklikdir, event trigger etmə

                // Video fərqlidirsə dəyiş
                if (data.id !== state.currentVideoId) {
                    state.currentVideoId = data.id;
                    state.player.loadVideoById(data.id, data.time);
                }

                // Zaman sinxronizasiyası (2 saniyə fərq varsa)
                const localTime = state.player.getCurrentTime();
                if (Math.abs(localTime - data.time) > 2) {
                    state.player.seekTo(data.time, true);
                }

                // Oynatma/Dayandırma
                if (data.isPlaying && state.player.getPlayerState() !== YT.PlayerState.PLAYING) {
                    state.player.playVideo();
                } else if (!data.isPlaying && state.player.getPlayerState() === YT.PlayerState.PLAYING) {
                    state.player.pauseVideo();
                }

                setTimeout(() => { state.isLocalChange = false; }, 500);
            });
        }

        // --- OTAQ İDARƏETMƏSİ ---
        async function createRoom() {
            const nameInput = document.getElementById('hostName');
            if (!nameInput.value.trim()) return showNotification("Xəta", "Adınızı daxil edin");

            state.userName = nameInput.value.trim();
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            await db.ref(`rooms/${roomId}`).set({
                hostId: userId,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                currentVideo: { id: 'jfKfPfyJRdk', time: 0, isPlaying: false, updatedBy: userId }
            });

            joinProcess(roomId, true);
        }

        function joinProcess(roomId, isHost) {
            state.currentRoom = roomId;
            state.isHost = isHost;
            
            // İstifadəçini otağa əlavə et
            db.ref(`rooms/${roomId}/users/${userId}`).set({
                name: state.userName,
                avatar: state.userAvatar,
                isHost: isHost,
                status: 'active'
            });

            // Otaqdan çıxanda təmizlə
            db.ref(`rooms/${roomId}/users/${userId}`).onDisconnect().remove();

            document.getElementById('landing').classList.add('hidden');
            document.getElementById('room').classList.remove('hidden');
            document.getElementById('roomCode').textContent = roomId;
            
            if (isHost) {
                document.getElementById('hostControls').classList.remove('hidden');
                document.getElementById('changeVideoBtn').classList.remove('hidden');
            }

            setupChatListeners();
            if (state.playerReady) syncVideoFromFirebase();
        }

        // --- ÇAT VƏ BİLDİRİŞLƏR ---
        function setupChatListeners() {
            const msgRef = db.ref(`rooms/${state.currentRoom}/messages`).limitToLast(50);
            
            msgRef.on('child_added', (snap) => {
                const msg = snap.val();
                displayMessage(snap.key, msg);
            });
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !state.currentRoom) return;

            db.ref(`rooms/${state.currentRoom}/messages`).push({
                userId: userId,
                name: state.userName,
                text: text,
                avatar: state.userAvatar,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            input.value = '';
            input.style.height = 'auto';
        }

        // Köməkçi Funksiyalar (Notification, UI Helper)
        function showNotification(title, text) {
            const toast = document.getElementById('notificationToast');
            document.getElementById('notifTitle').textContent = title;
            document.getElementById('notifText').textContent = text;
            toast.style.transform = 'translateX(0)';
            setTimeout(() => { toast.style.transform = 'translateX(150%)'; }, 3000);
        }

        // UI Event Listeners
        document.getElementById('messageInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

    </script>
</body>
</html>
