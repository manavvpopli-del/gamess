<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KinoZal - Test Versiyasƒ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --primary-color: #dc2626;
            --primary-dark: #991b1b;
            --primary-light: #fca5a5;
            --bg-color: #0a0000;
            --glass-bg: rgba(20, 0, 0, 0.95);
            --border-color: rgba(220, 38, 38, 0.3);
            --shadow-color: rgba(220, 38, 38, 0.15);
        }
        
        body.theme-red { --primary-color: #dc2626; --primary-dark: #991b1b; --primary-light: #fca5a5; --bg-color: #0a0000; --glass-bg: rgba(20, 0, 0, 0.95); --border-color: rgba(220, 38, 38, 0.3); --shadow-color: rgba(220, 38, 38, 0.15); }
        body.theme-pink { --primary-color: #ec4899; --primary-dark: #be185d; --primary-light: #fbcfe8; --bg-color: #0f0006; --glass-bg: rgba(30, 0, 15, 0.95); --border-color: rgba(236, 72, 153, 0.3); --shadow-color: rgba(236, 72, 153, 0.15); }
        body.theme-green { --primary-color: #22c55e; --primary-dark: #15803d; --primary-light: #86efac; --bg-color: #000a03; --glass-bg: rgba(0, 20, 5, 0.95); --border-color: rgba(34, 197, 94, 0.3); --shadow-color: rgba(34, 197, 94, 0.15); }
        body.theme-blue { --primary-color: #3b82f6; --primary-dark: #1d4ed8; --primary-light: #93c5fd; --bg-color: #000510; --glass-bg: rgba(0, 10, 30, 0.95); --border-color: rgba(59, 130, 246, 0.3); --shadow-color: rgba(59, 130, 246, 0.15); }
        body.theme-black { --primary-color: #525252; --primary-dark: #171717; --primary-light: #a3a3a3; --bg-color: #000000; --glass-bg: rgba(10, 10, 10, 0.95); --border-color: rgba(82, 82, 82, 0.3); --shadow-color: rgba(0, 0, 0, 0.3); }
        body.theme-gray { --primary-color: #6b7280; --primary-dark: #374151; --primary-light: #d1d5db; --bg-color: #0a0a0a; --glass-bg: rgba(20, 20, 20, 0.95); --border-color: rgba(107, 114, 128, 0.3); --shadow-color: rgba(107, 114, 128, 0.15); }
        body.theme-gold { --primary-color: #f59e0b; --primary-dark: #b45309; --primary-light: #fbbf24; --bg-color: #0f0800; --glass-bg: rgba(40, 25, 0, 0.95); --border-color: rgba(245, 158, 11, 0.3); --shadow-color: rgba(245, 158, 11, 0.15); }
        
        body { 
            background: var(--bg-color); 
            color: white; 
            overflow: hidden; 
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            transition: background 0.5s ease;
            margin: 0;
            padding: 0;
        }
        
        body.cinema-mode { background: #000 !important; }
        body.cinema-mode #room > header,
        body.cinema-mode .chat-container,
        body.cinema-mode #hostControls { opacity: 0; pointer-events: none; transform: translateY(-100%); }
        body.cinema-mode #videoSection { position: fixed; inset: 0; z-index: 50; height: 100vh !important; width: 100vw !important; }
        body.cinema-mode .cinema-exit { opacity: 1; pointer-events: all; transform: translateY(0); }
        
        .cinema-toggle { position: fixed; top: 20px; left: 20px; z-index: 100; background: var(--glass-bg); border: 2px solid var(--border-color); backdrop-filter: blur(10px); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; box-shadow: 0 0 20px var(--shadow-color); color: var(--primary-color); }
        .cinema-exit { position: fixed; top: 20px; right: 20px; z-index: 100; background: rgba(0,0,0,0.8); border: 2px solid var(--primary-color); backdrop-filter: blur(10px); padding: 12px 24px; border-radius: 30px; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: all 0.3s; color: white; font-weight: 600; opacity: 0; pointer-events: none; }
        .cinema-exit:hover { background: var(--primary-color); transform: scale(1.05); }
        
        .theme-picker { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 24px; padding: 24px; z-index: 200; display: none; box-shadow: 0 25px 50px -12px var(--shadow-color); min-width: 300px; opacity: 0; transition: all 0.3s ease; }
        .theme-picker.active { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; }
        .theme-option { aspect-ratio: 1; border-radius: 16px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; border: 3px solid transparent; transition: all 0.2s; position: relative; overflow: hidden; }
        .theme-option:hover { transform: scale(1.05); }
        .theme-option.active { border-color: white; box-shadow: 0 0 20px rgba(255,255,255,0.3); }
        .theme-option::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent); }
        .theme-label { font-size: 10px; font-weight: 600; text-transform: uppercase; z-index: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        .main-container { display: flex; flex-direction: column; height: calc(100vh - 56px); }
        @media (min-width: 1024px) { .main-container { flex-direction: row; } }
        
        #videoSection { height: 40vh; min-height: 40vh; max-height: 40vh; position: relative; background: black; }
        @media (min-width: 1024px) { #videoSection { height: 100%; min-height: 100%; max-height: 100%; flex: 1; } }
        
        .chat-container { height: calc(60vh - 56px); min-height: calc(60vh - 56px); max-height: calc(60vh - 56px); display: flex; flex-direction: column; background: var(--bg-color); border-left: 1px solid var(--border-color); }
        @media (min-width: 1024px) { .chat-container { width: 420px; height: 100%; min-height: 100%; max-height: 100%; flex-shrink: 0; } }
        
        .users-bar { background: var(--glass-bg); border-bottom: 1px solid var(--border-color); padding: 12px 16px; flex-shrink: 0; height: 70px; min-height: 70px; }
        
        .messages-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; padding: 16px; display: flex; flex-direction: column; gap: 2px; min-height: 0; }
        
        /* D√úZ∆èLƒ∞≈û: Input √ßox a≈üaƒüƒ±da idi, yuxarƒ± qaldƒ±rƒ±ldƒ± */
        .chat-input-area { 
            background: var(--glass-bg); 
            border-top: 1px solid var(--border-color); 
            padding: 12px 16px 20px 16px; /* Bottom padding artƒ±rƒ±ldƒ± */
            flex-shrink: 0; 
            min-height: 80px; /* Min height artƒ±rƒ±ldƒ± */
            position: relative;
            z-index: 10;
        }
        
        @media (max-width: 768px) {
            .chat-input-area {
                padding-bottom: max(20px, env(safe-area-inset-bottom)); /* Mobilde safe area n…ôz…ôr…ô alƒ±nsƒ±n amma √ßox olmasƒ±n */
            }
        }
        
        .input-container { background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); border-radius: 24px; display: flex; align-items: flex-end; padding: 4px; transition: all 0.3s; }
        .input-container:focus-within { border-color: var(--primary-color); background: rgba(255,255,255,0.08); box-shadow: 0 0 0 3px var(--shadow-color), 0 4px 12px rgba(0,0,0,0.3); }
        
        .chat-textarea { flex: 1; background: transparent; border: none; outline: none; color: white; font-size: 16px; padding: 10px 16px; resize: none; max-height: 80px; min-height: 40px; line-height: 1.4; width: 100%; -webkit-user-select: text; user-select: text; }
        .chat-textarea::placeholder { color: rgba(255,255,255,0.3); }
        .chat-textarea:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .send-btn { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; margin: 2px; transition: all 0.2s; box-shadow: 0 4px 12px var(--shadow-color); flex-shrink: 0; }
        .send-btn:hover { transform: scale(1.05); }
        .send-btn:active { transform: scale(0.95); }
        .send-btn:disabled { opacity: 0.5; pointer-events: none; }
        
        .reply-bar { background: var(--glass-bg); border-left: 3px solid var(--primary-color); padding: 8px 16px; margin: 0 16px 8px 16px; border-radius: 12px 12px 0 0; display: flex; align-items: center; justify-content: space-between; animation: slideUp 0.2s ease; border-top: 1px solid var(--border-color); flex-shrink: 0; }
        
        .glass-red { background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--border-color); box-shadow: 0 8px 32px var(--shadow-color); }
        
        .msg-wrapper { display: flex; width: 100%; margin-bottom: 4px; animation: msgAppear 0.2s ease-out; position: relative; }
        @keyframes msgAppear { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-bubble { max-width: 75%; padding: 8px 12px; border-radius: 16px; font-size: 13.5px; line-height: 1.35; position: relative; word-wrap: break-word; overflow-wrap: break-word; word-break: normal; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .msg-own { margin-left: auto; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border-bottom-right-radius: 4px; }
        .msg-other { margin-right: auto; background: rgba(255,255,255,0.05); color: var(--primary-light); border: 1px solid var(--border-color); border-bottom-left-radius: 4px; }
        .msg-reply { background: rgba(0,0,0,0.2); border-left: 2px solid var(--primary-light); padding: 4px 8px; margin-bottom: 4px; border-radius: 6px; font-size: 11px; }
        .msg-meta { font-size: 10px; margin-top: 2px; opacity: 0.85; display: flex; align-items: center; gap: 4px; justify-content: flex-end; }
        
        /* BOSS Badge stilƒ± */
        .msg-sender { 
            font-size: 11px; 
            font-weight: 600; 
            color: var(--primary-color); 
            margin-bottom: 2px; 
            margin-left: 44px; 
            display: flex; 
            align-items: center; 
            gap: 4px; 
        }
        .msg-sender.creator { 
            color: #f59e0b; 
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.3); 
            font-weight: 700;
        }
        .boss-icon-inline {
            width: 14px;
            height: 14px;
            object-fit: contain;
            filter: drop-shadow(0 0 4px rgba(245, 158, 11, 0.8));
            vertical-align: middle;
        }
        
        .msg-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); margin-right: 8px; align-self: flex-end; margin-bottom: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); cursor: pointer; }
        .msg-avatar.creator-avatar { border-color: #f59e0b; box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
        
        .reaction-bar { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
        .reaction-item { background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); border-radius: 12px; padding: 2px 6px; font-size: 11px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 2px; }
        .reaction-item:hover { background: var(--primary-color); transform: scale(1.1); }
        .reaction-item.user-reacted { background: var(--primary-color); border-color: var(--primary-light); color: white; }
        
        .typing-indicator { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(255,255,255,0.05); border-radius: 16px; font-size: 11px; color: var(--primary-color); margin-bottom: 8px; animation: fadeIn 0.3s ease; border: 1px solid var(--border-color); flex-shrink: 0; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .typing-dots { display: flex; gap: 2px; }
        .typing-dots span { width: 4px; height: 4px; background: var(--primary-color); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .messages-scroll::-webkit-scrollbar { width: 4px; }
        .messages-scroll::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }
        
        .user-chip { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s; white-space: nowrap; position: relative; }
        .user-chip:hover { background: rgba(255,255,255,0.1); transform: translateY(-1px); box-shadow: 0 4px 12px var(--shadow-color); border-color: var(--primary-color); }
        .user-chip.host { background: rgba(234, 179, 8, 0.1); border-color: rgba(234, 179, 8, 0.3); }
        .user-chip.creator { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(180, 83, 9, 0.2)); 
            border-color: #f59e0b; 
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
            animation: pulseBoss 2s infinite;
        }
        
        @keyframes pulseBoss {
            0%, 100% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
            50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.6); }
        }
        
        .user-chip img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }
        .boss-badge-mini { width: 16px; height: 16px; object-fit: contain; filter: drop-shadow(0 0 4px rgba(245, 158, 11, 0.8)); }
        
        .avatar-upload { width: 100px; height: 100px; border-radius: 50%; border: 3px dashed var(--primary-color); cursor: pointer; position: relative; overflow: hidden; background: rgba(255,255,255,0.02); transition: all 0.3s; }
        .avatar-upload:hover { border-color: var(--primary-light); background: rgba(255,255,255,0.05); transform: scale(1.05); }
        .avatar-preview { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: none; }
        .avatar-preview.show { display: block; }
        .avatar-placeholder { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--primary-color); pointer-events: none; }
        .avatar-placeholder.hidden { display: none; }
        
        .modal-overlay { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); }
        .modal-content-red { background: var(--glass-bg); border: 1px solid var(--border-color); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9), 0 0 40px var(--shadow-color); }
        .notification-red { background: var(--glass-bg); border: 1px solid var(--border-color); box-shadow: 0 10px 30px var(--shadow-color); }
        
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: var(--primary-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .toggle-switch { width: 50px; height: 26px; background: #374151; border-radius: 13px; position: relative; cursor: pointer; transition: background 0.3s; }
        .toggle-switch.active { background: var(--primary-color); }
        .toggle-switch::after { content: ''; position: absolute; width: 22px; height: 22px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: transform 0.3s; }
        .toggle-switch.active::after { transform: translateX(24px); }
        
        .danger-btn { background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444; padding: 12px; border-radius: 12px; width: 100%; font-weight: 600; transition: all 0.2s; margin-top: 8px; cursor: pointer; }
        .danger-btn:hover { background: rgba(239, 68, 68, 0.25); }
        
        .theme-btn { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: transparent; border: 1px solid var(--border-color); border-radius: 20px; color: white; font-size: 12px; cursor: pointer; transition: all 0.3s; }
        .theme-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--primary-color); }
        .theme-btn i { color: var(--primary-color); }
        .color-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--primary-color); display: inline-block; }
        
        #searchResults { background: rgba(10, 10, 10, 0.98); max-height: 35vh; overflow-y: auto; }
        .hidden { display: none !important; }
        
        /* YENƒ∞: BOSS Giri≈ü Animasiyasƒ± (Hamƒ± g√∂r√ºr) */
        .boss-entry-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, rgba(245, 158, 11, 0.2), rgba(0,0,0,0.95));
            z-index: 99999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: bossEntryIn 0.5s ease;
        }
        .boss-entry-overlay.active { display: flex; }
        @keyframes bossEntryIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes bossEntryOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }
        .boss-entry-content {
            text-align: center;
            animation: bossPulse 2s ease-in-out infinite;
        }
        .boss-entry-icon {
            width: 150px;
            height: 150px;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 50px rgba(245, 158, 11, 0.8));
            animation: bossIconPulse 1s ease;
        }
        @keyframes bossIconPulse {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        .boss-entry-text {
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            text-shadow: 0 0 60px rgba(245, 158, 11, 0.5);
        }
        .boss-entry-subtext {
            font-size: 18px;
            color: rgba(251, 191, 36, 0.9);
            margin-top: 10px;
            font-weight: 600;
        }
        
        /* YENƒ∞: Ekran Mesajƒ± Overlay */
        .screen-message-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: screenMsgIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }
        .screen-message-overlay.active { display: flex; }
        @keyframes screenMsgIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
        .screen-message-text {
            font-size: clamp(40px, 10vw, 100px);
            font-weight: 900;
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 60px rgba(245, 158, 11, 0.5);
            max-width: 90%;
            word-break: break-word;
            line-height: 1.2;
        }
        .screen-message-text.shake { animation: shakeAnim 0.5s ease infinite; }
        .screen-message-text.pulse { animation: pulseAnim 1s ease infinite; }
        .screen-message-text.spin { animation: spinAnim 2s linear infinite; }
        
        @keyframes shakeAnim {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-20px) rotate(-5deg) scale(1.1); }
            75% { transform: translateX(20px) rotate(5deg) scale(1.1); }
        }
        @keyframes pulseAnim {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        @keyframes spinAnim {
            from { transform: rotate(0deg) scale(1); }
            to { transform: rotate(360deg) scale(1); }
        }
        .screen-message-sender {
            position: absolute;
            bottom: 40px;
            font-size: 20px;
            color: rgba(255,255,255,0.8);
            letter-spacing: 0.2em;
            text-transform: uppercase;
            font-weight: 700;
            background: rgba(245, 158, 11, 0.2);
            padding: 10px 30px;
            border-radius: 30px;
            border: 2px solid rgba(245, 158, 11, 0.5);
        }
        
        .sync-indicator { 
            position: absolute; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(0,0,0,0.8); 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-size: 12px; 
            color: var(--primary-color); 
            border: 1px solid var(--border-color); 
            z-index: 10; 
            display: none; 
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        .sync-indicator.active { display: flex; }
        
        /* Status indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            display: inline-block;
            margin-right: 4px;
        }
        .status-dot.away { background: #eab308; animation: blink 2s infinite; }
        .status-dot.offline { background: #ef4444; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    </style>
</head>
<body class="h-screen flex flex-col theme-red">

    <!-- YENƒ∞: BOSS Giri≈ü Animasiyasƒ± (Hamƒ± g√∂r√ºr) -->
    <div id="bossEntryOverlay" class="boss-entry-overlay">
        <div class="boss-entry-content">
            <img src="boss.png" class="boss-entry-icon" alt="BOSS" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div style="display:none; width:150px; height:150px; background:linear-gradient(135deg, #f59e0b, #d97706); border-radius:50%; align-items:center; justify-content:center; font-size:80px; margin-bottom:20px;">üëë</div>
            <div class="boss-entry-text">QURUCU DAXƒ∞L OLDU</div>
            <div class="boss-entry-subtext" id="bossEntryName">Qurucu otaƒüa qo≈üuldu</div>
        </div>
    </div>

    <!-- YENƒ∞: Ekran Mesajƒ± Overlay -->
    <div id="screenMessageOverlay" class="screen-message-overlay" onclick="closeScreenMessage()">
        <div class="screen-message-text" id="screenMessageText">MESAJ</div>
        <div class="screen-message-sender" id="screenMessageSender">QURUCU</div>
    </div>

    <!-- YENƒ∞: Animasiya G√∂nd…ôrm…ô Modalƒ± -->
    <div id="animationModal" class="fixed inset-0 modal-overlay hidden z-[60] flex items-center justify-center p-4" onclick="if(event.target === this) closeAnimationModal()">
        <div class="modal-content-red rounded-3xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold flex items-center gap-2 text-amber-500">
                    <i class="fas fa-bullhorn"></i>
                    Ekran Mesajƒ± G√∂nd…ôr
                </h3>
                <button onclick="closeAnimationModal()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-neutral-400 mb-2 block uppercase font-bold tracking-wider">H…ôd…ôf ƒ∞stifad…ô√ßi</label>
                    <select id="animationTarget" class="w-full bg-black/40 border border-neutral-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-amber-500 transition">
                        <option value="">üåê Hamƒ±sƒ±na g√∂nd…ôr</option>
                    </select>
                </div>
                
                <div>
                    <label class="text-xs text-neutral-400 mb-2 block uppercase font-bold tracking-wider">Mesaj</label>
                    <input type="text" id="animationText" placeholder="M…ôs…ôl…ôn: SALAM!" maxlength="20"
                        class="w-full bg-black/40 border border-neutral-700 rounded-xl px-4 py-3 text-white text-center font-black text-2xl uppercase focus:outline-none focus:border-amber-500 transition placeholder:text-neutral-600 tracking-widest">
                </div>
                
                <div>
                    <label class="text-xs text-neutral-400 mb-2 block uppercase font-bold tracking-wider">Effekt</label>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="setAnimType('shake')" class="anim-type-btn active p-3 rounded-xl bg-amber-600/20 border-2 border-amber-500 text-amber-400 font-bold transition hover:scale-105" data-type="shake">
                            <i class="fas fa-bolt text-2xl mb-1 block"></i>
                            Titr…ôm…ô
                        </button>
                        <button onclick="setAnimType('pulse')" class="anim-type-btn p-3 rounded-xl bg-neutral-800 border-2 border-neutral-700 text-neutral-400 font-bold transition hover:scale-105 hover:bg-neutral-700" data-type="pulse">
                            <i class="fas fa-heart text-2xl mb-1 block"></i>
                            Puls
                        </button>
                        <button onclick="setAnimType('spin')" class="anim-type-btn p-3 rounded-xl bg-neutral-800 border-2 border-neutral-700 text-neutral-400 font-bold transition hover:scale-105 hover:bg-neutral-700" data-type="spin">
                            <i class="fas fa-sync text-2xl mb-1 block"></i>
                            Fƒ±rlanma
                        </button>
                    </div>
                </div>
                
                <button onclick="sendScreenAnimation()" class="w-full py-4 mt-2 rounded-xl font-black text-lg bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white shadow-lg shadow-amber-900/50 transition transform active:scale-95 uppercase tracking-widest">
                    <i class="fas fa-paper-plane mr-2"></i>G√∂nd…ôr
                </button>
            </div>
        </div>
    </div>

    <input type="file" id="avatarInput" style="display: none;" accept="image/*">

    <!-- LANDING -->
    <div id="landing" class="flex-1 flex items-center justify-center p-4 overflow-auto">
        <div class="max-w-md w-full space-y-6 pb-8">
            <div class="text-center space-y-2">
                <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-rose-600 mb-2 tracking-tighter">üìΩÔ∏è KinoZal</h1>
                <p class="text-red-200/60 text-sm font-bold tracking-widest uppercase">Demo</p>
            </div>

            <div class="glass-red rounded-3xl p-8 space-y-6 shadow-2xl border border-red-900/50">
                <div class="flex flex-col items-center space-y-3">
                    <label class="text-xs font-bold uppercase tracking-widest" style="color: var(--primary-color)">Profil ≈û…ôkli</label>
                    <div class="avatar-upload" id="avatarUpload" onclick="triggerAvatarUpload()">
                        <div class="avatar-placeholder" id="avatarPlaceholder">
                            <i class="fas fa-camera text-2xl mb-1"></i>
                            <span class="text-xs">≈û…ôkil se√ß</span>
                        </div>
                        <img id="avatarPreview" class="avatar-preview" src="" alt="Avatar">
                    </div>
                    <p class="text-xs hidden text-red-400 font-bold" id="avatarError">
                        <i class="fas fa-exclamation-circle mr-1"></i>≈û…ôkil se√ßilm…ôlidir
                    </p>
                </div>

                <div class="space-y-3">
                    <input type="text" id="hostName" placeholder="Adƒ±nƒ±zƒ± daxil edin" 
                        class="w-full px-4 py-3 rounded-xl bg-black/40 border text-white focus:outline-none transition text-center font-medium placeholder:text-white/30 focus:border-red-500" 
                        style="border-color: var(--border-color); font-size: 16px;">
                    
                    <button onclick="createRoom()" class="w-full py-3.5 rounded-xl font-bold transition shadow-lg text-white hover:opacity-90 active:scale-95 uppercase tracking-wider" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); box-shadow: 0 10px 30px var(--shadow-color);">
                        <i class="fas fa-plus-circle mr-2"></i>Otaq Yarat
                    </button>
                </div>

                <div class="relative flex items-center py-2">
                    <div class="flex-grow border-t border-white/10"></div>
                    <span class="px-3 text-xs text-white/40 font-bold">VE YA</span>
                    <div class="flex-grow border-t border-white/10"></div>
                </div>

                <div class="space-y-3">
                    <input type="text" id="joinRoomId" placeholder="Otaq Kodu" 
                        class="w-full px-4 py-3 rounded-xl bg-black/40 border text-white uppercase text-center font-black tracking-[0.2em] focus:outline-none transition placeholder:text-white/30 focus:border-red-500" 
                        style="border-color: var(--border-color); font-size: 16px;">
                    <button onclick="joinRoom()" class="w-full py-3.5 bg-neutral-900 hover:bg-neutral-800 rounded-xl font-bold transition border text-white/90 active:scale-95 uppercase tracking-wider" style="border-color: var(--border-color)">
                        <i class="fas fa-sign-in-alt mr-2"></i>Qo≈üul
                    </button>
                </div>

                <div class="relative flex items-center py-2">
                    <div class="flex-grow border-t border-amber-600/30"></div>
                    <span class="px-3 text-xs text-amber-500 font-black tracking-[0.2em]">‚òÖ QURUCU Gƒ∞Rƒ∞≈ûƒ∞ ‚òÖ</span>
                    <div class="flex-grow border-t border-amber-600/30"></div>
                </div>

                <div class="space-y-3">
                    <input type="text" id="creatorRoomId" placeholder="Otaq Kodu" 
                        class="w-full px-4 py-3 rounded-xl bg-amber-950/30 border border-amber-600/50 text-white uppercase text-center font-black tracking-[0.2em] focus:outline-none transition placeholder:text-white/30 focus:border-amber-500 focus:bg-amber-950/50" 
                        style="font-size: 16px;">
                    <input type="password" id="creatorPassword" placeholder="Qurucu ≈ûifr…ôsi" 
                        class="w-full px-4 py-3 rounded-xl bg-amber-950/30 border border-amber-600/50 text-white text-center font-black tracking-widest focus:outline-none transition placeholder:text-white/30 focus:border-amber-500 focus:bg-amber-950/50" 
                        style="font-size: 16px;">
                    <button onclick="enterAsCreator()" class="w-full py-3.5 rounded-xl font-black transition shadow-lg text-white active:scale-95 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 border border-amber-500/50 uppercase tracking-wider" style="box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);">
                        <i class="fas fa-crown mr-2 text-amber-200"></i>QURUCU olaraq daxil ol
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- THEME PICKER -->
    <div id="themePicker" class="theme-picker">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">üé® Tema Se√ß</h3>
            <button onclick="closeThemePicker()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="theme-grid" id="themeGrid"></div>
    </div>

    <!-- USER MODAL (Permissions) -->
    <div id="userModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4" onclick="if(event.target === this) closeUserModal()">
        <div class="modal-content-red rounded-3xl p-6 w-full max-w-sm">
            <div class="flex items-center gap-4 mb-6">
                <img id="modalUserAvatar" src="" class="w-16 h-16 rounded-full object-cover border-2" style="border-color: var(--primary-color)">
                <div class="flex-1">
                    <h3 id="modalUserName" class="text-lg font-bold text-white"></h3>
                    <p class="text-xs opacity-60" id="modalUserStatus">ƒ∞zl…ôyici</p>
                </div>
                <button onclick="closeUserModal()" class="ml-auto p-2 text-neutral-400 hover:text-white hover:bg-neutral-800 rounded-full transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-3">
                <h4 class="text-xs font-bold uppercase tracking-wider mb-3 opacity-60">ƒ∞caz…ôl…ôr</h4>
                
                <!-- YENƒ∞: Ekran Mesajƒ± g√∂nd…ôrm…ô d√ºym…ôsi -->
                <button onclick="openAnimationModalFromUser()" class="w-full py-3 mb-3 rounded-xl bg-gradient-to-r from-amber-600/20 to-orange-600/20 border-2 border-amber-500/50 text-amber-400 hover:bg-amber-600/30 transition flex items-center justify-center gap-2 font-bold">
                    <i class="fas fa-bullhorn"></i>
                    <span>Ekran Mesajƒ± G√∂nd…ôr</span>
                </button>
                
                <div class="flex items-center justify-between p-3 rounded-xl bg-neutral-900/80 border border-white/10">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-comment text-neutral-400"></i>
                        <span class="text-sm font-medium">Yazƒ± Yazmaq</span>
                    </div>
                    <div class="toggle-switch active" id="permChat" onclick="togglePermission('chat')"></div>
                </div>
                
                <div class="flex items-center justify-between p-3 rounded-xl bg-neutral-900/80 border border-white/10">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-eye text-neutral-400"></i>
                        <span class="text-sm font-medium">Video ƒ∞zl…ôm…ô</span>
                    </div>
                    <div class="toggle-switch active" id="permVideo" onclick="togglePermission('video')"></div>
                </div>
                
                <div class="flex items-center justify-between p-3 rounded-xl bg-neutral-900/80 border border-white/10">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-film text-neutral-400"></i>
                        <span class="text-sm font-medium">Video Se√ßm…ô</span>
                    </div>
                    <div class="toggle-switch" id="permChangeVideo" onclick="togglePermission('changeVideo')"></div>
                </div>
            </div>
            
            <button onclick="kickUser()" class="danger-btn mt-4">
                <i class="fas fa-sign-out-alt mr-2"></i>Otaqdan At
            </button>
        </div>
    </div>

    <!-- ROOM INTERFACE -->
    <div id="room" class="hidden flex-1 flex-col relative">
        <button class="cinema-toggle" onclick="toggleCinemaMode()" title="Sinema Rejimi">
            <i class="fas fa-film text-xl"></i>
        </button>
        
        <button class="cinema-exit" onclick="toggleCinemaMode()">
            <i class="fas fa-compress"></i>
            <span>Sinema rejimind…ôn √ßƒ±x</span>
        </button>

        <header class="glass-red border-b flex items-center justify-between px-4 shrink-0 z-20 h-14">
            <div class="flex items-center space-x-3">
                <h1 class="text-lg font-black text-white tracking-tight">KINO<span style="color: var(--primary-color)">ZAL</span></h1>
                <div class="flex items-center gap-2 px-3 py-1 rounded-xl bg-black/40 border border-white/10">
                    <span class="text-[10px] uppercase font-bold opacity-60">Kod:</span>
                    <span id="roomCode" class="font-mono font-black text-sm tracking-widest text-white">---</span>
                    <button onclick="copyCode()" class="p-1.5 text-neutral-400 hover:text-white transition">
                        <i class="fas fa-copy text-xs"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex items-center space-x-2">
                <button onclick="openThemePicker()" class="theme-btn">
                    <div class="color-dot"></div>
                    <span class="hidden sm:inline">Tema</span>
                </button>
                <span id="userType" class="px-3 py-1 rounded-full text-xs font-bold bg-neutral-900 border border-white/10">ƒ∞zl…ôyici</span>
                <button onclick="leaveRoom()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 transition text-red-500">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
        </header>

        <div class="main-container overflow-hidden">
            <div id="videoSection">
                <button id="changeVideoBtn" onclick="toggleSearch()" class="hidden absolute top-4 right-4 z-40 glass-red px-4 py-2 rounded-xl border border-white/10 text-sm font-bold text-white shadow-lg transition hover:scale-105">
                    <i class="fas fa-film mr-2" style="color: var(--primary-color)"></i>Video D…ôyi≈ü
                </button>

                <div id="searchContainer" class="hidden absolute top-16 left-1/2 transform -translate-x-1/2 z-30 w-full max-w-lg px-4">
                    <div class="glass-red rounded-2xl overflow-hidden shadow-2xl border border-white/10">
                        <div class="flex items-center px-4 py-3 border-b border-white/10 bg-neutral-950/50">
                            <i class="fas fa-search mr-3" style="color: var(--primary-color)"></i>
                            <input type="text" id="searchQuery" placeholder="YouTube-da axtar..." class="flex-1 bg-transparent border-none outline-none text-white placeholder-neutral-500 text-sm" onkeypress="if(event.key==='Enter') searchYouTube()">
                            <button onclick="searchYouTube()" class="px-4 py-1.5 rounded-lg text-sm font-bold bg-red-600 text-white hover:bg-red-500 transition">Axtar</button>
                            <button onclick="closeSearch()" class="ml-2 p-2 text-neutral-400 hover:text-white transition">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="searchResults" class="hidden p-3 bg-neutral-950/98 space-y-2 max-h-[40vh] overflow-y-auto"></div>
                    </div>
                </div>

                <div class="flex-1 relative flex items-center justify-center bg-black h-full">
                    <div id="playerWrapper" class="w-full h-full relative">
                        <div id="player"></div>
                    </div>
                    <div id="playerLoader" class="absolute inset-0 flex items-center justify-center bg-black z-10">
                        <div class="spinner"></div>
                    </div>
                    <div id="syncIndicator" class="sync-indicator">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        <span>Sinxronizasiya...</span>
                    </div>
                </div>

                <div id="hostControls" class="hidden glass-red border-t border-white/10 p-3 z-30 absolute bottom-0 left-0 right-0">
                    <div class="flex items-center justify-center space-x-6">
                        <button onclick="playerControl('seek', -10)" class="p-3 rounded-full hover:bg-white/10 transition text-white/80 hover:text-white">
                            <i class="fas fa-backward"></i>
                        </button>
                        <button onclick="playerControl('toggle')" class="w-14 h-14 rounded-full flex items-center justify-center hover:scale-105 transition shadow-lg text-white bg-gradient-to-br from-red-600 to-red-800 shadow-red-900/50">
                            <i class="fas fa-play ml-1 text-xl" id="playIcon"></i>
                            <i class="fas fa-pause hidden text-xl" id="pauseIcon"></i>
                        </button>
                        <button onclick="playerControl('seek', 10)" class="p-3 rounded-full hover:bg-white/10 transition text-white/80 hover:text-white">
                            <i class="fas fa-forward"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="chat-container">
                <div class="users-bar">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-bold uppercase tracking-wider flex items-center gap-1 opacity-60">
                            <i class="fas fa-users text-[10px]"></i> ƒ∞≈ütirak√ßƒ±lar
                        </h3>
                        <span class="text-[11px] text-neutral-500 bg-neutral-900/50 px-2 py-0.5 rounded-full font-bold" id="onlineCount">0 onlayn</span>
                    </div>
                    <div id="usersList" class="flex gap-2 overflow-x-auto custom-scrollbar pb-1"></div>
                </div>

                <div id="replyIndicator" class="hidden reply-bar">
                    <div class="flex-1 min-w-0">
                        <div class="text-[10px] font-bold mb-0.5 flex items-center gap-1 text-amber-500">
                            <i class="fas fa-reply text-[8px]"></i> Cavab
                        </div>
                        <div class="text-xs text-neutral-300 truncate" id="replyText"></div>
                    </div>
                    <button onclick="cancelReply()" class="p-1.5 hover:bg-neutral-800 rounded-full text-neutral-400 hover:text-white transition">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>

                <div id="chatMessages" class="messages-scroll">
                    <div id="typingIndicator" class="hidden typing-indicator">
                        <div class="typing-dots"><span></span><span></span><span></span></div>
                        <span id="typingText">kims…ô yazƒ±r...</span>
                    </div>
                </div>
                
                <!-- D√úZ∆èLƒ∞≈ü: Input sah…ôsi yuxarƒ± qaldƒ±rƒ±ldƒ±, √ßox a≈üaƒüƒ±da qalmamasƒ± √º√ß√ºn -->
                <div class="chat-input-area">
                    <div class="input-container">
                        <textarea id="messageInput" placeholder="Mesaj yaz..." rows="1" 
                            class="chat-textarea"
                            oninput="autoResize(this); handleTyping()"
                            onkeypress="handleKeyPress(event)"></textarea>
                        <button onclick="sendMessage()" id="sendBtn" class="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notificationToast" class="notification-red fixed top-20 right-4 p-4 rounded-2xl z-50 transform translate-x-[150%] transition-transform duration-300 max-w-xs border border-red-500/30">
        <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-xl bg-red-600/20 flex items-center justify-center shrink-0 text-red-500">
                <i class="fas fa-info"></i>
            </div>
            <div>
                <div class="text-sm font-bold text-white mb-0.5" id="notifTitle">Bildiri≈ü</div>
                <div class="text-xs text-neutral-400 leading-relaxed" id="notifText">...</div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCM5WdZNSj9oFipNI-J3csHpOIvK8PfyJRdk",
            authDomain: "sevgili-testi.firebaseapp.com",
            databaseURL: "https://sevgili-testi-default-rtdb.firebaseio.com",
            projectId: "sevgili-testi",
            storageBucket: "sevgili-testi.firebasestorage.app",
            messagingSenderId: "399260477557",
            appId: "1:399260477557:web:584204a698d7bf145bb03c"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const YOUTUBE_API_KEY = "AIzaSyBterRsxZoTvVbxlsOzESKWBDAY2B8BWc4";
        
        // State
        let userId = localStorage.getItem('syncUserId');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('syncUserId', userId);
        }
        
        let currentRoom = null;
        let isHost = false;
        let isCreator = false;
        let player = null;
        let serverOffset = 0;
        let currentVideoId = null;
        let replyingTo = null;
        let userName = '';
        let userAvatar = localStorage.getItem('userAvatar') || '';
        let selectedUserId = null;
        let userPermissions = { chat: true, video: true, changeVideo: false };
        let typingTimeout = null;
        let cinemaMode = false;
        let isSending = false;
        let messageIds = new Set();
        let playerReady = false;
        let dbRefs = [];
        let roomMasterId = null; // BOSS or Host ID
        let currentAnimType = 'shake';
        
        const themes = [
            { id: 'red', name: 'Qƒ±rmƒ±zƒ±', color: '#dc2626' },
            { id: 'pink', name: '√á…ôhrayƒ±', color: '#ec4899' },
            { id: 'green', name: 'Ya≈üƒ±l', color: '#22c55e' },
            { id: 'blue', name: 'Mavi', color: '#3b82f6' },
            { id: 'black', name: 'Qara', color: '#525252' },
            { id: 'gray', name: 'Boz', color: '#6b7280' },
            { id: 'gold', name: 'Qƒ±zƒ±lƒ±', color: '#f59e0b' }
        ];
        
        // Server time sync
        db.ref(".info/serverTimeOffset").on("value", (snap) => { serverOffset = snap.val() || 0; });
        const getServerTime = () => Date.now() + serverOffset;
        
        // Get Master (BOSS priority)
        function updateRoomMaster(users) {
            if (!users) return;
            let master = null;
            let maxPriority = 0;
            
            Object.entries(users).forEach(([uid, data]) => {
                const priority = data.isCreator ? 3 : (data.isHost ? 2 : 1);
                if (priority > maxPriority && data.status === 'active') {
                    maxPriority = priority;
                    master = uid;
                }
            });
            
            roomMasterId = master;
            return master;
        }
        
        // Check if I am the current master controller
        function isRoomMaster() {
            return userId === roomMasterId;
        }
        
        // Stable Video Sync - Only Master broadcasts
        function setupVideoSync() {
            if (!currentRoom) return;
            
            const videoRef = db.ref(`rooms/${currentRoom}/currentVideo`);
            const videoListener = videoRef.on('value', async (snap) => {
                const data = snap.val();
                if (!data || !playerReady) return;
                
                // Don't react to own updates
                if (data.updatedBy === userId) {
                    currentVideoId = data.id;
                    return;
                }
                
                // Only accept updates from Master
                const usersSnap = await db.ref(`rooms/${currentRoom}/users`).once('value');
                const users = usersSnap.val();
                const currentMaster = updateRoomMaster(users);
                
                if (data.updatedBy !== currentMaster) return; // Ignore non-master updates
                
                showSyncIndicator();
                
                // Video ID changed?
                if (data.id !== currentVideoId) {
                    currentVideoId = data.id;
                    player.loadVideoById({
                        videoId: data.id,
                        startSeconds: data.time || 0
                    });
                    
                    if (!data.isPlaying) {
                        setTimeout(() => player.pauseVideo(), 500);
                    }
                    hideSyncIndicator();
                    showNotification('Yeni video', 'Video d…ôyi≈üdirildi');
                    return;
                }
                
                // Time sync (allow 3s drift)
                const playerTime = player.getCurrentTime() || 0;
                const serverTime = data.time || 0;
                const drift = Math.abs(playerTime - serverTime);
                
                if (drift > 3) {
                    player.seekTo(serverTime, true);
                }
                
                // State sync
                const playerState = player.getPlayerState();
                const isPlaying = playerState === YT.PlayerState.PLAYING;
                
                if (data.isPlaying && !isPlaying && playerState !== YT.PlayerState.BUFFERING) {
                    player.playVideo();
                } else if (!data.isPlaying && isPlaying) {
                    player.pauseVideo();
                }
                
                hideSyncIndicator();
            });
            
            dbRefs.push({ ref: videoRef, type: 'value', fn: videoListener });
        }
        
        function showSyncIndicator() {
            document.getElementById('syncIndicator')?.classList.add('active');
        }
        
        function hideSyncIndicator() {
            setTimeout(() => {
                document.getElementById('syncIndicator')?.classList.remove('active');
            }, 1000);
        }
        
        function onPlayerReady() {
            playerReady = true;
            document.getElementById('playerLoader').style.display = 'none';
            loadInitialVideo();
            
            // Master heartbeat
            setInterval(() => {
                if (!playerReady || !isRoomMaster()) return;
                
                const state = player.getPlayerState();
                db.ref(`rooms/${currentRoom}/currentVideo`).update({
                    id: currentVideoId,
                    time: player.getCurrentTime(),
                    isPlaying: state === YT.PlayerState.PLAYING,
                    state: state,
                    updatedBy: userId,
                    updatedAt: getServerTime()
                });
            }, 2000);
        }
        
        function onPlayerStateChange(e) {
            const isPlaying = e.data === YT.PlayerState.PLAYING;
            document.getElementById('playIcon')?.classList.toggle('hidden', isPlaying);
            document.getElementById('pauseIcon')?.classList.toggle('hidden', !isPlaying);
            
            // Only Master broadcasts
            if (!isRoomMaster() || !currentRoom) return;
            
            clearTimeout(window.stateDebounce);
            window.stateDebounce = setTimeout(() => {
                db.ref(`rooms/${currentRoom}/currentVideo`).update({
                    id: currentVideoId,
                    time: player.getCurrentTime(),
                    isPlaying: isPlaying,
                    state: e.data,
                    updatedBy: userId,
                    updatedAt: getServerTime()
                });
            }, 200);
        }
        
        function loadInitialVideo() {
            if (!currentRoom) return;
            db.ref(`rooms/${currentRoom}/currentVideo`).once('value').then(snap => {
                const data = snap.val();
                if (data?.id) {
                    currentVideoId = data.id;
                    player.loadVideoById({ videoId: data.id, startSeconds: data.time || 0 });
                    if (!data.isPlaying) setTimeout(() => player.pauseVideo(), 1000);
                }
            });
        }
        
        function playerControl(action, val) {
            // Only Master can control
            if (!isRoomMaster() || !playerReady) {
                showNotification('ƒ∞caz…ô yoxdur', 'Videonu yalnƒ±z Qurucu/Moderator idar…ô ed…ô bil…ôr');
                return;
            }
            
            if (action === 'toggle') {
                const state = player.getPlayerState();
                if (state === YT.PlayerState.PLAYING) player.pauseVideo();
                else player.playVideo();
            } else if (action === 'seek') {
                player.seekTo(player.getCurrentTime() + val, true);
            }
        }
        
        function selectVideo(id, title) {
            if (!isRoomMaster()) {
                showNotification('ƒ∞caz…ô yoxdur', 'Videonu yalnƒ±z Qurucu d…ôyi≈ü…ô bil…ôr');
                return;
            }
            
            currentVideoId = id;
            db.ref(`rooms/${currentRoom}/currentVideo`).set({
                id: id, title: title, time: 0, isPlaying: true,
                state: YT.PlayerState.PLAYING,
                updatedBy: userId, updatedAt: getServerTime()
            });
            
            player.loadVideoById(id);
            closeSearch();
            showNotification('Video d…ôyi≈üdirildi', title);
        }
        
        // Room Management
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        async function createRoom() {
            if (!validateInputs()) return;
            userName = document.getElementById('hostName').value.trim();
            const code = generateRoomCode();
            
            await db.ref(`rooms/${code}`).set({
                createdAt: getServerTime(),
                hostId: userId,
                theme: { color: 'red', updatedBy: userId, updatedAt: getServerTime() },
                currentVideo: { 
                    id: 'jfKfPfyJRdk', title: 'Lofi Girl', time: 0, isPlaying: false,
                    updatedBy: userId, updatedAt: getServerTime()
                },
                users: { 
                    [userId]: { 
                        name: userName, avatar: userAvatar, isHost: true, isCreator: false,
                        priority: 2, joinedAt: getServerTime(), status: 'active', focused: true
                    }
                }
            });
            
            enterRoom(code, true, false);
        }
        
        async function joinRoom() {
            const code = document.getElementById('joinRoomId')?.value.trim().toUpperCase();
            if (!validateInputs() || !code) { showNotification('X…ôta', 'Kodu daxil edin!'); return; }
            
            userName = document.getElementById('hostName').value.trim();
            const roomSnap = await db.ref(`rooms/${code}`).once('value');
            if (!roomSnap.exists()) { showNotification('X…ôta', 'Otaq tapƒ±lmadƒ±!'); return; }
            
            const roomData = roomSnap.val();
            if (roomData.theme?.color) applyTheme(roomData.theme.color);
            
            await db.ref(`rooms/${code}/users/${userId}`).set({
                name: userName, avatar: userAvatar, isHost: false, isCreator: false,
                priority: 1, joinedAt: getServerTime(), status: 'active', focused: true
            });
            
            enterRoom(code, false, false);
        }
        
        async function enterAsCreator() {
            const code = document.getElementById('creatorRoomId')?.value.trim().toUpperCase();
            const password = document.getElementById('creatorPassword')?.value.trim();
            
            if (!code) { showNotification('X…ôta', 'Otaq kodunu daxil edin!'); return; }
            if (password !== 'mod123') { showNotification('X…ôta', 'Yanlƒ±≈ü Qurucu ≈üifr…ôsi!'); return; }
            
            userName = document.getElementById('hostName')?.value.trim() || 'BOSS';
            const roomSnap = await db.ref(`rooms/${code}`).once('value');
            if (!roomSnap.exists()) { showNotification('X…ôta', 'Otaq tapƒ±lmadƒ±!'); return; }
            
            const roomData = roomSnap.val();
            if (roomData.theme?.color) applyTheme(roomData.theme.color);
            
            isCreator = true;
            const creatorAvatar = userAvatar || 'https://via.placeholder.com/150/f59e0b/ffffff?text=BOSS';
            
            // Trigger global entry event first
            await db.ref(`rooms/${code}/events`).push({
                type: 'bossEntered',
                bossName: userName,
                timestamp: getServerTime()
            });
            
            await db.ref(`rooms/${code}/users/${userId}`).set({
                name: userName, isHost: true, isCreator: true, priority: 3,
                avatar: creatorAvatar, joinedAt: getServerTime(), status: 'active', focused: true
            });
            
            enterRoom(code, true, true);
        }
        
        function enterRoom(code, host, creator) {
            currentRoom = code;
            isHost = host;
            isCreator = creator;
            roomMasterId = userId; // Initially myself until sync
            
            document.getElementById('landing')?.classList.add('hidden');
            document.getElementById('room')?.classList.remove('hidden');
            document.getElementById('roomCode').textContent = code;
            
            const userType = document.getElementById('userType');
            if (creator) {
                userType.textContent = 'BOSS';
                userType.className = 'px-3 py-1 rounded-full text-xs font-black bg-amber-600/20 text-amber-400 border border-amber-500/50 shadow-lg shadow-amber-900/20';
                document.getElementById('hostControls')?.classList.remove('hidden');
                document.getElementById('changeVideoBtn')?.classList.remove('hidden');
                userPermissions = { chat: true, video: true, changeVideo: true };
            } else if (host) {
                userType.textContent = 'MODERATOR';
                userType.className = 'px-3 py-1 rounded-full text-xs font-black bg-purple-600/20 text-purple-400 border border-purple-500/50';
                document.getElementById('hostControls')?.classList.remove('hidden');
                document.getElementById('changeVideoBtn')?.classList.remove('hidden');
                userPermissions = { chat: true, video: true, changeVideo: true };
            } else {
                userType.textContent = 'ƒ∞ZL∆èYƒ∞Cƒ∞';
                userType.className = 'px-3 py-1 rounded-full text-xs font-bold bg-neutral-800 text-neutral-400 border border-white/10';
            }
            
            initThemePicker();
            initPlayer();
            setupRealTimeListeners();
            setupVisibilityTracking();
        }
        
        function setupRealTimeListeners() {
            if (!currentRoom) return;
            
            // Theme
            const themeRef = db.ref(`rooms/${currentRoom}/theme`);
            const themeListener = themeRef.on('value', (snap) => {
                const data = snap.val();
                if (data?.color) applyTheme(data.color);
            });
            dbRefs.push({ ref: themeRef, type: 'value', fn: themeListener });
            
            // Video Sync
            setupVideoSync();
            
            // Users & Master detection
            const usersRef = db.ref(`rooms/${currentRoom}/users`);
            const usersListener = usersRef.on('value', (snap) => {
                const users = snap.val() || {};
                updateRoomMaster(users);
                renderUsersList(users);
                
                // Update animation target dropdown
                const select = document.getElementById('animationTarget');
                if (select && isCreator) {
                    select.innerHTML = '<option value="">üåê Hamƒ±sƒ±na g√∂nd…ôr</option>';
                    Object.entries(users).forEach(([uid, data]) => {
                        if (uid !== userId && data.status === 'active') {
                            const option = document.createElement('option');
                            option.value = uid;
                            option.textContent = data.name + (data.isHost ? ' (Mod)' : '');
                            select.appendChild(option);
                        }
                    });
                }
            });
            dbRefs.push({ ref: usersRef, type: 'value', fn: usersListener });
            
            // Messages
            const msgRef = db.ref(`rooms/${currentRoom}/messages`).limitToLast(50);
            const msgListener = msgRef.on('child_added', (snap) => {
                const msg = snap.val();
                if (msg && !messageIds.has(snap.key)) {
                    messageIds.add(snap.key);
                    displayMessage(snap.key, msg);
                    if (msg.userId !== userId) removeTypingIndicator(msg.userId);
                }
            });
            dbRefs.push({ ref: msgRef, type: 'child_added', fn: msgListener });
            
            // Typing
            const typingRef = db.ref(`rooms/${currentRoom}/typing`);
            const typingListener = typingRef.on('value', (snap) => {
                const typing = snap.val() || {};
                const now = getServerTime();
                const activeTypers = Object.entries(typing)
                    .filter(([uid, data]) => uid !== userId && (now - data.timestamp) < 3000)
                    .map(([_, data]) => data.name);
                
                const indicator = document.getElementById('typingIndicator');
                if (activeTypers.length > 0) {
                    indicator.classList.remove('hidden');
                    document.getElementById('typingText').textContent = activeTypers.join(', ') + ' yazƒ±r...';
                } else {
                    indicator.classList.add('hidden');
                }
            });
            dbRefs.push({ ref: typingRef, type: 'value', fn: typingListener });
            
            // BOSS Entry Event (Global)
            const eventsRef = db.ref(`rooms/${currentRoom}/events`);
            const eventsListener = eventsRef.on('child_added', (snap) => {
                const event = snap.val();
                if (event.type === 'bossEntered' && event.timestamp > getServerTime() - 10000) {
                    showBossEntryAnimation(event.bossName);
                }
            });
            dbRefs.push({ ref: eventsRef, type: 'child_added', fn: eventsListener });
            
            // Screen Messages
            const screenRef = db.ref(`rooms/${currentRoom}/screenMessages`);
            const screenListener = screenRef.on('child_added', (snap) => {
                const msg = snap.val();
                if (!msg) return;
                
                if (msg.targetUserId === '' || msg.targetUserId === userId) {
                    showScreenMessage(msg.text, msg.senderName, msg.animType);
                }
                setTimeout(() => snap.ref.remove(), 1000);
            });
            dbRefs.push({ ref: screenRef, type: 'child_added', fn: screenListener });
            
            // Permissions for viewers
            if (!isHost && !isCreator) {
                const permRef = db.ref(`rooms/${currentRoom}/permissions/${userId}`);
                const permListener = permRef.on('value', (snap) => {
                    const perms = snap.val();
                    if (perms) {
                        userPermissions = { ...userPermissions, ...perms };
                        updatePermissionUI();
                    }
                });
                dbRefs.push({ ref: permRef, type: 'value', fn: permListener });
                
                // Kick detection
                const kickRef = db.ref(`rooms/${currentRoom}/users/${userId}`);
                const kickListener = kickRef.on('value', (snap) => {
                    if (!snap.exists()) { alert('Siz otaqdan atƒ±ldƒ±nƒ±z!'); location.reload(); }
                });
                dbRefs.push({ ref: kickRef, type: 'value', fn: kickListener });
            }
        }
        
        function renderUsersList(users) {
            const list = document.getElementById('usersList');
            list.innerHTML = '';
            let count = 0;
            
            Object.entries(users).forEach(([uid, data]) => {
                // Status color
                let statusClass = 'status-dot';
                let statusText = '';
                
                if (data.status === 'away') {
                    statusClass += ' away';
                    statusText = ' (Gone)';
                } else if (data.status === 'offline' || !data.status) {
                    statusClass += ' offline';
                    statusText = ' (Offline)';
                } else {
                    count++;
                }
                
                const chip = document.createElement('div');
                const isBoss = data.isCreator;
                const isHost = data.isHost && !isBoss;
                
                chip.className = `user-chip ${isBoss ? 'creator' : ''} ${isHost ? 'host' : ''}`;
                chip.style.opacity = data.status !== 'active' ? '0.5' : '1';
                
                if ((isCreator || isHost) && uid !== userId) {
                    chip.onclick = () => openUserModal(uid, data);
                }
                
                // BOSS PNG icon for creator
                const bossIcon = isBoss 
                    ? `<img src="boss.png" class="boss-badge-mini" alt="BOSS" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';"><i class="fas fa-crown text-amber-400 text-[10px] hidden"></i>` 
                    : (isHost ? '<i class="fas fa-star text-purple-400 text-[10px]"></i>' : '');
                
                chip.innerHTML = `
                    <span class="${statusClass}"></span>
                    <img src="${data.avatar || 'https://via.placeholder.com/24'}" class="w-6 h-6 rounded-full object-cover" onerror="this.src='https://via.placeholder.com/24'">
                    <span class="text-xs font-bold">${escapeHtml(data.name)}${statusText}</span>
                    ${bossIcon}
                `;
                list.appendChild(chip);
                
                // Notify BOSS about status changes
                if (isCreator && uid !== userId && data.status !== 'active') {
                    showNotification('ƒ∞stifad…ô√ßi statusu', `${data.name} ${data.status === 'away' ? 's…ôhif…ôni arxa plana atdƒ±' : '√ßƒ±xdƒ±'}`);
                }
            });
            
            document.getElementById('onlineCount').textContent = count + ' onlayn';
        }
        
        function setupVisibilityTracking() {
            // Visibility change
            document.addEventListener('visibilitychange', () => {
                if (!currentRoom) return;
                const status = document.hidden ? 'away' : 'active';
                db.ref(`rooms/${currentRoom}/users/${userId}/status`).set(status);
            });
            
            // Before unload
            window.addEventListener('beforeunload', () => {
                if (currentRoom) {
                    db.ref(`rooms/${currentRoom}/users/${userId}/status`).set('offline');
                }
            });
        }
        
        // Chat Functions
        function handleTyping() {
            if (!currentRoom) return;
            const input = document.getElementById('messageInput');
            
            if (!input.value.trim()) {
                db.ref(`rooms/${currentRoom}/typing/${userId}`).remove();
                return;
            }
            
            db.ref(`rooms/${currentRoom}/typing/${userId}`).set({
                name: userName, timestamp: getServerTime()
            });
            
            if (typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                db.ref(`rooms/${currentRoom}/typing/${userId}`).remove();
            }, 2000);
        }
        
        function removeTypingIndicator(uid) {
            if (currentRoom) db.ref(`rooms/${currentRoom}/typing/${uid}`).remove();
        }
        
        function sendMessage() {
            if (isSending) return;
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !currentRoom) return;
            
            if (!isHost && !isCreator && userPermissions.chat === false) {
                showNotification('Block', 'Siz…ô yazƒ± yazmaq qadaƒüan edilib!');
                return;
            }
            
            isSending = true;
            db.ref(`rooms/${currentRoom}/typing/${userId}`).remove();
            
            const msg = {
                type: 'text', text: text, userId: userId, name: userName,
                avatar: userAvatar, isCreator: isCreator, timestamp: getServerTime()
            };
            if (replyingTo) { msg.replyTo = replyingTo; cancelReply(); }
            
            input.value = '';
            input.style.height = 'auto';
            
            db.ref(`rooms/${currentRoom}/messages`).push(msg).finally(() => isSending = false);
        }
        
        function displayMessage(msgId, msg) {
            const container = document.getElementById('chatMessages');
            if (document.getElementById('msg-' + msgId)) return;
            
            const isOwn = msg.userId === userId;
            const wrapper = document.createElement('div');
            wrapper.className = 'msg-wrapper';
            wrapper.id = 'msg-' + msgId;
            
            const replyHtml = msg.replyTo ? `<div class="msg-reply">${escapeHtml(msg.replyTo.text)}</div>` : '';
            const avatarSrc = msg.avatar || 'https://via.placeholder.com/32';
            const avatarClass = msg.isCreator ? 'msg-avatar creator-avatar' : 'msg-avatar';
            const avatarHtml = !isOwn ? `<img src="${avatarSrc}" class="${avatarClass}" onclick="setReply('${msgId}', '${escapeHtml(msg.name)}', '${escapeHtml(msg.text)}')">` : '';
            
            // BOSS PNG in chat
            const bossBadge = msg.isCreator 
                ? `<img src="boss.png" class="boss-icon-inline" alt="BOSS" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';"><i class="fas fa-crown text-amber-400 text-[10px] hidden"></i>` 
                : '';
            const senderClass = msg.isCreator ? 'msg-sender creator' : 'msg-sender';
            
            wrapper.innerHTML = `
                ${avatarHtml}
                <div class="flex flex-col ${isOwn ? 'items-end' : 'items-start'} flex-1">
                    ${!isOwn ? `<div class="${senderClass}">${escapeHtml(msg.name)} ${bossBadge}</div>` : ''}
                    <div class="msg-bubble ${isOwn ? 'msg-own' : 'msg-other'}">
                        ${replyHtml}
                        <div class="break-words">${escapeHtml(msg.text)}</div>
                        <div class="msg-meta"><span>${formatTime(msg.timestamp)}</span></div>
                    </div>
                </div>
            `;
            
            const typingIndicator = document.getElementById('typingIndicator');
            container.insertBefore(wrapper, typingIndicator);
            container.scrollTop = container.scrollHeight;
        }
        
        // Permission System
        function togglePermission(type) {
            if (!selectedUserId || !currentRoom) return;
            
            const el = document.getElementById('perm' + type.charAt(0).toUpperCase() + type.slice(1));
            const currentState = el.classList.contains('active');
            const newState = !currentState;
            
            // Visual update
            el.classList.toggle('active', newState);
            
            // D√úZ∆èLƒ∞≈û: Permission d√ºzg√ºn yazƒ±lƒ±r (true/false)
            db.ref(`rooms/${currentRoom}/permissions/${selectedUserId}/${type}`).set(newState)
                .then(() => {
                    showNotification('Uƒüurlu', `${type}: ${newState ? 'Aktiv' : 'Deaktiv'}`);
                })
                .catch(err => {
                    console.error('Permission error:', err);
                    showNotification('X…ôta', 'ƒ∞caza d…ôyi≈üdirilm…ôdi');
                });
        }
        
        // Animation Modal
        function openAnimationModal() {
            if (!isCreator) return;
            document.getElementById('animationModal').classList.remove('hidden');
        }
        
        function openAnimationModalFromUser() {
            closeUserModal();
            setTimeout(() => openAnimationModal(), 300);
        }
        
        function closeAnimationModal() {
            document.getElementById('animationModal').classList.add('hidden');
        }
        
        function setAnimType(type) {
            currentAnimType = type;
            document.querySelectorAll('.anim-type-btn').forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.classList.add('active', 'bg-amber-600/20', 'border-amber-500', 'text-amber-400');
                    btn.classList.remove('bg-neutral-800', 'border-neutral-700', 'text-neutral-400');
                } else {
                    btn.classList.remove('active', 'bg-amber-600/20', 'border-amber-500', 'text-amber-400');
                    btn.classList.add('bg-neutral-800', 'border-neutral-700', 'text-neutral-400');
                }
            });
        }
        
        function sendScreenAnimation() {
            if (!isCreator) return;
            
            const text = document.getElementById('animationText').value.trim();
            const targetId = document.getElementById('animationTarget').value;
            
            if (!text) {
                showNotification('X…ôta', 'Mesaj yazƒ±n');
                return;
            }
            
            db.ref(`rooms/${currentRoom}/screenMessages`).push({
                text: text,
                senderName: userName,
                targetUserId: targetId,
                animType: currentAnimType,
                timestamp: getServerTime()
            });
            
            closeAnimationModal();
            document.getElementById('animationText').value = '';
            showNotification('G√∂nd…ôrildi', targetId ? '≈û…ôxsi mesaj g√∂nd…ôrildi' : 'Hami√ßa g√∂nd…ôrildi');
        }
        
        // Visual Effects
        function showBossEntryAnimation(bossName) {
            const overlay = document.getElementById('bossEntryOverlay');
            document.getElementById('bossEntryName').textContent = bossName + ' otaƒüa qo≈üuldu';
            overlay.classList.add('active');
            
            setTimeout(() => {
                overlay.style.animation = 'bossEntryOut 0.5s ease forwards';
                setTimeout(() => {
                    overlay.classList.remove('active');
                    overlay.style.animation = '';
                }, 500);
            }, 3000);
        }
        
        function showScreenMessage(text, sender, animType) {
            const overlay = document.getElementById('screenMessageOverlay');
            const textEl = document.getElementById('screenMessageText');
            const senderEl = document.getElementById('screenMessageSender');
            
            textEl.textContent = text;
            senderEl.textContent = 'üëë ' + sender;
            textEl.className = 'screen-message-text ' + (animType || 'shake');
            
            overlay.classList.add('active');
            
            setTimeout(() => {
                overlay.classList.remove('active');
            }, 5000);
        }
        
        function closeScreenMessage() {
            document.getElementById('screenMessageOverlay').classList.remove('active');
        }
        
        // Helpers
        function setReply(msgId, name, text) {
            replyingTo = { id: msgId, name, text: text.length > 30 ? text.substring(0, 30) + '...' : text };
            document.getElementById('replyIndicator').classList.remove('hidden');
            document.getElementById('replyText').textContent = name + ': ' + replyingTo.text;
            document.getElementById('messageInput').focus();
        }
        
        function cancelReply() { replyingTo = null; document.getElementById('replyIndicator').classList.add('hidden'); }
        function handleKeyPress(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
        function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 80) + 'px'; }
        function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function formatTime(timestamp) { if (!timestamp) return ''; return new Date(timestamp).toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' }); }
        
        // UI Functions
        function initThemePicker() {
            const grid = document.getElementById('themeGrid');
            if (!grid) return;
            grid.innerHTML = '';
            themes.forEach(theme => {
                const btn = document.createElement('div');
                btn.className = 'theme-option';
                btn.style.background = `linear-gradient(135deg, ${theme.color}, ${theme.color}dd)`;
                btn.onclick = () => changeTheme(theme.id);
                btn.innerHTML = `<span class="theme-label">${theme.name}</span><div style="width: 20px; height: 20px; border-radius: 50%; background: white; border: 2px solid ${theme.color};"></div>`;
                btn.dataset.theme = theme.id;
                if (theme.id === 'red') btn.classList.add('active');
                grid.appendChild(btn);
            });
        }
        
        function openThemePicker() {
            if (!isCreator && !userPermissions.changeVideo) {
                showNotification('ƒ∞caz…ô yoxdur', 'Temanƒ± yalnƒ±z Qurucu d…ôyi≈ü…ô bil…ôr');
                return;
            }
            document.getElementById('themePicker')?.classList.add('active');
        }
        
        function closeThemePicker() { document.getElementById('themePicker')?.classList.remove('active'); }
        
        function changeTheme(themeId) {
            if (!isCreator && !userPermissions.changeVideo) return;
            applyTheme(themeId);
            db.ref(`rooms/${currentRoom}/theme`).set({ color: themeId, updatedBy: userId, updatedAt: getServerTime() });
            closeThemePicker();
        }
        
        function applyTheme(themeId) {
            document.body.className = document.body.className.replace(/theme-\w+/g, '').trim();
            document.body.classList.add(`theme-${themeId}`);
        }
        
        function openUserModal(uid, userData) {
            if ((!isCreator && !isHost) || uid === userId) return;
            selectedUserId = uid;
            document.getElementById('modalUserName').textContent = userData.name || 'Nam…ôlum';
            document.getElementById('modalUserAvatar').src = userData.avatar || 'https://via.placeholder.com/64';
            document.getElementById('modalUserStatus').textContent = userData.isCreator ? 'BOSS' : (userData.isHost ? 'Moderator' : 'ƒ∞zl…ôyici');
            
            // Load current permissions
            db.ref(`rooms/${currentRoom}/permissions/${uid}`).once('value').then(snap => {
                const perms = snap.val() || {};
                document.getElementById('permChat').classList.toggle('active', perms.chat !== false);
                document.getElementById('permVideo').classList.toggle('active', perms.video !== false);
                document.getElementById('permChangeVideo').classList.toggle('active', perms.changeVideo === true);
            });
            
            document.getElementById('userModal').classList.remove('hidden');
        }
        
        function closeUserModal() { document.getElementById('userModal').classList.add('hidden'); selectedUserId = null; }
        
        function kickUser() {
            if (!selectedUserId || !confirm('ƒ∞stifad…ô√ßini otaqdan at?')) return;
            db.ref(`rooms/${currentRoom}/users/${selectedUserId}`).remove();
            db.ref(`rooms/${currentRoom}/permissions/${selectedUserId}`).remove();
            closeUserModal();
            showNotification('ƒ∞stifad…ô√ßi atƒ±ldƒ±', 'ƒ∞stifad…ô√ßi otaqdan √ßƒ±xarƒ±ldƒ±');
        }
        
        function leaveRoom() {
            if (!confirm('Otaqdan √ßƒ±xmaq ist…ôyirsiniz?')) return;
            if (document.fullscreenElement) document.exitFullscreen().catch(() => {});
            
            if (currentRoom) {
                db.ref(`rooms/${currentRoom}/users/${userId}`).remove();
                db.ref(`rooms/${currentRoom}/typing/${userId}`).remove();
            }
            
            // Cleanup listeners
            dbRefs.forEach(({ ref, type, fn }) => ref.off(type, fn));
            dbRefs = [];
            
            location.reload();
        }
        
        function toggleCinemaMode() {
            cinemaMode = !cinemaMode;
            document.body.classList.toggle('cinema-mode');
            if (cinemaMode) document.documentElement.requestFullscreen?.().catch(() => {});
            else if (document.fullscreenElement) document.exitFullscreen();
        }
        
        function toggleSearch() { 
            if (!isRoomMaster()) {
                showNotification('ƒ∞caz…ô yoxdur', 'Videonu yalnƒ±z Qurucu d…ôyi≈ü…ô bil…ôr');
                return;
            }
            document.getElementById('searchContainer')?.classList.toggle('hidden'); 
        }
        
        function closeSearch() { 
            document.getElementById('searchContainer')?.classList.add('hidden'); 
            document.getElementById('searchResults')?.classList.add('hidden');
        }
        
        async function searchYouTube() {
            const query = document.getElementById('searchQuery')?.value.trim();
            if (!query) return;
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="flex justify-center p-4"><div class="spinner"></div></div>';
            resultsDiv.classList.remove('hidden');
            
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=8&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}`);
                const data = await res.json();
                
                resultsDiv.innerHTML = '';
                if (!data.items?.length) {
                    resultsDiv.innerHTML = '<div class="text-xs text-center p-2 text-neutral-400">N…ôtic…ô tapƒ±lmadƒ±</div>';
                    return;
                }
                
                data.items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'flex space-x-3 p-2 rounded-lg bg-neutral-900/50 hover:bg-neutral-800 cursor-pointer transition';
                    card.onclick = () => selectVideo(item.id.videoId, item.snippet.title);
                    
                    card.innerHTML = `
                        <div class="relative w-28 h-16 shrink-0 rounded-lg overflow-hidden">
                            <img src="${item.snippet.thumbnails.medium?.url}" class="w-full h-full object-cover" loading="lazy">
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-xs font-bold text-white line-clamp-2">${escapeHtml(item.snippet.title)}</h4>
                        </div>
                    `;
                    resultsDiv.appendChild(card);
                });
            } catch (err) {
                resultsDiv.innerHTML = '<div class="text-xs text-center p-2 text-red-400">Axtarƒ±≈ü x…ôtasƒ±</div>';
            }
        }
        
        function copyCode() {
            navigator.clipboard.writeText(currentRoom).then(() => showNotification('Kopyalandƒ±', 'Otaq kodu kopyalandƒ±'));
        }
        
        function showNotification(title, text) {
            const notif = document.getElementById('notificationToast');
            document.getElementById('notifTitle').textContent = title;
            document.getElementById('notifText').textContent = text;
            notif.style.transform = 'translateX(0)';
            setTimeout(() => notif.style.transform = 'translateX(150%)', 3000);
        }
        
        function validateInputs() {
            const name = document.getElementById('hostName')?.value.trim();
            if (!name) { showNotification('X…ôta', 'Adƒ±nƒ±zƒ± daxil edin!'); return false; }
            if (!isCreator && !userAvatar) { 
                document.getElementById('avatarError')?.classList.remove('hidden');
                showNotification('X…ôta', 'Profil ≈ü…ôkli se√ßin');
                return false; 
            }
            return true;
        }
        
        function triggerAvatarUpload() { document.getElementById('avatarInput')?.click(); }
        
        document.getElementById('avatarInput')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) { showNotification('X…ôta', '≈û…ôkil 2MB-dan ki√ßik olmalƒ±dƒ±r!'); return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                userAvatar = e.target.result;
                localStorage.setItem('userAvatar', userAvatar);
                document.getElementById('avatarPreview').src = userAvatar;
                document.getElementById('avatarPreview').classList.add('show');
                document.getElementById('avatarPlaceholder').classList.add('hidden');
                document.getElementById('avatarError')?.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        });
        
        function initPlayer() {
            if (typeof YT === 'undefined' || !YT.Player) { setTimeout(initPlayer, 100); return; }
            
            try {
                player = new YT.Player('player', {
                    height: '100%', width: '100%',
                    videoId: 'jfKfPfyJRdk',
                    playerVars: { 
                        autoplay: 0, controls: isCreator ? 1 : 0, 
                        disablekb: isCreator ? 0 : 1, rel: 0, playsinline: 1
                    },
                    events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange }
                });
            } catch(e) { setTimeout(initPlayer, 500); }
        }
        
        if (localStorage.getItem('userAvatar')) {
            const avatar = localStorage.getItem('userAvatar');
            document.getElementById('avatarPreview').src = avatar;
            document.getElementById('avatarPreview').classList.add('show');
            document.getElementById('avatarPlaceholder').classList.add('hidden');
        }
    </script>
</body>
</html>
